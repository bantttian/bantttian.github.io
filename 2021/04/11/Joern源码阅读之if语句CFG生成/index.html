<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>Joern源码阅读之if语句CFG生成 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Joern源码阅读之if语句CFG生成</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-04-11&nbsp;&nbsp;20:53:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p>我在记录调试分析joern源码的过程中，学到了一些关于java的新知识，为了能够方便自己后面回顾，所以先记录下一些基础概念：</p>
<blockquote>
<ol>
<li><p><strong>重载overload</strong>：重载是在一个类里面，方法名字相同，而参数不同。返回类型可以相同也可以不同。每个重载的方法（或者构造函数）都必须有一个独一无二的参数类型列表。最常用的地方就是<strong>构造器的重载</strong>。</p>
</li>
<li><p><strong>重写override</strong>：重写是子类对父类的允许访问的方法的实现过程进行重新编写, 返回值和形参都不能改变。<strong>即外壳不变，核心重写！</strong>重写方法不能抛出新的检查异常或者比被重写方法申明更加宽泛的异常。例如： 父类的一个方法申明了一个检查异常 IOException，但是在重写这个方法的时候不能抛出 Exception 异常，因为 Exception 是 IOException 的父类，只能抛出 IOException 的子类异常。  </p>
</li>
<li><p><strong>Statement</strong>：statement的例子有（for循环，if条件句）</p>
</li>
<li><p><strong>Expression</strong>：expression的例子有（函数调用，变量之间的运算）</p>
</li>
</ol>
<p>如果你能将一串代码作为参数传递，那么这就能被称为expression。</p>
<ol start="6">
<li><strong>Statement和Expression之间的关系</strong>：<strong>所有的expression都是Statement</strong>，反之则不成立。expression可以作为右值，但是statement不可以。简单来说，expression是可以用<strong>eval来求值</strong>的东西，statement则不一定。可以参考这篇问答：<a href="https://stackoverflow.com/questions/4728073/what-is-the-difference-between-an-expression-and-a-statement-in-python" target="_blank" rel="noopener">https://stackoverflow.com/questions/4728073/what-is-the-difference-between-an-expression-and-a-statement-in-python</a> 。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;function foo(expression)</span><br><span class="line">   &#123;</span><br><span class="line">   	statement;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="条件句基本结构"><a href="#条件句基本结构" class="headerlink" title="条件句基本结构"></a>条件句基本结构</h2><p>最常见的条件句就是if（或者是if-else）条件语句。</p>
<h3 id="官方手册"><a href="#官方手册" class="headerlink" title="官方手册"></a>官方手册</h3><p>if条件句官方手册：<a href="https://www.php.net/manual/zh/control-structures.if.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/control-structures.if.php</a></p>
<p>官方中给出的最常见的if条件句结构：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/1.png" alt="1"></p>
<p>一个最简单的例子，下面的php代码<code>if_normal.php</code>表示，如果<code>firstName</code>不为空，那么<code>$name</code>就设为<code>$firstName</code>，否则就设为<code>Guest</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($firstName)) </span><br><span class="line">    $name = $firstName;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    $name = <span class="string">"Guest"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>生成的代码属性图为：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/2.png" alt="2"></p>
<p>从中抽取出CFG为：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/3.png" alt="3"></p>
<p>程序的控制流一共有两条路径（数字表示id）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2 -&gt; 7 -&gt; 11 -&gt; 22 -&gt; 3</span><br><span class="line">2 -&gt; 7 -&gt; 18 -&gt; 22 -&gt; 3</span><br></pre></td></tr></table></figure>

<p>我们知道，在控制流图中，有<code>CFG_FUNC_ENTRY</code>和<code>CFG_FUNC_EXIT</code>，其中，<code>CFG_FUNC_EXIT</code>结点的前一个node通常是一个null结点，控制流会汇聚在null node，最后通过null node流向CFG出口结点<code>CFG_FUNC_EXIT</code>。</p>
<p>上图中<code>id=7</code>的结点它的<code>type = AST_UNARY_OP</code>，说明了这是一个<strong>一元操作运算符</strong>，<code>flags = UNARY_BOOL_NOT</code>，说明该一元操作运算符是<code>!</code>。</p>
<p>在<code>joern/projects/extensions/joern-php/src/main/java/inputModules/csv/PHPCSVNodeTypes.java</code>的<strong>PHPCSVNodeTypes</strong>类中，就定义了几种flags来区分不同的操作运算符：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVNodeTypes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// flags for TYPE_UNARY_OP nodes (exclusive)</span></span><br><span class="line">    <span class="comment">// 一元操作运算符 !</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_UNARY_BOOL_NOT = <span class="string">"UNARY_BOOL_NOT"</span>;</span><br><span class="line">    <span class="comment">// 一元操作运算符 ~</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_UNARY_BITWISE_NOT = <span class="string">"UNARY_BITWISE_NOT"</span>;</span><br><span class="line">    <span class="comment">// 一元操作运算符 +</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_UNARY_MINUS = <span class="string">"UNARY_MINUS"</span>; <span class="comment">// since version 20 of php-ast</span></span><br><span class="line">    <span class="comment">// 一元操作运算符 -</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_UNARY_PLUS = <span class="string">"UNARY_PLUS"</span>; <span class="comment">// since version 20 of php-ast</span></span><br><span class="line">	<span class="comment">// 一元操作运算符 @</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_UNARY_SILENCE = <span class="string">"UNARY_SILENCE"</span>; <span class="comment">// since version 20 of php-ast</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="nodes-csv"><a href="#nodes-csv" class="headerlink" title="nodes.csv"></a>nodes.csv</h3><p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/8.png" alt="8"></p>
<h3 id="rels-csv"><a href="#rels-csv" class="headerlink" title="rels.csv"></a>rels.csv</h3><p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/7.png" alt="7"></p>
<h3 id="cpg-edges-csv"><a href="#cpg-edges-csv" class="headerlink" title="cpg_edges.csv"></a>cpg_edges.csv</h3><p>根据<code>nodes.csv</code>和<code>rels.csv</code>生成的对应的<code>cpg_edges.csv</code>为：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/0.png" alt="0"></p>
<p>根据<code>rels.csv</code>得到的ast结构为，严格来说，<code>[0]</code>号结点类型是<code>Artificial</code>，并不是<code>AST</code>类型的：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/10.png" alt="10"></p>
<p>根据该AST树转成的CFG图为：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/24.png" alt="24"></p>
<h2 id="if条件句解析流程分析"><a href="#if条件句解析流程分析" class="headerlink" title="if条件句解析流程分析"></a>if条件句解析流程分析</h2><h3 id="Main-java"><a href="#Main-java" class="headerlink" title="Main.java"></a>Main.java</h3><p>首先，从AST树的<code>id=1</code>的结点开始，调用<code>ASTToCFGConverter.convert</code>将AST对象转化为CFG对象：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/9.png" alt="9"></p>
<p>因为是PHP源码，所以<code>ASTToCFGConverter.setFactory</code>会将<code>ASTToCFGConverter.factory</code>设置为<code>PHPCFGFactory</code>，那么第23行调用的就是<code>PHPCFGFactory.convert()</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/11.png" alt="11"></p>
<p>并且传入的参数node对象的类型为<code>FunctionDef</code>，但上面第21行的node类型是<code>FUnctionDefBase</code>，因为后者是前者的父类：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/12.png" alt="12"></p>
<p>我们可以看到，无论是子类<code>FunctionDef</code>还是父类<code>FunctionDefBase</code>，其实归根结底都是一种<code>ASTNode</code>。</p>
<h3 id="PHPCFGFactory-amp-CFGFactory"><a href="#PHPCFGFactory-amp-CFGFactory" class="headerlink" title="PHPCFGFactory &amp; CFGFactory"></a>PHPCFGFactory &amp; CFGFactory</h3><p><code>PHPCFGFactory</code>类中有<strong>重载（overload）方法</strong> <code>newInstance()</code>来处理不同的statement：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCFGFactory</span> <span class="keyword">extends</span> <span class="title">CFGFactory</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// node id offsets for entry and exit nodes of function definitions</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CFG_ENTRY_OFFSET = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CFG_EXIT_OFFSET = <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		structuredFlowVisitior = <span class="keyword">new</span> PHPStructuredFlowVisitor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PHPCFGFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		structuredFlowVisitior = <span class="keyword">new</span> PHPStructuredFlowVisitor();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 处理FunctionDef node结点</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span> </span>&#123; ... &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 处理if条件语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(IfStatementBase ifStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理if条件句内的元素结点</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CFG <span class="title">convertIfElem</span><span class="params">(Iterator&lt;IfElement&gt; iterator)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理switch语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(SwitchStatement switchStatement)</span> </span>&#123; ... &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 处理foreach语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ForEachStatement forEachStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理try...catch语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(TryStatement tryStatement)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>newInstance(FunctionDefBase functionDefinition)</code><strong>重写</strong>了父类<strong>CFGFactory</strong>的<code>CFGFactory.newInstance(FunctionDefBase functionDefinition)</code>，区别在于，在返回父类<code>CFGFactory</code>生成的<code>cfg</code>之后，还需要设置entry node和exit node的id，分为设置为2和3，并将entry node的类型转为<code>CFGEntryNode</code>，exit node的类型转为<code>CFGExitNode</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCFGFactory</span> <span class="keyword">extends</span> <span class="title">CFGFactory</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">// 调用父类CFGFactory.newInstance(FunctionDefBase functionDefinition)生成CFG</span></span><br><span class="line">		CFG cfg = <span class="keyword">super</span>.newInstance(functionDefinition);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// for PHP, we additionally set the node ids for the function entry and exit nodes:</span></span><br><span class="line">		<span class="comment">// their ids match the ids of the entry and exit nodes output by the PHP AST parser</span></span><br><span class="line">		Long id = functionDefinition.getNodeId();	<span class="comment">// 获取func的rootnode id，为1</span></span><br><span class="line">        <span class="comment">// 为entry node和exit node设置id，分别为2和3，同时将其类型转化为CFGEntryNode和CFGExitNode</span></span><br><span class="line">		((CFGEntryNode)cfg.getEntryNode()).setNodeId( id + CFG_ENTRY_OFFSET);</span><br><span class="line">		((CFGExitNode)cfg.getExitNode()).setNodeId( id + CFG_EXIT_OFFSET);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> cfg;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和<code>PHPCFGFactory</code>一样，<code>CFGFactory</code>也存在对cfg实例化方法<code>newInstance()</code>的<strong>重载（overload）</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFGFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> StructuredFlowVisitor structuredFlowVisitior;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ASTNode... nodes)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newErrorInstance</span><span class="params">()</span> n</span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(WhileStatement whileStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ForStatement forStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(DoStatement doStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(TryStatement tryStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(SwitchStatement switchStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ParameterList paramList)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(CompoundStatement content)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ReturnStatement returnStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(GotoStatement gotoStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(Label labelStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ContinueStatement continueStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(BreakStatement breakStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ThrowStatement throwStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">convert</span><span class="params">(ASTNode node)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixBreakStatements</span><span class="params">(CFG thisCFG, CFGNode target)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixContinueStatement</span><span class="params">(CFG thisCFG, CFGNode target)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixBreakOrContinueStatements</span><span class="params">(CFG thisCFG, CFGNode target, Iterator&lt;CFGNode&gt; it)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixGotoStatements</span><span class="params">(CFG thisCFG)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixReturnStatements</span><span class="params">(CFG thisCFG)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CFGFactory-newInstance-FunctionDefBase-functionDefinition"><a href="#CFGFactory-newInstance-FunctionDefBase-functionDefinition" class="headerlink" title="CFGFactory.newInstance(FunctionDefBase functionDefinition)"></a>CFGFactory.newInstance(FunctionDefBase functionDefinition)</h3><p>我们跟入到<code>CFGFactory.newInstance(FunctionDefBase functionDefinition)</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/13.png" alt="13"></p>
<p>上图中第44行的断点处：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFG function = newInstance();</span><br></pre></td></tr></table></figure>

<p>它的作用是生成一个最小单位的CFG，一个最小单位的CFG只包含两个结点，一个entry node，一个exit node，表示为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] &#x3D;&#x3D;[]&#x3D;&#x3D;&gt; [EXIT] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p>前面我们说到，无论是子类<code>FunctionDef</code>对象，还是它的父类<code>FunctionDefBase</code>对象，其实它们都是一种<code>ASTNode</code>。一般来说，下面几种类型的ASTNode会成为<code>FunctionDefBase functionDefinition</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVNodeTypes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// declaration nodes</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_TOPLEVEL = <span class="string">"AST_TOPLEVEL"</span>; <span class="comment">// artificial</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_FUNC_DECL = <span class="string">"AST_FUNC_DECL"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_METHOD = <span class="string">"AST_METHOD"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_CLOSURE = <span class="string">"AST_CLOSURE"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在单php文件中，只要存在多个函数定义，就有可能存在多个<code>FunctionDefBase</code>类型结点，因为该类型就是用来区分函数块的。</p>
<h4 id="FunctionDefBase"><a href="#FunctionDefBase" class="headerlink" title="FunctionDefBase"></a>FunctionDefBase</h4><p>接着继续分析，程序执行到下一行，此时已经执行了<code>functionDefinition.getParameterList()</code>，但未执行<code>convert()</code>函数：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/15.png" alt="15"></p>
<p><code>functionDefinition.getParameterList()</code>返回的结果是<code>null</code>。</p>
<p>这是什么意思？</p>
<p>我们来看一下<code>FunctionDefBase</code>类，它有两个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FunctionDefBase</span> <span class="keyword">extends</span> <span class="title">ASTNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> ParameterList parameterList = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">protected</span> CompoundStatement content = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分别为类<code>ParameterList</code>和类<code>CompoundStatement</code>。</p>
<h5 id="FunctionDeBase-ParameterList"><a href="#FunctionDeBase-ParameterList" class="headerlink" title="FunctionDeBase.ParameterList"></a>FunctionDeBase.ParameterList</h5><p>其中<code>ParameterList</code>是一种<code>ASTNode List</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/16.png" alt="16"></p>
<p><code>ParameterList</code>类有一个成员变量<code>parameters</code>，是一个LinkedList，它用来存储类型为<code>ParameterBase</code>的结点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParameterList</span> <span class="keyword">extends</span> <span class="title">ASTNode</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">ParameterBase</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> LinkedList&lt;ParameterBase&gt; parameters = <span class="keyword">new</span> LinkedList&lt;ParameterBase&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ParameterBase</code>类是<code>Parameter</code>的父类，一般函数中的参数类型就是<code>ParameterBase</code>（更具象来说是<code>Parameter</code>），那<code>ParameterList</code>的作用主要维护一个函数中的类型为<code>ParameterBase</code>的函数参数。它们的关系如下图所示：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/18.png" alt="18"></p>
<h5 id="FunctionDefBase-CompoundStatement"><a href="#FunctionDefBase-CompoundStatement" class="headerlink" title="FunctionDefBase.CompoundStatement"></a>FunctionDefBase.CompoundStatement</h5><p>然后是<code>CompoundStatement</code>，简单来说就是一种复合类型的Statement。CompoundStatement通常包含更小的CompoundStatement。</p>
<p>用一个最简单的例子来描述<code>ParamterList</code>和<code>CompoundStatement</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/17.png" alt="17"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// function是最小的CFG，也是CFG的起始</span></span><br><span class="line">        CFG function = newInstance();</span><br><span class="line">        <span class="comment">// 若functionDefinition对应的代码是非函数式的，那么functionDefinition.getParameterList()最后返回的是null，parameterBlock最后也是一个仅包含entry node和exit node的最小CFG</span></span><br><span class="line">        CFG parameterBlock = convert(</span><br><span class="line">            functionDefinition.getParameterList());</span><br><span class="line">        <span class="comment">// 处理函数体里的语句内容，对于非函数PHP文件，则是处理从&lt;?php后面的语句内容</span></span><br><span class="line">        CFG functionBody = convert(functionDefinition.getContent());</span><br><span class="line">        parameterBlock.appendCFG(functionBody);</span><br><span class="line">        function.appendCFG(parameterBlock);</span><br><span class="line">        fixGotoStatements(function);</span><br><span class="line">        fixReturnStatements(function);</span><br><span class="line">        <span class="keyword">if</span> (!function.getBreakStatements().isEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(<span class="string">"warning: unresolved break statement"</span>);</span><br><span class="line">            fixBreakStatements(function, function.getErrorNode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!function.getContinueStatements().isEmpty())</span><br><span class="line">        &#123;</span><br><span class="line">            System.err.println(<span class="string">"warning: unresolved continue statement"</span>);</span><br><span class="line">            fixContinueStatement(function, function.getErrorNode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (function.hasExceptionNode())</span><br><span class="line">        &#123;</span><br><span class="line">            function.addEdge(function.getExceptionNode(),</span><br><span class="line">                             function.getExitNode(), CFGEdge.UNHANDLED_EXCEPT_LABEL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> function;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// e.printStackTrace();</span></span><br><span class="line">        <span class="keyword">return</span> newErrorInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="functionBody生成"><a href="#functionBody生成" class="headerlink" title="functionBody生成"></a>functionBody生成</h3><p>接着开始处理最主要的内容，我们可以较为简单的理解为开始处理函数里面的语句，对于无函数的php文件，就是<code>&lt;?php</code>后面对应的语句。</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/19.png" alt="19"></p>
<p>其中<code>id=4</code>的结点就是<code>type = AST_STMT_LIST</code>的结点，它通常是很多结点的父结点。</p>
<p>跟进<code>CFGFactory.convert</code>函数，我们会发现这一步主要是根据传进convert函数的node类型来决定<code>StructuredFlowVisitor</code>。</p>
<p>前面我们已经知道，CFG图是由<code>CFGFactory</code>或是<code>PHPCFGFactory</code>类中的重载方法<code>newInstance</code>来决定的，但是不同的结点类型，它们的处理过程也有不同， 那么如何确定某个结点使用哪个<code>newInstance</code>函数来生成该结点对应的CFG呢？这是由<code>StructuredFlowVisitor</code>决定的。这里稍微提一下<code>StructuredFlowVisitor</code>，它是<code>PHPStructuredFlowVistor</code>的父类：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/21.png" alt="21"></p>
<p><code>StructuredFlowVisitor</code>只处理两种类型的结点，<code>CompoundStatement</code>和其他：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StructuredFlowVisitor</span> <span class="keyword">extends</span> <span class="title">ASTNodeVisitor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> CFG returnCFG;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">getCFG</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> returnCFG;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(CompoundStatement content)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(content);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ASTNode expression)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(expression);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而在<code>PHPStructuredFlowVisitor</code>中，对<code>StructuredFlowVisitor.visit(ASTNode expression)</code>进行了多次重写，进行了更加细致的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPStructuredFlowVisitor</span> <span class="keyword">extends</span> <span class="title">StructuredFlowVisitor</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ParameterList paramList)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(paramList);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ParameterBase param)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(param);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (CFGNode node : returnCFG.getVertices())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (!(node <span class="keyword">instanceof</span> ASTNodeContainer))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			returnCFG.registerParameter(node);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(IfStatementBase node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = PHPCFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Label node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(WhileStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(DoStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ForStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ForEachStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = PHPCFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ReturnStatement expression)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(expression);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(GotoStatement expression)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(expression);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(SwitchStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = PHPCFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ContinueStatement expression)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(expression);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(BreakStatement expression)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(expression);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(TryStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = PHPCFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(ThrowStatement node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		returnCFG = CFGFactory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段的执行流程为：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/20.png" alt="20"></p>
<p><code>id=4, type=AST_STMT_LIST</code>的结点，它有一个<code>id=5, type=AST_IF</code>的子结点，子结点类型为<code>IfStatement</code>，在403行的代码由两部分组成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CFG tmp_CFG = convert(statement);</span><br><span class="line">compoundBlock.appendCFG(tmp_CFG);</span><br></pre></td></tr></table></figure>

<p><code>convert()</code>函数的作用和流程还和之前一样，不一样的地方只是<code>PHPStructuredFlowVistitor.visit</code>会根据传入的结点类型进行不同的处理，目的就是找到正确的<code>PHPCFGFactory.newInstance()</code>来处理结点：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/22.png" alt="22"></p>
<h4 id="PHPCFGFactory-newInstance-IfStatement-ifStatement"><a href="#PHPCFGFactory-newInstance-IfStatement-ifStatement" class="headerlink" title="PHPCFGFactory.newInstance(IfStatement ifStatement)"></a>PHPCFGFactory.newInstance(IfStatement ifStatement)</h4><p>对于类型为<code>IfStatement</code>的结点，对应的<code>PHPCFGFactory.newInstance()</code>为<code>newInstance(IfStatement ifStatement)</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCFGFactory</span> <span class="keyword">extends</span> <span class="title">CFGFactory</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(IfStatementBase ifStatement)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// IfStatementBase是IfStatement的父类</span></span><br><span class="line">			IfStatement phpIfStatement = (IfStatement)ifStatement;</span><br><span class="line">			</span><br><span class="line">            <span class="comment">// IfStatement对应的AST结点属性有type=AST_IF，而其IfStatement.iterator()会返回子结点，也就是AST结点属性为type=AST_IF_ELEM的子结点</span></span><br><span class="line">			Iterator&lt;IfElement&gt; iterator = phpIfStatement.iterator();</span><br><span class="line">			<span class="keyword">if</span>(!iterator.hasNext())</span><br><span class="line">				<span class="keyword">return</span> newErrorInstance();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// type=AST_IF_ELEM的结点是交由convertIfElem来处理的</span></span><br><span class="line">			CFG ifElemCFG = convertIfElem(iterator);</span><br><span class="line">			<span class="keyword">return</span> ifElemCFG;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// e.printStackTrace();</span></span><br><span class="line">			<span class="keyword">return</span> newErrorInstance();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，在关系图中，<code>type=AST_IF</code>的结点会根据分支语句的数量，有对应数量的<code>type=AST_IF_ELEM</code>的子结点，而<code>IfStatement.iterator()</code>会返回<code>type=AST_IF</code>（结点类型为<code>IfStatement</code>）对应个数的子结点，该子结点<code>type=AST_IF_ELEM</code>，类型为<code>IfElement</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/23.png" alt="23"></p>
<p>与普通结点不一样，<code>IfElment</code>结点转化为CFG不是由<code>PHPCFGFactory.convert</code>来处理，而是<code>PHPCFGFactory.convertIfElem</code>来说处理。</p>
<h4 id="PHPCFGFactory-convertIfElem-if-block"><a href="#PHPCFGFactory-convertIfElem-if-block" class="headerlink" title="PHPCFGFactory.convertIfElem: if-block"></a>PHPCFGFactory.convertIfElem: if-block</h4><p>跟入<code>PHPCFGFactory.convertIfElem(Iterator&lt;IfElement&gt; iterator)</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCFGFactory</span> <span class="keyword">extends</span> <span class="title">CFGFactory</span> </span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CFG <span class="title">convertIfElem</span><span class="params">(Iterator&lt;IfElement&gt; iterator)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">// 新建一个仅包含entry node和exit node最小的CFG块</span></span><br><span class="line">		CFG block = <span class="keyword">new</span> CFG();</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 取出IfElement结点</span></span><br><span class="line">		IfElement ifElem = iterator.next();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">		获取下列if条件句</span></span><br><span class="line"><span class="comment">		if (expression) &#123;</span></span><br><span class="line"><span class="comment">			statement1;</span></span><br><span class="line"><span class="comment">		&#125; else &#123;</span></span><br><span class="line"><span class="comment">			statement2;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		中的expression</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Expression condition = ifElem.getCondition();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">		获取下列if条件句</span></span><br><span class="line"><span class="comment">		if (expression) &#123;</span></span><br><span class="line"><span class="comment">			statement1;</span></span><br><span class="line"><span class="comment">		&#125; else &#123;</span></span><br><span class="line"><span class="comment">			statement2;</span></span><br><span class="line"><span class="comment">		&#125;</span></span><br><span class="line"><span class="comment">		中的statement1</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Statement statement = ifElem.getStatement();</span><br><span class="line">        <span class="comment">// 将statement1对应的结点转为CFG</span></span><br><span class="line">		CFG ifBlock = convert(statement);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(condition == <span class="keyword">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// this is the 'else' case</span></span><br><span class="line">            <span class="comment">// [My Annotation]:</span></span><br><span class="line">            <span class="comment">/* condition对应的是下面if else-if</span></span><br><span class="line"><span class="comment">            if (expression1) &#123;</span></span><br><span class="line"><span class="comment">            	statement1;</span></span><br><span class="line"><span class="comment">            &#125; else if (expression2) &#123;</span></span><br><span class="line"><span class="comment">            	statement2;</span></span><br><span class="line"><span class="comment">            &#125; else &#123;</span></span><br><span class="line"><span class="comment">            	statement3;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            中的expression1和expression2</span></span><br><span class="line"><span class="comment">            如果是else block,那自然能就变成了null</span></span><br><span class="line"><span class="comment">            所以是null就说明这是一个else block</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">			<span class="keyword">return</span> ifBlock;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CFGNode conditionContainer = <span class="keyword">new</span> ASTNodeContainer(</span><br><span class="line">				condition);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        CFGFactory.newInstance(ASTNode... nodes)</span></span><br><span class="line"><span class="comment">        public static CFG newInstance(ASTNode... nodes)</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            try</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                CFG block = new CFG();</span></span><br><span class="line"><span class="comment">                CFGNode last = block.getEntryNode();</span></span><br><span class="line"><span class="comment">                for (ASTNode node : nodes)</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                    CFGNode container = new ASTNodeContainer(node);</span></span><br><span class="line"><span class="comment">                    block.addVertex(container);</span></span><br><span class="line"><span class="comment">                    block.addEdge(last, container);</span></span><br><span class="line"><span class="comment">                    last = container;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                block.addEdge(last, block.getExitNode());</span></span><br><span class="line"><span class="comment">                return block;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            catch (Exception e)</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                // e.printStackTrace();</span></span><br><span class="line"><span class="comment">                return newErrorInstance();</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        给某个结点生成CFG的步骤就是</span></span><br><span class="line"><span class="comment">        1. new ASTNodeContainer</span></span><br><span class="line"><span class="comment">        2. addVertex</span></span><br><span class="line"><span class="comment">        3. addEdge</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		block.addVertex(conditionContainer);</span><br><span class="line">		block.addEdge(block.getEntryNode(), conditionContainer);</span><br><span class="line"></span><br><span class="line">		block.mountCFG(conditionContainer, block.getExitNode(), ifBlock,</span><br><span class="line">				CFGEdge.TRUE_LABEL);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(iterator.hasNext())</span><br><span class="line">		&#123;</span><br><span class="line">			CFG elseBlock = convertIfElem(iterator);</span><br><span class="line">			block.mountCFG(conditionContainer, block.getExitNode(),</span><br><span class="line">					elseBlock, CFGEdge.FALSE_LABEL);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			block.addEdge(conditionContainer, block.getExitNode(),</span><br><span class="line">					CFGEdge.FALSE_LABEL);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> block;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ifElem.getCondition()</code>和<code>ifElem.getStatement()</code>分别会获取下面if条件句中的<code>expr</code>和<code>statement</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (expr)</span><br><span class="line">  statement</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应我们的例子为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($firstName))  <span class="comment">// [(7) UnaryOperationExpression] =&gt; 对应 type = AST_IF的node</span></span><br><span class="line">    $name = $firstName;	 <span class="comment">// [(11) ExpressionStatement] =&gt; 对应 type = AST_ASSIGN的node</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    $name = <span class="string">"Guest"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果<code>$name = $firstName;</code>是更复杂一点的复合语句，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$name = $firstName;</span><br><span class="line"><span class="keyword">echo</span> $name;</span><br></pre></td></tr></table></figure>

<p>那么<code>[(11) ExpressionStatment]</code>就会变成<code>CompoundStatement</code>，因为无论是<code>CompoundStatement</code>还是<code>ExpressionStatement</code>都是继承自<code>Statement</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/25.png" alt="25"></p>
<p>接着将该<code>[(11) ExpressionStatement]</code>转变成<code>CFG</code>对象：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/26.png" alt="26"></p>
<p>对应的<code>ifBlock</code>为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(11) ExpressionStatement] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(11) ExpressionStatement] &#123; [(11) ExpressionStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>然后将<code>type=AST_IF</code>的结点也转为CFG对象：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/27.png" alt="27"></p>
<p>对应的<code>block</code>为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(7) UnaryOperationExpression] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(7) UnaryOperationExpression] &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p>接着<code>block</code>块调用<code>CFG.mountCFG()</code>将<code>AST_IF</code>和<code>AST_IF_ELEM</code>等分支结点连接起来：</p>
<blockquote>
<p><code>block</code>：代表<code>AST_IF</code>结点对应的CFG对象</p>
<p><code>conditionContainer</code>：<code>代表AST_IF</code>结点，是一个ASTNode对象</p>
<p><code>ifBlock</code>：代表<code>AST_IF_ELEM</code>（是if分支语句中的一支）结点对应的CFG对象</p>
</blockquote>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/28.png" alt="28"></p>
<h4 id="CFG-mountCFG"><a href="#CFG-mountCFG" class="headerlink" title="CFG.mountCFG"></a>CFG.mountCFG</h4><p>跟入<code>CFG.mountCFG</code>，注意调用该函数的是<code>AST_IF</code>结点对应的CFG对象（下面注释中，我就称其为main if block）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Control Flow Graph. Consider this to be the target format of CFGFactories.</span></span><br><span class="line"><span class="comment"> * Please place language specific attributes of the CFG into a sub-class.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFG</span> <span class="keyword">extends</span> <span class="title">IncidenceListGraph</span>&lt;<span class="title">CFGNode</span>, <span class="title">CFGEdge</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">        </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mountCFG</span><span class="params">(CFGNode branchNode, CFGNode mergeNode, CFG cfg,</span></span></span><br><span class="line"><span class="function"><span class="params">			String label)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (!cfg.isEmpty())</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// 将cfg添加进main if block，但是CFG.addCFG仅仅是将vertex和edge加入，并不会进行连接操作</span></span><br><span class="line">			addCFG(cfg);</span><br><span class="line">			<span class="keyword">for</span> (CFGEdge edge : cfg.outgoingEdges(cfg.getEntryNode()))</span><br><span class="line">			&#123;</span><br><span class="line">				addEdge(branchNode, edge.getDestination(), label);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> (CFGEdge edge : cfg.incomingEdges(cfg.getExitNode()))</span><br><span class="line">			&#123;</span><br><span class="line">				addEdge(edge.getSource(), mergeNode, edge.getLabel());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			addEdge(branchNode, mergeNode, label);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCFG</span><span class="params">(CFG otherCFG)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">// 将othercfg的vertex加入到main if block中</span></span><br><span class="line">		addVertices(otherCFG);</span><br><span class="line">        <span class="comment">// 将othercfg的edge加入到main if block中</span></span><br><span class="line">		addEdges(otherCFG);</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// 将othercfg中的parameter，breakStatement，continueStatement，returnStatement，gotoStatement和lable都加入到main if block中</span></span><br><span class="line">		getParameters().addAll(otherCFG.getParameters());</span><br><span class="line">		getBreakStatements().addAll(otherCFG.getBreakStatements());</span><br><span class="line"> 		getContinueStatements().addAll(otherCFG.getContinueStatements());</span><br><span class="line">		getReturnStatements().addAll(otherCFG.getReturnStatements());</span><br><span class="line">		getGotoStatements().putAll(otherCFG.getGotoStatements());</span><br><span class="line">		getLabels().putAll(otherCFG.getLabels());</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.hasExceptionNode() &amp;&amp; otherCFG.hasExceptionNode())</span><br><span class="line">		&#123;</span><br><span class="line">			CFGExceptionNode oldExceptionNode = getExceptionNode();</span><br><span class="line">			CFGExceptionNode newExceptionNode = <span class="keyword">new</span> CFGExceptionNode();</span><br><span class="line">			setExceptionNode(newExceptionNode);</span><br><span class="line">			addEdge(oldExceptionNode, newExceptionNode,</span><br><span class="line">					CFGEdge.UNHANDLED_EXCEPT_LABEL);</span><br><span class="line">			addEdge(otherCFG.getExceptionNode(), newExceptionNode,</span><br><span class="line">					CFGEdge.UNHANDLED_EXCEPT_LABEL);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (otherCFG.hasExceptionNode())</span><br><span class="line">		&#123;</span><br><span class="line">			setExceptionNode(otherCFG.getExceptionNode());</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEdges</span><span class="params">(CFG cfg)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (CFGNode vertex : cfg.getVertices())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (CFGEdge edge : cfg.outgoingEdges(vertex))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (!(edge.getSource().equals(cfg.getEntryNode())</span><br><span class="line">						|| edge.getDestination().equals(cfg.getExitNode())))</span><br><span class="line">				&#123;</span><br><span class="line">					addEdge(edge);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(CFGNode srcBlock, CFGNode dstBlock)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		addEdge(srcBlock, dstBlock, CFGEdge.EMPTY_LABEL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addEdge</span><span class="params">(CFGNode srcBlock, CFGNode dstBlock, String label)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		CFGEdge edge = <span class="keyword">new</span> CFGEdge(srcBlock, dstBlock, label);</span><br><span class="line">		addEdge(edge);</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/29.png" alt="29"></p>
<p>经过<code>CFG.addCFG()</code>之后，<code>block</code>（即<code>this</code>对象，因为是<code>block</code>对象调用的<code>mountCFG</code>（<code>block.mountCFG()</code>））所代表的<code>AST_IF</code>结点为变成了：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/30.png" alt="30"></p>
<p>然后对<code>block(this)</code>进行连边：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/32.png" alt="32"></p>
<p>它是这样处理的：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/31.png" alt="31"></p>
<p>最后得到的<code>block(this)</code>为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(7) UnaryOperationExpression] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(7) UnaryOperationExpression] &#123; [(7) UnaryOperationExpression] ==[True]==&gt; [(11) ExpressionStatement] , &#125;</span><br><span class="line">[(11) ExpressionStatement] &#123; [(11) ExpressionStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<h4 id="PHPCFGFactory-convertIfElem-else-block"><a href="#PHPCFGFactory-convertIfElem-else-block" class="headerlink" title="PHPCFGFactory.convertIfElem: else-block"></a>PHPCFGFactory.convertIfElem: else-block</h4><p>到上面这一步为止，源码中的下面部分的CFG已经处理了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($firstName)) </span><br><span class="line">    $name = $firstName;</span><br></pre></td></tr></table></figure>

<p>但是还有else部分没有处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">    $name = <span class="string">"Guest"</span>;</span><br></pre></td></tr></table></figure>

<p>我们继续跟下去，else对应的<code>type=AST_IF_ELEM</code>结点的类型为<code>IfElement</code>，id为16。对于该else block，也是通过<code>convertIfElement(iterator)</code>来处理的，所以我们看到在101行，调用了<code>convertIfElem(iterator)</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/33.png" alt="33"></p>
<p>递归跟入<code>convertIfElem()</code>，我们知道elseBlock并没有对应的condition，所以<code>condition</code>对象的值肯定为<code>null</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CFG <span class="title">convertIfElem</span><span class="params">(Iterator&lt;IfElement&gt; iterator)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CFG block = <span class="keyword">new</span> CFG();</span><br><span class="line"></span><br><span class="line">    IfElement ifElem = iterator.next();</span><br><span class="line">    Expression condition = ifElem.getCondition();</span><br><span class="line">    Statement statement = ifElem.getStatement();</span><br><span class="line">    <span class="comment">// 将else block中statement对应的语句转为cfg</span></span><br><span class="line">    CFG ifBlock = convert(statement);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// else 语句对应的condition是null</span></span><br><span class="line">    <span class="keyword">if</span>(condition == <span class="keyword">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// this is the 'else' case</span></span><br><span class="line">        <span class="keyword">return</span> ifBlock;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为<code>condition==null</code>，所以直接将<code>ifBlock</code>返回给<code>elseBlock</code>，然后调用<code>block.mountCFG()</code>将<code>elseBlock</code>拼接到main if block中，并且将边标记为<code>CFGEdge.FalseLabel</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/34.png" alt="34"></p>
<p>经过<code>block.mountCFG()</code>得到的CFG为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(7) UnaryOperationExpression] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(7) UnaryOperationExpression] &#123; [(7) UnaryOperationExpression] ==[True]==&gt; [(11) ExpressionStatement] ,[(7) UnaryOperationExpression] ==[False]==&gt; [(18) ExpressionStatement] , &#125;</span><br><span class="line">[(11) ExpressionStatement] &#123; [(11) ExpressionStatement] ==[]==&gt; [EXIT] , &#125;</span><br><span class="line">[(18) ExpressionStatement] &#123; [(18) ExpressionStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<h4 id="return-to-PHPCFGFactory-newInstance"><a href="#return-to-PHPCFGFactory-newInstance" class="headerlink" title="return to PHPCFGFactory.newInstance"></a>return to PHPCFGFactory.newInstance</h4><p>现在if语句中的主要结点对应的CFG都已经形成了，所以接下来就是进行返回之前的递归调用，可进行收尾处理。</p>
<p>将<code>PHPCFGFactory.convertIfElem(Iterator&lt;IfElement&gt; iterator)</code>的结果返回给<code>PHPCFGFactory.newInstance(IfStatementBase ifStatement)</code>：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/35.png" alt="35"></p>
<p>然后返回到处理<code>id=4</code>的结点（这个结点<code>type=AST_STMT_LIST</code>，是其他<code>AST</code>结点的父亲节点）：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/36.png" alt="36"></p>
<p><code>type=4</code>的结点即<code>compoundBlock</code>对象，它是最小的CFG单位，将if block（<code>[(5) IfStatement]</code>）添加上去后，还有CFG的汇流点，<code>CFG_FUNC_EXIT</code>的父亲结点，<code>[(22) NullNode]</code>需要处理：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/37.png" alt="37"></p>
<p>利用<code>compoundBlock.appendCFG()</code>将<code>[(5) IFStatement]</code>对应的子CFG和<code>[(22) NullNode]</code>对应的子CFG加入后，得到的CFG结构为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(7) UnaryOperationExpression] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(7) UnaryOperationExpression] &#123; [(7) UnaryOperationExpression] ==[True]==&gt; [(11) ExpressionStatement] ,[(7) UnaryOperationExpression] ==[False]==&gt; [(18) ExpressionStatement] , &#125;</span><br><span class="line">[(11) ExpressionStatement] &#123; [(11) ExpressionStatement] ==[]==&gt; [(22) NullNode] , &#125;</span><br><span class="line">[(18) ExpressionStatement] &#123; [(18) ExpressionStatement] ==[]==&gt; [(22) NullNode] , &#125;</span><br><span class="line">[(22) NullNode] &#123; [(22) NullNode] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>到这一步，<strong>functionBody</strong>，也就是函数体的内容语句部分对应的CFG就已经生成了：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/38.png" alt="38"></p>
<p>然后后面还需要处理函数的parameter，因为此次解析的代码并不是函数式的，所以<code>parameterBlock</code>其实也是仅包含enrty node和exit node的最小的CFG块，然后将<code>functionBody</code>加到<code>parameterBlock</code>上，最后将<code>parameterBlock</code>用同样的方式添加到CFG起始块<code>function</code>上。</p>
<p>最后，还需要为entry node和exit node分配id，并将它们的类型转为对应的<code>CFGEntryNode</code>和<code>CFGExitNode</code>（这两个类型都是继承自<code>CFGNode</code>），这样，cfg就生成了。</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/39.png" alt="39"></p>
<p>现在得到的cfg为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[(2) ENTRY] &#123; [(2) ENTRY] ==[]==&gt; [(7) UnaryOperationExpression] , &#125;</span><br><span class="line">[(3) EXIT] &#123;  &#125;</span><br><span class="line">[(7) UnaryOperationExpression] &#123; [(7) UnaryOperationExpression] ==[True]==&gt; [(11) ExpressionStatement] ,[(7) UnaryOperationExpression] ==[False]==&gt; [(18) ExpressionStatement] , &#125;</span><br><span class="line">[(11) ExpressionStatement] &#123; [(11) ExpressionStatement] ==[]==&gt; [(22) NullNode] , &#125;</span><br><span class="line">[(18) ExpressionStatement] &#123; [(18) ExpressionStatement] ==[]==&gt; [(22) NullNode] , &#125;</span><br><span class="line">[(22) NullNode] &#123; [(22) NullNode] ==[]==&gt; [(3) EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>最后就是调用<code>csvCFGExporter.writeCFGEdges(cfg)</code>将生成的cfg写入到<code>cfg_edges.csv</code>中：<br><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/40.png" alt="40"></p>
<h3 id="CFG生成小结"><a href="#CFG生成小结" class="headerlink" title="CFG生成小结"></a>CFG生成小结</h3><p>从上面的分析流程，其实我们可以看出在生成CFG的过程中，是通过<strong>前序遍历</strong>的方式来访问每一个AST结点，并将符合要求的结点转为<code>CFGNode</code>对象，添加到CFG中。</p>
<p>画一个比较粗略的执行流程：</p>
<p><img src="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/if-CFG_generate.svg" alt="if-CFG_generate"></p>
<h2 id="后续问题"><a href="#后续问题" class="headerlink" title="后续问题"></a>后续问题</h2><p>当然这是最简单的if条件语句，在很多情况下，if条件句可能会被其他运算符替代，比如php中唯一的<strong>三元运算符</strong><code>?:</code>和<strong>null合并运算符</strong><code>??</code>。</p>
<h3 id="三元运算符"><a href="#三元运算符" class="headerlink" title="三元运算符 ?:"></a>三元运算符 ?:</h3><p>三元运算符可以用一行代码进行逻辑判断，从而代替常见的if-else变量赋值判断。</p>
<h3 id="null合并运算符"><a href="#null合并运算符" class="headerlink" title="null合并运算符 ??"></a>null合并运算符 ??</h3><p>null合并运算符又称为<strong>空值合并运算符</strong>，它是用于执行isset()检测的三元运算符的快捷方式。NULL 合并运算符会判断变量是否存在且值不为NULL，如果是，它就会返回自身的值，否则返回它的第二个操作数。 </p>
<p>这两种特殊的条件语句，它们生成的CPG，其实我们可以猜到，因为缺少if关键字，所以如果joern没有对其进行特殊的处理，是非常有可能无法生成正确的CPG的。这个在后续的学习中会进行测试。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://bantttian.github.io/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/">https://bantttian.github.io/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"># PHP程序分析</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/04/17/DataFlowAnalysis%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E4%B9%8BReachingDefinitions/">DataFlowAnalysis原理学习之ReachingDefinitions</a>
            
            
            <a class="next" rel="next" href="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/">Joern源码阅读之switch语句CFG生成</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
