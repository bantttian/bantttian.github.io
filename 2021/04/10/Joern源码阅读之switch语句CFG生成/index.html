<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>Joern源码阅读之switch语句CFG生成 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Joern源码阅读之switch语句CFG生成</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-04-10&nbsp;&nbsp;15:16:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Joern在解析php源码时，会先生成Control Flow Graph，然后生成UDG（一个过渡Graph），接着生成Data Dependency Graph，最后处理Call Graph。现在就先来学习下Jeorn是怎么生成Control Flow Graph的。</p>
<h2 id="Switch-Demo"><a href="#Switch-Demo" class="headerlink" title="Switch Demo"></a>Switch Demo</h2><p>官方手册：<a href="https://www.php.net/manual/zh/control-structures.switch.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/control-structures.switch.php</a></p>
<p>利用Joern生成下面switch语句的CPG代码属性图：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">switch</span> ($i) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"apple"</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"i is apple"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"bar"</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"i is bar"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"cake"</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"i is cake"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的CPG图，下图中蓝色AST结点中的数字是lineno：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/1.png" alt="1"></p>
<p>而下图蓝色AST结点中的数字代表的则是id：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/0.png" alt="0"></p>
<p>其中不存在PDG图，也就是数据流图，没有<code>REACHES</code>关系边。从中抽出CFG图为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/2.png" alt="2"></p>
<h4 id="nodes-csv"><a href="#nodes-csv" class="headerlink" title="nodes.csv"></a>nodes.csv</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ cat nodes.csv </span><br><span class="line">id:int	labels:label	type	flags:string_array	lineno:int	code	childnum:int	funcid:int	classname	namespace	endlineno:int	name	doccomment</span><br><span class="line">0	Filesystem	File							&quot;a.php&quot;	</span><br><span class="line">1	AST	AST_TOPLEVEL	TOPLEVEL_FILE	1				&quot;&quot;	13	&quot;a.php&quot;	</span><br><span class="line">2	Artificial	CFG_FUNC_ENTRY					1	&quot;a.php&quot;	</span><br><span class="line">3	Artificial	CFG_FUNC_EXIT					1	&quot;a.php&quot;	</span><br><span class="line">4	AST	AST_STMT_LIST		1		0	1		&quot;&quot;			</span><br><span class="line">5	AST	AST_SWITCH		2		0	1		&quot;&quot;			</span><br><span class="line">6	AST	AST_VAR		2		0	1		&quot;&quot;	</span><br><span class="line">7	AST	string		2	&quot;i&quot;	0	1		&quot;&quot;	</span><br><span class="line">8	AST	AST_SWITCH_LIST		3		1	1		&quot;&quot;			</span><br><span class="line">9	AST	AST_SWITCH_CASE		3		0	1		&quot;&quot;			</span><br><span class="line">10	AST	string		3	&quot;apple&quot;	0	1		&quot;&quot;	</span><br><span class="line">11	AST	AST_STMT_LIST		3		1	1		&quot;&quot;			</span><br><span class="line">12	AST	AST_ECHO		4		0	1		&quot;&quot;			</span><br><span class="line">13	AST	string		4	&quot;i is apple&quot;	0	1		&quot;&quot;			</span><br><span class="line">14	AST	AST_BREAK		5		1	1		&quot;&quot;			</span><br><span class="line">15	AST	NULL		5		0	1		&quot;&quot;	</span><br><span class="line">16	AST	AST_SWITCH_CASE		6		1	1		&quot;&quot;			</span><br><span class="line">17	AST	string		6	&quot;bar&quot;	0	1		&quot;&quot;	</span><br><span class="line">18	AST	AST_STMT_LIST		6		1	1		&quot;&quot;			</span><br><span class="line">19	AST	AST_ECHO		7		0	1		&quot;&quot;			</span><br><span class="line">20	AST	string		7	&quot;i is bar&quot;	0	1		&quot;&quot;			</span><br><span class="line">21	AST	AST_BREAK		8		1	1		&quot;&quot;			</span><br><span class="line">22	AST	NULL		8		0	1		&quot;&quot;	</span><br><span class="line">23	AST	AST_SWITCH_CASE		9		2	1		&quot;&quot;			</span><br><span class="line">24	AST	string		9	&quot;cake&quot;	0	1		&quot;&quot;	</span><br><span class="line">25	AST	AST_STMT_LIST		9		1	1		&quot;&quot;			</span><br><span class="line">26	AST	AST_ECHO		10		0	1		&quot;&quot;			</span><br><span class="line">27	AST	string		10	&quot;i is cake&quot;	0	1		&quot;&quot;			</span><br><span class="line">28	AST	AST_BREAK		11		1	1		&quot;&quot;			</span><br><span class="line">29	AST	NULL		11		0	1		&quot;&quot;	</span><br><span class="line">30	AST	NULL		1		1	1		&quot;&quot;</span><br></pre></td></tr></table></figure>

<p>附上更清晰的图片：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/3.png" alt="3"></p>
<h4 id="rels-csv"><a href="#rels-csv" class="headerlink" title="rels.csv"></a>rels.csv</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ cat rels.csv </span><br><span class="line">start	end	type</span><br><span class="line">1	2	ENTRY</span><br><span class="line">1	3	EXIT</span><br><span class="line">6	7	PARENT_OF</span><br><span class="line">5	6	PARENT_OF</span><br><span class="line">9	10	PARENT_OF</span><br><span class="line">12	13	PARENT_OF</span><br><span class="line">11	12	PARENT_OF</span><br><span class="line">14	15	PARENT_OF</span><br><span class="line">11	14	PARENT_OF</span><br><span class="line">9	11	PARENT_OF</span><br><span class="line">8	9	PARENT_OF</span><br><span class="line">16	17	PARENT_OF</span><br><span class="line">19	20	PARENT_OF</span><br><span class="line">18	19	PARENT_OF</span><br><span class="line">21	22	PARENT_OF</span><br><span class="line">18	21	PARENT_OF</span><br><span class="line">16	18	PARENT_OF</span><br><span class="line">8	16	PARENT_OF</span><br><span class="line">23	24	PARENT_OF</span><br><span class="line">26	27	PARENT_OF</span><br><span class="line">25	26	PARENT_OF</span><br><span class="line">28	29	PARENT_OF</span><br><span class="line">25	28	PARENT_OF</span><br><span class="line">23	25	PARENT_OF</span><br><span class="line">8	23	PARENT_OF</span><br><span class="line">5	8	PARENT_OF</span><br><span class="line">4	5	PARENT_OF</span><br><span class="line">4	30	PARENT_OF</span><br><span class="line">1	4	PARENT_OF</span><br><span class="line">0	1	FILE_OF</span><br></pre></td></tr></table></figure>

<h4 id="cpg-edges-csv"><a href="#cpg-edges-csv" class="headerlink" title="cpg_edges.csv"></a>cpg_edges.csv</h4><p>输入<code>nodes.csv</code>文件和<code>rel.csv</code>文件，最后输出的文件<code>cpg_edges.csv</code>内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">start	end	type	var</span><br><span class="line">2	6	FLOWS_TO	</span><br><span class="line">6	12	FLOWS_TO	</span><br><span class="line">6	19	FLOWS_TO	</span><br><span class="line">6	26	FLOWS_TO	</span><br><span class="line">6	30	FLOWS_TO	</span><br><span class="line">12	14	FLOWS_TO	</span><br><span class="line">14	30	FLOWS_TO	</span><br><span class="line">19	21	FLOWS_TO	</span><br><span class="line">21	30	FLOWS_TO	</span><br><span class="line">26	28	FLOWS_TO	</span><br><span class="line">28	30	FLOWS_TO	</span><br><span class="line">30	3	FLOWS_TO</span><br></pre></td></tr></table></figure>

<p>生成的edges.csv中只有控制流上的关系。</p>
<h2 id="Joern源码分析"><a href="#Joern源码分析" class="headerlink" title="Joern源码分析"></a>Joern源码分析</h2><h3 id="CFG生成入口"><a href="#CFG生成入口" class="headerlink" title="CFG生成入口"></a>CFG生成入口</h3><p>下面是Joern在生成PHP代码属性图时的入口函数Main函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tools.php.ast2cpg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.cli.ParseException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast.php.functionDef.FunctionDef;</span><br><span class="line"><span class="keyword">import</span> cfg.ASTToCFGConverter;</span><br><span class="line"><span class="keyword">import</span> cfg.CFG;</span><br><span class="line"><span class="keyword">import</span> cfg.PHPCFGFactory;</span><br><span class="line"><span class="keyword">import</span> cg.CG;</span><br><span class="line"><span class="keyword">import</span> cg.PHPCGFactory;</span><br><span class="line"><span class="keyword">import</span> ddg.CFGAndUDGToDefUseCFG;</span><br><span class="line"><span class="keyword">import</span> ddg.DDGCreator;</span><br><span class="line"><span class="keyword">import</span> ddg.DataDependenceGraph.DDG;</span><br><span class="line"><span class="keyword">import</span> ddg.DefUseCFG.DefUseCFG;</span><br><span class="line"><span class="keyword">import</span> inputModules.csv.KeyedCSV.exceptions.InvalidCSVFile;</span><br><span class="line"><span class="keyword">import</span> inputModules.csv.csvFuncExtractor.CSVFunctionExtractor;</span><br><span class="line"><span class="keyword">import</span> outputModules.common.Writer;</span><br><span class="line"><span class="keyword">import</span> outputModules.csv.MultiPairCSVWriterImpl;</span><br><span class="line"><span class="keyword">import</span> outputModules.csv.exporters.CSVCFGExporter;</span><br><span class="line"><span class="keyword">import</span> outputModules.csv.exporters.CSVCGExporter;</span><br><span class="line"><span class="keyword">import</span> outputModules.csv.exporters.CSVDDGExporter;</span><br><span class="line"><span class="keyword">import</span> udg.CFGToUDGConverter;</span><br><span class="line"><span class="keyword">import</span> udg.php.useDefAnalysis.PHPASTDefUseAnalyzer;</span><br><span class="line"><span class="keyword">import</span> udg.useDefGraph.UseDefGraph;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// command line interface</span></span><br><span class="line">	<span class="keyword">static</span> CommandLineInterface cmdLine = <span class="keyword">new</span> CommandLineInterface();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// converters</span></span><br><span class="line">	<span class="keyword">static</span> CSVFunctionExtractor extractor = <span class="keyword">new</span> CSVFunctionExtractor();</span><br><span class="line">	<span class="comment">//static PHPCFGFactory cfgFactory = new PHPCFGFactory();</span></span><br><span class="line">	<span class="keyword">static</span> ASTToCFGConverter ast2cfgConverter = <span class="keyword">new</span> ASTToCFGConverter();</span><br><span class="line">	<span class="keyword">static</span> CFGToUDGConverter cfgToUDG = <span class="keyword">new</span> CFGToUDGConverter();</span><br><span class="line">	<span class="keyword">static</span> CFGAndUDGToDefUseCFG udgAndCfgToDefUseCFG = <span class="keyword">new</span> CFGAndUDGToDefUseCFG();</span><br><span class="line">	<span class="keyword">static</span> DDGCreator ddgCreator = <span class="keyword">new</span> DDGCreator();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// exporters</span></span><br><span class="line">	<span class="keyword">static</span> CSVCFGExporter csvCFGExporter = <span class="keyword">new</span> CSVCFGExporter();</span><br><span class="line">	<span class="keyword">static</span> CSVDDGExporter csvDDGExporter = <span class="keyword">new</span> CSVDDGExporter();</span><br><span class="line">	<span class="keyword">static</span> CSVCGExporter csvCGExporter = <span class="keyword">new</span> CSVCGExporter();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvalidCSVFile, IOException </span>&#123;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">// parse command line</span></span><br><span class="line">        <span class="comment">// [My Annotation]: 读取命令行参数</span></span><br><span class="line">		parseCommandLine(args);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// initialize readers</span></span><br><span class="line">		String nodeFilename = cmdLine.getNodeFile();</span><br><span class="line">		String edgeFilename = cmdLine.getEdgeFile();</span><br><span class="line">		FileReader nodeFileReader = <span class="keyword">new</span> FileReader(nodeFilename);</span><br><span class="line">		FileReader edgeFileReader = <span class="keyword">new</span> FileReader(edgeFilename);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// initialize converters</span></span><br><span class="line"></span><br><span class="line">		extractor.setInterpreters(<span class="keyword">new</span> PHPCSVNodeInterpreter(), <span class="keyword">new</span> PHPCSVEdgeInterpreter());</span><br><span class="line"></span><br><span class="line">		extractor.initialize(nodeFileReader, edgeFileReader);</span><br><span class="line">		ast2cfgConverter.setFactory(<span class="keyword">new</span> PHPCFGFactory());</span><br><span class="line">		cfgToUDG.setASTDefUseAnalyzer(<span class="keyword">new</span> PHPASTDefUseAnalyzer());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// initialize writers</span></span><br><span class="line">		MultiPairCSVWriterImpl csvWriter = <span class="keyword">new</span> MultiPairCSVWriterImpl();</span><br><span class="line">		csvWriter.openEdgeFile( <span class="string">"."</span>, <span class="string">"cpg_edges.csv"</span>);</span><br><span class="line">		Writer.setWriterImpl( csvWriter);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// let's go...</span></span><br><span class="line">		FunctionDef rootnode;</span><br><span class="line">		<span class="keyword">while</span> ((rootnode = (FunctionDef)extractor.getNextFunction()) != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">			PHPCGFactory.addFunctionDef( rootnode);</span><br><span class="line">			</span><br><span class="line">			CFG cfg = ast2cfgConverter.convert(rootnode);</span><br><span class="line">			csvCFGExporter.writeCFGEdges(cfg);</span><br><span class="line"></span><br><span class="line">			UseDefGraph udg = cfgToUDG.convert(cfg);</span><br><span class="line">			DefUseCFG defUseCFG = udgAndCfgToDefUseCFG.convert(cfg, udg);</span><br><span class="line">			DDG ddg = ddgCreator.createForDefUseCFG(defUseCFG);</span><br><span class="line">			csvDDGExporter.writeDDGEdges(ddg);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// now that we wrapped up all functions, let's finish off with the call graph</span></span><br><span class="line">		CG cg = PHPCGFactory.newInstance();</span><br><span class="line">		csvCGExporter.writeCGEdges(cg);</span><br><span class="line"></span><br><span class="line">		csvWriter.closeEdgeFile();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseCommandLine</span><span class="params">(String[] args)</span>	</span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			cmdLine.parseCommandLine(args);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException | ParseException e) &#123;</span><br><span class="line">			printHelpAndTerminate(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printHelpAndTerminate</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		System.err.println(e.getMessage());</span><br><span class="line">		cmdLine.printHelp();</span><br><span class="line">		System.exit(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中第37行的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ASTToCFGConverter ast2cfgConverter = <span class="keyword">new</span> ASTToCFGConverter();</span><br></pre></td></tr></table></figure>

<p>和第64行的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ast2cfgConverter.setFactory(<span class="keyword">new</span> PHPCFGFactory());</span><br></pre></td></tr></table></figure>

<p>以及76行至79行的CFG处理流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHPCGFactory.addFunctionDef( rootnode);</span><br><span class="line"></span><br><span class="line">CFG cfg = ast2cfgConverter.convert(rootnode);</span><br><span class="line">csvCFGExporter.writeCFGEdges(cfg);</span><br></pre></td></tr></table></figure>

<p>若上面代码没有行号，可以看下图：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/4.png" alt="4"></p>
<h3 id="CFGFactory初始化"><a href="#CFGFactory初始化" class="headerlink" title="CFGFactory初始化"></a>CFGFactory初始化</h3><p>在整个CFG解析过程中，从<code>ASTToCFGConverter</code>类开始，将AST对象转成CFG对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast.functionDef.FunctionDefBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASTToCFGConverter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> CFGFactory factory;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFactory</span><span class="params">(CFGFactory factory)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// prior to converting a function node,</span></span><br><span class="line">		<span class="comment">// this method should be used to set the</span></span><br><span class="line">		<span class="comment">// CFG factory for a particular language,</span></span><br><span class="line">		<span class="comment">// such as a C CFG factory or a PHP CFG factory.</span></span><br><span class="line">		<span class="comment">// [My Annotation]: 为某种语言设置特定的factory，比如php就设置为PHPCFGFactory</span></span><br><span class="line">		<span class="keyword">this</span>.factory = factory;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">convert</span><span class="params">(FunctionDefBase node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">// [My Annotation]: 调用PHPCFGFactory.newInstance来生成一个CFG对象</span></span><br><span class="line">		<span class="keyword">return</span> factory.newInstance(node);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/6.png" alt="6"></p>
<p>在从根节点构建CFG图之前，首先确定使用的CFGFactory为<code>PHPCFGFactory</code>。<code>PHPCFGFactory</code>类继承自<strong>jpanlib</strong>中的父类<code>CFGFactory</code>，它是<strong>joern-php</strong>中<code>PHPCFGFactory</code>的基类，同时也是<strong>joern-fuzzyc</strong>中<code>CCFGFactory</code>的基类。前者是生成php源码CFG的，后者是用来生成fuzzy-c源码CFG的。</p>
<blockquote>
<p><code>CFGFactory</code>：joern/projects/extensions/joern-fuzzyc/src/main/java/cfg/CCFGFactory.java</p>
<p><code>PHPCFGFactory</code>：joern/projects/extensions/joern-php/src/main/java/cfg/PHPCFGFactory.java</p>
<p><code>CCFGFactory</code>：joern/projects/extensions/joern-fuzzyc/src/main/java/cfg/CCFGFactory.java</p>
</blockquote>
<p>它们之间的继承关系如下图所示：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/7.png" alt="7"></p>
<h3 id="CFG根节点"><a href="#CFG根节点" class="headerlink" title="CFG根节点"></a>CFG根节点</h3><p>结点类型为<code>TOPLevelFUnctionDef</code>，是<code>ASTNode</code>类型的结点中特殊的结点之一。<strong>整个过程是比较比复杂的，所以我打算在另一篇文章中再阐述。</strong></p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/8.png" alt="8"></p>
<p>跟进<code>PHPCFGFactory.addFunctionDef()</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/9.png" alt="9"></p>
<p>直接返回null。</p>
<h3 id="CFG对象实例化"><a href="#CFG对象实例化" class="headerlink" title="CFG对象实例化"></a>CFG对象实例化</h3><p>Control Flow Graph显式地描述了执行代码语句的顺序，以及执行特定执行路径所需要满足的条件。因此，statements和predicates都应该用结点来表示，并且这些结点需要由有向边连接来表示控制流的传递。<strong>CFG可以由抽象语法树转化而来</strong>。首先，考虑结构化控制语句（constructed control statements），例如，<code>if</code>，<code>while</code>，<code>for</code>等等来初步构建控制流图。然后，再考虑像<code>goto</code>，<code>break</code>，<code>continue</code>之类的非结构化控制语句（unstructured control statements）来修正初步控制流程图。（来自<strong>S&amp;P’14, Modeling and Discovering Vulnerabilities with Code Property Graphs</strong>，本文的研究成果就是joern工具）</p>
<blockquote>
<p>这里用一张思维导图稍微补充一下流程控制语句中的结构化语句和非结构化语句</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/13.png" alt="13"></p>
<p>参考<a href="https://blog.csdn.net/u010785142/article/details/47304113" target="_blank" rel="noopener">C语言5种程序语句（1）——流程控制语句中的结构化语句（条件语句和循环语句）</a></p>
</blockquote>
<p>在第77行，使用<code>ASTToCFGConverter</code>类的实例化对象<code>ast2cfgConverter</code>，从每个function definition node开始，一步一步生成CFG图：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/10.png" alt="10"></p>
<p>跟进<code>ASTToCFGConverter.convert()</code>（注意区分和后面<code>CFGFactory.convert()</code>函数之间的区别），调用<code>factory</code>对象的<code>newInstance()</code>方法，该<code>factory</code>已经被初始化为<code>PHPCFGFactory</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/11.png" alt="11"></p>
<h4 id="Class：FunctionDefBase"><a href="#Class：FunctionDefBase" class="headerlink" title="Class：FunctionDefBase"></a>Class：FunctionDefBase</h4><p><strong>FunctionDefBase</strong>是<strong>FunctionDef</strong>的父类，但是无论是父类还是子类，它们都是一种<strong>ASTNode</strong>，继承关系为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/59.png" alt="59"></p>
<p><code>FunctionDefBase</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ast.functionDef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast.ASTNode;</span><br><span class="line"><span class="keyword">import</span> ast.logical.statements.CompoundStatement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FunctionDefBase</span> <span class="keyword">extends</span> <span class="title">ASTNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> ParameterList parameterList = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">protected</span> CompoundStatement content = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">getFunctionSignature</span><span class="params">()</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ParameterList <span class="title">getParameterList</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.parameterList;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameterList</span><span class="params">(ParameterList parameterList)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.parameterList = parameterList;</span><br><span class="line">		<span class="keyword">super</span>.addChild(parameterList);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> CompoundStatement <span class="title">getContent</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.content;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getEscapedCodeStr</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		setCodeStr(getFunctionSignature());</span><br><span class="line">		<span class="keyword">return</span> getCodeStr();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(CompoundStatement content)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.content = content;</span><br><span class="line">		<span class="keyword">super</span>.addChild(content);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>FunctionDefBase有两个protected成员变量，<code>ParameterList</code>和<code>CompoundStatement</code>。<strong>CompoundStatement</strong>是什么呢？它定义在：</p>
<blockquote>
<p>joern/projects/extensions/jpanlib/src/main/java/ast/logical/statements/CompoundStatement.java</p>
</blockquote>
<p>继承自类<code>Statement</code>，也是一种ASTNode结点。继承关系如下图所示：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/26.png" alt="26"></p>
<p>CompoundStatement是一种比较特殊的Statement类型，是一种复合类型的statement，比如一个for循环，其内部所有的语句，我们都可以将其认为是<code>CompoundStatement</code>。</p>
<p>至于<code>ParameterList</code>，我猜测是这样的，比如有一个函数，它有一些参数，<code>ParameterList</code>中就会维护这些参数。当然这个case中没有体现出这些，是我的猜测，比如一个函数为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">($a, $b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $c = $a + $b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那该FunctionDefBase对象对应的<code>parameterList</code>为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/60.png" alt="60"></p>
<h4 id="PHPCFGFactory-newInstace"><a href="#PHPCFGFactory-newInstace" class="headerlink" title="PHPCFGFactory.newInstace"></a>PHPCFGFactory.newInstace</h4><p>回到前面的执行路径，继续跟踪，又了调用<code>PHPCFGFactory.newInstance(node)</code>。我们可以看到在<code>PHPCFGFactory</code>中，存在很多<code>newInstance()</code>同名函数，因为不同语句的结构存在差别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCFGFactory</span> <span class="keyword">extends</span> <span class="title">CFGFactory</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// node id offsets for entry and exit nodes of function definitions</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CFG_ENTRY_OFFSET = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CFG_EXIT_OFFSET = <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		structuredFlowVisitior = <span class="keyword">new</span> PHPStructuredFlowVisitor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PHPCFGFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		structuredFlowVisitior = <span class="keyword">new</span> PHPStructuredFlowVisitor();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 处理FunctionDef node结点</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span> </span>&#123; ... &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 处理if条件语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(IfStatementBase ifStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理if条件句内的元素结点</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CFG <span class="title">convertIfElem</span><span class="params">(Iterator&lt;IfElement&gt; iterator)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理switch语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(SwitchStatement switchStatement)</span> </span>&#123; ... &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 处理foreach语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ForEachStatement forEachStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理try...catch语句</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(TryStatement tryStatement)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是我们很容易发现，还有一些语句，比如<code>while</code>，<code>for</code>，<code>break</code>语句都没有出现，它们则是在<code>PHPCFGFactory</code>的父类<code>CFGFactory</code>中被定义，像源码中的break语句就是交由<code>newInstance(BreakStatement breakStatement)</code>来处理的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFGFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> StructuredFlowVisitor structuredFlowVisitior;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ASTNode... nodes)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newErrorInstance</span><span class="params">()</span> n</span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(WhileStatement whileStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ForStatement forStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(DoStatement doStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(TryStatement tryStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(SwitchStatement switchStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ParameterList paramList)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(CompoundStatement content)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ReturnStatement returnStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(GotoStatement gotoStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(Label labelStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ContinueStatement continueStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(BreakStatement breakStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ThrowStatement throwStatement)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">convert</span><span class="params">(ASTNode node)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixBreakStatements</span><span class="params">(CFG thisCFG, CFGNode target)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixContinueStatement</span><span class="params">(CFG thisCFG, CFGNode target)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixBreakOrContinueStatements</span><span class="params">(CFG thisCFG, CFGNode target, Iterator&lt;CFGNode&gt; it)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixGotoStatements</span><span class="params">(CFG thisCFG)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixReturnStatements</span><span class="params">(CFG thisCFG)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进该函数<code>CFGFactory.newInstance(FunctionDefBase functionDefinition)</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCFGFactory</span> <span class="keyword">extends</span> <span class="title">CFGFactory</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// node id offsets for entry and exit nodes of function definitions</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CFG_ENTRY_OFFSET = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CFG_EXIT_OFFSET = <span class="number">2</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		structuredFlowVisitior = <span class="keyword">new</span> PHPStructuredFlowVisitor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PHPCFGFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		structuredFlowVisitior = <span class="keyword">new</span> PHPStructuredFlowVisitor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		CFG cfg = <span class="keyword">super</span>.newInstance(functionDefinition);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// for PHP, we additionally set the node ids for the function entry and exit nodes:</span></span><br><span class="line">		<span class="comment">// their ids match the ids of the entry and exit nodes output by the PHP AST parser</span></span><br><span class="line">		Long id = functionDefinition.getNodeId();	<span class="comment">// 一般是1</span></span><br><span class="line">        <span class="comment">// 分别为entry node和exit node设置id，并且将类型分别转为特殊的CFGEntryNode和CFGExitNode</span></span><br><span class="line">		((CFGEntryNode)cfg.getEntryNode()).setNodeId( id + CFG_ENTRY_OFFSET);</span><br><span class="line">		((CFGExitNode)cfg.getExitNode()).setNodeId( id + CFG_EXIT_OFFSET);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> cfg;</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PHPCFGFactory.newInstance(FUnctionDefBase functionDefinition)</code>重写了父类<code>CFGFactory</code>的<code>newInstance(FunctionDefBase functionDefinition)</code>方法。先调用父类的方法，即<code>super.newInstance()</code>来生成初步的CFG。</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/12.png" alt="12"></p>
<h4 id="CFGFactory-newInstance"><a href="#CFGFactory-newInstance" class="headerlink" title="CFGFactory.newInstance"></a>CFGFactory.newInstance</h4><p>看下<code>CFGFactory.newInstance(FunctionDefBase functionDefinition)</code>是如何初始化并且构建一个CFG图的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFGFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> StructuredFlowVisitor structuredFlowVisitior;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> CFG <span class="title">newInstance</span><span class="params">(FunctionDefBase functionDefinition)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		&#123;</span><br><span class="line">			CFG function = newInstance();</span><br><span class="line">			CFG parameterBlock = convert(</span><br><span class="line">					functionDefinition.getParameterList());</span><br><span class="line">			CFG functionBody = convert(functionDefinition.getContent());</span><br><span class="line">			parameterBlock.appendCFG(functionBody);</span><br><span class="line">			function.appendCFG(parameterBlock);</span><br><span class="line">			fixGotoStatements(function);</span><br><span class="line">			fixReturnStatements(function);</span><br><span class="line">			<span class="keyword">if</span> (!function.getBreakStatements().isEmpty())</span><br><span class="line">			&#123;</span><br><span class="line">				System.err.println(<span class="string">"warning: unresolved break statement"</span>);</span><br><span class="line">				fixBreakStatements(function, function.getErrorNode());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (!function.getContinueStatements().isEmpty())</span><br><span class="line">			&#123;</span><br><span class="line">				System.err.println(<span class="string">"warning: unresolved continue statement"</span>);</span><br><span class="line">				fixContinueStatement(function, function.getErrorNode());</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (function.hasExceptionNode())</span><br><span class="line">			&#123;</span><br><span class="line">				function.addEdge(function.getExceptionNode(),</span><br><span class="line">						function.getExitNode(), CFGEdge.UNHANDLED_EXCEPT_LABEL);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> function;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// e.printStackTrace();</span></span><br><span class="line">			<span class="keyword">return</span> newErrorInstance();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，先创建一个CFG块，将其赋给<code>function</code>变量，它是一个最小单位的CFG图，仅仅由entry node和exit node组成，一般表示为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] &#x3D;&#x3D;[]&#x3D;&#x3D;&gt; [EXIT] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p>其中这里的<code>function</code>最后会变成cpg图中类型为<code>AST_FUNC_DECL</code>或是<code>AST_TOPLEVEL</code>之类的结点，如果它的类型是<code>AST_TOPLEVEL</code>，那么它的id是1，它的类型在<strong>PHPCSVNodeTypes</strong>类中有定义，有4种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVNodeTypes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// declaration nodes</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_TOPLEVEL = <span class="string">"AST_TOPLEVEL"</span>; <span class="comment">// artificial</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_FUNC_DECL = <span class="string">"AST_FUNC_DECL"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_METHOD = <span class="string">"AST_METHOD"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_CLOSURE = <span class="string">"AST_CLOSURE"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/14.png" alt="14"></p>
<p>跟入无参的<code>newInstance()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFGFactory</span></span></span><br><span class="line"><span class="class"></span>&#123;	</span><br><span class="line">    <span class="comment">// ASTNode... nodes是自从Java5之后新增的对方法参数支持的一种新写法，叫可变长度参数列标，类型后面跟...表示此处接受的参数为0到n个Object类型的对象，或者是一个Object[]</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(ASTNode... nodes)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">try</span></span><br><span class="line">		&#123;</span><br><span class="line">			CFG block = <span class="keyword">new</span> CFG();</span><br><span class="line">			CFGNode last = block.getEntryNode();</span><br><span class="line">			<span class="keyword">for</span> (ASTNode node : nodes)</span><br><span class="line">			&#123;</span><br><span class="line">				CFGNode container = <span class="keyword">new</span> ASTNodeContainer(node);</span><br><span class="line">				block.addVertex(container);</span><br><span class="line">				block.addEdge(last, container);</span><br><span class="line">				last = container;</span><br><span class="line">			&#125;</span><br><span class="line">			block.addEdge(last, block.getExitNode());</span><br><span class="line">			<span class="keyword">return</span> block;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception e)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// e.printStackTrace();</span></span><br><span class="line">			<span class="keyword">return</span> newErrorInstance();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先初始化一个CFG block，然后获取该控制流块的entrynode和exitnode，形成一个仅有<code>[Entry] ==[]==&gt; [Exit]</code>的初始CFG block：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/16.png" alt="16"></p>
<h4 id="Class：CFG"><a href="#Class：CFG" class="headerlink" title="Class：CFG"></a>Class：CFG</h4><p>跟入<strong>CFG类</strong>的构造函数<code>CFG()</code>：<br><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/17.png" alt="17"></p>
<p>先稍微介绍下CFG类，位于基础类库<strong>jpanlib/</strong>目录下，具体位置为<code>joern/projects/extensions/jpanlib/src/main/java/cfg/CFG.java</code>。</p>
<p>文件中存在注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Control Flow Graph. Consider this to be the target format of CFGFactories.</span></span><br><span class="line"><span class="comment"> * Please place language specific attributes of the CFG into a sub-class.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>说明CFG图就是CFGFactory的目标格式。</p>
<p>CFG类继承自<code>joern/projects/extensions/jpanlib/src/main/java/graphutils/IncidenceListGraph.java</code>中的<code>IncidenceListGraph</code>类，源码中存在注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * An graph implementation based on two incidence lists.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;V&gt;</span></span><br><span class="line"><span class="comment"> *            The vertex type.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;E&gt;</span></span><br><span class="line"><span class="comment"> *            The edge type.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<p>是基于两个关联列表的图implementation。在<code>IncidenceListGraph</code>中定义了很多的图操作。</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/5.png" alt="5"></p>
<p>继续回到源码，执行到第36行，它这里用了<strong>this</strong>关键字来调用本类的<strong>重载构造器</strong>（因为构造方法在类里不能像其他方法一样调用，只能通过<code>this(参数列表)</code>调用）。<img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/18.png" alt="18"></p>
<blockquote>
<p><strong>补充1：重写Override和重载Overload的区别</strong></p>
<p><a href="https://www.runoob.com/java/java-override-overload.html" target="_blank" rel="noopener">https://www.runoob.com/java/java-override-overload.html</a></p>
<p><strong>重写</strong>：是子类对父类的允许访问的方法的实现过程进行重新编写, 返回值和形参都不能改变。<strong>即外壳不变，核心重写！</strong>重写方法不能抛出新的检查异常或者比被重写方法申明更加宽泛的异常。例如： 父类的一个方法申明了一个检查异常 IOException，但是在重写这个方法的时候不能抛出 Exception 异常，因为 Exception 是 IOException 的父类，只能抛出 IOException 的子类异常。  </p>
<p><strong>重载</strong>：重载(overloading) 是在一个类里面，方法名字相同，而参数不同。返回类型可以相同也可以不同。每个重载的方法（或者构造函数）都必须有一个独一无二的参数类型列表。最常用的地方就是<strong>构造器的重载</strong>。</p>
<p><strong>补充2：Java使用this关键字调用本类重载构造器</strong></p>
<p><a href="https://www.cnblogs.com/wanghongyun/p/6132083.html" target="_blank" rel="noopener">https://www.cnblogs.com/wanghongyun/p/6132083.html</a></p>
<p>在构造器中是可以直接调用本类的其他重载构造器的，但是不能直接使用构造器名称来调用另一个构造器，而是需要使用<code>this</code>关键字。</p>
<p><code>this(...)</code>方法必须出现在构造器的第一行，用来调用其他重载构造器，调用时参数必须严格匹配。这种调用方式的有点在于一个构造器可以不必重复编写其他构造器中已有的代码，而是通过调用其他构造函数以实现复用，从而提供良好的类代码结构。</p>
</blockquote>
<p>在上图<code>public CFG(CFGNode entry, CFGNode exit)</code>函数中，接受的两个参数类型都是<code>CFGNode</code>类型的，不过通过<code>this</code>关键字传入的两个参数分别是<code>new CFGEntryNode()</code>和<code>new CFGExitNode()</code>，我们知道<code>CFGNode</code>和<code>CFGEntryNode</code>与<code>CFGExitNode</code>之间存在某种继承关系。在IDEA中查看继承关系，<code>CFGNode</code>是一个接口，<code>AbstractCFGNode</code>是实现了该接口的抽象类（抽象类是只能被用于继承的），然后<code>CFGEntryNode</code>和<code>CFGExitNode</code>分别继承自该抽象类：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/19.png" alt="19"></p>
<p>在<code>public CFG(CFGNode entry, CFGNode exit)</code>中是最最初始的CFG图，目前的CFG图中存在两个结点，就是CFG的entry结点和exit结点，但是它们的<code>id</code>都为<font color="red">-1</font>，因为这并不代表任何具象的AST结点，只是标记某个CFG块的entry和exit位置：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/20.png" alt="20"></p>
<p>然后初始化存储非结构化控制语句的List：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/21.png" alt="21"></p>
<p><code>CFG</code>对象实例化结束后， 程序返回到<code>CFGFactory.newInstance()</code>，并将该<code>CFG</code>对象赋给<code>block</code>参数。接着读取<code>block.entry</code>和<code>block.exit</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/22.png" alt="22"></p>
<p>但是<code>nodes</code>是空的list，所以后面的for循环会被跳过，直接进入第89行调用<code>CFG.addEdge()</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/23.png" alt="23"></p>
<p>该函数会设置<code>outNeighborhood</code>和<code>inNeiborhood</code>。这样就合成了一个最基本的CFG图，由一个entry结点和exit结点组成。接着开始处理AST树的叶子结点，将其一点点加入到CFG图中。继续跟入：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/24.png" alt="24"></p>
<p>对于CFG图上的起始结点（即<code>flags: TOPLEVEL_FILE</code>的结点），它的content内容就是它的子结点：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/25.png" alt="25"></p>
<p>故<code>functionDef.getContent()</code>返回的是一个类型为<code>CompoundStatement</code>的AST结点。接着调用<code>CFGFactory.convert</code>函数，该函数的作用就是将ASTNode转化成CFG：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">convert</span><span class="params">(ASTNode node)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> newInstance();</span><br><span class="line"></span><br><span class="line">    node.accept(structuredFlowVisitior);</span><br><span class="line">    <span class="keyword">return</span> structuredFlowVisitior.getCFG();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/61.png" alt="61"></p>
<p>首先<code>newInstance()</code>会初始化一个最小的CFG块，接着处理后面的CompoundStatement。</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/27.png" alt="27"></p>
<p>通过<code>content.getStatements()</code>返回子结点之后，先将<code>statement</code>转化为子控制流图（对应代码是<code>convert(statement)</code>，convert函数的返回类型是<code>CFG</code>），为了方便起见，我称其为<strong>child-CFG</strong>，将其都加入CFG中。可以看到两个子结点的类型分别是：</p>
<ul>
<li><p><strong>NullNode</strong>：一个空结点node类型，该类型结点往往是CFG中EXIT结点的parent结点</p>
</li>
<li><p><strong>SwitchStatementPHP</strong>：继承自<strong>SwitchStatement</strong></p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/29.png" alt="29"></p>
<p><strong>SwitchStatementPHP</strong>有两个成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwitchStatementPHP</span> <span class="keyword">extends</span> <span class="title">SwitchStatement</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Expression expression = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">protected</span> SwitchList switchList = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<p>继续跟入<code>CFGFactory.convert</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/28.png" alt="28"></p>
<p>因为node结点的类型是<code>SwitchStatementPHP</code>，所以调用相应的visitor：<code>PHPStructureFlowVisitor</code>，然后调用<code>PHPCFGFactory.newInstance(node)</code>创建child-CFG，跟入该函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CFG <span class="title">newInstance</span><span class="params">(SwitchStatement switchStatement)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// [My Annotation]: 将传入参数switchStatement类型转为专门处理PHP语言的SwitchStatementPHP</span></span><br><span class="line">        <span class="comment">// 因为SwitchStatementPHP是SwitchStatement的子类</span></span><br><span class="line">        SwitchStatementPHP phpSwitchStatement = (SwitchStatementPHP)switchStatement;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create new CFG block</span></span><br><span class="line">        <span class="comment">// [My Annotation]: 实例化一个child-CFG，switchBlock: "[ENTRY] &#123;  &#125;\n[EXIT] &#123;  &#125;\n"</span></span><br><span class="line">        CFG switchBlock = <span class="keyword">new</span> CFG();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// "head" vertex: the expression to be compared to the individual cases</span></span><br><span class="line">        <span class="comment">// [My Annotation]: ASTNodeContainer其实可以理解为控制流图上普通的结点</span></span><br><span class="line">        <span class="comment">// phpSwitchStatement是针对switch语句的一种特殊的ASTNode结点，将其通过new ASTNodeContainer转为CFGNode结点</span></span><br><span class="line">        CFGNode conditionContainer = <span class="keyword">new</span> ASTNodeContainer(</span><br><span class="line">            phpSwitchStatement.getExpression());</span><br><span class="line">        <span class="comment">// 然后将其加入到child-CFG的vertex-list中</span></span><br><span class="line">        switchBlock.addVertex(conditionContainer);</span><br><span class="line">        <span class="comment">// 然后把边edge连起来</span></span><br><span class="line">        switchBlock.addEdge(switchBlock.getEntryNode(), conditionContainer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create a CFG block for each case and connect them</span></span><br><span class="line">        <span class="comment">// [My Annotation]: 将每一个switch case块加入到switchblock中</span></span><br><span class="line">        <span class="keyword">boolean</span> defaultExists = <span class="keyword">false</span>;	<span class="comment">// 判断是否存在一个default块</span></span><br><span class="line">        <span class="keyword">for</span>( SwitchCase switchCase : phpSwitchStatement.getSwitchList()) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// convert case block and add to main switch block</span></span><br><span class="line">            <span class="comment">// [My Annotation]: 为每一个switch case块实例化一个caseBody CFG</span></span><br><span class="line">            <span class="comment">// switchCase.getStatement()得到的statement类型是一个CompoundStatement</span></span><br><span class="line">            <span class="comment">// 然后调用CFGFactory.convert函数将其转为child CFG</span></span><br><span class="line">            CFG caseBody = convert(switchCase.getStatement());</span><br><span class="line">            <span class="comment">// 调用CFG.appendCFG将caseBody添加到main switch block中</span></span><br><span class="line">            switchBlock.appendCFG(caseBody);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// determine label</span></span><br><span class="line">            <span class="comment">// [My Annotation]: 判断该switchCase（一种statement）的label是什么，label指case "apple"中的"apple"</span></span><br><span class="line">            String label = switchCase.getValue() != <span class="keyword">null</span></span><br><span class="line">                ? switchCase.getValue().getEscapedCodeStr()</span><br><span class="line">                : <span class="string">"default"</span>;</span><br><span class="line">          	<span class="comment">// 如果default标签存在，将defaultExists标记为true</span></span><br><span class="line">            <span class="keyword">if</span>( label.equals(<span class="string">"default"</span>)) defaultExists = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// connect condition to first statement of case</span></span><br><span class="line">            <span class="comment">// if case is empty, simply connect to current exit node</span></span><br><span class="line">            <span class="keyword">if</span>( !caseBody.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">for</span>( CFGEdge caseEntryEdge : caseBody.outgoingEdges( caseBody.getEntryNode())) &#123;</span><br><span class="line">                    switchBlock.addEdge( conditionContainer, caseEntryEdge.getDestination(), label);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                switchBlock.addEdge( conditionContainer, switchBlock.getExitNode(), label);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// default edge to exit node (if no default case is found)</span></span><br><span class="line">        <span class="comment">// 如果没有default case，那么需要手动加上</span></span><br><span class="line">        <span class="keyword">if</span>( !defaultExists) &#123;</span><br><span class="line">            switchBlock.addEdge( conditionContainer, switchBlock.getExitNode(), <span class="string">"default"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// finally, fix break statements and rejoice, for we are done</span></span><br><span class="line">        fixBreakStatements( switchBlock, switchBlock.getExitNode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> switchBlock;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//e.printStackTrace();</span></span><br><span class="line">        <span class="keyword">return</span> newErrorInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来利用<code>SwitchStatementPHP.getExpression()</code>的结果合成CFGNode：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/31.png" alt="31"></p>
<p>返回一个后继结点，它的类型是Variable，也是ASTNode的子类类型之一：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/32.png" alt="32"></p>
<p>然后将其实例化为一个<code>ASTNodeContainer</code>对象，它是一种CFG的一种Node类型：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/30.png" alt="30"></p>
<p><code>ASTNodeContainer</code>的作用主要是保存一个CFG结点的ASTNode属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cfg.nodes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast.ASTNode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASTNodeContainer</span> <span class="keyword">extends</span> <span class="title">AbstractCFGNode</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">// 成员变量是ASTNode</span></span><br><span class="line">	<span class="keyword">private</span> ASTNode astNode;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ASTNodeContainer</span><span class="params">(ASTNode node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (node == <span class="keyword">null</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"node must not be null"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		setASTNode(node);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setASTNode</span><span class="params">(ASTNode astNode)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.astNode = astNode;</span><br><span class="line">        <span class="comment">// 将该结点标记为CFG上的结点</span></span><br><span class="line">		<span class="keyword">this</span>.astNode.markAsCFGNode();</span><br><span class="line">	&#125;</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为是CFGNode，所以它的<code>isInCFG</code>属性应为<code>true</code>，调用<code>ASTNode.markAsCFGNode</code>将其标记为true：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/33.png" alt="33"></p>
<p>然后将新的CFGNode保存到CFG图的vertex-list中：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/34.png" alt="34"></p>
<h4 id="CFG-addEdge"><a href="#CFG-addEdge" class="headerlink" title="CFG.addEdge"></a>CFG.addEdge</h4><p>接着调用<code>CFG.addEdge()</code>为entry结点和该CFGNode结点添加一条CFGEdge，即<code>[ENTRY] ==[]==&gt; [6 (Variable)]</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/35.png" alt="35"></p>
<p>这里会维护<code>outNeighborhood</code>和<code>inNeighborhood</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/36.png" alt="36"></p>
<p>接着为每一个switch case块实例化一个caseBody CFG，<code>switchCase.getStatement()</code>得到的statement类型是一个<code>CompoundStatement</code>，它们的结构如下图所示：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/37.png" alt="37"></p>
<p>然后调用<code>CFGFactory.convert</code>函数将<code>switch.getStatement</code>得到的CompoundStatement转为child CFG，执行完的结果：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/38.png" alt="38"></p>
<p>这里可以看到的是这里的<code>CompoundStatement</code>其实就对应我们源码中的echo和break语句，因此是<strong>复合类型</strong>的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">"i is apple"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>然后调用<code>CFG.appendCFG()</code>将<code>caseBody</code>添加进main switchblock <code>switchBlock</code>中。</p>
<h4 id="CFG-appendCFG"><a href="#CFG-appendCFG" class="headerlink" title="CFG.appendCFG"></a>CFG.appendCFG</h4><p><code>CFG.appendCFG</code>已经在之前将基本CFG块合成较大的CFG块时出现好几次了，现在来看下它到底做了什么事情。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CFG</span> <span class="keyword">extends</span> <span class="title">IncidenceListGraph</span>&lt;<span class="title">CFGNode</span>, <span class="title">CFGEdge</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> CFGNode entry;</span><br><span class="line">	<span class="keyword">private</span> CFGNode exit;</span><br><span class="line">	<span class="keyword">private</span> CFGNode error;</span><br><span class="line">	<span class="keyword">private</span> List&lt;CFGNode&gt; parameters;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> List&lt;CFGNode&gt; breakStatements;</span><br><span class="line">	<span class="keyword">private</span> List&lt;CFGNode&gt; continueStatements;</span><br><span class="line">	<span class="keyword">private</span> List&lt;CFGNode&gt; returnStatements;</span><br><span class="line">	<span class="keyword">private</span> HashMap&lt;CFGNode, String&gt; gotoStatements;</span><br><span class="line">	<span class="keyword">private</span> HashMap&lt;String, CFGNode&gt; labels;</span><br><span class="line">	<span class="keyword">private</span> CFGExceptionNode exceptionNode;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCFG</span><span class="params">(CFG otherCFG)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">// [My Annotation]: 将otherCFG中的vertex加入到当前的main CFG的vertex list中</span></span><br><span class="line">		addVertices(otherCFG);</span><br><span class="line">        <span class="comment">// [My Annotation]: 将otherCFG中的edge加入当前的main CFG的edge list中，但未进行拼接</span></span><br><span class="line">		addEdges(otherCFG);</span><br><span class="line">	</span><br><span class="line">        <span class="comment">// [My Annotation]: 将parameters，breakStatements等必要信息加入到main CFG中</span></span><br><span class="line">        <span class="comment">// 后面同下就不再赘述了</span></span><br><span class="line">		getParameters().addAll(otherCFG.getParameters());</span><br><span class="line">		getBreakStatements().addAll(otherCFG.getBreakStatements());</span><br><span class="line"> 		getContinueStatements().addAll(otherCFG.getContinueStatements());</span><br><span class="line">		getReturnStatements().addAll(otherCFG.getReturnStatements());</span><br><span class="line">		getGotoStatements().putAll(otherCFG.getGotoStatements());</span><br><span class="line">		getLabels().putAll(otherCFG.getLabels());</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.hasExceptionNode() &amp;&amp; otherCFG.hasExceptionNode())</span><br><span class="line">		&#123;</span><br><span class="line">			CFGExceptionNode oldExceptionNode = getExceptionNode();</span><br><span class="line">			CFGExceptionNode newExceptionNode = <span class="keyword">new</span> CFGExceptionNode();</span><br><span class="line">			setExceptionNode(newExceptionNode);</span><br><span class="line">			addEdge(oldExceptionNode, newExceptionNode,</span><br><span class="line">					CFGEdge.UNHANDLED_EXCEPT_LABEL);</span><br><span class="line">			addEdge(otherCFG.getExceptionNode(), newExceptionNode,</span><br><span class="line">					CFGEdge.UNHANDLED_EXCEPT_LABEL);</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (otherCFG.hasExceptionNode())</span><br><span class="line">		&#123;</span><br><span class="line">			setExceptionNode(otherCFG.getExceptionNode());</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendCFG</span><span class="params">(CFG otherCFG)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="comment">// addCFG函数会将otherCFG中vertex和edge加入到this指向的main CFG中，但是还没有进行拼接</span></span><br><span class="line">		addCFG(otherCFG);</span><br><span class="line">		<span class="keyword">if</span> (!otherCFG.isEmpty())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (CFGEdge edge1 : incomingEdges(getExitNode()))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">for</span> (CFGEdge edge2 : otherCFG</span><br><span class="line">						.outgoingEdges(otherCFG.getEntryNode()))</span><br><span class="line">				&#123;</span><br><span class="line">					addEdge(edge1.getSource(), edge2.getDestination(),</span><br><span class="line">							edge1.getLabel());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// 断开main CFG中某个结点和exit结点之间的连接，等待重新连接</span></span><br><span class="line">			removeEdgesTo(getExitNode());</span><br><span class="line">			<span class="keyword">for</span> (CFGEdge edge : otherCFG.incomingEdges(otherCFG.getExitNode()))</span><br><span class="line">			&#123;</span><br><span class="line">				addEdge(edge.getSource(), getExitNode(), edge.getLabel());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [My Annotation]: 将subordinate CFG(即传入的参数)添加到main CFG中，但是不需要加入每个CFG块都存在的entry结点和exit结点</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addVertices</span><span class="params">(CFG cfg)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (CFGNode vertex : cfg.getVertices())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// do not add entry and exit node</span></span><br><span class="line">			<span class="keyword">if</span> (!(vertex.equals(cfg.getEntryNode())</span><br><span class="line">					|| vertex.equals(cfg.getExitNode())))</span><br><span class="line">			&#123;</span><br><span class="line">				addVertex(vertex);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addEdges</span><span class="params">(CFG cfg)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">for</span> (CFGNode vertex : cfg.getVertices())</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// 给定一个vertex，返回从vertex是出点的edge</span></span><br><span class="line">			<span class="keyword">for</span> (CFGEdge edge : cfg.outgoingEdges(vertex))</span><br><span class="line">			&#123;</span><br><span class="line">                <span class="comment">// 对于[ENTRY] ==[]==&gt; [(12) EchoStatement]这种情况的边就不要加入到main CFG中了</span></span><br><span class="line">                <span class="comment">// 否则会出现一个CFG块里有多条从Entry出发的关系边和到Exit结束的关系边</span></span><br><span class="line">				<span class="keyword">if</span> (!(edge.getSource().equals(cfg.getEntryNode())</span><br><span class="line">						|| edge.getDestination().equals(cfg.getExitNode())))</span><br><span class="line">				&#123;</span><br><span class="line">					addEdge(edge);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当程序执行到下图时：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/39.png" alt="39"></p>
<p>先记录下<code>switchBlock</code>和<code>caseBody</code>的状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// switchBlock</span><br><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(6) Variable] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(6) Variable] &#123;  &#125;</span><br><span class="line"></span><br><span class="line">// caseBody</span><br><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(12) EchoStatement] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(12) EchoStatement] &#123; [(12) EchoStatement] ==[]==&gt; [(14) BreakStatement] , &#125;</span><br><span class="line">[(14) BreakStatement] &#123; [(14) BreakStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>对照neo4j中的可视化图形，switchBlock为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/40.png" alt="40"></p>
<p>caseBody为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/41.png" alt="41"></p>
<p>经过<code>CFG.appendCFG</code>合成的new switchBlock为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/42.png" alt="42"></p>
<p>首先将otherCFG的vertex都加入到main CFG中，但是每个CFG块都有的entry结点和exit结点就不必重复加入了：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/43.png" alt="43"></p>
<p>然后将<code>otherCFG</code>的edges也都加入到main CFG中，这个main CFG就是调用appendCFG的对象。其中<code>IncidenceListGraph.outgoingEdges(vertex)</code>会返回从该vertex出发的关系边，并且一条关系边中的两个结点不能存在entry结点或是exit结点：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/44.png" alt="44"></p>
<p>返回后：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/45.png" alt="45"></p>
<p>得到的CFG图目前是这样的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(6) Variable] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(6) Variable] &#123;  &#125;</span><br><span class="line">[(12) EchoStatement] &#123; [(12) EchoStatement] ==[]==&gt; [(14) BreakStatement] , &#125;</span><br><span class="line">[(14) BreakStatement] &#123;  &#125;</span><br></pre></td></tr></table></figure>

<p><code>[(6) Variable]</code>和<code>[(12) EchoStatement]</code>及<code>[(14) BreakStatement]</code>是没有什么关联的，但是<code>[(12) EchoStatement] ==[]==&gt; [(14) BreakStatement]</code>是存在关系边的，所以后面需要将id为6的结点和这两个结点连接起来。</p>
<p>然后将otherCFG中一些必要的Statement也加入到main CFG中，比如加入了一个<code>BreakStatement</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/46.png" alt="46"></p>
<p>然后重新组合<code>otherCFG</code>和main CFG：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/47.png" alt="47"></p>
<p>可以看到其对main CFG造成的改变就是多了一条<code>[(14) BreakStatement] ==[]==&gt; [EXIT]</code>的边。</p>
<p>但是目前<code>[(6) Variable]</code>并没有与<code>[(12) EchoStatement]</code>连接起来，所以接下去需要将caseBody的每个CFG头结点与switchBlock连接：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/49.png" alt="49"></p>
<p>如此得到的switchBlock就变成了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(6) Variable] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(6) Variable] &#123; [(6) Variable] ==[apple]==&gt; [(12) EchoStatement] , &#125;</span><br><span class="line">[(12) EchoStatement] &#123; [(12) EchoStatement] ==[]==&gt; [(14) BreakStatement] , &#125;</span><br><span class="line">[(14) BreakStatement] &#123; [(14) BreakStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>现在的CFG就是下面的标红部分：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/42.png" alt="42"></p>
<p>其中下面几个id的结点都是break结点：</p>
<ol>
<li>id = 14</li>
<li>id = 21</li>
<li>id = 28</li>
</ol>
<h4 id="default-case"><a href="#default-case" class="headerlink" title="default case"></a>default case</h4><p>接着需要确定switch语句中是否存在default标签，如果没有后面需要特殊处理下：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/48.png" alt="48"></p>
<h4 id="fixBreakStatements"><a href="#fixBreakStatements" class="headerlink" title="fixBreakStatements"></a>fixBreakStatements</h4><p>最后，还需要对<code>breakStatements</code>进行最后的处理，调用<code>CFGFactory.fixBreakStatements()</code>处理：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/50.png" alt="50"></p>
<p>传入的参数<code>thisCFG</code>则是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(6) Variable] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(6) Variable] &#123; [(6) Variable] ==[apple]==&gt; [(12) EchoStatement] ,[(6) Variable] ==[bar]==&gt; [(19) EchoStatement] ,[(6) Variable] ==[cake]==&gt; [(26) EchoStatement] ,[(6) Variable] ==[default]==&gt; [EXIT] , &#125;</span><br><span class="line">[(12) EchoStatement] &#123; [(12) EchoStatement] ==[]==&gt; [(14) BreakStatement] , &#125;</span><br><span class="line">[(14) BreakStatement] &#123; [(14) BreakStatement] ==[]==&gt; [(19) EchoStatement] , &#125;</span><br><span class="line">[(19) EchoStatement] &#123; [(19) EchoStatement] ==[]==&gt; [(21) BreakStatement] , &#125;</span><br><span class="line">[(21) BreakStatement] &#123; [(21) BreakStatement] ==[]==&gt; [(26) EchoStatement] , &#125;</span><br><span class="line">[(26) EchoStatement] &#123; [(26) EchoStatement] ==[]==&gt; [(28) BreakStatement] , &#125;</span><br><span class="line">[(28) BreakStatement] &#123; [(28) BreakStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>用一张更清晰的图来表示为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/51.png" alt="51"></p>
<p>从上图很容易发现多了两条边：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[(14) BreakStatement] &#123; [(14) BreakStatement] ==[]==&gt; [(19) EchoStatement] , &#125;</span><br><span class="line">[(21) BreakStatement] &#123; [(21) BreakStatement] ==[]==&gt; [(26) EchoStatement] , &#125;</span><br></pre></td></tr></table></figure>

<p>按照上图的语义，对照源码有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">switch</span> ($i) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"apple"</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"i is apple"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"bar"</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"i is bar"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"cake"</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"i is cake"</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>当第5行break之后，还会继续执行到<code>case &quot;bar&quot;</code>中的内容。</p>
<p>来分析下<code>fixBreakOrContinueStatements</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixBreakOrContinueStatements</span><span class="params">(CFG thisCFG, CFGNode target, Iterator&lt;CFGNode&gt; it)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(it.hasNext())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 从数组中取出每一个CFGNode结点</span></span><br><span class="line">        CFGNode breakOrContinueNode = it.next();</span><br><span class="line"></span><br><span class="line">        ASTNodeContainer nodeContainer = (ASTNodeContainer) breakOrContinueNode;</span><br><span class="line">        BreakOrContinueStatement statement = (BreakOrContinueStatement) nodeContainer.getASTNode();</span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 可能与多层嵌套的break有关，可以后面再看</span></span><br><span class="line">        Integer depth = statement.getDepthAsInteger();</span><br><span class="line">        <span class="keyword">if</span>(depth != <span class="number">0</span> &amp;&amp; depth != <span class="number">1</span>)&#123;</span><br><span class="line">            statement.decrementDepth();</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 除去CFG中多余的边，break语句后面不应继续执行了</span></span><br><span class="line">        thisCFG.removeEdgesFrom(breakOrContinueNode);</span><br><span class="line">        thisCFG.addEdge(breakOrContinueNode, target);</span><br><span class="line">        it.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除去CFG中break结点后多余的edge：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/52.png" alt="52"></p>
<p>最后将该break结点连接到exit结点上：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/53.png" alt="53"></p>
<p>最后返回得到一个switchBlock：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/54.png" alt="54"></p>
<p>得到的CFG结构为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[ENTRY] &#123; [ENTRY] ==[]==&gt; [(6) Variable] , &#125;</span><br><span class="line">[EXIT] &#123;  &#125;</span><br><span class="line">[(6) Variable] &#123; [(6) Variable] ==[apple]==&gt; [(12) EchoStatement] ,[(6) Variable] ==[bar]==&gt; [(19) EchoStatement] ,[(6) Variable] ==[cake]==&gt; [(26) EchoStatement] ,[(6) Variable] ==[default]==&gt; [EXIT] , &#125;</span><br><span class="line">[(12) EchoStatement] &#123; [(12) EchoStatement] ==[]==&gt; [(14) BreakStatement] , &#125;</span><br><span class="line">[(14) BreakStatement] &#123; [(14) BreakStatement] ==[]==&gt; [EXIT] , &#125;</span><br><span class="line">[(19) EchoStatement] &#123; [(19) EchoStatement] ==[]==&gt; [(21) BreakStatement] , &#125;</span><br><span class="line">[(21) BreakStatement] &#123; [(21) BreakStatement] ==[]==&gt; [EXIT] , &#125;</span><br><span class="line">[(26) EchoStatement] &#123; [(26) EchoStatement] ==[]==&gt; [(28) BreakStatement] , &#125;</span><br><span class="line">[(28) BreakStatement] &#123; [(28) BreakStatement] ==[]==&gt; [EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<h4 id="返回CFGFactory-newInstance"><a href="#返回CFGFactory-newInstance" class="headerlink" title="返回CFGFactory.newInstance"></a>返回CFGFactory.newInstance</h4><p>接着层层返回到<code>CFGFactory.newInstance</code>：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/55.png" alt="55"></p>
<p>其中<code>function</code>，<code>parameterBlock</code>和<code>functionBody</code>分别为：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/56.png" alt="56"></p>
<h4 id="返回PHPCFGFactory-newInstance"><a href="#返回PHPCFGFactory-newInstance" class="headerlink" title="返回PHPCFGFactory.newInstance"></a>返回PHPCFGFactory.newInstance</h4><p>最后返回到<code>PHPCFGFactory.newInstance()</code>对<code>ENTRY</code>结点和<code>EXIT</code>结点的id进行分配，分别为2和3：</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/57.png" alt="57"></p>
<p>最后51行返回的CFG就是最终的CFG。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[(2) ENTRY] &#123; [(2) ENTRY] ==[]==&gt; [(6) Variable] , &#125;</span><br><span class="line">[(3) EXIT] &#123;  &#125;</span><br><span class="line">[(6) Variable] &#123; [(6) Variable] ==[apple]==&gt; [(12) EchoStatement] ,[(6) Variable] ==[bar]==&gt; [(19) EchoStatement] ,[(6) Variable] ==[cake]==&gt; [(26) EchoStatement] ,[(6) Variable] ==[default]==&gt; [(30) NullNode] , &#125;</span><br><span class="line">[(12) EchoStatement] &#123; [(12) EchoStatement] ==[]==&gt; [(14) BreakStatement] , &#125;</span><br><span class="line">[(14) BreakStatement] &#123; [(14) BreakStatement] ==[]==&gt; [(30) NullNode] , &#125;</span><br><span class="line">[(19) EchoStatement] &#123; [(19) EchoStatement] ==[]==&gt; [(21) BreakStatement] , &#125;</span><br><span class="line">[(21) BreakStatement] &#123; [(21) BreakStatement] ==[]==&gt; [(30) NullNode] , &#125;</span><br><span class="line">[(26) EchoStatement] &#123; [(26) EchoStatement] ==[]==&gt; [(28) BreakStatement] , &#125;</span><br><span class="line">[(28) BreakStatement] &#123; [(28) BreakStatement] ==[]==&gt; [(30) NullNode] , &#125;</span><br><span class="line">[(30) NullNode] &#123; [(30) NullNode] ==[]==&gt; [(3) EXIT] , &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到和此前不一样的地方在于，<code>[ENTRY]</code>和<code>[EXIT]</code>变成了<code>[(2) ENTRY]</code>和<code>[(3) EXIT]</code>，它们有了自己的id，但注意它们的类型和其他结点不一样，它们是<code>CFGEntryNode</code>和<code>CFGExitNode</code>，其他的结点类型是<code>ASTNodeContainer</code>，不过都是一种<code>CFGNode</code>。</p>
<h3 id="CSVCFGExpoter-writeCFGEdges"><a href="#CSVCFGExpoter-writeCFGEdges" class="headerlink" title="CSVCFGExpoter.writeCFGEdges"></a>CSVCFGExpoter.writeCFGEdges</h3><p>该函数的作用就是就是将CFGEdges写入到<code>cpg_edges.csv</code>文件中。</p>
<p><img src="/2021/04/10/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bswitch%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/imgs/58.png" alt="58"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> outputModules.csv.exporters;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cfg.CFG;</span><br><span class="line"><span class="keyword">import</span> cfg.CFGEdge;</span><br><span class="line"><span class="keyword">import</span> cfg.nodes.ASTNodeContainer;</span><br><span class="line"><span class="keyword">import</span> cfg.nodes.AbstractCFGNode;</span><br><span class="line"><span class="keyword">import</span> cfg.nodes.CFGEntryNode;</span><br><span class="line"><span class="keyword">import</span> cfg.nodes.CFGExitNode;</span><br><span class="line"><span class="keyword">import</span> cfg.nodes.CFGNode;</span><br><span class="line"><span class="keyword">import</span> databaseNodes.EdgeTypes;</span><br><span class="line"><span class="keyword">import</span> databaseNodes.NodeKeys;</span><br><span class="line"><span class="keyword">import</span> outputModules.common.CFGExporter;</span><br><span class="line"><span class="keyword">import</span> outputModules.common.Writer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CSVCFGExporter</span> <span class="keyword">extends</span> <span class="title">CFGExporter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeCFGNode</span><span class="params">(CFGNode statement,</span></span></span><br><span class="line"><span class="function"><span class="params">			Map&lt;String, Object&gt; properties)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		properties.put(NodeKeys.FUNCTION_ID,</span><br><span class="line">				String.format(<span class="string">"%d"</span>, Writer.getIdForObject(currentFunction)));</span><br><span class="line">		Writer.addNode(statement, properties);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addFlowToLink</span><span class="params">(Object srcBlock, Object dstBlock,</span></span></span><br><span class="line"><span class="function"><span class="params">			Map&lt;String, Object&gt; properties)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">long</span> srcId = Writer.getIdForObject(srcBlock);</span><br><span class="line">		<span class="keyword">long</span> dstId = Writer.getIdForObject(dstBlock);</span><br><span class="line">        <span class="comment">// [My Annotation]: 写入edge的类型为FLOWS_TO</span></span><br><span class="line">		Writer.addEdge(srcId, dstId, properties, EdgeTypes.FLOWS_TO);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Simple method that takes a CFG and writes out the edges.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeCFGEdges</span><span class="params">(CFG cfg)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// cfg.getEdges会获取cfg图中的outgoingEdges</span></span><br><span class="line">		<span class="keyword">for</span>( CFGEdge cfgEdge : cfg.getEdges())	&#123;</span><br><span class="line"></span><br><span class="line">			CFGNode src = cfgEdge.getSource();</span><br><span class="line">			CFGNode dst = cfgEdge.getDestination();</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// skip blocks that are neither entry, exit nor AST nodes</span></span><br><span class="line">			<span class="comment">// (e.g., artificial [ERROR] blocks and such generated by the CFG factory)</span></span><br><span class="line">            <span class="comment">// CFG图中有三种结点类型，ASTNodeContainer, CFGEntryNode和CFGExitNode</span></span><br><span class="line">			<span class="keyword">if</span>( (src <span class="keyword">instanceof</span> ASTNodeContainer || src <span class="keyword">instanceof</span> CFGEntryNode || src <span class="keyword">instanceof</span> CFGExitNode)</span><br><span class="line">					&amp;&amp; (dst <span class="keyword">instanceof</span> ASTNodeContainer || dst <span class="keyword">instanceof</span> CFGEntryNode || dst <span class="keyword">instanceof</span> CFGExitNode)) &#123;</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// CFG nodes that are AST node containers have their ids stored in their AST node;</span></span><br><span class="line">				<span class="comment">// abstract nodes such as entry or exit nodes have their id set internally.</span></span><br><span class="line">                <span class="comment">// 获取各自node的id，因为写入cpg_edges.csv文件中的就是node id</span></span><br><span class="line">				Long srcId = (src <span class="keyword">instanceof</span> ASTNodeContainer) ? ((ASTNodeContainer)src).getASTNode().getNodeId()</span><br><span class="line">						: ((AbstractCFGNode)src).getNodeId();</span><br><span class="line">				Long dstId = (dst <span class="keyword">instanceof</span> ASTNodeContainer) ? ((ASTNodeContainer)dst).getASTNode().getNodeId()</span><br><span class="line">						: ((AbstractCFGNode)dst).getNodeId();</span><br><span class="line">				</span><br><span class="line">				Writer.setIdForObject(src, srcId);</span><br><span class="line">				Writer.setIdForObject(dst, dstId);</span><br><span class="line">				addFlowToLink( src, dst, <span class="keyword">null</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// clean up</span></span><br><span class="line">		Writer.reset();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本小节仅仅涉及的是switch源码的CFG生成，还有一些其他的可继续挖掘的信息我都是没有跟下去的。因为这些打算放在其他的文章里，进行专项学习。</p>
<p>之前在phith0n大大开设的知识星球里看到过，说现在的漏洞分析文章大多都是一步一步跟踪流程，贴了一张张截图，但是这样的文章大多是”没有灵魂的“，因为缺少了我们从中学习到的更加深层，更加通用的，我们在调试漏洞时思考的内容。这些内容只能对这一个漏洞适用，缺少了”可迁移性“，我们应该在文章体现的是更加<strong>本质</strong>内容，我深以为然。但是我离这样的水平还有很长的距离，所以现在我还是将我跟踪调试的步骤一步一步记录下来。期望在结束的时候，我能学习到更加深层次的东西。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"># PHP程序分析</a>
                    
                        <a href="/tags/Joern/"># Joern</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/04/11/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8Bif%E8%AF%AD%E5%8F%A5CFG%E7%94%9F%E6%88%90/">Joern源码阅读之if语句CFG生成</a>
            
            
            <a class="next" rel="next" href="/2021/04/01/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%E4%B9%8BIEAD%E6%BA%90%E7%A0%81%E5%AF%BC%E5%85%A5/">Joern源码阅读笔记之IEAD源码导入</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
