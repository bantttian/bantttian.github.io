<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>PHPJoern源码阅读 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">PHPJoern源码阅读</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-04-21&nbsp;&nbsp;16:04:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们知道在Joern为php源码生成CPG代码属性图的步骤是这样的：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/7.svg" alt="7"></p>
<p>本文的目的就是对phpjoern部分解析ast树的过程做一个分析以及记录。</p>
<h2 id="调试环境配置"><a href="#调试环境配置" class="headerlink" title="调试环境配置"></a>调试环境配置</h2><p>为了方便更加快速地了解PHPJoern解析的流程，我利用phpstorm来进行调试，调试前确保已经配置好<strong><a href="https://xdebug.org/docs/install" target="_blank" rel="noopener">xdebug</a></strong>，对于Ubuntu可以直接使用apt-get安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install xdebug</span><br></pre></td></tr></table></figure>

<p>安装好之后修改<code>php.ini</code>，对于我的测试机来说就是<code>/etc/php/7.0/cli/php.ini</code>，在末尾添加下面几行配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[xdebug]</span><br><span class="line">xdebug.remote_port=9000</span><br><span class="line">xdebug.remote_enable = on</span><br><span class="line">xdebug.remote_host=127.0.0.1</span><br><span class="line">xdebug.idekey = PHPSTORM</span><br><span class="line">xdebug.remote_autostart=1</span><br><span class="line">xdebug.remote_mode=req</span><br></pre></td></tr></table></figure>

<p>接着在phpstorm中打开文件所在目录，下图红框中是解析php的主要文件，白色箭头指向的是执行解析的文件：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/3.png" alt="3"></p>
<p>分析这几个文件，发现<code>src/Parser.php</code>是主程序，所以我们执行也可以通过执行<code>Parser.php</code>来替代可执行文件<code>php2ast</code>。</p>
<p>为<code>src/Parser.php</code>添加命令行配置，右上角选择<code>Edit Configurations</code>，然后根据你需要解析的文件相对于<code>src/Parser.php</code>文件的位置，填写<code>Arguments</code>参数：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/4.png" alt="4"></p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p>用tree命令查看<code>phpjoern</code>项目的目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tree</span></span><br><span class="line">.</span><br><span class="line">├── AUTHORS</span><br><span class="line">├── conf</span><br><span class="line">│   └── batch.properties</span><br><span class="line">├── LICENSE</span><br><span class="line">├── php2ast</span><br><span class="line">├── README.md</span><br><span class="line">└── src</span><br><span class="line">    ├── CSVExporter.php</span><br><span class="line">    ├── Exporter.php</span><br><span class="line">    ├── GraphMLExporter.php</span><br><span class="line">    ├── Parser.php</span><br><span class="line">    └── util.php</span><br><span class="line"></span><br><span class="line">2 directories, 10 files</span><br></pre></td></tr></table></figure>

<p>一共有两个文件夹，<code>src/</code>和<code>conf/</code>，其中<code>conf/batch.properties</code>文件中保存的应该是导入neo4j时的配置信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># conf&#x2F;batch.properties</span><br><span class="line">cache_type &#x3D; none</span><br><span class="line">use_memory_mapped_buffers &#x3D; true</span><br><span class="line">neostore.nodestore.db.mapped_memory &#x3D; 1G</span><br><span class="line">neostore.relationshipstore.db.mapped_memory &#x3D; 3G</span><br><span class="line">neostore.propertystore.db.mapped_memory &#x3D; 1G</span><br><span class="line">neostore.propertystore.db.strings.mapped_memory &#x3D; 500M</span><br><span class="line">neostore.propertystore.db.index.keys.mapped_memory &#x3D; 5M</span><br><span class="line">neostore.propertystore.db.index.mapped_memory &#x3D; 5M</span><br></pre></td></tr></table></figure>

<p><code>./php2ast</code>文件是可执行的二进制文件，它会解析php文件，将其解析为抽象语法树：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> file php2ast </span></span><br><span class="line">php2ast: Bourne-Again shell script, ASCII text executable</span><br></pre></td></tr></table></figure>

<p><code>src/</code>目录下有5个php文件，解析处理php的逻辑就在这5个php文件中。</p>
<blockquote>
<p>src/Parser.php：主程序，程序入口在该文件中</p>
<p>src/Exporter.php：</p>
<p>src/CSVExporter.php：</p>
<p>src/GraphMLExporter.php：</p>
<p>src/util.php：</p>
</blockquote>
<h3 id="src-Parser-php"><a href="#src-Parser-php" class="headerlink" title="src/Parser.php"></a>src/Parser.php</h3><p>先来看一下主程序<code>src/Parser.php</code>，其中有我自己添加的一些注释：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">declare</span>( strict_types = <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// report on errors, except notices</span></span><br><span class="line">error_reporting( E_ALL &amp; ~E_NOTICE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This program looks for PHP files in a given directory and dumps ASTs.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Malte Skoruppa &lt;skoruppa<span class="doctag">@cs</span>.uni-saarland.de&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'Exporter.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'CSVExporter.php'</span>;</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'GraphMLExporter.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将要被解析的文件或者是目录</span></span><br><span class="line">$path = <span class="keyword">null</span>; <span class="comment">// file/folder to be parsed</span></span><br><span class="line">$format = Exporter::JEXP_FORMAT; <span class="comment">// format to use for export (default: jexp)</span></span><br><span class="line">$nodefile = CSVExporter::NODE_FILE; <span class="comment">// name of node file when using CSV format (default: nodes.csv)</span></span><br><span class="line">$relfile = CSVExporter::REL_FILE; <span class="comment">// name of relationship file when using CSV format (default: rels.csv)</span></span><br><span class="line">$outfile = GraphMLExporter::GRAPHML_FILE; <span class="comment">// name of output file when using GraphML format (default: graph.xml)</span></span><br><span class="line">$scriptname = <span class="keyword">null</span>; <span class="comment">// this script's name</span></span><br><span class="line">$startcount = <span class="number">0</span>; <span class="comment">// the start count for numbering nodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parses the cli arguments.</span></span><br><span class="line"><span class="comment"> * 该函数的主要作用是检查命令行参数是否合法，比如参数数目是否正确之类的</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Boolean that indicates whether the given arguments are</span></span><br><span class="line"><span class="comment"> *         fine.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_arguments</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">global</span> $argv;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>( !<span class="keyword">isset</span>( $argv)) &#123;</span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">false</span> === (boolean) ini_get( <span class="string">'register_argc_argv'</span>)) &#123;</span><br><span class="line">      error_log( <span class="string">'[ERROR] Please enable register_argc_argv in your php.ini.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      error_log( <span class="string">'[ERROR] No $argv array available.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;   <span class="comment">// PHP_EOL表示换行符\n</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove the script name (first argument)</span></span><br><span class="line">  <span class="keyword">global</span> $scriptname;</span><br><span class="line">  <span class="comment">// [My Annotation]: array_shift() 函数删除数组中第一个元素，并返回被删除元素的值</span></span><br><span class="line">    <span class="comment">// 所以array_shift() 函数会删除第一个参数，返回的参数为我们需要解析的文件名</span></span><br><span class="line">  $scriptname = array_shift( $argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果array_shift() 之后，$argv数组为空，则说明缺少了文件参数</span></span><br><span class="line">  <span class="keyword">if</span>( count( $argv) === <span class="number">0</span>) &#123;</span><br><span class="line">    error_log( <span class="string">'[ERROR] Missing argument.'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the path and remove from command line (last argument)</span></span><br><span class="line">  <span class="keyword">global</span> $path;</span><br><span class="line">  <span class="comment">// array_pop()和array_shift()的效果相反，返回 array 的最后一个值，并会弹出数组最后一个单元（出栈），</span></span><br><span class="line">    <span class="comment">// 即通过array_pop()可以获得需要解析的文件名</span></span><br><span class="line">  $path = (string) array_pop( $argv);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Parse options</span></span><br><span class="line">  $longopts  = [<span class="string">"help"</span>, <span class="string">"version"</span>, <span class="string">"format:"</span>, <span class="string">"nodes:"</span>, <span class="string">"relationships:"</span>, <span class="string">"out:"</span>, <span class="string">"count:"</span>];</span><br><span class="line">  $options = getopt( <span class="string">"hvf:n:r:o:c:"</span>, $longopts);</span><br><span class="line">  <span class="keyword">if</span>( $options === <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">    error_log( <span class="string">'[ERROR] Could not parse command line arguments.'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Help?</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'help'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'h'</span>])) &#123;</span><br><span class="line">    print_version();</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">    print_usage();</span><br><span class="line">    <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">    print_help();</span><br><span class="line">    <span class="keyword">exit</span>( <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Version?</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'version'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'v'</span>])) &#123;</span><br><span class="line">    print_version();</span><br><span class="line">    <span class="keyword">exit</span>( <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Format?</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'format'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'f'</span>])) &#123;</span><br><span class="line">    <span class="keyword">global</span> $format;</span><br><span class="line">    <span class="keyword">switch</span>( $options[<span class="string">'format'</span>] ?? $options[<span class="string">'f'</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"jexp"</span>:</span><br><span class="line">      $format = Exporter::JEXP_FORMAT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"neo4j"</span>:</span><br><span class="line">      $format = Exporter::NEO4J_FORMAT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"graphml"</span>:</span><br><span class="line">      $format = Exporter::GRAPHML_FORMAT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      error_log( <span class="string">"[WARNING] Unknown format '&#123;$options['f']&#125;', using jexp format."</span>);</span><br><span class="line">      $format = Exporter::JEXP_FORMAT;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Nodes file? (for CSV output)</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'nodes'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'n'</span>])) &#123;</span><br><span class="line">    <span class="keyword">global</span> $nodefile;</span><br><span class="line">    $nodefile = $options[<span class="string">'nodes'</span>] ?? $options[<span class="string">'n'</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Relationships file? (for CSV output)</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'relationships'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'r'</span>])) &#123;</span><br><span class="line">    <span class="keyword">global</span> $relfile;</span><br><span class="line">    $relfile = $options[<span class="string">'relationships'</span>] ?? $options[<span class="string">'r'</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Output file? (for XML output)</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'out'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'o'</span>])) &#123;</span><br><span class="line">    <span class="keyword">global</span> $outfile;</span><br><span class="line">    $outfile = $options[<span class="string">'out'</span>] ?? $options[<span class="string">'o'</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start count?</span></span><br><span class="line">  <span class="keyword">if</span>( <span class="keyword">isset</span>( $options[<span class="string">'count'</span>]) || <span class="keyword">isset</span>( $options[<span class="string">'c'</span>])) &#123;</span><br><span class="line">    <span class="keyword">global</span> $startcount;</span><br><span class="line">    $startcount = (int)($options[<span class="string">'count'</span>] ?? $options[<span class="string">'c'</span>]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prints a version message.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_version</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  $version = <span class="string">'UNKNOWN'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">Note:</span> Only works on Unix :-p</span></span><br><span class="line">  <span class="keyword">if</span>( file_exists( <span class="string">".git/HEAD"</span>))</span><br><span class="line">    <span class="keyword">if</span>( preg_match( <span class="string">'/^ref: (.+)$/'</span>, file_get_contents( <span class="string">".git/HEAD"</span>), $matches))</span><br><span class="line">      <span class="keyword">if</span>( file_exists( <span class="string">".git/&#123;$matches[1]&#125;"</span>))</span><br><span class="line">        $version = substr( file_get_contents( <span class="string">".git/&#123;$matches[1]&#125;"</span>), <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"PHPJoern parser utility, commit &#123;$version&#125;"</span>, PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prints a usage message.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_usage</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">global</span> $scriptname;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'Usage: php '</span>.$scriptname.<span class="string">' [options] &lt;file|folder&gt;'</span>, PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prints a help message.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">print_help</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'Options:'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -h, --help                 Display help message'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -v, --version              Display version information'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -f, --format &lt;format&gt;      Format to use for the output files: "jexp" (default), "neo4j", or "graphml"'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -n, --nodes &lt;file&gt;         Output file for nodes (for CSV output, i.e., neo4j or jexp modes)'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -r, --relationships &lt;file&gt; Output file for relationships (for CSV output, i.e., jexp or neo4j modes)'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -o, --out &lt;file&gt;           Output file for entire graph (for XML output, i.e., graphml mode)'</span>, PHP_EOL;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'  -c, --count &lt;number&gt;       Initial value of node counter (defaults to 0)'</span>, PHP_EOL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parses and generates an AST for a single file.</span></span><br><span class="line"><span class="comment"> * 为单个php文件解析ast</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $path     Path to the file</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $exporter An Exporter instance to use for exporting</span></span><br><span class="line"><span class="comment"> *                  the AST of the parsed file.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The node index of the exported file node, or -1 if there</span></span><br><span class="line"><span class="comment"> *         was an error.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_file</span><span class="params">( $path, $exporter)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  $finfo = <span class="keyword">new</span> SplFileInfo( $path);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Parsing file "</span>, $finfo-&gt;getPathname(), PHP_EOL;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ast\parse_file()是指php-ast工具，会生成一个ast树</span></span><br><span class="line">    $ast = ast\parse_file( $path, $version = <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The above may throw a ParseError. We only export to the output</span></span><br><span class="line">    <span class="comment">// file(s) if that didn't happen.</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * $exporter-&gt;store_filenode的返回值是fileSystem(type=file)节点的id，store_filenode()函数的作用是存储file节点的</span></span><br><span class="line"><span class="comment">       * 因此$fnode 就是返回的fileSystem(type=File)节点对应的id</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    $fnode = $exporter-&gt;store_filenode( $finfo-&gt;getFilename());</span><br><span class="line">    <span class="comment">// 处理AST(type=AST_TOPLEVEL)节点</span></span><br><span class="line">    $tnode = $exporter-&gt;store_toplevelnode( Exporter::TOPLEVEL_FILE, $path, <span class="number">1</span>, count(file($path)));</span><br><span class="line">    <span class="comment">// 处理ast中的其余节点</span></span><br><span class="line">    $astroot = $exporter-&gt;export( $ast, $tnode);</span><br><span class="line">    <span class="comment">// 存储关系边</span></span><br><span class="line">    $exporter-&gt;store_rel( $tnode, $astroot, <span class="string">"PARENT_OF"</span>);</span><br><span class="line">    $exporter-&gt;store_rel( $fnode, $tnode, <span class="string">"FILE_OF"</span>);</span><br><span class="line">    <span class="comment">//echo ast_dump( $ast), PHP_EOL;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>( ParseError $e) &#123;</span><br><span class="line">    $fnode = <span class="number">-1</span>;</span><br><span class="line">    error_log( <span class="string">"[ERROR] In $path: "</span>.$e-&gt;getMessage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回的$fnode是一个数值，为Filesystem(type=File)节点的id</span></span><br><span class="line">  <span class="keyword">return</span> $fnode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parses and generates ASTs for all PHP files buried within a</span></span><br><span class="line"><span class="comment"> * directory.</span></span><br><span class="line"><span class="comment"> * parse_dir()也还是通过parse_file()函数来解析单个文件的</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $path     Path to the directory</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $exporter An Exporter instance to use for exporting</span></span><br><span class="line"><span class="comment"> *                  the ASTs of all parsed files.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $exporter 决定了ast是用什么格式导出的</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $top      Boolean indicating whether this call</span></span><br><span class="line"><span class="comment"> *                  corresponds to the top-level call of the</span></span><br><span class="line"><span class="comment"> *                  function. We wouldn't need this if I didn't</span></span><br><span class="line"><span class="comment"> *                  insist on the root directory of a project</span></span><br><span class="line"><span class="comment"> *                  getting node index 0. But, I do insist.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $top      top变量用来判定当前目录是否是最外层目录</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> If the directory corresponding to the function call finds</span></span><br><span class="line"><span class="comment"> *         itself interesting, it stores a directory node for itself</span></span><br><span class="line"><span class="comment"> *         and this function returns the index of that</span></span><br><span class="line"><span class="comment"> *         node. Otherwise, returns -1. A directory finds itself</span></span><br><span class="line"><span class="comment"> *         interesting if it contains PHP files, or if one of its</span></span><br><span class="line"><span class="comment"> *         child directories finds itself interesting. -- As a special</span></span><br><span class="line"><span class="comment"> *         case, the root directory of a project (corresponding to the</span></span><br><span class="line"><span class="comment"> *         top-level call) always finds itself interesting and always</span></span><br><span class="line"><span class="comment"> *         stores a directory node for itself.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 在没解析错误的情况下，最后的返回结果是当前遍历目录对应的目录节点id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_dir</span><span class="params">( $path, $exporter, $top = true)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// save any interesting directory/file indices in the current folder</span></span><br><span class="line">  $found = [];</span><br><span class="line">  <span class="comment">// if the current folder finds itself interesting, we will create a</span></span><br><span class="line">  <span class="comment">// directory node for it and return its index</span></span><br><span class="line">    <span class="comment">// 为最顶层目录也创建一个directory node，也是Filesystem，但是type=Directory，并且返回它对应id，一般情况下最顶层id=0</span></span><br><span class="line">  $dirnode = $top ? $exporter-&gt;store_dirnode( basename( $path)) : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// opendir()函数打开一个目录句柄</span></span><br><span class="line">  $dhandle = opendir( $path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// iterate over everything in the current folder</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * readdir()函数：返回目录中下一个文件的文件名。文件名以在文件系统中的排序返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string|false the filename on success or false on failure.</span></span><br><span class="line"><span class="comment">     * 返回值：成功则返回文件名 或者在失败时返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 循环遍历目录下的内容</span></span><br><span class="line">  <span class="keyword">while</span>( <span class="keyword">false</span> !== ($filename = readdir( $dhandle))) &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * SplFileInfo:</span></span><br><span class="line"><span class="comment">       * The SplFileInfo class offers a high-level object oriented interface to information for an individual file.</span></span><br><span class="line"><span class="comment">       * SplFileInfo类是为单个文件的信息提供高级面向对象的接口，它可以用来获取文件详细信息</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    $finfo = <span class="keyword">new</span> SplFileInfo( build_path( $path, $filename));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * SplFileInfo::isFile ( void ) : bool    判断对象是否引用了常规文件</span></span><br><span class="line"><span class="comment">       * SplFIleInfo::isReadable ( void ) : bool    判断文件是否可读</span></span><br><span class="line"><span class="comment">       * SplFileInfo::getExtension ( void ) : string    获取文件扩展名</span></span><br><span class="line"><span class="comment">       * SplFileInfo::getPathname ( void ) : string    //获取文件的路径</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    <span class="keyword">if</span>( $finfo-&gt;isFile() &amp;&amp; $finfo-&gt;isReadable() &amp;&amp; in_array( strtolower( $finfo-&gt;getExtension()), [<span class="string">'php'</span>,<span class="string">'inc'</span>,<span class="string">'phar'</span>]))</span><br><span class="line">      <span class="comment">// 调用parse_file()函数来解析单文件，将解析了的文件存储在$found数组中</span></span><br><span class="line">        $found[] = parse_file( $finfo-&gt;getPathname(), $exporter);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( $finfo-&gt;isDir() &amp;&amp; $finfo-&gt;isReadable() &amp;&amp; $filename !== <span class="string">'.'</span> &amp;&amp; $filename !== <span class="string">'..'</span>)</span><br><span class="line">        <span class="comment">// 处理多层目录的情况，递归调用parse_dir()</span></span><br><span class="line">      <span class="keyword">if</span>( <span class="number">-1</span> !== ($childdir = parse_dir( $finfo-&gt;getPathname(), $exporter, <span class="keyword">false</span>)))</span><br><span class="line">        $found[] = $childdir;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the current folder finds itself interesting...</span></span><br><span class="line">  <span class="keyword">if</span>( !<span class="keyword">empty</span>( $found)) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !$top)</span><br><span class="line">        <span class="comment">// 如果不是最顶层（外层）目录，另外分配id</span></span><br><span class="line">      $dirnode = $exporter-&gt;store_dirnode( basename( $path));</span><br><span class="line">    <span class="keyword">foreach</span>( $found <span class="keyword">as</span> $i =&gt; $nodeindex)</span><br><span class="line">      $exporter-&gt;store_rel( $dirnode, $nodeindex, <span class="string">"DIRECTORY_OF"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  closedir( $dhandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后的返回结果是，当前遍历的目录，比如有目录a/b/，当前遍历深度在目录b/，那么返回的$dirnode节点id也就是目录b/对应的Filesystem(type=Directory)节点id</span></span><br><span class="line"><span class="comment">     * 但是递归调用结束后，返回的最外层目录的id肯定为0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">return</span> $dirnode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Builds a file path with the appropriate directory separator.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ...$segments Unlimited number of path segments.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The file path built from the path segments.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">build_path</span><span class="params">( ...$segments)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> join( DIRECTORY_SEPARATOR, $segments);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Main script</span></span><br><span class="line"><span class="comment"> * 主程序，程序入口处</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// parse_arguments()函数会先检查传入的参数是否正确</span></span><br><span class="line"><span class="keyword">if</span>( parse_arguments() === <span class="keyword">false</span>) &#123;</span><br><span class="line">  print_usage();</span><br><span class="line">  <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">  print_help();</span><br><span class="line">  <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check that source exists and is readable</span></span><br><span class="line"><span class="comment">// 然后检查文件是否存在，存在的情况下是否可读，如果不存在或是不可读，exit</span></span><br><span class="line"><span class="keyword">if</span>( !file_exists( $path) || !is_readable( $path)) &#123;</span><br><span class="line">  error_log( <span class="string">'[ERROR] The given path does not exist or cannot be read.'</span>);</span><br><span class="line">  <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exporter = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// Determine whether source is a file or a directory</span></span><br><span class="line"><span class="comment">// 判断需要解析的文件是单文件还是目录</span></span><br><span class="line"><span class="keyword">if</span>( is_file( $path)) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( $format === Exporter::GRAPHML_FORMAT)</span><br><span class="line">        <span class="comment">// 确定用什么格式来导出ast，GraphML format有很多工具支持</span></span><br><span class="line">      $exporter = <span class="keyword">new</span> GraphMLExporter( $outfile, $startcount);</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// either NEO4J_FORMAT or JEXP_FORMAT</span></span><br><span class="line">      $exporter = <span class="keyword">new</span> CSVExporter( $format, $nodefile, $relfile, $startcount);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出格式为NEO4J_FORMAT，neo4j-import工具可用</span></span><br><span class="line"><span class="comment">     * 导出格式为JEXP_FORMAT，batch-import工具可用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>( IOError $e) &#123;</span><br><span class="line">    error_log( <span class="string">"[ERROR] "</span>.$e-&gt;getMessage());</span><br><span class="line">    <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  parse_file( $path, $exporter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>( is_dir( $path)) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( $format === Exporter::GRAPHML_FORMAT)</span><br><span class="line">      $exporter = <span class="keyword">new</span> GraphMLExporter( $outfile, $startcount);</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// either NEO4J_FORMAT or JEXP_FORMAT</span></span><br><span class="line">      $exporter = <span class="keyword">new</span> CSVExporter( $format, $nodefile, $relfile, $startcount);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>( IOError $e) &#123;</span><br><span class="line">    error_log( <span class="string">"[ERROR] "</span>.$e-&gt;getMessage());</span><br><span class="line">    <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析目录</span></span><br><span class="line">  parse_dir( $path, $exporter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  error_log( <span class="string">'[ERROR] The given path is neither a regular file nor a directory.'</span>);</span><br><span class="line">  <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Done."</span>, PHP_EOL;</span><br></pre></td></tr></table></figure>

<h4 id="拆解分析：主程序"><a href="#拆解分析：主程序" class="headerlink" title="拆解分析：主程序"></a>拆解分析：主程序</h4><p>我们先厘清程序的主要逻辑。</p>
<p>首先是程序入口部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Main script</span></span><br><span class="line"><span class="comment"> * 主程序，程序入口处</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// parse_arguments()函数会先检查传入的参数是否正确</span></span><br><span class="line"><span class="keyword">if</span>( parse_arguments() === <span class="keyword">false</span>) &#123;</span><br><span class="line">  print_usage();</span><br><span class="line">  <span class="keyword">echo</span> PHP_EOL;</span><br><span class="line">  print_help();</span><br><span class="line">  <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check that source exists and is readable</span></span><br><span class="line"><span class="comment">// 然后检查文件是否存在，存在的情况下是否可读，如果不存在或是不可读，exit</span></span><br><span class="line"><span class="keyword">if</span>( !file_exists( $path) || !is_readable( $path)) &#123;</span><br><span class="line">  error_log( <span class="string">'[ERROR] The given path does not exist or cannot be read.'</span>);</span><br><span class="line">  <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exporter = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// Determine whether source is a file or a directory</span></span><br><span class="line"><span class="comment">// 判断需要解析的文件是目录还是单一文件</span></span><br><span class="line"><span class="keyword">if</span>( is_file( $path)) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( $format === Exporter::GRAPHML_FORMAT)</span><br><span class="line">      $exporter = <span class="keyword">new</span> GraphMLExporter( $outfile, $startcount);</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// either NEO4J_FORMAT or JEXP_FORMAT</span></span><br><span class="line">      $exporter = <span class="keyword">new</span> CSVExporter( $format, $nodefile, $relfile, $startcount);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>( IOError $e) &#123;</span><br><span class="line">    error_log( <span class="string">"[ERROR] "</span>.$e-&gt;getMessage());</span><br><span class="line">    <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  parse_file( $path, $exporter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span>( is_dir( $path)) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( $format === Exporter::GRAPHML_FORMAT)</span><br><span class="line">      $exporter = <span class="keyword">new</span> GraphMLExporter( $outfile, $startcount);</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// either NEO4J_FORMAT or JEXP_FORMAT</span></span><br><span class="line">      $exporter = <span class="keyword">new</span> CSVExporter( $format, $nodefile, $relfile, $startcount);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>( IOError $e) &#123;</span><br><span class="line">    error_log( <span class="string">"[ERROR] "</span>.$e-&gt;getMessage());</span><br><span class="line">    <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析目录</span></span><br><span class="line">  parse_dir( $path, $exporter);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  error_log( <span class="string">'[ERROR] The given path is neither a regular file nor a directory.'</span>);</span><br><span class="line">  <span class="keyword">exit</span>( <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Done."</span>, PHP_EOL;</span><br></pre></td></tr></table></figure>

<p>用流程图来表示为：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/parser.svg" alt="parser"></p>
<ol>
<li><p>首先调用<code>parse_arguments()</code>检查传入的参数是否正确。</p>
</li>
<li><p>在传入参数正常的情况下，检查需要解析的目标文件是否存在及其可读性。</p>
</li>
<li><p>然后通过下面的<code>if-else</code>条件句来处理单文件或是目录：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( is_file( $path)) &#123;</span><br><span class="line">    set $exporter</span><br><span class="line">    parse_file( $path, $exporter);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (is_dir( $path)) &#123;</span><br><span class="line">    set $exporter</span><br><span class="line">    parse_dir( $path, $exporter);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行完<code>parse_file</code>或是<code>parse_dir</code>函数之后，如果没有问题，输出<code>Done.</code>，程序结束。</p>
</li>
</ol>
<h4 id="SplFileInfo文件处理类"><a href="#SplFileInfo文件处理类" class="headerlink" title="SplFileInfo文件处理类"></a>SplFileInfo文件处理类</h4><p>因为后面<code>parse_dir()</code>和<code>parse_file()</code>函数都会用到这个文件操作类，所以先看一下该类的主要作用。根据官方手册：<a href="https://www.php.net/manual/en/class.splfileinfo.php" target="_blank" rel="noopener">https://www.php.net/manual/en/class.splfileinfo.php</a> ，<code>SplFileInfo</code>的主要方法及其作用为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SplFileInfo &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> __construct ( string $file_name )</span><br><span class="line">    <span class="keyword">public</span> getATime ( void ) : int    <span class="comment">//获取文件的上次访问时间</span></span><br><span class="line">    <span class="keyword">public</span> getBasename ([ string $suffix ] ) : string    <span class="comment">//获取文件的基本名称</span></span><br><span class="line">    <span class="keyword">public</span> getCTime ( void ) : int    <span class="comment">//获取文件 inode 修改时间</span></span><br><span class="line">    <span class="keyword">public</span> getExtension ( void ) : string    <span class="comment">//获取文件扩展名</span></span><br><span class="line">    <span class="keyword">public</span> getFileInfo ([ string $class_name ] ) : SplFileInfo    <span class="comment">//获取文件的SplFileInfo对象</span></span><br><span class="line">    <span class="keyword">public</span> getFilename ( void ) : string    <span class="comment">//获取文件名</span></span><br><span class="line">    <span class="keyword">public</span> getGroup ( void ) : int    <span class="comment">//获取文件组</span></span><br><span class="line">    <span class="keyword">public</span> getInode ( void ) : int    <span class="comment">//获取文件的inode</span></span><br><span class="line">    <span class="keyword">public</span> getLinkTarget ( void ) : string    <span class="comment">//获取链接的目标</span></span><br><span class="line">    <span class="keyword">public</span> getMTime ( void ) : int    <span class="comment">//获取上次修改时间</span></span><br><span class="line">    <span class="keyword">public</span> getOwner ( void ) : int    <span class="comment">//获取文件的所有者</span></span><br><span class="line">    <span class="keyword">public</span> getPath ( void ) : string    <span class="comment">//获取没有文件名的路径</span></span><br><span class="line">    <span class="keyword">public</span> getPathInfo ([ string $class_name ] ) : SplFileInfo    <span class="comment">//获取路径的SplFileInfo对象</span></span><br><span class="line">    <span class="keyword">public</span> getPathname ( void ) : string    <span class="comment">//获取文件的路径</span></span><br><span class="line">    <span class="keyword">public</span> getPerms ( void ) : int    <span class="comment">//获取文件权限</span></span><br><span class="line">    <span class="keyword">public</span> getRealPath ( void ) : string    <span class="comment">//获取文件的绝对路径</span></span><br><span class="line">    <span class="keyword">public</span> getSize ( void ) : int    <span class="comment">//获取文件大小</span></span><br><span class="line">    <span class="keyword">public</span> getType ( void ) : string    <span class="comment">//获取文件类型</span></span><br><span class="line">    <span class="keyword">public</span> isDir ( void ) : bool    <span class="comment">//判断文件是否是目录</span></span><br><span class="line">    <span class="keyword">public</span> isExecutable ( void ) : bool    <span class="comment">//判断文件是否可执行</span></span><br><span class="line">    <span class="keyword">public</span> isFile ( void ) : bool    <span class="comment">//判断对象是否引用了常规文件</span></span><br><span class="line">    <span class="keyword">public</span> isLink ( void ) : bool    <span class="comment">//判断文件是否为链接</span></span><br><span class="line">    <span class="keyword">public</span> isReadable ( void ) : bool    <span class="comment">//判断文件是否可读</span></span><br><span class="line">    <span class="keyword">public</span> isWritable ( void ) : bool    <span class="comment">//判断条目是否可写</span></span><br><span class="line">    <span class="keyword">public</span> openFile ([ string $open_mode = <span class="string">"r"</span> [, bool $use_include_path = <span class="keyword">FALSE</span> [, resource $context = <span class="keyword">NULL</span> ]]] ) : SplFileObject    <span class="comment">//获取文件的SplFileObject对象</span></span><br><span class="line">    <span class="keyword">public</span> setFileClass ([ string $class_name = <span class="string">"SplFileObject"</span> ] ) : void    <span class="comment">//设置与SplFileInfo :: openFile一起使用的类</span></span><br><span class="line">    <span class="keyword">public</span> setInfoClass ([ string $class_name = <span class="string">"SplFileInfo"</span> ] ) : void    <span class="comment">//设置与SplFileInfo :: getFileInfo和SplFileInfo :: getPathInfo一起使用的类</span></span><br><span class="line">    <span class="keyword">public</span> __toString ( void ) : string    <span class="comment">//以字符串形式返回文件的路径</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="拆解分析：parse-file"><a href="#拆解分析：parse-file" class="headerlink" title="拆解分析：parse_file()"></a>拆解分析：parse_file()</h4><p><code>parse_file()</code>函数会为单个php文件生成ast，它接受两个参数：</p>
<blockquote>
<p>$path：需要解析的文件的路径</p>
<p>$exporter：$exporter决定了导出ast的format</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_file</span><span class="params">( $path, $exporter)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  $finfo = <span class="keyword">new</span> SplFileInfo( $path);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"Parsing file "</span>, $finfo-&gt;getPathname(), PHP_EOL;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ast\parse_file()是指php-ast工具，会生成一个ast树</span></span><br><span class="line">    $ast = ast\parse_file( $path, $version = <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The above may throw a ParseError. We only export to the output</span></span><br><span class="line">    <span class="comment">// file(s) if that didn't happen.</span></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * $exporter-&gt;store_filenode的返回值是fileSystem(type=file)节点的id，store_filenode()函数的作用是存储file节点的</span></span><br><span class="line"><span class="comment">       * 因此$fnode 就是返回的fileSystem(type=File)节点对应的id</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    $fnode = $exporter-&gt;store_filenode( $finfo-&gt;getFilename());</span><br><span class="line">    <span class="comment">// 处理AST(type=AST_TOPLEVEL)节点</span></span><br><span class="line">    $tnode = $exporter-&gt;store_toplevelnode( Exporter::TOPLEVEL_FILE, $path, <span class="number">1</span>, count(file($path)));</span><br><span class="line">    <span class="comment">// 处理ast中的其余节点</span></span><br><span class="line">    $astroot = $exporter-&gt;export( $ast, $tnode);</span><br><span class="line">    <span class="comment">// 存储关系边</span></span><br><span class="line">    $exporter-&gt;store_rel( $tnode, $astroot, <span class="string">"PARENT_OF"</span>);</span><br><span class="line">    $exporter-&gt;store_rel( $fnode, $tnode, <span class="string">"FILE_OF"</span>);</span><br><span class="line">    <span class="comment">//echo ast_dump( $ast), PHP_EOL;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span>( ParseError $e) &#123;</span><br><span class="line">    $fnode = <span class="number">-1</span>;</span><br><span class="line">    error_log( <span class="string">"[ERROR] In $path: "</span>.$e-&gt;getMessage());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回的$fnode是一个数值，为Filesystem(type=File)节点的id</span></span><br><span class="line">  <span class="keyword">return</span> $fnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的主要处理步骤是这样的：</p>
<ol>
<li>首先利用<strong>php-ast</strong>工具中的<code>ast\parse_file()</code>来解析php文件，生成ast。</li>
<li>然后分别存储文件根节点Filesystem(type=File)和toplevel节点AST(type=AST_TOPLEVEL)，因为这两个节点相较其他节点比较特殊。它们在数据库中存储的信息数量和其他节点不相同。</li>
<li>然后递归处理其他节点。</li>
<li>最后调用<code>$exporter-&gt;store_rel</code>存储关系边。</li>
<li>返回<code>$fnode</code>，即文件节点Filesystem(type=File)对应的id。</li>
</ol>
<h4 id="拆解分析：parse-dir"><a href="#拆解分析：parse-dir" class="headerlink" title="拆解分析：parse_dir()"></a>拆解分析：parse_dir()</h4><p><code>parse_dir()</code>函数接受三个参数：</p>
<blockquote>
<p>$path：需要解析的文件的路径</p>
<p>$exporter：$exporter决定了导出ast的format</p>
<p>$top：用来标识是不是最外层的目录</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_dir</span><span class="params">( $path, $exporter, $top = true)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// save any interesting directory/file indices in the current folder</span></span><br><span class="line">  $found = [];</span><br><span class="line">  <span class="comment">// if the current folder finds itself interesting, we will create a</span></span><br><span class="line">  <span class="comment">// directory node for it and return its index</span></span><br><span class="line">    <span class="comment">// 为最顶层目录也创建一个directory node，也是Filesystem，但是type=Directory，并且返回它对应id，一般情况下最顶层id=0</span></span><br><span class="line">  $dirnode = $top ? $exporter-&gt;store_dirnode( basename( $path)) : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// opendir()函数打开一个目录句柄</span></span><br><span class="line">  $dhandle = opendir( $path);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// iterate over everything in the current folder</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * readdir()函数：返回目录中下一个文件的文件名。文件名以在文件系统中的排序返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string|false the filename on success or false on failure.</span></span><br><span class="line"><span class="comment">     * 返回值：成功则返回文件名 或者在失败时返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 循环遍历目录下的内容</span></span><br><span class="line">  <span class="keyword">while</span>( <span class="keyword">false</span> !== ($filename = readdir( $dhandle))) &#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * SplFileInfo:</span></span><br><span class="line"><span class="comment">       * The SplFileInfo class offers a high-level object oriented interface to information for an individual file.</span></span><br><span class="line"><span class="comment">       * SplFileInfo类是为单个文件的信息提供高级面向对象的接口，它可以用来获取文件详细信息</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    $finfo = <span class="keyword">new</span> SplFileInfo( build_path( $path, $filename));</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * SplFileInfo::isFile ( void ) : bool    判断对象是否引用了常规文件</span></span><br><span class="line"><span class="comment">       * SplFIleInfo::isReadable ( void ) : bool    判断文件是否可读</span></span><br><span class="line"><span class="comment">       * SplFileInfo::getExtension ( void ) : string    获取文件扩展名</span></span><br><span class="line"><span class="comment">       * SplFileInfo::getPathname ( void ) : string    //获取文件的路径</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    <span class="keyword">if</span>( $finfo-&gt;isFile() &amp;&amp; $finfo-&gt;isReadable() &amp;&amp; in_array( strtolower( $finfo-&gt;getExtension()), [<span class="string">'php'</span>,<span class="string">'inc'</span>,<span class="string">'phar'</span>]))</span><br><span class="line">      <span class="comment">// 调用parse_file()函数来解析单文件，将解析了的文件存储在$found数组中</span></span><br><span class="line">        $found[] = parse_file( $finfo-&gt;getPathname(), $exporter);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( $finfo-&gt;isDir() &amp;&amp; $finfo-&gt;isReadable() &amp;&amp; $filename !== <span class="string">'.'</span> &amp;&amp; $filename !== <span class="string">'..'</span>)</span><br><span class="line">        <span class="comment">// 处理多层目录的情况，递归调用parse_dir()</span></span><br><span class="line">      <span class="keyword">if</span>( <span class="number">-1</span> !== ($childdir = parse_dir( $finfo-&gt;getPathname(), $exporter, <span class="keyword">false</span>)))</span><br><span class="line">        $found[] = $childdir;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// if the current folder finds itself interesting...</span></span><br><span class="line">  <span class="keyword">if</span>( !<span class="keyword">empty</span>( $found)) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !$top)</span><br><span class="line">        <span class="comment">// 如果不是最顶层（外层）目录，另外分配id</span></span><br><span class="line">      $dirnode = $exporter-&gt;store_dirnode( basename( $path));</span><br><span class="line">    <span class="keyword">foreach</span>( $found <span class="keyword">as</span> $i =&gt; $nodeindex)</span><br><span class="line">      $exporter-&gt;store_rel( $dirnode, $nodeindex, <span class="string">"DIRECTORY_OF"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  closedir( $dhandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最后的返回结果是，当前遍历的目录，比如有目录a/b/，当前遍历深度在目录b/，那么返回的$dirnode节点id也就是目录b/对应的Filesystem(type=Directory)节点id</span></span><br><span class="line"><span class="comment">     * 但是递归调用结束后，返回的最外层目录的id肯定为0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="keyword">return</span> $dirnode;</span><br></pre></td></tr></table></figure>

<p>用流程图来表示为parse_dir()的处理逻辑为（随便画的，一点儿也不规范…）：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/parse_dir.svg" alt="parse_dir"></p>
<p>下面这行代码会创建一个directory节点，返回值是int类型的数字来唯一标识这个directory节点：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$dirnode = $top ? $exporter-&gt;store_dirnode( basename( $path)) : <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<p>下图中的中心节点就是整个CPG图的最顶点节点，类型是<code>Filesystem</code>，它有三个子节点，这三个子节点分别对应它目录下的文件：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/6.png" alt="6"></p>
<h3 id="src-Exporter-php"><a href="#src-Exporter-php" class="headerlink" title="src/Exporter.php"></a>src/Exporter.php</h3><p><strong>Exporter</strong>类是<strong>CSVExporter</strong>类和<strong>GraphMLExporter</strong>类的父类。在phpstorm中查看它们的继承关系：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/5.png" alt="5"></p>
<h4 id="类常量和类变量"><a href="#类常量和类变量" class="headerlink" title="类常量和类变量"></a>类常量和类变量</h4><p>在<code>src/Exporter.php</code>中定义了一些常量，主要是和导出格式或者节点的属性相关的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Constant for Neo4J format (to be used with neo4j-import) */</span></span><br><span class="line"><span class="keyword">const</span> NEO4J_FORMAT = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** Constant for jexp format (to be used with batch-import) */</span></span><br><span class="line"><span class="keyword">const</span> JEXP_FORMAT = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** Constant for GraphML format (supported by many tools) */</span></span><br><span class="line"><span class="keyword">const</span> GRAPHML_FORMAT = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Labels */</span></span><br><span class="line"><span class="keyword">const</span> LABEL_FS = <span class="string">"Filesystem"</span>;</span><br><span class="line"><span class="keyword">const</span> LABEL_AST = <span class="string">"AST"</span>;</span><br><span class="line"><span class="keyword">const</span> LABEL_ART = <span class="string">"Artificial"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Type of directory nodes */</span></span><br><span class="line"><span class="keyword">const</span> DIR = <span class="string">"Directory"</span>;</span><br><span class="line"><span class="comment">/** Type of file nodes */</span></span><br><span class="line"><span class="keyword">const</span> FILE = <span class="string">"File"</span>;</span><br><span class="line"><span class="comment">/** Type of toplevel nodes */</span></span><br><span class="line"><span class="keyword">const</span> TOPLEVEL = <span class="string">"AST_TOPLEVEL"</span>;</span><br><span class="line"><span class="comment">/** Flags for toplevel nodes */</span></span><br><span class="line"><span class="keyword">const</span> TOPLEVEL_FILE = <span class="string">"TOPLEVEL_FILE"</span>;</span><br><span class="line"><span class="keyword">const</span> TOPLEVEL_CLASS = <span class="string">"TOPLEVEL_CLASS"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Type of entry and exit nodes (for CFG construction) */</span></span><br><span class="line"><span class="keyword">const</span> FUNC_ENTRY = <span class="string">"CFG_FUNC_ENTRY"</span>;</span><br><span class="line"><span class="keyword">const</span> FUNC_EXIT = <span class="string">"CFG_FUNC_EXIT"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Delimiter for arrays, used by format_flags() */</span></span><br><span class="line"><span class="keyword">protected</span> $array_delim = <span class="string">";"</span>;</span><br></pre></td></tr></table></figure>

<p>还有一个变量<code>$nodecount</code>作为id计数器：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Node counter */</span></span><br><span class="line"><span class="keyword">protected</span> $nodecount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h4 id="store-filenode"><a href="#store-filenode" class="headerlink" title="store_filenode()"></a>store_filenode()</h4><p><code>store_filenode()</code>函数接受一个文件名<code>$filename</code>作为参数，它的作用是存储一个file 节点，调用的是同类的<code>store_node()</code>方法，该方法会返回一个<code>id</code>(int类型的返回值)，这个id将用来唯一标识该file 节点：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store_filenode</span><span class="params">( $filename)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_FS, <span class="keyword">self</span>::FILE, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;quote_and_escape( $filename), <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="store-toplevelnode"><a href="#store-toplevelnode" class="headerlink" title="store_toplevelnode()"></a>store_toplevelnode()</h4><p>在处理完toplevel节点之后，还会把两个比较特殊的节点，cfg图的entry节点和exit节点也存进结果中。因为这两个节点并不出现在php-ast解析的ast树中，是在<code>store_toplevelnode</code>中额外添加上的。然后还要调用<code>store_rel()</code>处理关系边：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store_toplevelnode</span><span class="params">( $flag, $name, $lineno, $endlineno, $childnum = null, $funcid = null, $namespace = null)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先处理toplevel节点</span></span><br><span class="line">    $tnode = <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_AST, <span class="keyword">self</span>::TOPLEVEL, $flag, $lineno, <span class="keyword">null</span>, $childnum, $funcid, <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;quote_and_escape( $namespace), $endlineno, <span class="keyword">$this</span>-&gt;quote_and_escape( $name), <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For toplevel nodes, we create artificial entry and exit nodes (like file and dir nodes,</span></span><br><span class="line">    <span class="comment">// they are not actually part of the AST).</span></span><br><span class="line">    <span class="comment">// For the entry and exit nodes, we only set</span></span><br><span class="line">    <span class="comment">// (1) the funcid (to the id of the toplevel node), and</span></span><br><span class="line">    <span class="comment">// (2) the name (to that of the file or class)</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 在处理了toplevel节点（toplevel节点是AST类型的）之后，还会处理两个artificial节点，分别是entry node和exit node</span></span><br><span class="line"><span class="comment">       * 一个Artificial节点存储的信息是这样的： name: case1_optimize/1.php      id: 4     type: CFG_FUNC_EXIT     funcid: 2</span></span><br><span class="line"><span class="comment">       * type分别为self::FUNC_ENTRY和self::EXIT</span></span><br><span class="line"><span class="comment">       * name是文件名</span></span><br><span class="line"><span class="comment">       * funcid比较特殊，是其toplevel节点的id</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">    $entrynode = <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_ART, <span class="keyword">self</span>::FUNC_ENTRY, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, $tnode, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;quote_and_escape( $name), <span class="keyword">null</span>);</span><br><span class="line">    $exitnode = <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_ART, <span class="keyword">self</span>::FUNC_EXIT, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, $tnode, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;quote_and_escape( $name), <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// 将toplevel节点 和entry节点 的关系边连起来，关系是ENTRY</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;store_rel( $tnode, $entrynode, <span class="string">"ENTRY"</span>);</span><br><span class="line">    <span class="comment">// 将toplevel节点 和exit节点 的关系边连起来，关系是EXIT</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;store_rel( $tnode, $exitnode, <span class="string">"EXIT"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $tnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="store-node"><a href="#store-node" class="headerlink" title="store_node()"></a>store_node()</h4><p>在类<strong>Exporter</strong>中，<code>store_node()</code>函数是一个抽象函数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">store_node</span><span class="params">( $label, $type, $flags, $lineno, $code = null, $childnum = null, $funcid = null, $classname = null, $namespace = null, $endlineno = null, $name = null, $doccomment = null, $fileid = null)</span> : <span class="title">int</span></span>;</span><br></pre></td></tr></table></figure>

<p>在<code>src/CSVExporter.php</code>中，<code>store_node()</code>具体实现为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">store_node</span><span class="params">( $label, $type, $flags, $lineno, $code = null, $childnum = null, $funcid = null, $classname = null, $namespace = null, $endlineno = null, $name = null, $doccomment = null)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    fwrite( <span class="keyword">$this</span>-&gt;nhandle, <span class="string">"&#123;$this-&gt;nodecount&#125;&#123;$this-&gt;csv_delim&#125;&#123;$label&#125;&#123;$this-&gt;csv_delim&#125;&#123;$type&#125;&#123;$this-&gt;csv_delim&#125;&#123;$flags&#125;&#123;$this-&gt;csv_delim&#125;&#123;$lineno&#125;&#123;$this-&gt;csv_delim&#125;&#123;$code&#125;&#123;$this-&gt;csv_delim&#125;&#123;$childnum&#125;&#123;$this-&gt;csv_delim&#125;&#123;$funcid&#125;&#123;$this-&gt;csv_delim&#125;&#123;$classname&#125;&#123;$this-&gt;csv_delim&#125;&#123;$namespace&#125;&#123;$this-&gt;csv_delim&#125;&#123;$endlineno&#125;&#123;$this-&gt;csv_delim&#125;&#123;$name&#125;&#123;$this-&gt;csv_delim&#125;&#123;$doccomment&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return the current node index, *then* increment it</span></span><br><span class="line">    <span class="comment">// $this-&gt;nodecount 记录当前的id，id是可以唯一标记一个节点的</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;nodecount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它实现了父类Exporter中的抽象方法store_node()，并且会将需要的信息写入csv文件中。同时，需要将id计数器<strong>nodecount</strong>增加一个单位，并将其作为函数返回值返回。</p>
<h4 id="store-rel"><a href="#store-rel" class="headerlink" title="store_rel()"></a>store_rel()</h4><p>同样的，<code>Exporter::store_rel()</code>也是一个抽象函数，在<strong>GraphMLExporter</strong>类和<strong>CSVExporter</strong>类中有不同的定义。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store_rel</span><span class="params">( $start, $end, $type)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>CSVExporter::store_rel()</code>函数实现为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store_rel</span><span class="params">( $start, $end, $type)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    fwrite( <span class="keyword">$this</span>-&gt;rhandle, <span class="string">"&#123;$start&#125;&#123;$this-&gt;csv_delim&#125;&#123;$end&#125;&#123;$this-&gt;csv_delim&#125;&#123;$type&#125;\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会存储节点之间的关系，参数<code>$type</code>就是relationship，比如<code>PARENT_OF, ENTRY, EXIT</code>。</p>
<h4 id="export"><a href="#export" class="headerlink" title="export()"></a>export()</h4><p>phpjoern处理ast树的file节点和toplevel节点是分别在<code>store_filenode()</code>和<code>store_toplevel()</code>函数中完成的，ast树的其余部分主体则是在<code>export()</code>中处理的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">export</span><span class="params">( $ast, $funcid, $nodeline = <span class="number">0</span>, $childname = <span class="string">""</span>, $childnum = <span class="number">0</span>, $namespace = <span class="string">""</span>, $uses = [], $classname = <span class="string">""</span>)</span> : <span class="title">int</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (1) if $ast is an AST node, print info and recurse</span></span><br><span class="line">    <span class="comment">// An instance of ast\Node declares:</span></span><br><span class="line">    <span class="comment">// $kind (integer, name can be retrieved using ast\get_kind_name())</span></span><br><span class="line">    <span class="comment">// $flags (integer, corresponding to a set of flags for the current node)</span></span><br><span class="line">    <span class="comment">// $lineno (integer, starting line number)</span></span><br><span class="line">    <span class="comment">// $children (array of child nodes)</span></span><br><span class="line">    <span class="comment">// Additionally, an instance of the subclass ast\Node\Decl declares:</span></span><br><span class="line">    <span class="comment">// $endLineno (integer, end line number of the declaration)</span></span><br><span class="line">    <span class="comment">// $name (string, the name of the declared function/class)</span></span><br><span class="line">    <span class="comment">// $docComment (string, the preceding doc comment)</span></span><br><span class="line">    <span class="comment">// 首先处理最普遍的情况：当前节点是AST类型的</span></span><br><span class="line">    <span class="keyword">if</span>( $ast <span class="keyword">instanceof</span> ast\Node) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * function get_kind_name(int $kind): string &#123;&#125;</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> int $kind AST_* constant value defining the kind of an AST node</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> string String representation of AST kind value</span></span><br><span class="line"><span class="comment">         * 该函数会根据$kind值返回一个string, 该string对应特定的type，即$kind是和type对应的</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        $nodetype = ast\get_kind_name( $ast-&gt;kind);</span><br><span class="line">        $nodeline = $ast-&gt;lineno;</span><br><span class="line"></span><br><span class="line">        $nodeflags = <span class="string">""</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * function kind_uses_flags(int $kind): bool &#123;&#125;</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> int $kind AST_* constant value defining the kind of an AST node</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span> bool Returns true if AST kind uses flags</span></span><br><span class="line"><span class="comment">         * 判定某个AST_*类型是否有flags标志位，比如AST_NAME就有flags标志位，如NAME_NOT_FQ, NAME_FQ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>( ast\kind_uses_flags( $ast-&gt;kind)) &#123;</span><br><span class="line">            $nodeflags = <span class="keyword">$this</span>-&gt;format_flags( $ast-&gt;kind, $ast-&gt;flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// for decl nodes:</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="keyword">isset</span>( $ast-&gt;endLineno)) &#123;</span><br><span class="line">            $nodeendline = $ast-&gt;endLineno;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( <span class="keyword">isset</span>( $ast-&gt;name)) &#123;</span><br><span class="line">            $nodename = $ast-&gt;name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( <span class="keyword">isset</span>( $ast-&gt;docComment)) &#123;</span><br><span class="line">            $nodedoccomment = <span class="keyword">$this</span>-&gt;quote_and_escape( $ast-&gt;docComment);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// store node, export all children and store the relationships</span></span><br><span class="line">        $rootnode = <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_AST, $nodetype, $nodeflags, $nodeline, <span class="keyword">null</span>, $childnum, $funcid, $classname, <span class="keyword">$this</span>-&gt;quote_and_escape( $namespace), $nodeendline, $nodename, $nodedoccomment);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this node is a function/method/closure declaration, set $funcid.</span></span><br><span class="line">        <span class="comment">// Note that in particular, the decl node *itself* does not have $funcid set to its own id;</span></span><br><span class="line">        <span class="comment">// this is intentional. The *declaration* of a function/method/closure itself is part of the</span></span><br><span class="line">        <span class="comment">// control flow of the outer scope: e.g., a closure declaration is part of the control flow</span></span><br><span class="line">        <span class="comment">// of the function it is declared in, or a function/method declaration is part of the control flow</span></span><br><span class="line">        <span class="comment">// of the pseudo-function representing the top-level code it is declared in.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">Note:</span> we do not need to do this for TOPLEVEL types (and it wouldn't be straightforward since we</span></span><br><span class="line">        <span class="comment">// do not generate ast\Node objects for them). Rather, for toplevel nodes under files, the funcid is</span></span><br><span class="line">        <span class="comment">// set by the Parser class, which also stores the File node; and for toplevel nodes under classes,</span></span><br><span class="line">        <span class="comment">// we do it below, while iterating over the children.</span></span><br><span class="line">        <span class="comment">// Also, we create artificial entry and exit nodes for the CFG of the function (like file and dir nodes,</span></span><br><span class="line">        <span class="comment">// they are not actually part of the AST).</span></span><br><span class="line">        <span class="comment">// For the entry and exit nodes, we only set</span></span><br><span class="line">        <span class="comment">// (1) the funcid (to the id of the function node), and</span></span><br><span class="line">        <span class="comment">// (2) the name (to that of the function)</span></span><br><span class="line">        <span class="keyword">if</span>( $ast-&gt;kind === ast\AST_FUNC_DECL || $ast-&gt;kind === ast\AST_METHOD || $ast-&gt;kind === ast\AST_CLOSURE) &#123;</span><br><span class="line">            $funcid = $rootnode;</span><br><span class="line">            $entrynode = <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_ART, <span class="keyword">self</span>::FUNC_ENTRY, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, $rootnode, $classname, <span class="keyword">$this</span>-&gt;quote_and_escape( $namespace), <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;quote_and_escape( $nodename), <span class="keyword">null</span>);</span><br><span class="line">            $exitnode = <span class="keyword">$this</span>-&gt;store_node( <span class="keyword">self</span>::LABEL_ART, <span class="keyword">self</span>::FUNC_EXIT, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, $rootnode, $classname, <span class="keyword">$this</span>-&gt;quote_and_escape( $namespace), <span class="keyword">null</span>, <span class="keyword">$this</span>-&gt;quote_and_escape( $nodename), <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;store_rel( $rootnode, $entrynode, <span class="string">"ENTRY"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;store_rel( $rootnode, $exitnode, <span class="string">"EXIT"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this node is a class declaration, set $classname</span></span><br><span class="line">        <span class="comment">// 如果当前节点是class声明，那么记录$classname</span></span><br><span class="line">        <span class="keyword">if</span>( $ast-&gt;kind === ast\AST_CLASS) &#123;</span><br><span class="line">            $classname = $nodename;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// iterate over the children and count them</span></span><br><span class="line">        <span class="comment">// 开始递归遍历子节点</span></span><br><span class="line">        $i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span>( $ast-&gt;children <span class="keyword">as</span> $childrel =&gt; $child) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we encounter a child node that is a namespace node, set the namespace for subtrees and upcoming sister nodes</span></span><br><span class="line">            <span class="comment">// Note that we do not care whether the non-bracketed syntax (second child of AST_NAMESPACE is null)</span></span><br><span class="line">            <span class="comment">// or the bracketed syntax (second child of AST_NAMESPACE is a statement) was used:</span></span><br><span class="line">            <span class="comment">// (1) if non-bracketed, the namespace must be set for all upcoming sister nodes until we encounter</span></span><br><span class="line">            <span class="comment">//     the next AST_NAMESPACE</span></span><br><span class="line">            <span class="comment">// (2) if bracketed, the namespace in principle only holds for the subtree rooted in the second child</span></span><br><span class="line">            <span class="comment">//     of AST_NAMESPACE (and should be set only for that subtree, but not for upcoming sister nodes);</span></span><br><span class="line">            <span class="comment">//     however, in this case the next sister node (if it exists) *must* be another</span></span><br><span class="line">            <span class="comment">//     AST_NAMESPACE node, according to PHP syntax (otherwise, a 'No code may exist outside of namespace &#123;&#125;'</span></span><br><span class="line">            <span class="comment">//     fatal error would be thrown at runtime.) Hence, if the next sister node is an AST_NAMESPACE anyway,</span></span><br><span class="line">            <span class="comment">//     the namespace will be set to something new once we finished off the subtree rooted in the</span></span><br><span class="line">            <span class="comment">//     second child of the AST_NAMESPACE we encountered.</span></span><br><span class="line">            <span class="keyword">if</span>( $child-&gt;kind === ast\AST_NAMESPACE) &#123;</span><br><span class="line">                $namespace = $child-&gt;children[<span class="string">"name"</span>] ?? <span class="string">""</span>;</span><br><span class="line">                $uses = []; <span class="comment">// any namespace statement cancels all uses currently in effect</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we encounter a child node that is a use node, add the translation rules specified by it</span></span><br><span class="line">            <span class="comment">// to the translation rules currently in effect</span></span><br><span class="line">            <span class="keyword">if</span>( $child-&gt;kind === ast\AST_USE) &#123;</span><br><span class="line">                $uses = array_merge( $uses, <span class="keyword">$this</span>-&gt;getTranslationRulesForUse( $child));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// for the "stmts" child of an AST_CLASS, which is an AST_STMT_LIST,</span></span><br><span class="line">            <span class="comment">// we insert an artificial toplevel function node</span></span><br><span class="line">            <span class="keyword">if</span>( $ast-&gt;kind === ast\AST_CLASS &amp;&amp; $childrel === <span class="string">"stmts"</span>) &#123;</span><br><span class="line">                $tnode = <span class="keyword">$this</span>-&gt;store_toplevelnode( Exporter::TOPLEVEL_CLASS, $nodename, $nodeline, $nodeendline, $i, $funcid, $namespace);</span><br><span class="line">                <span class="comment">// when exporting the AST_STMT_LIST below the AST_CLASS, the</span></span><br><span class="line">                <span class="comment">// funcid is set to the toplevel node's id, childname is set to "stmts" (doesn't really matter, we can invent a name here), and childnum is set to 0</span></span><br><span class="line">                <span class="comment">// 递归遍历子节点</span></span><br><span class="line">                $childnode = <span class="keyword">$this</span>-&gt;export( $child, $tnode, $nodeline, <span class="string">"stmts"</span>, <span class="number">0</span>, $namespace, $uses, $classname);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;store_rel( $tnode, $childnode, <span class="string">"PARENT_OF"</span>); <span class="comment">// AST_TOPLEVEL -&gt; AST_STMT_LIST</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;store_rel( $rootnode, $tnode, <span class="string">"PARENT_OF"</span>); <span class="comment">// AST_CLASS -&gt; AST_TOPLEVEL</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// for the child of an AST_NAME node which is *not* fully qualified, we apply the translation rules currently in effect</span></span><br><span class="line">            <span class="keyword">elseif</span>( $ast-&gt;kind === ast\AST_NAME &amp;&amp; $childrel === <span class="string">"name"</span> &amp;&amp; $ast-&gt;flags !== ast\flags\NAME_FQ) &#123;</span><br><span class="line">                $child = <span class="keyword">$this</span>-&gt;applyTranslationRulesForName( $child, $uses);</span><br><span class="line">                <span class="comment">// 递归遍历子节点</span></span><br><span class="line">                $childnode = <span class="keyword">$this</span>-&gt;export( $child, $funcid, $nodeline, $childrel, $i, $namespace, $uses, $classname);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;store_rel( $rootnode, $childnode, <span class="string">"PARENT_OF"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// in all other cases, we simply recurse straightforwardly</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 递归遍历子节点</span></span><br><span class="line">                $childnode = <span class="keyword">$this</span>-&gt;export( $child, $funcid, $nodeline, $childrel, $i, $namespace, $uses, $classname);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;store_rel( $rootnode, $childnode, <span class="string">"PARENT_OF"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// next child...</span></span><br><span class="line">            $i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>export()</code>函数最外层有4个分支来处理不同的ast节点：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( $ast <span class="keyword">instanceof</span> ast\Node) &#123;</span><br><span class="line">    <span class="comment">// 第一种情况是最常见的，节点为ast\Node类型</span></span><br><span class="line">    <span class="comment">// 在这一层，是唯一可能有child ast\Node节点的，所以在这一层还会对子节点进行递归遍历</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// 接下去都是处理非AST节点，如果不是一个AST节点，还有其他可能，比如一种是string类型的字符串，另一种是NULL类型的节点，还有一种可能是integer, double等之类的数值</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>( is_string( $ast)) &#123;</span><br><span class="line">    <span class="comment">// 处理ast为字符串类型的节点</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>( $ast === <span class="keyword">null</span>) &#123;</span><br><span class="line">	<span class="comment">// 处理type=NULL的ast节点</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="comment">// 如果当前value既不是字符串string，也不是NULL类型，那么就将其转换为string类型</span></span><br><span class="line">    <span class="comment">// 开发者一开始认为该分支对应的value可能是布尔值，integers，floats或doubles，arrays，objects或是resources</span></span><br><span class="line">    <span class="comment">// 但是经过测试发现，该分支对应的value仅有integer和floats或doubles</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>export()</code>中，遇到<code>AST_USE</code>节点的时候还用到了<code>getTranslationRulesForUse()</code>来额外处理；遇到<code>AST_NAME</code>节点的时候使用<code>applyTranslationRulesForName()</code>来特殊处理。</p>
<h4 id="getTranslationRulesForUse"><a href="#getTranslationRulesForUse" class="headerlink" title="getTranslationRulesForUse()"></a>getTranslationRulesForUse()</h4><p>要了解<code>getTranslationRulesForUse()</code>函数和<code>applyTranslationRulesForName()</code>函数的作用，我们用一个testcase来说明：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// use.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">com</span>\<span class="title">rsumilang</span>\<span class="title">util</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">com</span>\<span class="title">rsumlang</span>\<span class="title">common</span> <span class="title">as</span> <span class="title">Common</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span> <span class="keyword">extends</span> <span class="title">Common</span>\<span class="title">Object</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="comment">// ... code ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再用<strong>php-ast</strong>解析<code>use.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'../util.php'</span>;</span><br><span class="line">$code = <span class="string">&lt;&lt;&lt;'EOC'</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">namespace com\rsumilang\util;</span></span><br><span class="line"><span class="string">use com\rsumlang\common as Common;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class String extends Common\Object</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">   // ... code ...</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOC;</span></span><br><span class="line"></span><br><span class="line">var_dump(ast\parse_code($code, $version=<span class="number">30</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// OUTPUT:</span></span><br><span class="line">class ast\Node#1 (4) &#123;</span><br><span class="line">  <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">  int(<span class="number">133</span>)</span><br><span class="line">  <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">  int(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">  int(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">public</span> $children =&gt;</span><br><span class="line">  <span class="keyword">array</span>(<span class="number">3</span>) &#123;</span><br><span class="line">    [<span class="number">0</span>] =&gt;</span><br><span class="line">    class ast\Node#2 (4) &#123;</span><br><span class="line">      <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">      int(<span class="number">541</span>)</span><br><span class="line">      <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">      int(<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">      int(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">public</span> $children =&gt;</span><br><span class="line">      <span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="string">'name'</span> =&gt;</span><br><span class="line">        string(<span class="number">18</span>) <span class="string">"com\rsumilang\util"</span></span><br><span class="line">        <span class="string">'stmts'</span> =&gt;</span><br><span class="line">        <span class="keyword">NULL</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="number">1</span>] =&gt;</span><br><span class="line">    class ast\Node#3 (4) &#123;</span><br><span class="line">      <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">      int(<span class="number">144</span>)</span><br><span class="line">      <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">      int(<span class="number">361</span>)</span><br><span class="line">      <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">      int(<span class="number">3</span>)</span><br><span class="line">      <span class="keyword">public</span> $children =&gt;</span><br><span class="line">      <span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        [<span class="number">0</span>] =&gt;</span><br><span class="line">        class ast\Node#4 (4) &#123;</span><br><span class="line">          <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">          int(<span class="number">542</span>)</span><br><span class="line">          <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">          int(<span class="number">0</span>)</span><br><span class="line">          <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">          int(<span class="number">3</span>)</span><br><span class="line">          <span class="keyword">public</span> $children =&gt;</span><br><span class="line">          <span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">            <span class="string">'name'</span> =&gt;</span><br><span class="line">            string(<span class="number">19</span>) <span class="string">"com\rsumlang\common"</span></span><br><span class="line">            <span class="string">'alias'</span> =&gt;</span><br><span class="line">            string(<span class="number">6</span>) <span class="string">"Common"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="number">2</span>] =&gt;</span><br><span class="line">    class ast\Node\Decl#5 (7) &#123;</span><br><span class="line">      <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">      int(<span class="number">69</span>)</span><br><span class="line">      <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">      int(<span class="number">0</span>)</span><br><span class="line">      <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">      int(<span class="number">5</span>)</span><br><span class="line">      <span class="keyword">public</span> $children =&gt;</span><br><span class="line">      <span class="keyword">array</span>(<span class="number">3</span>) &#123;</span><br><span class="line">        <span class="string">'extends'</span> =&gt;</span><br><span class="line">        class ast\Node#6 (4) &#123;</span><br><span class="line">          <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">          int(<span class="number">2048</span>)</span><br><span class="line">          <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">          int(<span class="number">1</span>)</span><br><span class="line">          <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">          int(<span class="number">5</span>)</span><br><span class="line">          <span class="keyword">public</span> $children =&gt;</span><br><span class="line">          <span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="string">'name'</span> =&gt;</span><br><span class="line">            string(<span class="number">13</span>) <span class="string">"Common\Object"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">'implements'</span> =&gt;</span><br><span class="line">        <span class="keyword">NULL</span></span><br><span class="line">        <span class="string">'stmts'</span> =&gt;</span><br><span class="line">        class ast\Node#7 (4) &#123;</span><br><span class="line">          <span class="keyword">public</span> $kind =&gt;</span><br><span class="line">          int(<span class="number">133</span>)</span><br><span class="line">          <span class="keyword">public</span> $flags =&gt;</span><br><span class="line">          int(<span class="number">0</span>)</span><br><span class="line">          <span class="keyword">public</span> $lineno =&gt;</span><br><span class="line">          int(<span class="number">6</span>)</span><br><span class="line">          <span class="keyword">public</span> $children =&gt;</span><br><span class="line">          <span class="keyword">array</span>(<span class="number">0</span>) &#123;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">public</span> $endLineno =&gt;</span><br><span class="line">      int(<span class="number">8</span>)</span><br><span class="line">      <span class="keyword">public</span> $name =&gt;</span><br><span class="line">      string(<span class="number">6</span>) <span class="string">"String"</span></span><br><span class="line">      <span class="keyword">public</span> $docComment =&gt;</span><br><span class="line">      <span class="keyword">NULL</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>testcase中使用<code>use</code>关键字来导入namespace：<code>com\rsumlang\common</code>，并且用别名<code>Common</code>来表示该命名空间。命名空间<code>Common\Object</code>实际上是<code>com\rsumlang\common\Object</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">getTranslationRulesForUse</span><span class="params">( $astuse)</span> : <span class="title">array</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !($astuse <span class="keyword">instanceof</span> ast\Node) || ($astuse-&gt;kind !== ast\AST_USE))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Illegal argument to getTranslationRulesForUse(): "</span> . var_export($astuse, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">    $uses = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>( $astuse-&gt;children <span class="keyword">as</span> $astuseelem) &#123;</span><br><span class="line">        $actual = $astuseelem-&gt;children[<span class="string">"name"</span>];</span><br><span class="line">        <span class="comment">// if no alias is given, the default one is the last part of the actual namespace</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * strrpos ( string $haystack , string $needle , int $offset = 0 ) : int</span></span><br><span class="line"><span class="comment">         * 计算指定字符串在目标字符串中最后一次出现的位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// 如果use关键字没有使用 别名alias，那么就令actual namespace最后一个`\`后面的部分作为别名</span></span><br><span class="line">        <span class="comment">// $uses[] 在后面的applyTranslationRulesForName()函数会用到</span></span><br><span class="line">        $alias = $astuseelem-&gt;children[<span class="string">"alias"</span>] ?? substr( $actual, strrpos( $actual, <span class="string">"\\"</span>) + <span class="number">1</span>);</span><br><span class="line">        $uses[$alias] = $actual;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $uses;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>getTranslationRulesForUse()</code>函数，就能够将命名空间的别名保存在<code>$uses[]</code>数组中：</p>
<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/8.png" alt="8"></p>
<h4 id="applyTranslationRulesForName"><a href="#applyTranslationRulesForName" class="headerlink" title="applyTranslationRulesForName()"></a>applyTranslationRulesForName()</h4><p>然后再遍历到其他节点的时候，通过<code>applyTranslationRulesForName()</code>函数还原出原始的namespace。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">applyTranslationRulesForName</span><span class="params">( $haystack, $uses)</span> : <span class="title">string</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !is_string( $haystack))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Illegal argument to applyTranslationRulesForName(): "</span> . var_export($haystack, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>( $uses <span class="keyword">as</span> $needle =&gt; $replacement) &#123;</span><br><span class="line">        $needle .= <span class="string">"\\"</span>;</span><br><span class="line">        $replacement .= <span class="string">"\\"</span>;</span><br><span class="line">        <span class="comment">// crude imitation of startsWith( $haystack, $needle)</span></span><br><span class="line">        <span class="keyword">if</span>( substr( $haystack, <span class="number">0</span>, strlen( $needle)) === $needle)</span><br><span class="line">            <span class="keyword">return</span> $replacement . substr( $haystack, strlen( $needle));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $haystack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/21/PHPJoernSourceCodeNotes/imgs/7.png" alt="7"></p>
<p>这样就能拿到正确完整的命名空间。</p>
<h4 id="php-ast中相关函数"><a href="#php-ast中相关函数" class="headerlink" title="php-ast中相关函数"></a>php-ast中相关函数</h4><h5 id="ast-get-kind-name"><a href="#ast-get-kind-name" class="headerlink" title="ast\get_kind_name()"></a>ast\get_kind_name()</h5><p><a href="https://github.com/nikic/php-ast/blob/b8fa288b4922fe923236a198e0fb17e3441a888b/ast.stub.php#L31" target="_blank" rel="noopener">https://github.com/nikic/php-ast/blob/b8fa288b4922fe923236a198e0fb17e3441a888b/ast.stub.php#L31</a> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $kind AST_* constant value defining the kind of an AST node</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string String representation of AST kind value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_kind_name</span><span class="params">(int $kind)</span>: <span class="title">string</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>该函数会根据$kind值返回一个string, 该string对应特定的type，即$kind是和type (AST_*) 对应的。</p>
<p>来自<a href="https://github.com/nikic/php-ast/blob/b09570df0098baba601a89e65348d0b04c351d69/ast_stub.php#L8" target="_blank" rel="noopener">https://github.com/nikic/php-ast/blob/b09570df0098baba601a89e65348d0b04c351d69/ast_stub.php#L8</a> 定义了不同的AST_* 与$kind值进行对照：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AST KIND CONSTANTS</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ast</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ARG_LIST = <span class="number">128</span>;</span><br><span class="line"><span class="keyword">const</span> AST_LIST = <span class="number">255</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ARRAY = <span class="number">129</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ENCAPS_LIST = <span class="number">130</span>;</span><br><span class="line"><span class="keyword">const</span> AST_EXPR_LIST = <span class="number">131</span>;</span><br><span class="line"><span class="keyword">const</span> AST_STMT_LIST = <span class="number">132</span>;</span><br><span class="line"><span class="keyword">const</span> AST_IF = <span class="number">133</span>;</span><br><span class="line"><span class="keyword">const</span> AST_SWITCH_LIST = <span class="number">134</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CATCH_LIST = <span class="number">135</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PARAM_LIST = <span class="number">136</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLOSURE_USES = <span class="number">137</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PROP_DECL = <span class="number">138</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CONST_DECL = <span class="number">139</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLASS_CONST_DECL = <span class="number">140</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NAME_LIST = <span class="number">141</span>;</span><br><span class="line"><span class="keyword">const</span> AST_TRAIT_ADAPTATIONS = <span class="number">142</span>;</span><br><span class="line"><span class="keyword">const</span> AST_USE = <span class="number">143</span>;</span><br><span class="line"><span class="keyword">const</span> AST_TYPE_UNION = <span class="number">144</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ATTRIBUTE_LIST = <span class="number">145</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ATTRIBUTE_GROUP = <span class="number">146</span>;</span><br><span class="line"><span class="keyword">const</span> AST_MATCH_ARM_LIST = <span class="number">147</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NAME = <span class="number">2048</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLOSURE_VAR = <span class="number">2049</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NULLABLE_TYPE = <span class="number">2050</span>;</span><br><span class="line"><span class="keyword">const</span> AST_FUNC_DECL = <span class="number">67</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLOSURE = <span class="number">68</span>;</span><br><span class="line"><span class="keyword">const</span> AST_METHOD = <span class="number">69</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ARROW_FUNC = <span class="number">71</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLASS = <span class="number">70</span>;</span><br><span class="line"><span class="keyword">const</span> AST_MAGIC_CONST = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> AST_TYPE = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> AST_VAR = <span class="number">256</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CONST = <span class="number">257</span>;</span><br><span class="line"><span class="keyword">const</span> AST_UNPACK = <span class="number">258</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CAST = <span class="number">261</span>;</span><br><span class="line"><span class="keyword">const</span> AST_EMPTY = <span class="number">262</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ISSET = <span class="number">263</span>;</span><br><span class="line"><span class="keyword">const</span> AST_SHELL_EXEC = <span class="number">265</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLONE = <span class="number">266</span>;</span><br><span class="line"><span class="keyword">const</span> AST_EXIT = <span class="number">267</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PRINT = <span class="number">268</span>;</span><br><span class="line"><span class="keyword">const</span> AST_INCLUDE_OR_EVAL = <span class="number">269</span>;</span><br><span class="line"><span class="keyword">const</span> AST_UNARY_OP = <span class="number">270</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PRE_INC = <span class="number">271</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PRE_DEC = <span class="number">272</span>;</span><br><span class="line"><span class="keyword">const</span> AST_POST_INC = <span class="number">273</span>;</span><br><span class="line"><span class="keyword">const</span> AST_POST_DEC = <span class="number">274</span>;</span><br><span class="line"><span class="keyword">const</span> AST_YIELD_FROM = <span class="number">275</span>;</span><br><span class="line"><span class="keyword">const</span> AST_GLOBAL = <span class="number">277</span>;</span><br><span class="line"><span class="keyword">const</span> AST_UNSET = <span class="number">278</span>;</span><br><span class="line"><span class="keyword">const</span> AST_RETURN = <span class="number">279</span>;</span><br><span class="line"><span class="keyword">const</span> AST_LABEL = <span class="number">280</span>;</span><br><span class="line"><span class="keyword">const</span> AST_REF = <span class="number">281</span>;</span><br><span class="line"><span class="keyword">const</span> AST_HALT_COMPILER = <span class="number">282</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ECHO = <span class="number">283</span>;</span><br><span class="line"><span class="keyword">const</span> AST_THROW = <span class="number">284</span>;</span><br><span class="line"><span class="keyword">const</span> AST_GOTO = <span class="number">285</span>;</span><br><span class="line"><span class="keyword">const</span> AST_BREAK = <span class="number">286</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CONTINUE = <span class="number">287</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLASS_NAME = <span class="number">276</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLASS_CONST_GROUP = <span class="number">546</span>;</span><br><span class="line"><span class="keyword">const</span> AST_DIM = <span class="number">512</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PROP = <span class="number">513</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NULLSAFE_PROP = <span class="number">514</span>;</span><br><span class="line"><span class="keyword">const</span> AST_STATIC_PROP = <span class="number">515</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CALL = <span class="number">516</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CLASS_CONST = <span class="number">517</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ASSIGN = <span class="number">518</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ASSIGN_REF = <span class="number">519</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ASSIGN_OP = <span class="number">520</span>;</span><br><span class="line"><span class="keyword">const</span> AST_BINARY_OP = <span class="number">521</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ARRAY_ELEM = <span class="number">526</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NEW = <span class="number">527</span>;</span><br><span class="line"><span class="keyword">const</span> AST_INSTANCEOF = <span class="number">528</span>;</span><br><span class="line"><span class="keyword">const</span> AST_YIELD = <span class="number">529</span>;</span><br><span class="line"><span class="keyword">const</span> AST_STATIC = <span class="number">532</span>;</span><br><span class="line"><span class="keyword">const</span> AST_WHILE = <span class="number">533</span>;</span><br><span class="line"><span class="keyword">const</span> AST_DO_WHILE = <span class="number">534</span>;</span><br><span class="line"><span class="keyword">const</span> AST_IF_ELEM = <span class="number">535</span>;</span><br><span class="line"><span class="keyword">const</span> AST_SWITCH = <span class="number">536</span>;</span><br><span class="line"><span class="keyword">const</span> AST_SWITCH_CASE = <span class="number">537</span>;</span><br><span class="line"><span class="keyword">const</span> AST_DECLARE = <span class="number">538</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PROP_ELEM = <span class="number">775</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PROP_GROUP = <span class="number">774</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CONST_ELEM = <span class="number">776</span>;</span><br><span class="line"><span class="keyword">const</span> AST_USE_TRAIT = <span class="number">539</span>;</span><br><span class="line"><span class="keyword">const</span> AST_TRAIT_PRECEDENCE = <span class="number">540</span>;</span><br><span class="line"><span class="keyword">const</span> AST_METHOD_REFERENCE = <span class="number">541</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NAMESPACE = <span class="number">542</span>;</span><br><span class="line"><span class="keyword">const</span> AST_USE_ELEM = <span class="number">543</span>;</span><br><span class="line"><span class="keyword">const</span> AST_TRAIT_ALIAS = <span class="number">544</span>;</span><br><span class="line"><span class="keyword">const</span> AST_GROUP_USE = <span class="number">545</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ATTRIBUTE = <span class="number">547</span>;</span><br><span class="line"><span class="keyword">const</span> AST_MATCH = <span class="number">548</span>;</span><br><span class="line"><span class="keyword">const</span> AST_MATCH_ARM = <span class="number">549</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NAMED_ARG = <span class="number">550</span>;</span><br><span class="line"><span class="keyword">const</span> AST_ENUM_CASE = <span class="number">777</span>;</span><br><span class="line"><span class="keyword">const</span> AST_METHOD_CALL = <span class="number">768</span>;</span><br><span class="line"><span class="keyword">const</span> AST_NULLSAFE_METHOD_CALL = <span class="number">769</span>;</span><br><span class="line"><span class="keyword">const</span> AST_STATIC_CALL = <span class="number">770</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CONDITIONAL = <span class="number">771</span>;</span><br><span class="line"><span class="keyword">const</span> AST_TRY = <span class="number">772</span>;</span><br><span class="line"><span class="keyword">const</span> AST_CATCH = <span class="number">773</span>;</span><br><span class="line"><span class="keyword">const</span> AST_FOR = <span class="number">1024</span>;</span><br><span class="line"><span class="keyword">const</span> AST_FOREACH = <span class="number">1025</span>;</span><br><span class="line"><span class="keyword">const</span> AST_PARAM = <span class="number">1280</span>;</span><br><span class="line"><span class="comment">// END AST KIND CONSTANTS</span></span><br></pre></td></tr></table></figure>

<h5 id="ast-kind-uses-flags"><a href="#ast-kind-uses-flags" class="headerlink" title="ast\kind_uses_flags()"></a>ast\kind_uses_flags()</h5><p><a href="https://github.com/nikic/php-ast/blob/b8fa288b4922fe923236a198e0fb17e3441a888b/ast.stub.php#L37" target="_blank" rel="noopener">https://github.com/nikic/php-ast/blob/b8fa288b4922fe923236a198e0fb17e3441a888b/ast.stub.php#L37</a> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $kind AST_* constant value defining the kind of an AST node</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool Returns true if AST kind uses flags</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">kind_uses_flags</span><span class="params">(int $kind)</span>: <span class="title">bool</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>判定某个AST_*类型是否有flags标志位，比如AST_NAME就有flags标志位，如NAME_NOT_FQ, NAME_FQ</p>
<h3 id="src-util-php"><a href="#src-util-php" class="headerlink" title="src/util.php"></a>src/util.php</h3><p><code>src/util.php</code>文件是从<a href="https://github.com/nikic/php-ast/blob/26bf9d3c9635c1ecf745bb0ede232fc02aecfd71/util.php" target="_blank" rel="noopener">php-ast</a>项目中复制回来的文件，主要是用来处理flags标志位的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">format_flags</span><span class="params">(int $kind, int $flags)</span> : <span class="title">string</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_flag_info</span><span class="params">()</span> : <span class="title">array</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>phpjoern部分的源码比较简单，只要搭个调试环境，跟踪一下就可以理清程序的主要逻辑。我跟踪调试的文件比较少，可能覆盖的范围还不太足够，还可以去 <a href="https://github.com/nikic/php-ast/tree/master/tests" target="_blank" rel="noopener">https://github.com/nikic/php-ast/tree/master/tests</a> 找测试用例。</p>
<p>所以接下去，我需要对phpjoern进行一个小的修改，仿照funcid，为每个节点记录其对应的文件id，记为fileid，这我将记录在下一篇文章中。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://bantttian.github.io/2021/04/21/PHPJoernSourceCodeNotes/">https://bantttian.github.io/2021/04/21/PHPJoernSourceCodeNotes/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"># PHP程序分析</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2021/04/18/DataFlowAnalysis%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0%E4%B9%8BLiveVariablesAnalysis/">DataFlowAnalysis原理学习之LiveVariablesAnalysis</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
