<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>Joern源码阅读之AST树生成 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Joern源码阅读之AST树生成</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-04-23&nbsp;&nbsp;17:29:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>phpjeorn将php-ast生成的抽象语法树保存在<code>nodes.csv</code>和<code>rels.csv</code>中，当joern读取这两个文件，并生成代码属性图的时候，要先将根据这两个文件恢复AST树，然后根据AST树按步骤生成控制流图CFG，然后根据控制流图生成DefUseGraph，再利用迭代算法，根据DefuseGraph和CFG生成数据流图DDG，最后生成Call Graph。因此，将<code>ndoes.csv</code>和<code>rels.csv</code>文件恢复为AST树也是关键的一步。本文就记录下这个过程中的一些关键步骤。</p>
<p>在调试跟踪的时候，发现了一些CSV处理类，要搞清楚Joern是如何将CSV文件恢复成AST树的，就要先了解这些CSV处理类。</p>
<h3 id="KeyedCSVRow类"><a href="#KeyedCSVRow类" class="headerlink" title="KeyedCSVRow类"></a>KeyedCSVRow类</h3><blockquote>
<p>/joern/projects/extensions/jpanlib/src/main/java/inputModules/csv/KeyedCSV/KeyedCSVRow.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyedCSVRow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> CSVKey[] keys;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;CSVKey,String&gt; values = <span class="keyword">new</span> LinkedHashMap&lt;CSVKey,String&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">KeyedCSVRow</span><span class="params">(CSVKey[] keys)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.keys = keys;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将csv文件中每行的信息以键值对的方式读取</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initFromCSVRecord</span><span class="params">(CSVRecord record)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">		Iterator&lt;String&gt; recIt = record.iterator();</span><br><span class="line">		<span class="keyword">while</span> (recIt.hasNext())</span><br><span class="line">		&#123;</span><br><span class="line">			String r = recIt.next();</span><br><span class="line">			values.put(keys[i], r);</span><br><span class="line">			i++;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据key获取value</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getFieldForKey</span><span class="params">(CSVKey key)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		String val = values.get(key);</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">null</span> == val) ? <span class="string">""</span> : val;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 字符串化操作</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.values.toString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下图是一个实例化后的<strong>KeyedCSVRow</strong>对象：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/2.png" alt="2"></p>
<p>对应<code>nodes.csv</code>文件中的第2行信息：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/3.png" alt="3"></p>
<h3 id="PHPCSVNodeTypes类"><a href="#PHPCSVNodeTypes类" class="headerlink" title="PHPCSVNodeTypes类"></a>PHPCSVNodeTypes类</h3><blockquote>
<p>joern/projects/extensions/joern-php/src/main/java/inputModules/csv/PHPCSVNodeTypes.java</p>
</blockquote>
<p>在<code>PHPCSVNodeTypes</code>类中定义了不同的AST nodes kind（也就是type）和修饰这些type的flags：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVNodeTypes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">/* node row keys */</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey NODE_ID = <span class="keyword">new</span> CSVKey(<span class="string">"id"</span>,<span class="string">"int"</span>);</span><br><span class="line">	<span class="comment">// node labels (either Filesystem, AST or Artificial)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey LABEL = <span class="keyword">new</span> CSVKey(<span class="string">"labels"</span>,<span class="string">"label"</span>);</span><br><span class="line">	<span class="comment">// node properties shared by all nodes (cf. ast\Node specification</span></span><br><span class="line">	<span class="comment">// in &#123;@link https://github.com/nikic/php-ast&#125;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey TYPE = <span class="keyword">new</span> CSVKey(<span class="string">"type"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey FLAGS = <span class="keyword">new</span> CSVKey(<span class="string">"flags"</span>,<span class="string">"string_array"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey LINENO = <span class="keyword">new</span> CSVKey(<span class="string">"lineno"</span>,<span class="string">"int"</span>);</span><br><span class="line">	<span class="comment">// node properties for declaration nodes  (cf. ast\Node\Decl specification</span></span><br><span class="line">	<span class="comment">// in &#123;@link https://github.com/nikic/php-ast&#125;</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey ENDLINENO = <span class="keyword">new</span> CSVKey(<span class="string">"endlineno"</span>,<span class="string">"int"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey NAME = <span class="keyword">new</span> CSVKey(<span class="string">"name"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey DOCCOMMENT = <span class="keyword">new</span> CSVKey(<span class="string">"doccomment"</span>);</span><br><span class="line">	<span class="comment">// meta-properties</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey CODE = <span class="keyword">new</span> CSVKey(<span class="string">"code"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey CHILDNUM = <span class="keyword">new</span> CSVKey(<span class="string">"childnum"</span>,<span class="string">"int"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey FUNCID = <span class="keyword">new</span> CSVKey(<span class="string">"funcid"</span>,<span class="string">"int"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey CLASSNAME = <span class="keyword">new</span> CSVKey(<span class="string">"classname"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey NAMESPACE = <span class="keyword">new</span> CSVKey(<span class="string">"namespace"</span>);</span><br><span class="line">	<span class="comment">//public static final CSVKey FILEID = new CSVKey("fileid", "int");</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* node labels */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LABEL_FS = <span class="string">"Filesystem"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LABEL_AST = <span class="string">"AST"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LABEL_ART = <span class="string">"Artificial"</span>;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* node types */</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// directory/file types</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_FILE = <span class="string">"File"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_DIRECTORY = <span class="string">"Directory"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// null nodes (leafs)</span></span><br><span class="line">	<span class="comment">// used as dummy child for nodes with a fixed number of children</span></span><br><span class="line">	<span class="comment">// that do not need a certain child in a given context, to keep</span></span><br><span class="line">	<span class="comment">// the number of their children constant</span></span><br><span class="line">	<span class="comment">// (e.g., a function node that does not specify its return type in</span></span><br><span class="line">	<span class="comment">// its declaration; see TestPHPCSVASTBuilderMinimal for more examples.)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_NULL = <span class="string">"NULL"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// primary expressions (leafs)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_INTEGER = <span class="string">"integer"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_DOUBLE = <span class="string">"double"</span>;</span><br><span class="line">	</span><br><span class="line">    [SNIP ... SNIP]</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_NAME_LIST = <span class="string">"AST_NAME_LIST"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_TRAIT_ADAPTATIONS = <span class="string">"AST_TRAIT_ADAPTATIONS"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_USE = <span class="string">"AST_USE"</span>;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* node flags */</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// flags for TYPE_ARRAY_ELEM and TYPE_CLOSURE_VAR (exclusive)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_BY_REFERENCE = <span class="string">"BY_REFERENCE"</span>; <span class="comment">// custom, see phpjoern commit 95cdc6b6de1c4b973775a97b90e8bf41c90f629b</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// flags for TYPE_NAME nodes (exclusive)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_NAME_FQ = <span class="string">"NAME_FQ"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_NAME_NOT_FQ = <span class="string">"NAME_NOT_FQ"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_NAME_RELATIVE = <span class="string">"NAME_RELATIVE"</span>;</span><br><span class="line"></span><br><span class="line">	[SNIP ... SNIP]</span><br><span class="line"></span><br><span class="line">	<span class="comment">// flags for TYPE_INCLUDE_OR_EVAL nodes (exclusive)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_EXEC_EVAL = <span class="string">"EXEC_EVAL"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_EXEC_INCLUDE = <span class="string">"EXEC_INCLUDE"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_EXEC_INCLUDE_ONCE = <span class="string">"EXEC_INCLUDE_ONCE"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_EXEC_REQUIRE = <span class="string">"EXEC_REQUIRE"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FLAG_EXEC_REQUIRE_ONCE = <span class="string">"EXEC_REQUIRE_ONCE"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PHPCSVEdgeTypes类"><a href="#PHPCSVEdgeTypes类" class="headerlink" title="PHPCSVEdgeTypes类"></a>PHPCSVEdgeTypes类</h2><blockquote>
<p>joern/projects/extensions/joern-php/src/main/java/inputModules/csv/PHPCSVEdgeTypes.java</p>
</blockquote>
<p>与<code>PHPCSVNodeTypes</code>类相似，定义了节点与节点之间不同类型的关系边：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVEdgeTypes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">/* edge row keys */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey START_ID = <span class="keyword">new</span> CSVKey(<span class="string">"start"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey END_ID = <span class="keyword">new</span> CSVKey(<span class="string">"end"</span>);</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> CSVKey TYPE = <span class="keyword">new</span> CSVKey(<span class="string">"type"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* edge types */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_FILE_OF = <span class="string">"FILE_OF"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_DIRECTORY_OF = <span class="string">"DIRECTORY_OF"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_AST_PARENT_OF = <span class="string">"PARENT_OF"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_CFG_ENTRY = <span class="string">"ENTRY"</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_CFG_EXIT = <span class="string">"EXIT"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CSVFunctionExtractor类"><a href="#CSVFunctionExtractor类" class="headerlink" title="CSVFunctionExtractor类"></a>CSVFunctionExtractor类</h2><blockquote>
<p>joern/projects/extensions/joern-php/src/main/java/inputModules/csv/csvFuncExtractor/CSVFunctionExtractor.java</p>
</blockquote>
<p><code>CSVFunctinoExtractor</code>类主要负责从csv文件中按行读取记录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> inputModules.csv.csvFuncExtractor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CSVFunctionExtractor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">	KeyedCSVReader nodeReader;</span><br><span class="line">	KeyedCSVReader edgeReader;</span><br><span class="line">    <span class="comment">// 一个first in last out的栈</span></span><br><span class="line">	Stack&lt;CSVAST&gt; csvStack = <span class="keyword">new</span> Stack&lt;CSVAST&gt;();</span><br><span class="line">	Stack&lt;String&gt; funcIdStack = <span class="keyword">new</span> Stack&lt;String&gt;();</span><br><span class="line">    <span class="comment">// 一个first in first out的队列，分别存储每个文件对应的nodes.csv中的节点和rels.csv中的关系边</span></span><br><span class="line">	Queue&lt;CSVAST&gt; csvFifoQueue = <span class="keyword">new</span> LinkedList&lt;CSVAST&gt;();</span><br><span class="line">	Map&lt;CSVAST,Set&lt;String&gt;&gt; csvNodeIds = <span class="keyword">new</span> HashMap&lt;CSVAST,Set&lt;String&gt;&gt;();</span><br><span class="line">	CSV2AST csv2ast = <span class="keyword">new</span> PHPCSV2AST();</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Returns a function node by reading from the node and edge</span></span><br><span class="line"><span class="comment">	 * readers and extracting and converting the next function.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The next function node, or null if there are none.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FunctionDefBase <span class="title">getNextFunction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> IOException, InvalidCSVFile</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>( csvFifoQueue.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// there are no functions in the queue, let's get some</span></span><br><span class="line">			<span class="keyword">assert</span> csvStack.empty() : <span class="string">"There are unfinished CSVASTs on the stack and they are not going to be converted."</span>;</span><br><span class="line">            <span class="comment">// 读取nodes.csv，按照一个一个php文件读取（而不是一个nodes.csv读取，因为只有一个nodes.csv文件）</span></span><br><span class="line">			addNodeRowsUntilNextFile();</span><br><span class="line">            <span class="comment">// 读取rels.csv，按照一个一个php文件读取</span></span><br><span class="line">			addEdgeRowsUntilNextFile();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		FunctionDefBase function = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>( !csvFifoQueue.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">			CSVAST csvAST = csvFifoQueue.remove();</span><br><span class="line">            <span class="comment">// csv2ast.convert()会将CSVAST转为抽象语法树</span></span><br><span class="line">			function = csv2ast.convert(csvAST);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> function;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/1.png" alt="1"></p>
<p>跟入<code>addNodeRowsUntilNextFile()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CSVFunctionExtractor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 该函数会通过nodeReader一行一行地从nodes.csv中，并且是一个一个文件地读取</span></span><br><span class="line"><span class="comment">	 * This function reads lines from the nodeReader, file by file.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 1. It first continuously adds lines that have the same funcid as the</span></span><br><span class="line"><span class="comment">	 *    funcid currently on top of the funcIdStack to the CSVAST on top of</span></span><br><span class="line"><span class="comment">	 *    the csvStack.</span></span><br><span class="line"><span class="comment">	 * 2. Upon finding a function declaration:</span></span><br><span class="line"><span class="comment">	 *    [&lt;outdated&gt;</span></span><br><span class="line"><span class="comment">	 *    a) It adds the line to the CSVAST on top of the csvStack, since the</span></span><br><span class="line"><span class="comment">	 *       declaration as such is indeed part of the outer scope and belongs there.</span></span><br><span class="line"><span class="comment">	 *    &lt;/outdated&gt;]</span></span><br><span class="line"><span class="comment">	 *       UPDATE: 2a) does not hold anymore! We now only add function declarations</span></span><br><span class="line"><span class="comment">	 *       once, as root node of the CSVAST that corresponds to this function itself.</span></span><br><span class="line"><span class="comment">	 *    b) It pushes a new CSVAST on top of  the csvStack and that function's id</span></span><br><span class="line"><span class="comment">	 *       on top of the funcIdStack. The line is also added to this new CSVAST.</span></span><br><span class="line"><span class="comment">	 *       [&lt;outdated&gt;</span></span><br><span class="line"><span class="comment">	 *       Do note that this means that we intentionally duplicate a line by adding it</span></span><br><span class="line"><span class="comment">	 *       to two separate CSVAST instances. This second addition is needed for</span></span><br><span class="line"><span class="comment">	 *       technical reasons, because the line contains meta-information about the</span></span><br><span class="line"><span class="comment">	 *       function (e.g., its name) that we will need when converting the CSVAST to an</span></span><br><span class="line"><span class="comment">	 *       ast.functionDef.FunctionDef node using the CSV2AST class.</span></span><br><span class="line"><span class="comment">	 *       &lt;/outdated&gt;]</span></span><br><span class="line"><span class="comment">	 *       UPDATE: So now, this line is not duplicated anymore. The line is *only*</span></span><br><span class="line"><span class="comment">	 *       added to new new CSVAST.</span></span><br><span class="line"><span class="comment">	 * 3. Upon finding a funcId different from the one on top of the funcIdStack,</span></span><br><span class="line"><span class="comment">	 *    it looks for that funcId within the stack. In a valid CSV file, this</span></span><br><span class="line"><span class="comment">	 *    funcId must have been previously declared by a function declaration.</span></span><br><span class="line"><span class="comment">	 *    a) If it is not found, an exception is thrown.</span></span><br><span class="line"><span class="comment">	 *    b) If it is found, we know that we finished scanning at least one function (since</span></span><br><span class="line"><span class="comment">	 *       we got back to the "outer" scope). The distance from the top of the stack to</span></span><br><span class="line"><span class="comment">	 *       the csvAST that corresponds to the current funcId is the number of functions</span></span><br><span class="line"><span class="comment">	 *       that we finished scanning. We pop the csvStack (and the funcIdStack) that many</span></span><br><span class="line"><span class="comment">	 *       times and put the popped CSVAST's in the csvFifoQueue.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addNodeRowsUntilNextFile</span><span class="params">()</span> <span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">while</span>( nodeReader.hasNextRow())</span><br><span class="line">		&#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// KeyedCSVRow对象会将nodes.csv文件中每行的信息以键值对的方式整理起来</span></span><br><span class="line">			KeyedCSVRow currNodeRow = nodeReader.getNextRow();</span><br><span class="line">			<span class="comment">//System.out.println(currNodeRow);</span></span><br><span class="line">            <span class="comment">// 获取当前行所对应节点的类型，如Directory, File, AST_CALL等等</span></span><br><span class="line">			String currType = currNodeRow.getFieldForKey(PHPCSVNodeTypes.TYPE);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ignore dir nodes</span></span><br><span class="line">            <span class="comment">// 如果遇到的节点是Directory节点，那先跳过</span></span><br><span class="line">			<span class="keyword">if</span>( currType.equals(PHPCSVNodeTypes.TYPE_DIRECTORY))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If we met a file node and we finished some new functions, break.</span></span><br><span class="line">			<span class="comment">// There should always be some new functions except at the very beginning</span></span><br><span class="line">			<span class="comment">// when this function is called for the first time.</span></span><br><span class="line">			<span class="keyword">if</span>( currType.equals(PHPCSVNodeTypes.TYPE_FILE)) &#123;</span><br><span class="line">				<span class="keyword">if</span>( !csvStack.isEmpty())</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ignore artificial CFG entry and exit nodes; they will be generated</span></span><br><span class="line">			<span class="comment">// by the CFG factory and their node ids will be computed using a fixed offset</span></span><br><span class="line">			<span class="comment">// from the id of the considered function</span></span><br><span class="line">			<span class="keyword">if</span>( currType.equals(PHPCSVNodeTypes.TYPE_CFG_ENTRY) || currType.equals(PHPCSVNodeTypes.TYPE_CFG_EXIT))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// if we met a toplevel node of a file, then make sure the csvStack is</span></span><br><span class="line">			<span class="comment">// empty, put a new CSVAST on the stack, add current row, and continue</span></span><br><span class="line">			<span class="keyword">if</span>( currType.equals(PHPCSVNodeTypes.TYPE_TOPLEVEL) &amp;&amp;</span><br><span class="line">				currNodeRow.getFieldForKey(PHPCSVNodeTypes.FLAGS).contains(PHPCSVNodeTypes.FLAG_TOPLEVEL_FILE)) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// make sure stack is empty</span></span><br><span class="line">				<span class="keyword">if</span>( !csvStack.empty())</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile( <span class="string">"nodeReader, line "</span> + nodeReader.getCurrentLineNumber() + <span class="string">": "</span></span><br><span class="line">							+ <span class="string">" A toplevel node of a file was found when the toplevel function"</span></span><br><span class="line">							+ <span class="string">" of the previous file was not finished scanning."</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// create a new top-level function at the bottom of the stack and add current row</span></span><br><span class="line">				String topLevelFuncId = currNodeRow.getFieldForKey(PHPCSVNodeTypes.NODE_ID);</span><br><span class="line">				initCSVAST(topLevelFuncId);</span><br><span class="line">				addRowToTopCSVAST(currNodeRow);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// we are looking neither at a dir node, file node, nor toplevel node of a file</span></span><br><span class="line">			<span class="comment">// make sure stack is not empty at this point</span></span><br><span class="line">			<span class="keyword">if</span>( csvStack.empty())</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile( <span class="string">"nodeReader, line "</span> + nodeReader.getCurrentLineNumber() + <span class="string">": "</span></span><br><span class="line">						+ <span class="string">"No toplevel node of a file to initialize top-level code was found."</span>);</span><br><span class="line"></span><br><span class="line">			String currFuncId = currNodeRow.getFieldForKey(PHPCSVNodeTypes.FUNCID);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// how many functions did we just finish?</span></span><br><span class="line">			<span class="comment">// (0 = currFuncId corresponds to CSVAST currently on top of stack)</span></span><br><span class="line">			<span class="keyword">int</span> finishedFunctions = funcIdStack.search(currFuncId) - <span class="number">1</span>;</span><br><span class="line">			<span class="comment">// if currFuncId is not in the stack, fail; this should never happen with a valid CSV file</span></span><br><span class="line">			<span class="keyword">if</span>( finishedFunctions &lt; <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile( <span class="string">"nodeReader, line "</span> + nodeReader.getCurrentLineNumber() + <span class="string">": "</span></span><br><span class="line">						+ <span class="string">"funcid "</span> + currFuncId + <span class="string">" has never been initialized by a function declaration."</span>);</span><br><span class="line">			<span class="comment">// put finished functions into the finished functions queue</span></span><br><span class="line">			<span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; finishedFunctions; i++) &#123;</span><br><span class="line">				csvFifoQueue.add( csvStack.pop());</span><br><span class="line">				funcIdStack.pop();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// put the current line on the correct CSVAST's</span></span><br><span class="line">			addRowAndInitASTForFuncType(currNodeRow);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If we are here, it means one of two things:</span></span><br><span class="line">		<span class="comment">// - We broke out of the loop because we finished scanning a file;</span></span><br><span class="line">		<span class="comment">// - The nodeReader does not have any more rows to read.</span></span><br><span class="line">		<span class="comment">// In both cases, we just push the remaining (now finished) functions</span></span><br><span class="line">		<span class="comment">// on the csvStack onto the csvFifoQueue.</span></span><br><span class="line">		<span class="keyword">while</span>( !csvStack.empty()) &#123;</span><br><span class="line">			csvFifoQueue.add( csvStack.pop());</span><br><span class="line">			funcIdStack.pop();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ASTUnderConstruction类"><a href="#ASTUnderConstruction类" class="headerlink" title="ASTUnderConstruction类"></a>ASTUnderConstruction类</h2><blockquote>
<p>joern/projects/extensions/jpanlib/src/main/java/inputModules/csv/csv2ast/ASTUnderConstruction.java</p>
</blockquote>
<p><strong>ASTUnderConstruction</strong>类是生成AST的辅助类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> inputModules.csv.csv2ast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ast.ASTNode;</span><br><span class="line"><span class="keyword">import</span> ast.functionDef.FunctionDefBase;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ASTUnderConstruction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	HashMap&lt;Long, ASTNode&gt; idToNode = <span class="keyword">new</span> HashMap&lt;Long, ASTNode&gt;();</span><br><span class="line">	<span class="comment">// AST树的根节点</span></span><br><span class="line">    FunctionDefBase rootNode;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> The AST's root node, or null if none is set.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> setRootNode(FunctionDef)</span></span><br><span class="line"><span class="comment">	 * 返回一棵AST树的根节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> FunctionDefBase <span class="title">getRootNode</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> rootNode;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * For ASTUnderConstruction instances representing single functions,</span></span><br><span class="line"><span class="comment">	 * the function's root node may be explicitly set.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> node The node to be considered as the AST's root node.</span></span><br><span class="line"><span class="comment">	 * 设置AST树的根节点</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRootNode</span><span class="params">(FunctionDefBase node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		rootNode = node;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span></span></span><br><span class="line">	<span class="comment">// - Make ASTUnderConstruction implement Map.</span></span><br><span class="line">	<span class="comment">// - Accordingly, rename addNodeWithId() to put() and getNodeById() to get();</span></span><br><span class="line">	<span class="comment">//    this makes the class more familiar to use for Java programmers anyhow.</span></span><br><span class="line">	<span class="comment">// - Throw an exception if trying to put() a Node that already exists</span></span><br><span class="line">	<span class="comment">//    in the map but with a different id.</span></span><br><span class="line">	<span class="comment">// - The previous point makes the map bijective. Implement a method getIdForNode()</span></span><br><span class="line">	<span class="comment">//    that gives us the unique id of a given node, or -1 if it is not contained.</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNodeWithId</span><span class="params">(ASTNode newNode, Long id)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		idToNode.put(id, newNode);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据id返回ASTNode</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ASTNode <span class="title">getNodeById</span><span class="params">(Long id)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> idToNode.get(id);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ASTNode <span class="title">getNodeWithLowestId</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		Object[] array = idToNode.keySet().toArray();</span><br><span class="line">		Arrays.sort(array);</span><br><span class="line">		<span class="keyword">return</span> idToNode.get(array[<span class="number">0</span>]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(ASTNode node)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> idToNode.containsValue(node);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="CSV2AST类"><a href="#CSV2AST类" class="headerlink" title="CSV2AST类"></a>CSV2AST类</h2><blockquote>
<p>joern/projects/extensions/jpanlib/src/main/java/inputModules/csv/csv2ast/CSV2AST.java</p>
<p>joern/projects/extensions/joern-php/src/main/java/inputModules/csv/csv2ast/PHPCSV2AST.java</p>
</blockquote>
<h3 id="convert-CSVAST-csvAST"><a href="#convert-CSVAST-csvAST" class="headerlink" title="convert(CSVAST csvAST)"></a>convert(CSVAST csvAST)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FunctionDefBase <span class="title">convert</span><span class="params">(CSVAST csvAST)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, InvalidCSVFile</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ASTUnderConstruction ast = <span class="keyword">new</span> ASTUnderConstruction();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据csvAST.nodeRows将每行的节点信息转成ASTNode保存在ast参数中</span></span><br><span class="line">    createASTNodes(csvAST, ast);</span><br><span class="line">    <span class="comment">// 根据csvAST.edgeRows将节点与节点之间的关系保存在ast中</span></span><br><span class="line">    createASTEdges(csvAST, ast);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回AST树的根节点</span></span><br><span class="line">    <span class="keyword">return</span> ast.getRootNode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createASTNodes"><a href="#createASTNodes" class="headerlink" title="createASTNodes"></a>createASTNodes</h3><p><code>createASTNodes()</code>函数会生成ASTNode类型的节点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createASTNodes</span><span class="params">(CSVAST csvAST, ASTUnderConstruction ast)</span> <span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Iterator&lt;KeyedCSVRow&gt; nodeRows = csvAST.nodeIterator();</span><br><span class="line">    <span class="comment">// 拿出nodeRows中的第一条记录保存为keyedRow</span></span><br><span class="line">    KeyedCSVRow keyedRow = getFirstKeyedRow(nodeRows);</span><br><span class="line">    <span class="comment">// 生成ASTNode</span></span><br><span class="line">    <span class="comment">// 单独传入keyedRow是为了单独处理根节点</span></span><br><span class="line">    createASTForFunction(ast, nodeRows, keyedRow);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法在<code>joern/projects/extensions/joern-php/src/main/java/inputModules/csv/csv2ast/PHPCSV2AST.java</code>的<strong>PHPCSV2AST</strong>类中被重写，对nodeRows中的第一条记录增加了要求，必须是function type：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSV2AST</span> <span class="keyword">extends</span> <span class="title">CSV2AST</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createASTNodes</span><span class="params">(CSVAST csvAST, ASTUnderConstruction ast)</span> <span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Iterator&lt;KeyedCSVRow&gt; nodeRows = csvAST.nodeIterator();</span><br><span class="line">        KeyedCSVRow keyedRow = getFirstKeyedRow(nodeRows);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// first row must be a function type;</span></span><br><span class="line">        <span class="comment">// otherwise we cannot create a function node</span></span><br><span class="line">        <span class="comment">// 这里加了一个对nodeRows中第一条记录的判断，第一条记录必须是function type</span></span><br><span class="line">        <span class="keyword">if</span>( !PHPCSVNodeTypes.funcTypes.contains(keyedRow.getFieldForKey(PHPCSVNodeTypes.TYPE)))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile( <span class="string">"Type of first row is not a function declaration."</span>);</span><br><span class="line"></span><br><span class="line">        createASTForFunction(ast, nodeRows, keyedRow);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PHPCSVNodeTypes.funcTypes</code>是比较广义的类型，有：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVNodeTypes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; funcTypes =</span><br><span class="line">				Arrays.asList(TYPE_TOPLEVEL, TYPE_FUNC_DECL, TYPE_METHOD, TYPE_CLOSURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="createASTForFunction"><a href="#createASTForFunction" class="headerlink" title="createASTForFunction"></a>createASTForFunction</h3><p><code>createASTForFunction()</code>函数会以function type节点对应的语句范围为单位，生成ASTNode：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">createASTForFunction</span><span class="params">(ASTUnderConstruction ast, Iterator&lt;KeyedCSVRow&gt; nodeRows, KeyedCSVRow keyedRow)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先设置根节点</span></span><br><span class="line">    <span class="comment">// nodeInterpreter.handle(keyedRow, ast)函数会读取keyedRow，将其转成ASTNode，并存储在ast参数中</span></span><br><span class="line">    <span class="comment">// 然后通过ast》getNodeById 返回一个id值</span></span><br><span class="line">    FunctionDefBase root = (FunctionDefBase) ast.getNodeById( nodeInterpreter.handle(keyedRow, ast));</span><br><span class="line">    <span class="comment">// 将其设置为根节点</span></span><br><span class="line">    ast.setRootNode(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (nodeRows.hasNext())</span><br><span class="line">    &#123;</span><br><span class="line">        keyedRow = nodeRows.next();</span><br><span class="line">        <span class="comment">// 继续读取后续的keyedRow，将其转成ASTNode，并存储在ast参数中</span></span><br><span class="line">        nodeInterpreter.handle(keyedRow, ast);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图是一个ast对象的简单例子：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/4.png" alt="4"></p>
<p>从上图的例子也可以看到，已经有了ASTNode，但是它们之前仅仅是通过<code>createASTForFunction</code>函数处理还没有节点与节点之间的关系。</p>
<h3 id="createASTEdges"><a href="#createASTEdges" class="headerlink" title="createASTEdges"></a>createASTEdges</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createASTEdges</span><span class="params">(CSVAST csvAST, ASTUnderConstruction ast)</span> <span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Iterator&lt;KeyedCSVRow&gt; edgeRows = csvAST.edgeIterator();</span><br><span class="line">    KeyedCSVRow keyedRow;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (edgeRows.hasNext())</span><br><span class="line">    &#123;</span><br><span class="line">        keyedRow = edgeRows.next();</span><br><span class="line">        <span class="comment">// 根据边之间的关系，通过设置ast中ASTNode节点的children对象作为节点与节点之间的关系边</span></span><br><span class="line">        edgeInterpreter.handle(keyedRow, ast);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="setInterpreters"><a href="#setInterpreters" class="headerlink" title="setInterpreters"></a>setInterpreters</h3><p>设置解释器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInterpreters</span><span class="params">(CSVRowInterpreter nodeInterpreter, CSVRowInterpreter edgeInterpreter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.nodeInterpreter = nodeInterpreter;</span><br><span class="line">    <span class="keyword">this</span>.edgeInterpreter = edgeInterpreter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PHPCSVNodeInterpreter类"><a href="#PHPCSVNodeInterpreter类" class="headerlink" title="PHPCSVNodeInterpreter类"></a>PHPCSVNodeInterpreter类</h2><blockquote>
<p>joern/projects/extensions/joern-php/src/main/java/tools/php/ast2cpg/PHPCSVNodeInterpreter.java</p>
<p>joern/projects/extensions/jpanlib/src/main/java/inputModules/csv/csv2ast/CSVRowInterpreter.java</p>
</blockquote>
<p><code>PHPCSVNodeInterpreter</code>通过<code>handle(KeyedCSVRow row, ASTUnderConstruction ast)</code>方法，将一行node记录转为AST，并保存在ast中。</p>
<p><code>PHPCSVNodeInterpreter</code>类实现了接口<code>CSVRowInterpreter</code>，后者只有一个接口方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CSVRowInterpreter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(KeyedCSVRow row, ASTUnderConstruction ast)</span> <span class="keyword">throws</span> InvalidCSVFile</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>PHPCSVNodeInterpreter</code>中实现了<code>handle</code>方法，先从参数<code>KeyedCSVRow row</code>中获取节点type，然后针对不同的type，有不同的处理方方式。该类中定义了很多<strong>handle****()</strong>函数，就是来处理不同type的节点，这些函数会返回一个节点对应的id，该id也是在row中定义好的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVNodeInterpreter</span> <span class="keyword">implements</span> <span class="title">CSVRowInterpreter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(KeyedCSVRow row, ASTUnderConstruction ast)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">long</span> retval = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 获取当前节点的type，不同type的节点有不同的处理方式</span></span><br><span class="line">		String type = row.getFieldForKey(PHPCSVNodeTypes.TYPE);</span><br><span class="line">		<span class="keyword">switch</span> (type)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// null nodes (leafs)</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NULL:</span><br><span class="line">				retval = handleNull(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// primary expressions (leafs)</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_INTEGER:</span><br><span class="line">				retval = handleInteger(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DOUBLE:</span><br><span class="line">				retval = handleDouble(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STRING:</span><br><span class="line">				retval = handleString(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// special nodes</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NAME:</span><br><span class="line">				retval = handleName(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLOSURE_VAR:</span><br><span class="line">				retval = handleClosureVar(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// declaration nodes</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TOPLEVEL:</span><br><span class="line">				retval = handleTopLevelFunction(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_FUNC_DECL:</span><br><span class="line">				retval = handleFunction(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLOSURE:</span><br><span class="line">				retval = handleClosure(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_METHOD:</span><br><span class="line">				retval = handleMethod(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLASS:</span><br><span class="line">				retval = handleClass(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes without children (leafs)</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_MAGIC_CONST:</span><br><span class="line">				retval = handleMagicConst(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TYPE:</span><br><span class="line">				retval = handleTypeHint(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 1 child</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_VAR:</span><br><span class="line">				retval = handleVariable(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONST:</span><br><span class="line">				retval = handleConstant(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_UNPACK:</span><br><span class="line">				retval = handleUnpack(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CAST:</span><br><span class="line">				retval = handleCast(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_EMPTY:</span><br><span class="line">				retval = handleEmpty(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ISSET:</span><br><span class="line">				retval = handleIsset(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SHELL_EXEC:</span><br><span class="line">				retval = handleShellExec(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLONE:</span><br><span class="line">				retval = handleClone(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_EXIT:</span><br><span class="line">				retval = handleExit(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PRINT:</span><br><span class="line">				retval = handlePrint(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_INCLUDE_OR_EVAL:</span><br><span class="line">				retval = handleIncludeOrEval(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_UNARY_OP:</span><br><span class="line">				retval = handleUnaryOperation(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PRE_INC:</span><br><span class="line">				retval = handlePreInc(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PRE_DEC:</span><br><span class="line">				retval = handlePreDec(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_POST_INC:</span><br><span class="line">				retval = handlePostInc(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_POST_DEC:</span><br><span class="line">				retval = handlePostDec(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_YIELD_FROM:</span><br><span class="line">				retval = handleYieldFrom(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_GLOBAL:</span><br><span class="line">				retval = handleGlobal(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_UNSET:</span><br><span class="line">				retval = handleUnset(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_RETURN:</span><br><span class="line">				retval = handleReturn(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_LABEL:</span><br><span class="line">				retval = handleLabel(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_REF:</span><br><span class="line">				retval = handleReference(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_HALT_COMPILER:</span><br><span class="line">				retval = handleHaltCompiler(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ECHO:</span><br><span class="line">				retval = handleEcho(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_THROW:</span><br><span class="line">				retval = handleThrow(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_GOTO:</span><br><span class="line">				retval = handleGoto(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_BREAK:</span><br><span class="line">				retval = handleBreak(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONTINUE:</span><br><span class="line">				retval = handleContinue(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 2 children</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DIM:</span><br><span class="line">				retval = handleArrayIndexing(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PROP:</span><br><span class="line">				retval = handleProperty(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STATIC_PROP:</span><br><span class="line">				retval = handleStaticProperty(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CALL:</span><br><span class="line">				retval = handleCall(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLASS_CONST:</span><br><span class="line">				retval = handleClassConstant(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ASSIGN:</span><br><span class="line">				retval = handleAssign(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ASSIGN_REF:</span><br><span class="line">				retval = handleAssignByRef(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ASSIGN_OP:</span><br><span class="line">				retval = handleAssignWithOp(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_BINARY_OP:</span><br><span class="line">				retval = handleBinaryOperation(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ARRAY_ELEM:</span><br><span class="line">				retval = handleArrayElement(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NEW:</span><br><span class="line">				retval = handleNew(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_INSTANCEOF:</span><br><span class="line">				retval = handleInstanceof(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_YIELD:</span><br><span class="line">				retval = handleYield(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_COALESCE:</span><br><span class="line">				retval = handleCoalesce(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STATIC:</span><br><span class="line">				retval = handleStaticVariable(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_WHILE:</span><br><span class="line">				retval = handleWhile(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DO_WHILE:</span><br><span class="line">				retval = handleDo(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_IF_ELEM:</span><br><span class="line">				retval = handleIfElement(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SWITCH:</span><br><span class="line">				retval = handleSwitch(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SWITCH_CASE:</span><br><span class="line">				retval = handleSwitchCase(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DECLARE:</span><br><span class="line">				retval = handleDeclare(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PROP_ELEM:</span><br><span class="line">				retval = handlePropertyElement(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONST_ELEM:</span><br><span class="line">				retval = handleConstantElement(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_USE_TRAIT:</span><br><span class="line">				retval = handleUseTrait(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRAIT_PRECEDENCE:</span><br><span class="line">				retval = handleTraitPrecedence(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_METHOD_REFERENCE:</span><br><span class="line">				retval = handleMethodReference(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NAMESPACE:</span><br><span class="line">				retval = handleNamespace(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_USE_ELEM:</span><br><span class="line">				retval = handleUseElement(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRAIT_ALIAS:</span><br><span class="line">				retval = handleTraitAlias(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_GROUP_USE:</span><br><span class="line">				retval = handleGroupUse(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 3 children</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_METHOD_CALL:</span><br><span class="line">				retval = handleMethodCall(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STATIC_CALL:</span><br><span class="line">				retval = handleStaticCall(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONDITIONAL:</span><br><span class="line">				retval = handleConditional(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRY:</span><br><span class="line">				retval = handleTry(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CATCH:</span><br><span class="line">				retval = handleCatch(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PARAM:</span><br><span class="line">				retval = handleParameter(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 4 children</span></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_FOR:</span><br><span class="line">				retval = handleFor(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_FOREACH:</span><br><span class="line">				retval = handleForEach(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with an arbitrary number of children</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ARG_LIST:</span><br><span class="line">				retval = handleArgumentList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_LIST:</span><br><span class="line">				retval = handleList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ARRAY:</span><br><span class="line">				retval = handleArray(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ENCAPS_LIST:</span><br><span class="line">				retval = handleEncapsList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_EXPR_LIST:</span><br><span class="line">				retval = handleExpressionList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STMT_LIST:</span><br><span class="line">				retval = handleCompound(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_IF:</span><br><span class="line">				retval = handleIf(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SWITCH_LIST:</span><br><span class="line">				retval = handleSwitchList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CATCH_LIST:</span><br><span class="line">				retval = handleCatchList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PARAM_LIST:</span><br><span class="line">				retval = handleParameterList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLOSURE_USES:</span><br><span class="line">				retval = handleClosureUses(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PROP_DECL:</span><br><span class="line">				retval = handlePropertyDeclaration(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONST_DECL:</span><br><span class="line">				retval = handleConstantDeclaration(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLASS_CONST_DECL:</span><br><span class="line">				retval = handleClassConstantDeclaration(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NAME_LIST:</span><br><span class="line">				retval = handleIdentifierList(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRAIT_ADAPTATIONS:</span><br><span class="line">				retval = handleTraitAdaptations(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_USE:</span><br><span class="line">				retval = handleUseStatement(row, ast);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				retval = defaultHandler(row, ast);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以<code>handleTopLevelFunction</code>为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">handleTopLevelFunction</span><span class="params">(KeyedCSVRow row,</span></span></span><br><span class="line"><span class="function"><span class="params">			ASTUnderConstruction ast)</span> <span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 实例化一个TopLevelFunctionDef对象，TopLevelFunctionDef继承自ASTNode</span></span><br><span class="line">    TopLevelFunctionDef newNode = <span class="keyword">new</span> TopLevelFunctionDef();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从row中读取type，flags，lineno，childnum等信息</span></span><br><span class="line">    String type = row.getFieldForKey(PHPCSVNodeTypes.TYPE);</span><br><span class="line">    String flags = row.getFieldForKey(PHPCSVNodeTypes.FLAGS);</span><br><span class="line">    String lineno = row.getFieldForKey(PHPCSVNodeTypes.LINENO);</span><br><span class="line">    String childnum = row.getFieldForKey(PHPCSVNodeTypes.CHILDNUM);</span><br><span class="line">    String endlineno = row.getFieldForKey(PHPCSVNodeTypes.ENDLINENO);</span><br><span class="line">    String name = row.getFieldForKey(PHPCSVNodeTypes.NAME);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将type，flags，lineno，childnum等信息保存到TopLevelFunctionDef对象中</span></span><br><span class="line">    newNode.setProperty(PHPCSVNodeTypes.TYPE.getName(), type);</span><br><span class="line">    newNode.setFlags(flags);</span><br><span class="line">    CodeLocation codeloc = <span class="keyword">new</span> CodeLocation();</span><br><span class="line">    codeloc.startLine = Integer.parseInt(lineno);</span><br><span class="line">    codeloc.endLine = Integer.parseInt(endlineno);</span><br><span class="line"></span><br><span class="line">    newNode.setLocation(codeloc);</span><br><span class="line">    newNode.setProperty(PHPCSVNodeTypes.CHILDNUM.getName(), childnum);</span><br><span class="line">    <span class="keyword">if</span> (flags.contains(PHPCSVNodeTypes.FLAG_TOPLEVEL_FILE))</span><br><span class="line">        newNode.setName(<span class="string">"&lt;"</span> + name + <span class="string">"&gt;"</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (flags.contains(PHPCSVNodeTypes.FLAG_TOPLEVEL_CLASS))</span><br><span class="line">        newNode.setName(<span class="string">"["</span> + name + <span class="string">"]"</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile(<span class="string">"While trying to handle row "</span></span><br><span class="line">                                 + row.toString() + <span class="string">": "</span> + <span class="string">"Invalid toplevel flags "</span> + flags</span><br><span class="line">                                 + <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> id = Long.parseLong(row.getFieldForKey(PHPCSVNodeTypes.NODE_ID));</span><br><span class="line">    <span class="comment">// 将TopLevelFunctionDef对象保存到ast中</span></span><br><span class="line">    ast.addNodeWithId(newNode, id);</span><br><span class="line">    <span class="comment">// 将id保存到TopLevelFunctionDef对象中</span></span><br><span class="line">    newNode.setNodeId(id);</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 最后的返回值是节点id</span></span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外几个比较特殊的方法是函数调用相关的节点，有4个：</p>
<blockquote>
<p>handleCall (KeyedCSVRow row, ASTUnderConstruction ast)</p>
<p>handleNew (KeyedCSVRow row, ASTUnderConstruction ast)</p>
<p>handleMethodCall (KeyedCSVRow row, ASTUnderConstruction ast)</p>
<p>handleStaticCall (KeyedCSVRow row, ASTUnderConstruction ast)</p>
</blockquote>
<p>以<code>handleCall</code>为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">handleCall</span><span class="params">(KeyedCSVRow row, ASTUnderConstruction ast)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 实例化一个CallExpressionBase对象newNode，CallExpressionBase继承自ASTNode</span></span><br><span class="line">    CallExpressionBase newNode = <span class="keyword">new</span> CallExpressionBase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取type，flags，lineno等信息</span></span><br><span class="line">    String type = row.getFieldForKey(PHPCSVNodeTypes.TYPE);</span><br><span class="line">    String flags = row.getFieldForKey(PHPCSVNodeTypes.FLAGS);</span><br><span class="line">    String lineno = row.getFieldForKey(PHPCSVNodeTypes.LINENO);</span><br><span class="line">    String childnum = row.getFieldForKey(PHPCSVNodeTypes.CHILDNUM);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将type，flags，lineno等信息保存到对象newNode中</span></span><br><span class="line">    newNode.setProperty(PHPCSVNodeTypes.TYPE.getName(), type);</span><br><span class="line">    newNode.setFlags(flags);</span><br><span class="line">    CodeLocation codeloc = <span class="keyword">new</span> CodeLocation();</span><br><span class="line">    codeloc.startLine = Integer.parseInt(lineno);</span><br><span class="line"></span><br><span class="line">    newNode.setLocation(codeloc);</span><br><span class="line">    newNode.setProperty(PHPCSVNodeTypes.CHILDNUM.getName(), childnum);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> id = Long.parseLong(row.getFieldForKey(PHPCSVNodeTypes.NODE_ID));</span><br><span class="line">    <span class="comment">// 将newNode保存到ast中</span></span><br><span class="line">    ast.addNodeWithId(newNode, id);</span><br><span class="line">    <span class="comment">// 为newNode设置id</span></span><br><span class="line">    newNode.setNodeId(id);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// special in the case of function calls:</span></span><br><span class="line">    <span class="comment">// we add the created node to the PHP call graph factory's list of function calls;</span></span><br><span class="line">    <span class="comment">// hence we get a list of all function calls without any additional traversals of</span></span><br><span class="line">    <span class="comment">// the final AST</span></span><br><span class="line">    <span class="comment">// 相比其他类型的节点，这里比较特殊，将newNode加入到PHPCGFactory的function call对应的LinkedList中</span></span><br><span class="line">    PHPCGFactory.addFunctionCall(newNode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相比其他方法，多了<code>PHPCGFactory.addFunctionCall(newNode);</code>操作。</p>
<p>在<code>PHPCGFactory</code>中维护了四个LinkedList数组，用来保存四种不同的CallExpression节点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCGFactory</span> </span>&#123;</span><br><span class="line">	<span class="comment">// maintains a list of function calls</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LinkedList&lt;CallExpressionBase&gt; functionCalls = <span class="keyword">new</span> LinkedList&lt;CallExpressionBase&gt;();</span><br><span class="line">	<span class="comment">// maintains a list of static method calls</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LinkedList&lt;StaticCallExpression&gt; staticMethodCalls = <span class="keyword">new</span> LinkedList&lt;StaticCallExpression&gt;();</span><br><span class="line">	<span class="comment">// maintains a list of static method calls</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LinkedList&lt;NewExpression&gt; constructorCalls = <span class="keyword">new</span> LinkedList&lt;NewExpression&gt;();</span><br><span class="line">	<span class="comment">// maintains a list of non-static method calls</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> LinkedList&lt;MethodCallExpression&gt; nonStaticMethodCalls = <span class="keyword">new</span> LinkedList&lt;MethodCallExpression&gt;();</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Adds a new function call.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> functionCall A PHP function/method/constructor call. An arbitrary number of</span></span><br><span class="line"><span class="comment">	 *                     distinguished calls to the same function/method/constructor can</span></span><br><span class="line"><span class="comment">	 *                     be added.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addFunctionCall</span><span class="params">( CallExpressionBase callExpression)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Note: we cannot access any of the CallExpression's getter methods here</span></span><br><span class="line">		<span class="comment">// because this method is called from the PHPCSVNodeInterpreter at the point</span></span><br><span class="line">		<span class="comment">// where it constructs the CallExpression. That is, this method is called for each</span></span><br><span class="line">		<span class="comment">// CallExpression *immediately* after its construction. At that point, the PHPCSVNodeInterpreter</span></span><br><span class="line">		<span class="comment">// has not called the CallExpression's setter methods  (as it has not yet interpreted the</span></span><br><span class="line">		<span class="comment">// corresponding CSV lines).</span></span><br><span class="line">		<span class="comment">// Hence, we only store the references to the CallExpression objects themselves.</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>( callExpression <span class="keyword">instanceof</span> StaticCallExpression)</span><br><span class="line">			<span class="keyword">return</span> staticMethodCalls.add( (StaticCallExpression)callExpression);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>( callExpression <span class="keyword">instanceof</span> NewExpression)</span><br><span class="line">			<span class="keyword">return</span> constructorCalls.add( (NewExpression)callExpression);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>( callExpression <span class="keyword">instanceof</span> MethodCallExpression)</span><br><span class="line">			<span class="keyword">return</span> nonStaticMethodCalls.add( (MethodCallExpression)callExpression);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> functionCalls.add( callExpression);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><code>PHPCGFactory.addFunctionCall()</code>方法是在<code>PHPCSVNodeInterpreter</code>中构造CallExpression的时候调用的，也就是说，在每个CallExpression构造完之后，就会调用这个方法，先保存该对象的引用。</p>
<h2 id="PHPCSVEdgeInterpreter类"><a href="#PHPCSVEdgeInterpreter类" class="headerlink" title="PHPCSVEdgeInterpreter类"></a>PHPCSVEdgeInterpreter类</h2><blockquote>
<p>joern/projects/extensions/joern-php/src/main/java/tools/php/ast2cpg/PHPCSVEdgeInterpreter.java</p>
</blockquote>
<p><code>PHPCSVEdgeInterpreter</code>通过<code>handle(KeyedCSVRow row, ASTUnderConstruction ast)</code>方法，将一行rels记录转为AST，并保存在ast中。</p>
<p>和<code>PHPCSVNodeInterpreter</code>一样，<code>PHPCSVEdgeInterpreter</code>类中也实现了<code>handle</code>方法，先从参数<code>KeyedCSVRow row</code>中获取节点type，然后针对不同的type，有不同的处理方方式。同样的，该类中也定义了很多<strong>handle****()</strong>函数来处理不同type的节点，这些函数会返回一个<code>errno</code>来判断有没有发生错误。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PHPCSVEdgeInterpreter</span> <span class="keyword">implements</span> <span class="title">CSVRowInterpreter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(KeyedCSVRow row, ASTUnderConstruction ast)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> InvalidCSVFile</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">long</span> startId = Long.parseLong(row.getFieldForKey(PHPCSVEdgeTypes.START_ID));</span><br><span class="line">		<span class="keyword">long</span> endId = Long.parseLong(row.getFieldForKey(PHPCSVEdgeTypes.END_ID));</span><br><span class="line"></span><br><span class="line">		ASTNode startNode = ast.getNodeById(startId);</span><br><span class="line">		ASTNode endNode = ast.getNodeById(endId);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// TODO put childnum property into edges file instead of nodes file,</span></span><br><span class="line">		<span class="comment">// then do not add the childnum property to ASTNodes in node interpreter any longer,</span></span><br><span class="line">		<span class="comment">// then introduce some NumberFormatException handling here.</span></span><br><span class="line">		<span class="comment">//int childnum = Integer.parseInt(row.getFieldForKey(PHPCSVEdgeTypes.CHILDNUM));</span></span><br><span class="line">		<span class="keyword">int</span> childnum = Integer.parseInt(endNode.getProperty(PHPCSVNodeTypes.CHILDNUM.getName()));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Special treatment for closures: they are expressions, so we create a ClosureExpression to hold them</span></span><br><span class="line">		<span class="comment">// We cannot do this in the PHPCSVNodeInterpreter, since CSV2AST expects an instance of PHPFunctionDef</span></span><br><span class="line">		<span class="comment">// for the first row of the CSVAST that it converts. (Closure is an instance of PHPFunctionDef and thus</span></span><br><span class="line">		<span class="comment">// cannot be an instance of Expression.)</span></span><br><span class="line">        <span class="comment">// Closure表示匿名类</span></span><br><span class="line">        <span class="comment">// 对匿名类进行特殊处理</span></span><br><span class="line">		<span class="keyword">if</span>( endNode <span class="keyword">instanceof</span> Closure)</span><br><span class="line">			endNode = createClosureExpression((Closure)endNode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// errno = 0表示正常</span></span><br><span class="line">        <span class="comment">// errno = 1表示childnum对不上</span></span><br><span class="line">        <span class="comment">// errno = 2表示在加入leaf子节点的时候发生了问题</span></span><br><span class="line">		<span class="keyword">int</span> errno = <span class="number">0</span>;</span><br><span class="line">		String type = startNode.getProperty(PHPCSVNodeTypes.TYPE.getName());</span><br><span class="line">		<span class="keyword">switch</span> (type)</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="comment">// 这些节点不存在leaf子节点，所以</span></span><br><span class="line">			<span class="comment">// - null nodes (leafs)</span></span><br><span class="line">			<span class="comment">// - primary expressions (leafs)</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NULL:</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_INTEGER:</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DOUBLE:</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STRING:</span><br><span class="line">				errno = <span class="number">2</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// special nodes</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NAME:</span><br><span class="line">				errno = handleName((Identifier)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLOSURE_VAR:</span><br><span class="line">				errno = handleClosureVar((ClosureVar)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// declaration nodes</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TOPLEVEL:</span><br><span class="line">				errno = handleTopLevelFunction((TopLevelFunctionDef)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_FUNC_DECL:</span><br><span class="line">				errno = handleFunction((FunctionDef)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLOSURE:</span><br><span class="line">				errno = handleClosure((Closure)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_METHOD:</span><br><span class="line">				errno = handleMethod((Method)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLASS:</span><br><span class="line">				errno = handleClass((ClassDef)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes without children (leafs)</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_MAGIC_CONST:</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TYPE:</span><br><span class="line">				errno = <span class="number">2</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 1 child</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_VAR:</span><br><span class="line">				errno = handleVariable((Variable)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONST:</span><br><span class="line">				errno = handleConstant((Constant)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_UNPACK:</span><br><span class="line">				errno = handleUnpack((UnpackExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CAST:</span><br><span class="line">				errno = handleCast((CastExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_EMPTY:</span><br><span class="line">				errno = handleEmpty((EmptyExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ISSET:</span><br><span class="line">				errno = handleIsset((IssetExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SHELL_EXEC:</span><br><span class="line">				errno = handleShellExec((ShellExecExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLONE:</span><br><span class="line">				errno = handleClone((CloneExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_EXIT:</span><br><span class="line">				errno = handleExit((ExitExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PRINT:</span><br><span class="line">				errno = handlePrint((PrintExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_INCLUDE_OR_EVAL:</span><br><span class="line">				errno = handleIncludeOrEval((IncludeOrEvalExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_UNARY_OP:</span><br><span class="line">				errno = handleUnaryOperation((UnaryOperationExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PRE_INC:</span><br><span class="line">				errno = handlePreInc((PreIncOperationExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PRE_DEC:</span><br><span class="line">				errno = handlePreDec((PreDecOperationExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_POST_INC:</span><br><span class="line">				errno = handlePostInc((PostIncOperationExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_POST_DEC:</span><br><span class="line">				errno = handlePostDec((PostDecOperationExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_YIELD_FROM:</span><br><span class="line">				errno = handleYieldFrom((YieldFromExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_GLOBAL:</span><br><span class="line">				errno = handleGlobal((GlobalStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_UNSET:</span><br><span class="line">				errno = handleUnset((UnsetStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_RETURN:</span><br><span class="line">				errno = handleReturn((ReturnStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_LABEL:</span><br><span class="line">				errno = handleLabel((Label)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_REF:</span><br><span class="line">				errno = handleReference((ReferenceExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_HALT_COMPILER:</span><br><span class="line">				errno = handleHaltCompiler((HaltCompilerStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ECHO:</span><br><span class="line">				errno = handleEcho((EchoStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_THROW:</span><br><span class="line">				errno = handleThrow((ThrowStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_GOTO:</span><br><span class="line">				errno = handleGoto((GotoStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_BREAK:</span><br><span class="line">				errno = handleBreak((BreakStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONTINUE:</span><br><span class="line">				errno = handleContinue((ContinueStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 2 children</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DIM:</span><br><span class="line">				errno = handleArrayIndexing((ArrayIndexing)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PROP:</span><br><span class="line">				errno = handleProperty((PropertyExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STATIC_PROP:</span><br><span class="line">				errno = handleStaticProperty((StaticPropertyExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CALL:</span><br><span class="line">				errno = handleCall((CallExpressionBase)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLASS_CONST:</span><br><span class="line">				errno = handleClassConstant((ClassConstantExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ASSIGN:</span><br><span class="line">				errno = handleAssign((AssignmentExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ASSIGN_REF:</span><br><span class="line">				errno = handleAssignByRef((AssignmentByRefExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ASSIGN_OP:</span><br><span class="line">				errno = handleAssignWithOp((AssignmentWithOpExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_BINARY_OP:</span><br><span class="line">				errno = handleBinaryOperation((BinaryOperationExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ARRAY_ELEM:</span><br><span class="line">				errno = handleArrayElement((ArrayElement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NEW:</span><br><span class="line">				errno = handleNew((NewExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_INSTANCEOF:</span><br><span class="line">				errno = handleInstanceof((InstanceofExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_YIELD:</span><br><span class="line">				errno = handleYield((YieldExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_COALESCE:</span><br><span class="line">				errno = handleCoalesce((CoalesceExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STATIC:</span><br><span class="line">				errno = handleStaticVariable((StaticVariableDeclaration)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_WHILE:</span><br><span class="line">				errno = handleWhile((WhileStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DO_WHILE:</span><br><span class="line">				errno = handleDo((DoStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_IF_ELEM:</span><br><span class="line">				errno = handleIfElement((IfElement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SWITCH:</span><br><span class="line">				errno = handleSwitch((SwitchStatementPHP)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SWITCH_CASE:</span><br><span class="line">				errno = handleSwitchCase((SwitchCase)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PROP_ELEM:</span><br><span class="line">				errno = handlePropertyElement((PropertyElement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_DECLARE:</span><br><span class="line">				errno = handleDeclare((DeclareStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONST_ELEM:</span><br><span class="line">				errno = handleConstantElement((ConstantElement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_USE_TRAIT:</span><br><span class="line">				errno = handleUseTrait((UseTrait)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRAIT_PRECEDENCE:</span><br><span class="line">				errno = handleTraitPrecedence((TraitPrecedence)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_METHOD_REFERENCE:</span><br><span class="line">				errno = handleMethodReference((MethodReference)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NAMESPACE:</span><br><span class="line">				errno = handleNamespace((NamespaceStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_USE_ELEM:</span><br><span class="line">				errno = handleUseElement((UseElement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRAIT_ALIAS:</span><br><span class="line">				errno = handleTraitAlias((TraitAlias)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_GROUP_USE:</span><br><span class="line">				errno = handleGroupUse((GroupUseStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 3 children</span></span><br><span class="line">			<span class="comment">// expressions</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_METHOD_CALL:</span><br><span class="line">				errno = handleMethodCall((MethodCallExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STATIC_CALL:</span><br><span class="line">				errno = handleStaticCall((StaticCallExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONDITIONAL:</span><br><span class="line">				errno = handleConditional((ConditionalExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRY:</span><br><span class="line">				errno = handleTry((TryStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CATCH:</span><br><span class="line">				errno = handleCatch((CatchStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PARAM:</span><br><span class="line">				errno = handleParameter((Parameter)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with exactly 4 children</span></span><br><span class="line">			<span class="comment">// statements</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_FOR:</span><br><span class="line">				errno = handleFor((ForStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_FOREACH:</span><br><span class="line">				errno = handleForEach((ForEachStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// nodes with an arbitrary number of children</span></span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ARG_LIST:</span><br><span class="line">				errno = handleArgumentList((ArgumentList)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_LIST:</span><br><span class="line">				errno = handleList((ListExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ARRAY:</span><br><span class="line">				errno = handleArray((ArrayExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_ENCAPS_LIST:</span><br><span class="line">				errno = handleEncapsList((EncapsListExpression)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_EXPR_LIST:</span><br><span class="line">				errno = handleExpressionList((ExpressionList)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_STMT_LIST:</span><br><span class="line">				errno = handleCompound((CompoundStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_IF:</span><br><span class="line">				errno = handleIf((IfStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_SWITCH_LIST:</span><br><span class="line">				errno = handleSwitchList((SwitchList)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CATCH_LIST:</span><br><span class="line">				errno = handleCatchList((CatchList)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PARAM_LIST:</span><br><span class="line">				errno = handleParameterList((ParameterList)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLOSURE_USES:</span><br><span class="line">				errno = handleClosureUses((ClosureUses)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_PROP_DECL:</span><br><span class="line">				errno = handlePropertyDeclaration((PropertyDeclaration)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CONST_DECL:</span><br><span class="line">				errno = handleConstantDeclaration((ConstantDeclaration)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_CLASS_CONST_DECL:</span><br><span class="line">				errno = handleClassConstantDeclaration((ClassConstantDeclaration)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_NAME_LIST:</span><br><span class="line">				errno = handleIdentifierList((IdentifierList)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_TRAIT_ADAPTATIONS:</span><br><span class="line">				errno = handleTraitAdaptations((TraitAdaptations)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> PHPCSVNodeTypes.TYPE_USE:</span><br><span class="line">				errno = handleUseStatement((UseStatement)startNode, endNode, childnum);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				errno = defaultHandler(startNode, endNode, childnum);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>( <span class="number">1</span> == errno)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile(<span class="string">"While trying to handle row "</span></span><br><span class="line">					+ row.toString() + <span class="string">": Invalid childnum "</span> + childnum</span><br><span class="line">					+ <span class="string">" for start node type "</span> + type + <span class="string">"."</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>( <span class="number">2</span> == errno)</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidCSVFile(<span class="string">"While trying to handle row "</span></span><br><span class="line">					+ row.toString() + <span class="string">": Cannot add child to leaf node "</span></span><br><span class="line">					+ type + <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> startId;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="样例跟踪"><a href="#样例跟踪" class="headerlink" title="样例跟踪"></a>样例跟踪</h2><p>以一个demo为例，调试跟踪一下Joern将<code>nodes.csv</code>和<code>rels.csv</code>重新组合成AST树的过程。</p>
<p><strong>case1_optimize/1.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"foo in 1.php"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo();</span><br></pre></td></tr></table></figure>

<p><strong>case1_optimize/2.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"foo in 2.php"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>case1_optimize_3.php</strong>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"foo in 3.php"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个断点打在<code>Main.java</code>中：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/5.png" alt="5"></p>
<p>跟入<code>CSVFunctionExtractor.getNextFunction</code>：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/6.png" alt="6"></p>
<p>通过<code>addNodeRowsUntilNextFile</code>方法和<code>AddEdgeRowsUntilNextFile</code>方法按php文件读取<code>nodes.csv</code>文件和<code>rels.csv</code>文件后，将其保存在<code>csvFifoQueue</code>队列中，通过队列保存到<code>csvAST</code>对象中：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/7.png" alt="7"></p>
<p>然后调用<code>PHPCSV2AST.convert</code>方法，将<code>csvAST</code>转为AST，调用过程如下图：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/8.png" alt="8"></p>
<p>然后需要利用<code>nodeInterpreter</code>即<code>PHPCSVNodeInterpreter.handle</code>处理不同type的节点，针对不同type的节点，有各种不同的<strong>handle****</strong>方法，能生成不同的ASTNode：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/9.png" alt="9"></p>
<p>处理完Node之后，Node之间是没什么联系的，因为边的信息还没有加入AST中，返回<code>CSV2AST.convert</code>方法，继续执行<code>createASTEdges</code>，会将边的关系通过添加child的方式加入到ASTNode中：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/10.png" alt="10"></p>
<p>比如demo中，以第一个function type为根节点生成的AST树为：</p>
<p><img src="/2021/04/23/Joern%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8BAST%E6%A0%91%E7%94%9F%E6%88%90/imgs/11.png" alt="11"></p>
<p>节点与节点之间的关系是通过<code>children</code>参数来连接的。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"># PHP程序分析</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2021/04/21/PHPJoernSourceCodeNotes/">PHPJoern源码阅读</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
