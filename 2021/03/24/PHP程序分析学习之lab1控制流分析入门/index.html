<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>PHP程序分析学习-控制流分析入门 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">PHP程序分析学习-控制流分析入门</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-03-24&nbsp;&nbsp;11:55:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>lab-1 是控制流分析入门。</p>
<h2 id="lab-1-sample"><a href="#lab-1-sample" class="headerlink" title="lab-1-sample"></a>lab-1-sample</h2><blockquote>
<p>实验纲要：通过所给php源码文件，利用PHPJoern进行程序分析，从文件的第一行或函数的开头开始分析，<br>给出到达函数 <code>$DB-&gt;request($query)</code>(lineno:72)  的控制流路径</p>
</blockquote>
<p><strong>Sample</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'only_tasks'</span>])) &#123;</span><br><span class="line">   $only_tasks = explode(<span class="string">','</span>, $_GET[<span class="string">'only_tasks'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   $only_tasks = [];</span><br><span class="line">&#125;</span><br><span class="line">$crontask = <span class="keyword">new</span> Crontask();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Sample Input:</strong></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(2,8)</span><br></pre></td></tr></table></figure>

<p><strong>Sample Output:</strong></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[2,3,4,8]</span><br><span class="line">[2,3,6,8]</span><br></pre></td></tr></table></figure>

<p><strong>note</strong></p>
<ul>
<li>到达该函数的控制流语句应当有多条。</li>
</ul>
<p>为sample case生成CPG图，并导入neo4j数据库分析结点信息。</p>
<p>在CPG图中存在一个起始结点，该结点通常包含一些其他结点不存在的属性，如同时存在<code>lineno</code>和<code>endlineno</code>，包含文件名，node的类型为<code>AST_TOPLEVEL</code>。</p>
<p>该起始结点如下图所示，属性为：</p>
<blockquote>
<ul>
<li>lineno : 1</li>
<li>endlineno : 9</li>
<li>flags : TOPLEVEL_FILE</li>
<li>name : lab1_sample.php</li>
<li>id : 1</li>
<li>type : AST_TOPLEVEL</li>
</ul>
</blockquote>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/1.png" alt="1"></p>
<p>控制流路径如下图绿色部分实线所示：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/2.png" alt="2"></p>
<p>当然我们也可以直接通过查询语句查看CFG，就可以很清晰地看到存在两条控制流路径：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p=()-[r:FLOWS_TO]-&gt;() RETURN p LIMIT 25</span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/3.png" alt="3"></p>
<h3 id="Python-Script-for-Sample"><a href="#Python-Script-for-Sample" class="headerlink" title="Python Script for Sample :"></a>Python Script for Sample :</h3><p>config.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.py</span></span><br><span class="line"><span class="keyword">import</span> py2neo</span><br><span class="line"></span><br><span class="line">neo4j_host = <span class="string">"10.176.36.21"</span></span><br><span class="line">neo4j_username = <span class="string">"neo4j"</span></span><br><span class="line">neo4j_password = <span class="string">"123"</span></span><br><span class="line">port = <span class="string">'36888'</span></span><br><span class="line">graph = py2neo.Graph(host=neo4j_host, port=port, auth=(neo4j_username, neo4j_password))</span><br></pre></td></tr></table></figure>

<p>main.py：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main.py</span></span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> graph</span><br><span class="line"><span class="keyword">import</span> py2neo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_FUNC_ENTRY_relationships</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    寻找CFG的ENRTY结点，先得到relationship</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'ENTRY'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_FUNC_ENTRY_node</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    寻找CFG的入口结点，只有一个</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    entry_relationship = get_CFG_FUNC_ENTRY_relationships(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> entry_relationship:</span><br><span class="line">        <span class="keyword">if</span> rel.start_node == Node:</span><br><span class="line">            <span class="keyword">return</span> rel.end_node</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_FLOWS_TO_relationships</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 FLOWS_TO Relationship list</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'FLOWS_TO'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_FLOWS_TO_nodes</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点，寻找其CFG图中的子结点</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    cfg_child_nodes = []</span><br><span class="line">    flows_to_rels = get_FLOWS_TO_relationships(Node)</span><br><span class="line">    <span class="keyword">for</span> node_item <span class="keyword">in</span> flows_to_rels:</span><br><span class="line">        <span class="keyword">if</span> node_item.start_node == Node:</span><br><span class="line">            <span class="keyword">if</span> node_item <span class="keyword">not</span> <span class="keyword">in</span> cfg_child_nodes:</span><br><span class="line">                cfg_child_nodes.append(node_item.end_node)</span><br><span class="line">    cfg_child_nodes.sort(key=<span class="keyword">lambda</span> node: node[<span class="string">'id'</span>], reverse=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> cfg_child_nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_paths</span><span class="params">(Node, path)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过深搜来遍历CFG路径</span></span><br><span class="line"><span class="string">    :param Node: CFG ENTRY Node</span></span><br><span class="line"><span class="string">    :param path: 控制流路径</span></span><br><span class="line"><span class="string">    :param path_num:    控制流条数</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> Node[<span class="string">'type'</span>] == <span class="string">'NULL'</span>:</span><br><span class="line">        print(<span class="string">"\t"</span>, path[:<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment"># path = []</span></span><br><span class="line">    child_nodes = get_FLOWS_TO_nodes(Node)</span><br><span class="line">    <span class="keyword">for</span> child <span class="keyword">in</span> child_nodes:</span><br><span class="line">        path.append(child[<span class="string">'lineno'</span>])</span><br><span class="line">        get_CFG_paths(child, path)</span><br><span class="line">        path.pop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    top_node = graph.nodes[<span class="number">1</span>]</span><br><span class="line">    print(<span class="string">"[*] TOPLEVEL Node = "</span>, top_node)</span><br><span class="line"></span><br><span class="line">    cfg_entry_node = get_CFG_FUNC_ENTRY_node(top_node)</span><br><span class="line">    print(<span class="string">"[*] CFG_FUNC_RNTRY_NODE's id = "</span>, cfg_entry_node[<span class="string">'id'</span>])</span><br><span class="line"></span><br><span class="line">    path = []</span><br><span class="line">    print(<span class="string">"[*] The Control Flow Paths is &#123;"</span>)</span><br><span class="line">    get_CFG_paths(cfg_entry_node, path)</span><br><span class="line">    print(<span class="string">"&#125;"</span>)</span><br></pre></td></tr></table></figure>

<p>Results for Sample : </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] TOPLEVEL Node =  (_1:AST &#123;endlineno: 9, flags: ['TOPLEVEL_FILE'], id: 1, lineno: 1, name: 'lab1_sample.php', type: 'AST_TOPLEVEL'&#125;)</span><br><span class="line">[*] CFG_FUNC_RNTRY_NODE's id =  2</span><br><span class="line">[*] The Control Flow Paths is &#123;</span><br><span class="line">	 [2, 3, 4, 8]</span><br><span class="line">	 [2, 3, 6, 8]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lab-1-源码-unlock-tasks-php"><a href="#lab-1-源码-unlock-tasks-php" class="headerlink" title="lab-1-源码-unlock-tasks.php"></a>lab-1-源码-unlock-tasks.php</h2><p>接下来看lab-1给出题目的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * GLPI - Gestionnaire Libre de Parc Informatique</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2015-2018 Teclib' and contributors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://glpi-project.org</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * based on GLPI - Gestionnaire Libre de Parc Informatique</span></span><br><span class="line"><span class="comment"> * Copyright (C) 2003-2014 by the INDEPNET Development Team.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * LICENSE</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This file is part of GLPI.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * GLPI is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment"> * it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment"> * the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment"> * (at your option) any later version.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * GLPI is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment"> * GNU General Public License for more details.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment"> * along with GLPI. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure current directory when run from crontab</span></span><br><span class="line">chdir(<span class="keyword">__DIR__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Glpi</span>\<span class="title">Event</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> (<span class="string">'../inc/includes.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'argv'</span>])) &#123;</span><br><span class="line">   <span class="keyword">for</span> ($i=<span class="number">1</span>; $i&lt;$_SERVER[<span class="string">'argc'</span>]; $i++) &#123;</span><br><span class="line">      $it    = explode(<span class="string">"="</span>, $_SERVER[<span class="string">'argv'</span>][$i], <span class="number">2</span>);</span><br><span class="line">      $it[<span class="number">0</span>] = preg_replace(<span class="string">'/^--/'</span>, <span class="string">''</span>, $it[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">      $_GET[$it[<span class="number">0</span>]] = (<span class="keyword">isset</span>($it[<span class="number">1</span>]) ? $it[<span class="number">1</span>] : <span class="keyword">true</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'cycle'</span>])) &#123;</span><br><span class="line">   $cycle = (int)$_GET[<span class="string">'cycle'</span>];</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   $cycle = <span class="number">25</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'only_tasks'</span>])) &#123;</span><br><span class="line">   $only_tasks = explode(<span class="string">','</span>, $_GET[<span class="string">'only_tasks'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   $only_tasks = [];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$crontask = <span class="keyword">new</span> Crontask();</span><br><span class="line">$query    = <span class="string">"SELECT `id`, `name`</span></span><br><span class="line"><span class="string">             FROM `glpi_crontasks`</span></span><br><span class="line"><span class="string">             WHERE `state` = '"</span>.Crontask::STATE_RUNNING.<span class="string">"'</span></span><br><span class="line"><span class="string">                   AND unix_timestamp(`lastrun`) + $cycle * `frequency` &lt; unix_timestamp(now())"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Number of unlocked tasks by the script</span></span><br><span class="line">$unlocked_tasks = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Date : "</span>.Html::convDateTime($_SESSION[<span class="string">'glpi_currenttime'</span>]).<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Start unlock script\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($DB-&gt;request($query) <span class="keyword">as</span> $task) &#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="keyword">empty</span>($only_tasks) &amp;&amp; !in_array($task[<span class="string">'name'</span>], $only_tasks)) &#123;</span><br><span class="line">      <span class="keyword">echo</span> $task[<span class="string">'name'</span>].<span class="string">" is still running but not in the whitelist\n"</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   $tmp[<span class="string">'state'</span>] = Crontask::STATE_WAITING;</span><br><span class="line">   $tmp[<span class="string">'id'</span>]    = $task[<span class="string">'id'</span>];</span><br><span class="line">   <span class="keyword">if</span> ($crontask-&gt;update($tmp)) &#123;</span><br><span class="line">      $unlocked_tasks++;</span><br><span class="line">      $message = <span class="string">"Task '"</span>.$task[<span class="string">'name'</span>].<span class="string">"' unlocked"</span>;</span><br><span class="line">      <span class="keyword">echo</span> $message.<span class="string">"\n"</span>;</span><br><span class="line">      Event::log($task[<span class="string">'id'</span>], <span class="string">'Crontask'</span>, <span class="number">5</span>, <span class="string">'Configuration'</span>, $message);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Number of unlocked tasks : "</span>.$unlocked_tasks.<span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>

<p>对用的AST图：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/AST_unlock_tasks.svg" alt="AST"></p>
<p>启动neo4j图数据库之后，在浏览器中访问，先了解下CFG图的基本情况。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p=()-[r:FLOWS_TO]-&gt;() RETURN p LIMIT 60</span><br></pre></td></tr></table></figure>

<p>粗略地一看，可以看到存在很多条Control Flows：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/4.png" alt="4"></p>
<p>我对其做了下简单的标记：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/sample.png" alt="sample"></p>
<p>但是该CFG图中存在多个回路，因此，对于这种情况我们需要特殊处理：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/5.png" alt="5"></p>
<h3 id="循环结构"><a href="#循环结构" class="headerlink" title="循环结构"></a>循环结构</h3><h4 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h4><p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/for.png" alt="for"></p>
<p>写了一段测试代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">1</span>; $i&lt;<span class="number">4</span>; $i++) &#123;</span><br><span class="line">        <span class="keyword">echo</span> $i * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/AST_for_loop.svg" alt="AST"></p>
<p>对应的CPG图为：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/13.png" alt="13"></p>
<p>抽出其中的CFG图：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/14.png" alt="14"></p>
<p>可以看到上面也存在回路（<code>id:16 -&gt; id:11 -&gt; id:21</code>），这是for循环CFG图的一个特点。</p>
<h4 id="foreach循环"><a href="#foreach循环" class="headerlink" title="foreach循环"></a>foreach循环</h4><p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/foreach.png" alt="foreach"></p>
<p>可以看到，foreach和for循环的不同就在于，foreach仅能用于数组和对象，当应用于其他数据类型的时候就会报错。</p>
<p>相同的，如果我们自己写个程序测试下，也能发现该结构会存在一条回路。</p>
<h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><p>首先，我们要找到目标行的结点，也就是确定72行所对应的Node结点。</p>
<p>但是，第72行对应的不仅仅是一个结点，我们进行简单的查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH (n:AST &#123;lineno: 72&#125;) RETURN n</span><br></pre></td></tr></table></figure>

<p>结果返回了12个结点，第72行代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($DB-&gt;request($query) <span class="keyword">as</span> $task)</span><br></pre></td></tr></table></figure>

<p>对应12个node结点，其中第72行的根节点为<code>node: { id = &#39;187&#39; }</code>：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/7.png" alt="7"></p>
<p>一开始查询到结果的时候，我以为在CFG图中的<code>lineno</code>为72的结点是<code>node: { id = &#39;187&#39; }</code>，但是，实际上，<code>node: { id = &#39;188&#39; }</code>才是CFG中的目标结点：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/8.png" alt="8"></p>
<p>重新查看lab的要求：</p>
<blockquote>
<p>实验纲要：通过所给php源码文件，利用PHPJoern进行程序分析，从文件的第一行或函数的开头开始分析，<br>给出到达函数 <code>$DB-&gt;request($query)</code>(lineno:72)  的控制流路径</p>
</blockquote>
<p>题目中的要求是，要给出到达函数<code>$DB-&gt;request($query)</code>的控制流路径，从图上可以看出，该部分属于下图中虚线框部分：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/9.png" alt="9"></p>
<p>而对于第72行代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($DB-&gt;request($query) <span class="keyword">as</span> $task)</span><br></pre></td></tr></table></figure>

<p>其中的<code>$DB-&gt;request($query)</code>属于<code>foreach</code>结点的<strong>子结点</strong>。</p>
<p>所以，确定<code>$DB-&gt;request($query)</code>结点的具体步骤为：</p>
<ol>
<li><p>先找到72行的根结点，即<code>foreach</code>结点</p>
</li>
<li><p>然后寻找<code>foreach</code>结点的子结点中满足条件的结点Target，该Target结点的子结点中可以看到下面几个结点：</p>
<blockquote>
<ul>
<li>lineno: 72    code: DB    id: 190    type: string</li>
<li>lineno: 72    code: request    id: 191    type: string</li>
</ul>
</blockquote>
</li>
</ol>
<p>确定72行的根结点：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_PARENT_OF_relationship</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 PARENT_OF Relationship list</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'PARENT_OF'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_PARENT_OF_NODE</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 PARENT Node</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    parent_of_rels_list = get_PARENT_OF_relationship(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> parent_of_rels_list:</span><br><span class="line">        <span class="keyword">if</span> rel.end_node == Node:</span><br><span class="line">            <span class="keyword">return</span> rel.start_node</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Line_Root_Node</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个结点，找到该节点所在行中的根节点</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> Node == <span class="literal">None</span>:</span><br><span class="line">        print(<span class="string">"[*] The Node is None."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> Node[<span class="string">'lineno'</span>] == <span class="literal">None</span>:</span><br><span class="line">        print(<span class="string">"[*] The attribute does not exists in Node."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    lineno = Node[<span class="string">'lineno'</span>]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        Parent_Node = get_PARENT_OF_NODE(Node)</span><br><span class="line">        <span class="keyword">if</span> Parent_Node[<span class="string">'lineno'</span>] == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> Parent_Node[<span class="string">'lineno'</span>] == lineno:</span><br><span class="line">            Node = Parent_Node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> Node</span><br></pre></td></tr></table></figure>

<p>寻找<code>foreach</code>结点的子结点中满足条件的结点Target：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Child_Nodes</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个结点，通过PARENT_OF relationships来寻找该结点的child 结点，有多个</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    child_node_list = []</span><br><span class="line">    parent_of_rels_list = get_PARENT_OF_relationship(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> parent_of_rels_list:</span><br><span class="line">        <span class="keyword">if</span> rel.start_node == Node:</span><br><span class="line">            <span class="keyword">if</span> rel.end_node <span class="keyword">not</span> <span class="keyword">in</span> child_node_list:</span><br><span class="line">                child_node_list.append(rel.end_node)</span><br><span class="line">    child_node_list.sort(key=<span class="keyword">lambda</span> node: node[<span class="string">'id'</span>], reverse=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> child_node_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">traverse_Child_Node_DFS</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过深搜DFS来确定当前Node结点或是子结点是否存在`$DB-&gt;request()`函数标志</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> Node[<span class="string">'code'</span>] == <span class="string">'DB'</span> <span class="keyword">or</span> Node[<span class="string">'code'</span>] == <span class="string">'request'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    child_node_list = get_Child_Nodes(Node)</span><br><span class="line">    <span class="keyword">for</span> child_node <span class="keyword">in</span> child_node_list:</span><br><span class="line">        flag = traverse_Child_Node_DFS(child_node)</span><br><span class="line">        <span class="keyword">if</span> flag == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">traverse_Child_Node_BFS</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过广搜BFS来确定当前Node结点或是子结点是否存在`$DB-&gt;request()`函数标志</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">    que = queue.Queue()</span><br><span class="line">    vis_nodes = []</span><br><span class="line">    que.put(Node)</span><br><span class="line">    <span class="keyword">while</span> que.qsize() != <span class="number">0</span>:</span><br><span class="line">        top_node = que.get()</span><br><span class="line">        <span class="keyword">if</span> top_node <span class="keyword">not</span> <span class="keyword">in</span> vis_nodes:</span><br><span class="line">          vis_nodes.append(top_node)</span><br><span class="line">        <span class="keyword">if</span> top_node[<span class="string">'code'</span>] == <span class="string">'DB'</span> <span class="keyword">or</span> top_node[<span class="string">'code'</span>] == <span class="string">'request'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        child_node_list = get_Child_Nodes(top_node)</span><br><span class="line">        <span class="keyword">for</span> child_node <span class="keyword">in</span> child_node_list:</span><br><span class="line">            <span class="keyword">if</span> child_node <span class="keyword">in</span> vis_nodes:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            que.put(child_node)</span><br><span class="line">            vis_nodes.append(child_node)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Target_Child_Node</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据提供的根节点（即foreach结点），确定$DB-&gt;request($query)函数的根结点</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    child_node_list = get_Child_Nodes(Node)</span><br><span class="line">    <span class="keyword">for</span> child_node <span class="keyword">in</span> child_node_list:</span><br><span class="line">        flag = traverse_Child_Node_DFS(child_node)</span><br><span class="line">        <span class="comment"># flag = traverse_Child_Node_BFS(child_node)</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> child_node</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>但这里我还有一个疑惑，为什么是<code>node: { id = &#39;188&#39; }</code>在CFG图上，而不是<code>node: { id = &#39;187&#39; }</code>？</p>
<p>我写了个程序验证下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">	<span class="keyword">echo</span> $value * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的CPG图为：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/10.png" alt="10"></p>
<p>同样的，在其中类型为<code>AST_FOREACH</code>类型的结点同样不在CFG图上：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/11.png" alt="11"></p>
<p>对应的CFG图为：</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/12.png" alt="12"></p>
<p>同样可以看到存在环路。</p>
<h3 id="完整程序"><a href="#完整程序" class="headerlink" title="完整程序"></a>完整程序</h3><p>因为我们要找到所有可能的路径，所以通过深搜来遍历CFG图获得控制流路径：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_FLOWS_TO_relationship</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 FLOWS_TO Relationship list</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'FLOWS_TO'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_Child_Nodes_List</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点，找到Node结点在CFG图中的子结点，应存在多个</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    cfg_child_node_list = []</span><br><span class="line">    cfg_flows_to_rels = get_FLOWS_TO_relationship(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> cfg_flows_to_rels:</span><br><span class="line">        <span class="keyword">if</span> rel.start_node == Node:</span><br><span class="line">            <span class="keyword">if</span> rel.end_node <span class="keyword">not</span> <span class="keyword">in</span> cfg_child_node_list:</span><br><span class="line">                cfg_child_node_list.append(rel.end_node)</span><br><span class="line">    cfg_child_node_list.sort(key=<span class="keyword">lambda</span> node: node[<span class="string">'id'</span>], reverse=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> cfg_child_node_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_CFG_PathList</span><span class="params">(PathList, CycleDict)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用于输出CFG路径，同时需要对循环涉及的路径进行特殊处理</span></span><br><span class="line"><span class="string">    :param PathList:</span></span><br><span class="line"><span class="string">    :param CycleDict:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    : 存在循环的情况</span></span><br><span class="line"><span class="string">    : PathList = [34, 36, 38, 40, 41, 41, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</span></span><br><span class="line"><span class="string">    : CycleDict = &#123;41: [42, 43, 45]&#125;</span></span><br><span class="line"><span class="string">    要将后一个重复的41替换为[42, 43, 45]</span></span><br><span class="line"><span class="string">    但是要注意，当前的PathList = [..., 41, 41, 48, ......]也是正确的CFG路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print(PathList)</span><br><span class="line"></span><br><span class="line">    flag = <span class="literal">True</span> <span class="comment"># 判断是否经过了循环路径</span></span><br><span class="line">    final_PathList = list(set(PathList))</span><br><span class="line">    <span class="keyword">if</span> len(final_PathList) == len(PathList):</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">    final_PathList.sort(key=PathList.index)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sorted(CycleDict.keys()):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> final_PathList:</span><br><span class="line">            idx = PathList.index(key)   <span class="comment"># 确定后一个重复的lineno的位置，进行替换</span></span><br><span class="line">            final_PathList[idx + <span class="number">1</span>:idx + <span class="number">1</span>] = iter(CycleDict[key])</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="literal">True</span>:    <span class="comment"># 如果没有经过循环，那么不用输出final_PathList，已经输出过PathList了</span></span><br><span class="line">        print(final_PathList)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_Path_DFS</span><span class="params">(StartNode, EndNode, PathList=[], CycleDict=&#123;&#125;)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过深搜来寻找CFG路径，当遍历到结束结点的时候就进行一次路径输出</span></span><br><span class="line"><span class="string">    :param StartNode: 遍历的起始Node结点</span></span><br><span class="line"><span class="string">    :param EndNode: 遍历的结束Node结点</span></span><br><span class="line"><span class="string">    :param PathList: 存储CFG路径</span></span><br><span class="line"><span class="string">    :param CycleDict: CFG图中存在的循环路径，需要特殊处理</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    PathList.append(StartNode[<span class="string">'lineno'</span>])</span><br><span class="line">    <span class="keyword">if</span> StartNode == EndNode:</span><br><span class="line">        print_CFG_PathList(PathList, CycleDict)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        CFG_Child_Node_List = get_CFG_Child_Nodes_List(StartNode)</span><br><span class="line">        <span class="keyword">for</span> CFG_Child_Node <span class="keyword">in</span> CFG_Child_Node_List:</span><br><span class="line">            <span class="comment"># 情况1：绝大多数情况下，CFG的当前结点lineno都不会小于其后续结点的lineno</span></span><br><span class="line">            <span class="keyword">if</span> CFG_Child_Node[<span class="string">'lineno'</span>] &gt;= StartNode[<span class="string">'lineno'</span>]:</span><br><span class="line">                get_CFG_Path_DFS(CFG_Child_Node, EndNode, PathList, CycleDict)</span><br><span class="line">            <span class="comment"># 情况2：在出现循环的情况下，当结点对应循环中的最后一行语句时，其后续子结点会回到循环体的初始行，所以会出现lineno变小的情况</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># CFG_Child_Node['lineno'] &lt; StartNode['lineno']</span></span><br><span class="line">                <span class="comment"># 举例：41 -&gt; 42 -&gt; 43 -&gt; 45(child_lineno) -&gt; 41</span></span><br><span class="line">                child_lineno = CFG_Child_Node[<span class="string">'lineno'</span>] <span class="comment"># 相当于上面的41</span></span><br><span class="line">                i = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> PathList[i] != child_lineno:</span><br><span class="line">                    i = i + <span class="number">1</span></span><br><span class="line">                i = i + <span class="number">1</span></span><br><span class="line">                CycleDict[child_lineno] = PathList[i + <span class="number">1</span>:]</span><br><span class="line">    PathList.pop()</span><br></pre></td></tr></table></figure>

<p>将上述的分析流程串起来，最后得到的程序为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> graph</span><br><span class="line"><span class="keyword">import</span> py2neo</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_AST_node_by_type</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供AST Type，获取AST结点</span></span><br><span class="line"><span class="string">    :param lineno:</span></span><br><span class="line"><span class="string">    :return: 返回第一个Node结点</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    Node_list = list(graph.nodes.match(<span class="string">"AST"</span>, type=type))</span><br><span class="line">    <span class="keyword">if</span> len(Node_list) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> Node_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_FUNC_ENTRY_relationships</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    寻找CFG的ENTRY结点，先得到relationships</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'ENTRY'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_FUNC_ENTRY_node</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    寻找CFG的入口结点，只有一个</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    entry_relationship = get_CFG_FUNC_ENTRY_relationships(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> entry_relationship:</span><br><span class="line">        <span class="keyword">if</span> rel <span class="keyword">in</span> entry_relationship:</span><br><span class="line">            <span class="keyword">if</span> rel.start_node == Node:</span><br><span class="line">                <span class="keyword">return</span> rel.end_node</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_PARENT_OF_relationship</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 PARENT_OF Relationship list</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'PARENT_OF'</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_PARENT_OF_NODE</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 PARENT_OF Relationship list</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    parent_of_rels_list = get_PARENT_OF_relationship(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> parent_of_rels_list:</span><br><span class="line">        <span class="keyword">if</span> rel.end_node == Node:</span><br><span class="line">            <span class="keyword">return</span> rel.start_node</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_AST_node_by_lineno</span><span class="params">(lineno)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供lineno，返回AST 结点，有多个</span></span><br><span class="line"><span class="string">    :param lineno:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    Node_list = list(graph.nodes.match(<span class="string">"AST"</span>, lineno=lineno))</span><br><span class="line">    <span class="keyword">return</span> Node_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Line_Root_Node</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个结点，找到该节点所在行中的根节点</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> Node == <span class="literal">None</span>:</span><br><span class="line">        print(<span class="string">"[*] The Node is None."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> Node[<span class="string">'lineno'</span>] == <span class="literal">None</span>:</span><br><span class="line">        print(<span class="string">"[*] The attribute does not exists in Node."</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    lineno = Node[<span class="string">'lineno'</span>]</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        Parent_Node = get_PARENT_OF_NODE(Node)</span><br><span class="line">        <span class="keyword">if</span> Parent_Node[<span class="string">'lineno'</span>] == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> Parent_Node[<span class="string">'lineno'</span>] == lineno:</span><br><span class="line">            Node = Parent_Node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> Node</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Child_Nodes</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个结点，通过PARENT_OF relationships来寻找该结点的child 结点，有多个</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    child_node_list = []</span><br><span class="line">    parent_of_rels_list = get_PARENT_OF_relationship(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> parent_of_rels_list:</span><br><span class="line">        <span class="keyword">if</span> rel.start_node == Node:</span><br><span class="line">            <span class="keyword">if</span> rel.end_node <span class="keyword">not</span> <span class="keyword">in</span> child_node_list:</span><br><span class="line">                child_node_list.append(rel.end_node)</span><br><span class="line">    child_node_list.sort(key=<span class="keyword">lambda</span> node: node[<span class="string">'id'</span>], reverse=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> child_node_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">traverse_Child_Node_DFS</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过深搜DFS来确定当前Node结点或是子结点是否存在`$DB-&gt;request()`函数标志</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> Node[<span class="string">'code'</span>] == <span class="string">'DB'</span> <span class="keyword">or</span> Node[<span class="string">'code'</span>] == <span class="string">'request'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    child_node_list = get_Child_Nodes(Node)</span><br><span class="line">    <span class="keyword">for</span> child_node <span class="keyword">in</span> child_node_list:</span><br><span class="line">        flag = traverse_Child_Node_DFS(child_node)</span><br><span class="line">        <span class="keyword">if</span> flag == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">traverse_Child_Node_BFS</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过广搜BFS来确定当前Node结点或是子结点是否存在`$DB-&gt;request()`函数标志</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">    que = queue.Queue()</span><br><span class="line">    vis_nodes = []</span><br><span class="line">    que.put(Node)</span><br><span class="line">    <span class="keyword">while</span> que.qsize() != <span class="number">0</span>:</span><br><span class="line">        top_node = que.get()</span><br><span class="line">        <span class="keyword">if</span> top_node <span class="keyword">not</span> <span class="keyword">in</span> vis_nodes:</span><br><span class="line">          vis_nodes.append(top_node)</span><br><span class="line">        <span class="keyword">if</span> top_node[<span class="string">'code'</span>] == <span class="string">'DB'</span> <span class="keyword">or</span> top_node[<span class="string">'code'</span>] == <span class="string">'request'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        child_node_list = get_Child_Nodes(top_node)</span><br><span class="line">        <span class="keyword">for</span> child_node <span class="keyword">in</span> child_node_list:</span><br><span class="line">            <span class="keyword">if</span> child_node <span class="keyword">in</span> vis_nodes:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            que.put(child_node)</span><br><span class="line">            vis_nodes.append(child_node)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_Target_Child_Node</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据提供的根节点（即foreach结点），确定$DB-&gt;request($query)函数的根结点</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    child_node_list = get_Child_Nodes(Node)</span><br><span class="line">    <span class="keyword">for</span> child_node <span class="keyword">in</span> child_node_list:</span><br><span class="line">        flag = traverse_Child_Node_BFS(child_node)</span><br><span class="line">        <span class="keyword">if</span> flag == <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> child_node</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_FLOWS_TO_relationship</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点, 返回和该node相关的 FLOWS_TO Relationship list</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> list(py2neo.RelationshipMatch(graph, nodes=&#123;Node&#125;, r_type=<span class="string">'FLOWS_TO'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_Child_Nodes_List</span><span class="params">(Node)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    提供一个Node结点，找到Node结点在CFG图中的子结点，应存在多个</span></span><br><span class="line"><span class="string">    :param Node:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    cfg_child_node_list = []</span><br><span class="line">    cfg_flows_to_rels = get_FLOWS_TO_relationship(Node)</span><br><span class="line">    <span class="keyword">for</span> rel <span class="keyword">in</span> cfg_flows_to_rels:</span><br><span class="line">        <span class="keyword">if</span> rel.start_node == Node:</span><br><span class="line">            <span class="keyword">if</span> rel.end_node <span class="keyword">not</span> <span class="keyword">in</span> cfg_child_node_list:</span><br><span class="line">                cfg_child_node_list.append(rel.end_node)</span><br><span class="line">    cfg_child_node_list.sort(key=<span class="keyword">lambda</span> node: node[<span class="string">'id'</span>], reverse=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> cfg_child_node_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_CFG_PathList</span><span class="params">(PathList, CycleDict)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用于输出CFG路径，同时需要对循环涉及的路径进行特殊处理</span></span><br><span class="line"><span class="string">    :param PathList:</span></span><br><span class="line"><span class="string">    :param CycleDict:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    : 存在循环的情况</span></span><br><span class="line"><span class="string">    : PathList = [34, 36, 38, 40, 41, 41, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</span></span><br><span class="line"><span class="string">    : CycleDict = &#123;41: [42, 43, 45]&#125;</span></span><br><span class="line"><span class="string">    要将后一个重复的41替换为[42, 43, 45]</span></span><br><span class="line"><span class="string">    但是要注意，当前的PathList = [..., 41, 41, 48, ......]也是正确的CFG路径</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    print(PathList)</span><br><span class="line"></span><br><span class="line">    flag = <span class="literal">True</span> <span class="comment"># 判断是否经过了循环路径</span></span><br><span class="line">    final_PathList = list(set(PathList))</span><br><span class="line">    <span class="keyword">if</span> len(final_PathList) == len(PathList):</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">    final_PathList.sort(key=PathList.index)</span><br><span class="line">    <span class="keyword">for</span> key <span class="keyword">in</span> sorted(CycleDict.keys()):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> final_PathList:</span><br><span class="line">            idx = PathList.index(key)   <span class="comment"># 确定后一个重复的lineno的位置，进行替换</span></span><br><span class="line">            final_PathList[idx + <span class="number">1</span>:idx + <span class="number">1</span>] = iter(CycleDict[key])</span><br><span class="line">    <span class="keyword">if</span> flag == <span class="literal">True</span>:    <span class="comment"># 如果没有经过循环，那么不用输出final_PathList，已经输出过PathList了</span></span><br><span class="line">        print(final_PathList)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_CFG_Path_DFS</span><span class="params">(StartNode, EndNode, PathList=[], CycleDict=&#123;&#125;)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    通过深搜来寻找CFG路径，当遍历到结束结点的时候就进行一次路径输出</span></span><br><span class="line"><span class="string">    :param StartNode: 遍历的起始Node结点</span></span><br><span class="line"><span class="string">    :param EndNode: 遍历的结束Node结点</span></span><br><span class="line"><span class="string">    :param PathList: 存储CFG路径</span></span><br><span class="line"><span class="string">    :param CycleDict: CFG图中存在的循环路径，需要特殊处理</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    PathList.append(StartNode[<span class="string">'lineno'</span>])</span><br><span class="line">    <span class="keyword">if</span> StartNode == EndNode:</span><br><span class="line">        print_CFG_PathList(PathList, CycleDict)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        CFG_Child_Node_List = get_CFG_Child_Nodes_List(StartNode)</span><br><span class="line">        <span class="keyword">for</span> CFG_Child_Node <span class="keyword">in</span> CFG_Child_Node_List:</span><br><span class="line">            <span class="comment"># 情况1：绝大多数情况下，CFG的当前结点lineno都不会小于其后续结点的lineno</span></span><br><span class="line">            <span class="keyword">if</span> CFG_Child_Node[<span class="string">'lineno'</span>] &gt;= StartNode[<span class="string">'lineno'</span>]:</span><br><span class="line">                get_CFG_Path_DFS(CFG_Child_Node, EndNode, PathList, CycleDict)</span><br><span class="line">            <span class="comment"># 情况2：在出现循环的情况下，当结点对应循环中的最后一行语句时，其后续子结点会回到循环体的初始行，所以会出现lineno变小的情况</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># CFG_Child_Node['lineno'] &lt; StartNode['lineno']</span></span><br><span class="line">                <span class="comment"># 举例：41 -&gt; 42 -&gt; 43 -&gt; 45(child_lineno) -&gt; 41</span></span><br><span class="line">                child_lineno = CFG_Child_Node[<span class="string">'lineno'</span>] <span class="comment"># 相当于上面的41</span></span><br><span class="line">                i = <span class="number">0</span></span><br><span class="line">                <span class="keyword">while</span> PathList[i] != child_lineno:</span><br><span class="line">                    i = i + <span class="number">1</span></span><br><span class="line">                i = i + <span class="number">1</span></span><br><span class="line">                CycleDict[child_lineno] = PathList[i + <span class="number">1</span>:]</span><br><span class="line">    PathList.pop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    start_lineno = <span class="number">1</span></span><br><span class="line">    end_lineno = <span class="number">72</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 从文件的起始行，也就是第一个Node开始遍历</span></span><br><span class="line">    start_node_type = <span class="string">"AST_TOPLEVEL"</span>    <span class="comment"># 文件第一行的AST Type为 AST_TOPLEVEL</span></span><br><span class="line">    start_node = get_AST_node_by_type(start_node_type)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 确定CFG的入口结点</span></span><br><span class="line">    cfg_entry_node = get_CFG_FUNC_ENTRY_node(start_node)</span><br><span class="line">    <span class="comment"># cfg_start_node = get_Child_Nodes(cfg_entry_node)[0]</span></span><br><span class="line">    cfg_start_node = graph.nodes[<span class="number">5</span>]</span><br><span class="line">    print(<span class="string">"[*] The Entry Node = "</span>, cfg_start_node)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 确定第72行对应的Node结点</span></span><br><span class="line">    temp_node = get_AST_node_by_lineno(end_lineno)</span><br><span class="line">    temp_root_node = get_Line_Root_Node(temp_node)</span><br><span class="line">    cfg_target_node = get_Target_Child_Node(temp_root_node)</span><br><span class="line">    print(<span class="string">"[*] The Target Node = "</span>, cfg_target_node)</span><br><span class="line"></span><br><span class="line">    get_CFG_Path_DFS(cfg_start_node, cfg_target_node)</span><br></pre></td></tr></table></figure>

<p>输出结果为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[*] The Entry Node =  (_5:AST &#123;childnum: 0, funcid: 1, id: 5, lineno: 34, type: 'AST_CALL'&#125;)</span><br><span class="line">[*] The Target Node =  (_188:AST &#123;childnum: 0, funcid: 1, id: 188, lineno: 72, type: 'AST_METHOD_CALL'&#125;)</span><br><span class="line">[34, 36, 38, 40, 41, 41, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 42, 43, 45, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 41, 48, 49, 54, 57, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 42, 43, 45, 48, 49, 54, 57, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 41, 48, 51, 54, 55, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 42, 43, 45, 48, 51, 54, 55, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 41, 48, 51, 54, 57, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 41, 42, 43, 45, 48, 51, 54, 57, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 48, 49, 54, 57, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 48, 51, 54, 55, 60, 61, 67, 69, 70, 72]</span><br><span class="line">[34, 36, 38, 40, 48, 51, 54, 57, 60, 61, 67, 69, 70, 72]</span><br></pre></td></tr></table></figure>

<h3 id="sink-flow结果"><a href="#sink-flow结果" class="headerlink" title="sink flow结果"></a>sink flow结果</h3><p>最后一共找到了8条sink flow，依次如下图所示。</p>
<p><strong>sink flow 1</strong>：[34, 36, 38, 40, 41, 41, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-9.png" alt="sink-flow-1"></p>
<p><strong>sink flow 2</strong>：[34, 36, 38, 40, 41, 42, 43, 45, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-1.png" alt="sink-flow-1"></p>
<p><strong>sink flow 3</strong>：[34, 36, 38, 40, 41, 41, 48, 49, 54, 57, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-10.png" alt="sink-flow-2"></p>
<p><strong>sink flow 4</strong>：[34, 36, 38, 40, 41, 42, 43, 45, 48, 49, 54, 57, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-2.png" alt="sink-flow-2"></p>
<p><strong>sink flow  5</strong>：[34, 36, 38, 40, 41, 41, 48, 51, 54, 55, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-11.png" alt="sink-flow-5"></p>
<p><strong>sink flow 6</strong>：[34, 36, 38, 40, 41, 42, 43, 45, 48, 51, 54, 55, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-3.png" alt="sink-flow-3"></p>
<p><strong>sink flow 7</strong>：[34, 36, 38, 40, 41, 41, 48, 51, 54, 57, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-12.png" alt="sink-flow-8"></p>
<p><strong>sink flow 8</strong>：[34, 36, 38, 40, 41, 42, 43, 45, 48, 51, 54, 57, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-4.png" alt="sink-flow-8"></p>
<p><strong>sink flow 9</strong>：[34, 36, 38, 40, 48, 49, 54, 55, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-5.png" alt="sink-flow-5"></p>
<p><strong>sink flow 10</strong>：[34, 36, 38, 40, 48, 49, 54, 57, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-6.png" alt="sink-flow-6"></p>
<p><strong>sink flow 11</strong>：[34, 36, 38, 40, 48, 51, 54, 55, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-7.png" alt="sink-flow-7"></p>
<p><strong>sink flow 12</strong>：[34, 36, 38, 40, 48, 51, 54, 57, 60, 61, 67, 69, 70, 72]</p>
<p><img src="/2021/03/24/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E5%AD%A6%E4%B9%A0%E4%B9%8Blab1%E6%8E%A7%E5%88%B6%E6%B5%81%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/imgs/6-path-8.png" alt="sink-flow-8"></p>
<h3 id="一个小问题"><a href="#一个小问题" class="headerlink" title="一个小问题"></a>一个小问题</h3><p>上面找到的sink flow中，其实还存在一些不太完美的地方，就是使用一条数据流边替代了控制流边。即上面<code>id:74 -&gt; id:97</code>的边，实际上的准确控制流的路径应该是<code>id:74 -&gt; id:41 -&gt; id:41 -&gt; id:97</code>，这是因为在遍历的时候存储的是lineno，而不是直接存储的结点，如果是存储的结点，那么其实是可以找到<code>id:74 -&gt; id:97</code>的路径的。不过这其实没有什么特别大的关系，这里只是记录下存在这么个问题。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90/"># PHP程序分析</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/04/01/PHP%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90%E4%B9%8BPHPJoern%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">PHP程序分析之PHPJoern环境配置</a>
            
            
            <a class="next" rel="next" href="/2021/03/21/Premiere%E5%BC%B9%E6%80%A7%E7%BC%A9%E6%94%BE%E8%BD%AC%E5%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Premiere弹性缩放转场学习笔记</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
